name: ğŸ”„ Generate Index

on:
  push:
    paths:
      - '**/*.html'
      - '!index.html'
      - 'generate-index.js'
    branches:
      - main
  workflow_dispatch:

permissions:
  contents: write

jobs:
  generate-index:
    name: ğŸ“‹ Generate HTML Index
    runs-on: ubuntu-latest
    
    steps:
      - name: ğŸ“¥ Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}
      
      - name: ğŸŸ¢ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
      
      - name: ğŸ” List HTML files
        run: |
          echo "ğŸ“š Fichiers HTML trouvÃ©s:"
          find . -name "*.html" -not -path "./.git/*" -not -name "index.html" | head -30
          echo ""
          echo "ğŸ“Š Total: $(find . -name "*.html" -not -path "./.git/*" -not -name "index.html" | wc -l) fichiers"
      
      - name: ğŸ”„ Pull latest changes (ANTI-CONFLIT)
        run: |
          echo "ğŸ”„ Synchronisation avec origin/main..."
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          
          # Pull avec rebase pour Ã©viter conflits
          git pull --rebase origin main || {
            echo "âš ï¸ Conflit dÃ©tectÃ©, rÃ©solution automatique..."
            # Si conflit sur index.html, prendre la version remote et rÃ©gÃ©nÃ©rer
            git checkout --theirs index.html 2>/dev/null || true
            git add index.html 2>/dev/null || true
            git rebase --continue || git rebase --skip
          }
      
      - name: ğŸš€ Generate index.html
        run: |
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "ğŸ”„ GÃ©nÃ©ration de l'index C Concept&Dev"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          node generate-index.js
      
      - name: ğŸ“Š Verify generated index
        run: |
          if [ -f index.html ]; then
            echo "âœ… index.html gÃ©nÃ©rÃ© avec succÃ¨s"
            echo ""
            echo "ğŸ“¦ Taille du fichier:"
            ls -lh index.html
          else
            echo "âŒ Erreur: index.html non gÃ©nÃ©rÃ©"
            exit 1
          fi
      
      - name: ğŸ“¤ Commit and push with retry (ANTI-CONFLIT)
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          
          # VÃ©rifier si changements
          if git diff --quiet index.html 2>/dev/null; then
            echo "â„¹ï¸ Pas de changements dÃ©tectÃ©s dans index.html"
            exit 0
          fi
          
          # Ajouter et commiter
          git add index.html
          git commit -m "ğŸ”„ Auto-update index.html [skip ci]"
          
          # Push avec retry (3 tentatives)
          for attempt in {1..3}; do
            echo "ğŸ“¤ Tentative de push ($attempt/3)..."
            
            if git push origin main; then
              echo "âœ… Push rÃ©ussi !"
              exit 0
            else
              echo "âš ï¸ Push Ã©chouÃ©, tentative $attempt/3"
              
              if [ $attempt -lt 3 ]; then
                echo "ğŸ”„ Pull + rebase avant nouvelle tentative..."
                sleep 5
                
                # Pull avec rebase
                git pull --rebase origin main || {
                  echo "âš ï¸ Conflit durant rebase, rÃ©solution..."
                  # Prendre la version remote et rÃ©gÃ©nÃ©rer
                  git checkout --theirs index.html 2>/dev/null || true
                  node generate-index.js
                  git add index.html
                  git rebase --continue || git rebase --skip
                }
              else
                echo "âŒ Ã‰chec aprÃ¨s 3 tentatives"
                exit 1
              fi
            fi
          done
      
      - name: ğŸ“‹ Summary
        if: always()
        run: |
          echo ""
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "âœ… WORKFLOW TERMINÃ‰"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo ""
          echo "L'index.html est maintenant Ã  jour et accessible"
          echo "sur GitHub Pages."
          echo ""
          echo "ğŸ”— https://c-concept-dev.github.io/C-Concept-Dev/"
          echo ""
