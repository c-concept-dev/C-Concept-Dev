<!DOCTYPE html>
<html lang="fr">
<!--
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    OCR UNIVERSEL V6.8.2 WORKER PAYLOAD FIX
    Knowledge Base Generator + V14 Workflow IntÃ©grÃ© - Worker Mode CorrigÃ©
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

ğŸ”§ CORRECTION V6.8.2 - WORKER PAYLOAD STRUCTURE:
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

âœ… BUG CRITIQUE CORRIGÃ‰:
   â€¢ Erreur: "Missing required fields: apiKey and payload"
   â€¢ Cause: Structure du payload incorrecte envoyÃ©e aux workers
   â€¢ Fix: Ajout de la structure {apiKey: "", payload: {...}}
   
âœ… CHANGEMENTS APPORTÃ‰S:
   â€¢ callViaWorker() restructurÃ© avec bon format
   â€¢ apiKey vide envoyÃ© (clÃ© cÃ´tÃ© serveur en mode worker)
   â€¢ payload encapsulÃ© correctement: {provider, model, messages, ...}
   â€¢ Logs amÃ©liorÃ©s pour debugging

ğŸ¯ STRUCTURE CORRECTE WORKER:
   {
       apiKey: "",  // Vide en mode worker
       payload: {
           provider: "openai",
           model: "gpt-4o",
           max_tokens: 32000,
           temperature: 0.3,
           messages: [{role: "user", content: "..."}]
       }
   }

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    HISTORIQUE - VERSION V6.7.5
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

ğŸš€ CORRECTIONS V6.7.5 - MODE ENSEMBLE 100% OPÃ‰RATIONNEL:
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

âœ… BUGS CRITIQUES CORRIGÃ‰S MODE ENSEMBLE:
   â€¢ Providers optimisÃ©s â†’ Claude, OpenAI, Groq
   â€¢ CORS Anthropic bloquÃ© â†’ âœ… FORCÃ‰ via Worker Mode
   â€¢ JSON Parsing crashes â†’ âœ… SÃ‰CURISÃ‰ avec vÃ©rifications
   â€¢ ZIP Generation Ã©chec â†’ âœ… CORRIGÃ‰ avec ArrayBuffer

âœ… PROVIDERS CONFIGURÃ‰S:
   â€¢ Anthropic Claude (toutes versions)
   â€¢ OpenAI GPT (4o, 4o-mini)
   â€¢ Groq (Llama 3.3 70B)

âœ… GESTION CORS OPTIMISÃ‰E:
   â€¢ Anthropic â†’ Worker Mode forcÃ© (bypass CORS)
   â€¢ OpenAI â†’ Direct API (pas de restrictions)
   â€¢ Groq â†’ Direct API forcÃ© (Worker incompatible)

âœ… KB ENGINE SÃ‰CURISÃ‰:
   â€¢ VÃ©rifications content !== undefined
   â€¢ Parsing JSON robuste avec fallbacks
   â€¢ Stockage FILE original pour ZIP
   â€¢ Conversion ArrayBuffer pour JSZip

âœ… WORKFLOW ENSEMBLE TESTÃ‰ ET VALIDÃ‰:
   â€¢ Les 6 tÃ¢ches parallÃ¨les fonctionnent
   â€¢ Multi-provider fallback chains opÃ©rationnels
   â€¢ GÃ©nÃ©ration ZIP complÃ¨te avec moteur de recherche
   â€¢ Mode Manuel/API Multi-LLM/ENSEMBLE/Worker prÃ©servÃ©s

ğŸ¯ ARCHITECTURE ROBUSTE:
   1. Upload fichier â†’ Extraction (PDF/EPUB/autres)
   2. Mode ENSEMBLE â†’ 6 tÃ¢ches parallÃ¨les multi-provider
   3. Fallback automatique si provider Ã©choue
   4. KB Engine â†’ JSON sÃ©curisÃ© + ZIP complet
   5. Download automatique avec moteur de recherche

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
-->
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OCR Universel V6.8.7 WORKER - Batch API + Structure Extraction Fix</title>
    
    <!-- Police Montserrat -->
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- BibliothÃ¨ques CDN -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/pdf-lib@1.17.1/dist/pdf-lib.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/tesseract.js@4/dist/tesseract.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mammoth/1.6.0/mammoth.browser.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/js-yaml/4.1.0/js-yaml.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/idb@7/build/umd.js"></script>
    
    <style>
        /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
        /* CHARTE GRAPHIQUE - C CONCEPT&DEV */
        /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
        
        :root {
            --vert-sauge: #C8D0C3;
            --beige-sable: #D8CDBB;
            --sable: #E6D7C3;
            --mer: #8FAFB1;
            --blanc: #FFFFFF;
            --noir: #000000;
            --gris-texte: #333333;
            --gris-secondaire: #666666;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Montserrat', 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, var(--sable) 0%, var(--beige-sable) 100%);
            color: var(--gris-texte);
            min-height: 100vh;
            padding: 20px;
            line-height: 1.6;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: var(--blanc);
            border-radius: 20px;
            padding: 40px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.15);
        }
        
        /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
        /* TYPOGRAPHIE */
        /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
        
        h1 {
            color: var(--mer);
            font-size: 2.5em;
            font-weight: 700;
            margin-bottom: 10px;
            text-align: center;
        }
        
        h2 {
            color: var(--mer);
            font-size: 2em;
            font-weight: 600;
            margin-top: 40px;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 3px solid var(--vert-sauge);
        }
        
        h3 {
            color: var(--gris-texte);
            font-size: 1.5em;
            font-weight: 600;
            margin-top: 30px;
            margin-bottom: 15px;
        }
        
        h4 {
            color: var(--mer);
            font-size: 1.2em;
            font-weight: 600;
            margin-bottom: 10px;
        }
        
        /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
        /* HEADER */
        /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
        
        .header {
            text-align: center;
            padding: 30px;
            background: linear-gradient(135deg, var(--sable) 0%, var(--beige-sable) 100%);
            border-radius: 12px;
            margin-bottom: 40px;
            border-left: 5px solid var(--mer);
        }
        
        .version-badge {
            display: inline-block;
            background: linear-gradient(135deg, var(--mer) 0%, var(--vert-sauge) 100%);
            color: var(--blanc);
            padding: 8px 20px;
            border-radius: 20px;
            font-size: 0.9em;
            font-weight: 600;
            margin-top: 10px;
        }
        
        .subtitle {
            font-size: 1.1em;
            color: var(--gris-secondaire);
            margin-top: 10px;
        }
        
        /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
        /* CARDS & SECTIONS */
        /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
        
        .section {
            background: var(--blanc);
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 15px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
        }
        
        .card {
            background: linear-gradient(135deg, var(--sable) 0%, var(--beige-sable) 100%);
            padding: 14px;
            border-radius: 8px;
            border-left: 4px solid var(--mer);
            margin-bottom: 15px;
            transition: transform 0.3s;
        }
        
        .card:hover {
            transform: translateY(-3px);
            box-shadow: 0 6px 20px rgba(143, 175, 177, 0.3);
        }
        
        .info-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin: 20px 0;
        }
        
        .info-item {
            background: var(--sable);
            padding: 20px;
            border-radius: 10px;
        }
        
        .info-label {
            font-size: 0.85em;
            color: var(--gris-secondaire);
            margin-bottom: 8px;
            font-weight: 500;
        }
        
        .info-value {
            font-size: 1.2em;
            font-weight: 600;
            color: var(--mer);
        }
        
        /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
        /* UPLOAD ZONE */
        /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
        
        .drop-zone {
            border: 3px dashed var(--mer);
            border-radius: 12px;
            padding: 60px 30px;
            text-align: center;
            cursor: pointer;
            background: var(--sable);
            transition: all 0.3s;
        }
        
        .drop-zone:hover, .drop-zone.drag-over {
            background: linear-gradient(135deg, var(--mer) 0%, var(--vert-sauge) 100%);
            color: var(--blanc);
            transform: scale(1.02);
        }
        
        .drop-zone input[type="file"] {
            display: none;
        }
        
        .drop-zone-icon {
            font-size: 4em;
            margin-bottom: 20px;
        }
        
        .supported-formats {
            margin-top: 20px;
            padding: 20px;
            background: var(--beige-sable);
            border-radius: 10px;
        }
        
        .format-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 10px;
            margin-top: 15px;
        }
        
        .format-badge {
            background: var(--mer);
            color: var(--blanc);
            padding: 6px 12px;
            border-radius: 8px;
            font-size: 0.85em;
            text-align: center;
            font-weight: 500;
        }
        
        /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
        /* PROGRESS */
        /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
        
        .progress-container {
            background: var(--sable);
            padding: 25px;
            border-radius: 12px;
            margin-bottom: 25px;
            border-left: 4px solid var(--mer);
            display: none;
        }
        
        .progress-bar-container {
            width: 100%;
            height: 30px;
            background: var(--beige-sable);
            border-radius: 15px;
            overflow: hidden;
            margin-bottom: 15px;
        }
        
        .progress-bar-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--mer), var(--vert-sauge));
            border-radius: 15px;
            transition: width 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--blanc);
            font-weight: 600;
        }
        
        .progress-detail {
            display: flex;
            justify-content: space-between;
            padding: 12px;
            background: var(--blanc);
            border-radius: 8px;
            margin-top: 10px;
        }
        
        /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
        /* STATUS MESSAGES */
        /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
        
        .status-message {
            padding: 15px 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            display: none;
            border-left: 4px solid;
        }
        
        .status-success {
            background: linear-gradient(135deg, #E6D7C3 0%, #D8CDBB 100%);
            border-color: #8FAFB1;
            color: #5a5a5a;
        }
        
        .status-info {
            background: var(--sable);
            border-color: var(--mer);
            color: var(--gris-texte);
        }
        
        .status-warning {
            background: linear-gradient(135deg, #E6D7C3 0%, #D8CDBB 100%);
            border-color: #C8D0C3;
            color: #5a5a5a;
        }
        
        .status-error {
            background: linear-gradient(135deg, #D8CDBB 0%, #C8D0C3 100%);
            border-color: #8FAFB1;
            color: #5a5a5a;
        }
        
        /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
        /* BUTTONS */
        /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
        
        .btn {
            background: linear-gradient(135deg, var(--mer) 0%, var(--vert-sauge) 100%);
            color: var(--blanc);
            border: none;
            padding: 15px 40px;
            border-radius: 10px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            box-shadow: 0 4px 15px rgba(143, 175, 177, 0.3);
            font-family: 'Montserrat', sans-serif;
        }
        
        .btn:hover {
            transform: scale(1.05);
            box-shadow: 0 6px 20px rgba(143, 175, 177, 0.5);
        }
        
        .btn-secondary {
            background: var(--beige-sable);
            color: var(--gris-texte);
        }
        
        .btn-small {
            padding: 10px 25px;
            font-size: 14px;
        }
        
        .btn-group {
            display: flex;
            gap: 15px;
            margin-top: 15px;
            flex-wrap: wrap;
        }
        
        /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
        /* TEMPLATES */
        /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
        
        .templates-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }
        
        .template-card {
            background: var(--sable);
            padding: 25px;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.3s;
            border-left: 4px solid var(--mer);
        }
        
        .template-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 6px 20px rgba(143, 175, 177, 0.3);
        }
        
        .template-badge {
            display: inline-block;
            background: var(--mer);
            color: var(--blanc);
            padding: 5px 12px;
            border-radius: 12px;
            font-size: 0.8em;
            margin-top: 10px;
            margin-right: 5px;
        }
        
        /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
        /* CONFIGURATION */
        /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
        
        .config-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
            margin: 30px 0;
        }
        
        .config-section {
            background: var(--sable);
            padding: 25px;
            border-radius: 12px;
            border-left: 4px solid var(--mer);
        }
        
        .platform-selector {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin: 20px 0;
        }
        
        .platform-option {
            background: var(--blanc);
            padding: 20px;
            border-radius: 10px;
            border: 2px solid var(--beige-sable);
            cursor: pointer;
            transition: all 0.3s;
            text-align: center;
        }
        
        .platform-option:hover {
            border-color: var(--mer);
        }
        
        .platform-option.selected {
            background: linear-gradient(135deg, var(--mer) 0%, var(--vert-sauge) 100%);
            color: var(--blanc);
            border-color: var(--mer);
        }
        
        .model-selector {
            display: none;
            margin-top: 15px;
        }
        
        .model-selector select {
            width: 100%;
            padding: 12px;
            border-radius: 8px;
            border: 2px solid var(--beige-sable);
            font-family: 'Montserrat', sans-serif;
            font-size: 15px;
            background: var(--blanc);
        }
        
        .indicator-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 15px;
            margin-top: 20px;
        }
        
        .indicator {
            text-align: center;
            padding: 15px;
            background: var(--blanc);
            border-radius: 8px;
        }
        
        .indicator-label {
            font-size: 0.85em;
            color: var(--gris-secondaire);
            margin-bottom: 8px;
        }
        
        .indicator-value {
            font-size: 1.1em;
            font-weight: 600;
            color: var(--mer);
        }
        
        /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
        /* COMPOSITION OVERRIDE */
        /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
        
        .composition-section {
            background: var(--sable);
            padding: 30px;
            border-radius: 12px;
            border-left: 4px solid var(--mer);
            margin-top: 30px;
            display: none;
        }
        
        .content-checkboxes {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }
        
        .checkbox-label {
            background: var(--blanc);
            padding: 15px;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 12px;
        }
        
        .checkbox-label:hover {
            background: var(--beige-sable);
        }
        
        .checkbox-label input[type="checkbox"] {
            width: 20px;
            height: 20px;
            cursor: pointer;
        }
        
        .weights-section {
            margin-top: 25px;
            padding: 25px;
            background: var(--blanc);
            border-radius: 10px;
        }
        
        .slider-item {
            display: grid;
            grid-template-columns: 200px 1fr 80px;
            gap: 15px;
            align-items: center;
            margin-bottom: 20px;
        }
        
        .slider-item input[type="range"] {
            width: 100%;
            height: 8px;
            border-radius: 4px;
            background: var(--beige-sable);
            outline: none;
            -webkit-appearance: none;
        }
        
        .slider-item input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 22px;
            height: 22px;
            border-radius: 50%;
            background: var(--mer);
            cursor: pointer;
        }
        
        .slider-item input[type="range"]::-moz-range-thumb {
            width: 22px;
            height: 22px;
            border-radius: 50%;
            background: var(--mer);
            cursor: pointer;
            border: none;
        }
        
        /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
        /* PARTS CONTAINER */
        /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
        
        .part-card {
            background: var(--sable);
            padding: 30px;
            border-radius: 12px;
            margin-bottom: 30px;
            border-left: 4px solid var(--mer);
        }
        
        .part-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        
        .part-title {
            font-size: 1.3em;
            font-weight: 600;
            color: var(--mer);
        }
        
        .status-badge {
            padding: 8px 16px;
            border-radius: 12px;
            font-size: 0.85em;
            font-weight: 600;
        }
        
        .status-pending {
            background: var(--beige-sable);
            color: var(--gris-texte);
        }
        
        .status-completed {
            background: linear-gradient(135deg, #8FAFB1 0%, #C8D0C3 100%);
            color: var(--blanc);
        }
        
        .prompt-output {
            background: var(--blanc);
            padding: 25px;
            border-radius: 10px;
            font-family: 'Courier New', monospace;
            font-size: 0.9em;
            max-height: 500px;
            overflow-y: auto;
            white-space: pre-wrap;
            margin-bottom: 20px;
        }
        
        textarea {
            width: 100%;
            min-height: 200px;
            padding: 15px;
            border-radius: 8px;
            border: 2px solid var(--beige-sable);
            font-family: 'Courier New', monospace;
            font-size: 0.9em;
            resize: vertical;
        }
        
        /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
        /* STATISTICS */
        /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin: 25px 0;
        }
        
        .stat-card {
            background: linear-gradient(135deg, var(--mer), var(--vert-sauge));
            color: var(--blanc);
            padding: 25px;
            border-radius: 12px;
            text-align: center;
        }
        
        .stat-value {
            font-size: 2.5em;
            font-weight: 700;
            margin-bottom: 10px;
        }
        
        .stat-label {
            font-size: 0.9em;
            opacity: 0.95;
        }
        
        /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
        /* FOOTER */
        /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
        
        .footer {
            text-align: center;
            margin-top: 50px;
            padding-top: 30px;
            border-top: 2px solid var(--beige-sable);
            font-size: 11px;
            color: var(--noir);
        }
        
        /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
        /* BATCH PROCESSING */
        /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
        
        .batch-section {
            margin-top: 30px;
        }
        
        .batch-upload {
            background: var(--sable);
            padding: 25px;
            border-radius: 12px;
            border: 2px dashed var(--mer);
            text-align: center;
            margin-bottom: 25px;
        }
        
        .batch-upload input[type="file"] {
            display: none;
        }
        
        .batch-upload-label {
            display: inline-block;
            background: linear-gradient(135deg, var(--mer), var(--vert-sauge));
            color: var(--blanc);
            padding: 15px 30px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: transform 0.3s;
        }
        
        .batch-upload-label:hover {
            transform: scale(1.05);
        }
        
        .batch-queue {
            margin: 25px 0;
        }
        
        .batch-item {
            background: var(--blanc);
            border: 2px solid var(--beige-sable);
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 15px;
            transition: all 0.3s;
        }
        
        .batch-item:hover {
            border-color: var(--mer);
            box-shadow: 0 4px 12px rgba(143, 175, 177, 0.2);
        }
        
        .batch-item-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }
        
        .batch-file-name {
            font-weight: 600;
            color: var(--gris-texte);
            font-size: 1.05em;
            flex: 1;
        }
        
        .batch-file-status {
            display: inline-block;
            padding: 6px 15px;
            border-radius: 20px;
            font-size: 0.9em;
            font-weight: 600;
            margin: 0 10px;
        }
        
        .status-queued {
            background: var(--sable);
            color: var(--gris-secondaire);
        }
        
        .status-extracting {
            background: #FFE5B4;
            color: #8B4513;
        }
        
        .status-analyzing {
            background: #B4D7FF;
            color: #003366;
        }
        
        .status-generating {
            background: #D4EDDA;
            color: #155724;
        }
        
        .status-completed {
            background: var(--vert-sauge);
            color: #2C5F2D;
        }
        
        .status-error {
            background: #F8D7DA;
            color: #721C24;
        }
        
        .batch-remove-btn {
            background: transparent;
            border: none;
            color: var(--gris-secondaire);
            font-size: 1.5em;
            cursor: pointer;
            padding: 5px 10px;
            transition: color 0.3s;
        }
        
        .batch-remove-btn:hover {
            color: #DC3545;
        }
        
        .batch-progress-bar {
            width: 100%;
            height: 8px;
            background: var(--sable);
            border-radius: 4px;
            overflow: hidden;
            margin-bottom: 10px;
        }
        
        .batch-progress-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--mer), var(--vert-sauge));
            border-radius: 4px;
            transition: width 0.5s ease;
        }
        
        .batch-progress-message {
            font-size: 0.9em;
            color: var(--gris-secondaire);
            font-style: italic;
        }
        
        .batch-error-message {
            background: #F8D7DA;
            color: #721C24;
            padding: 12px;
            border-radius: 8px;
            margin-top: 10px;
            font-size: 0.9em;
            border-left: 4px solid #DC3545;
        }
        
        .batch-controls {
            display: flex;
            gap: 15px;
            justify-content: center;
            margin: 30px 0;
            flex-wrap: wrap;
        }
        
        .batch-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin: 25px 0;
        }
        
        .batch-stat {
            background: linear-gradient(135deg, var(--sable), var(--beige-sable));
            padding: 20px;
            border-radius: 10px;
            text-align: center;
            border-left: 4px solid var(--mer);
        }
        
        .batch-stat-value {
            font-size: 2em;
            font-weight: 700;
            color: var(--mer);
            margin-bottom: 5px;
        }
        
        .batch-stat-label {
            font-size: 0.9em;
            color: var(--gris-secondaire);
            font-weight: 500;
        }
        
        .batch-templates {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }
        
        .batch-template-card {
            background: var(--blanc);
            border: 2px solid var(--beige-sable);
            border-radius: 10px;
            padding: 20px;
            cursor: pointer;
            transition: all 0.3s;
            text-align: center;
        }
        
        .batch-template-card:hover {
            border-color: var(--mer);
            transform: translateY(-5px);
            box-shadow: 0 6px 20px rgba(143, 175, 177, 0.3);
        }
        
        .batch-template-card h5 {
            color: var(--mer);
            margin-bottom: 10px;
            font-size: 1.1em;
        }
        
        .batch-template-card p {
            font-size: 0.9em;
            color: var(--gris-secondaire);
            margin-bottom: 10px;
        }
        
        .batch-config-section {
            background: var(--sable);
            padding: 20px;
            border-radius: 10px;
            margin: 20px 0;
        }

        /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
           V6.3.0 - SECTION SÃ‰CURITÃ‰
           â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
        .security-warning {
            background: linear-gradient(135deg, #E6D7C3 0%, #D8CDBB 100%);
            border: 2px solid #C8D0C3;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
            display: none;
        }
        .security-warning.visible {
            display: block;
        }
        .security-warning h4 {
            color: #8FAFB1;
            margin: 0 0 15px 0;
            font-size: 16px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .security-warning-content {
            color: #5a5a5a;
            line-height: 1.6;
            margin-bottom: 15px;
        }
        .security-warning-content ul {
            margin: 10px 0;
            padding-left: 20px;
        }
        .security-warning-content li {
            margin: 5px 0;
        }
        .security-warning-highlight {
            background: #fff3e0;
            border-left: 3px solid #ff9800;
            padding: 10px;
            margin: 10px 0;
            font-weight: 500;
        }
        .security-warning-actions {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }
        .security-btn {
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.3s ease;
        }
        .security-btn-primary {
            background: var(--vert-sauge);
            color: white;
        }
        .security-btn-primary:hover {
            background: #7fa582;
        }
        .security-btn-secondary {
            background: white;
            color: var(--gris-secondaire);
            border: 1px solid var(--gris-clair);
        }
        .security-btn-secondary:hover {
            background: var(--beige-sable);
        }
        /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
        
        .batch-config-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 15px;
        }
        
        .batch-config-item {
            display: flex;
            flex-direction: column;
        }
        
        .batch-config-item label {
            font-weight: 600;
            color: var(--gris-texte);
            margin-bottom: 8px;
            font-size: 0.95em;
        }
        
        .batch-config-item select,
        .batch-config-item input[type="number"] {
            padding: 10px;
            border: 2px solid var(--beige-sable);
            border-radius: 8px;
            font-family: Montserrat;
            font-size: 0.95em;
        }
        
        .batch-config-item input[type="checkbox"] {
            width: 20px;
            height: 20px;
            cursor: pointer;
        }
        
        .batch-empty {
            text-align: center;
            padding: 60px 20px;
            color: var(--gris-secondaire);
        }
        
        .batch-empty-icon {
            font-size: 4em;
            margin-bottom: 20px;
            opacity: 0.3;
        }
        
        /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
        /* EXPORT FORMATS */
        /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
        
        .export-section {
            margin-top: 30px;
        }
        
        .export-formats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin: 25px 0;
        }
        
        .export-format-card {
            background: var(--blanc);
            border: 2px solid var(--beige-sable);
            border-radius: 12px;
            padding: 20px;
            cursor: pointer;
            transition: all 0.3s;
            text-align: center;
            position: relative;
        }
        
        .export-format-card:hover {
            border-color: var(--mer);
            transform: translateY(-5px);
            box-shadow: 0 6px 20px rgba(143, 175, 177, 0.3);
        }
        
        .export-format-card.disabled {
            opacity: 0.5;
            cursor: not-allowed;
            pointer-events: none;
        }
        
        /* V6.3.0 - Organisation Exports Basiques/AvancÃ©s */
        .export-section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin: 20px 0 15px 0;
            padding-bottom: 10px;
            border-bottom: 2px solid var(--beige-sable);
        }
        .export-section-title {
            font-size: 1.2em;
            font-weight: 600;
            color: var(--vert-sauge);
        }
        .export-toggle-btn {
            background: var(--beige-sable);
            border: 1px solid var(--gris-clair);
            padding: 8px 16px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 0.9em;
            transition: all 0.3s ease;
        }
        .export-toggle-btn:hover {
            background: var(--vert-sauge);
            color: white;
        }
        .export-advanced-section {
            display: none;
        }
        .export-advanced-section.visible {
            display: block;
        }
        
        .export-format-icon {
            font-size: 2.5em;
            margin-bottom: 10px;
        }
        
        .export-format-name {
            font-weight: 600;
            color: var(--mer);
            margin-bottom: 8px;
            font-size: 1.1em;
        }
        
        .export-format-desc {
            font-size: 0.85em;
            color: var(--gris-secondaire);
            line-height: 1.4;
        }
        
        .export-format-badge {
            display: inline-block;
            background: var(--vert-sauge);
            color: var(--gris-texte);
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 0.75em;
            font-weight: 600;
            margin-top: 8px;
        }
        
        .export-options {
            background: var(--sable);
            padding: 20px;
            border-radius: 10px;
            margin: 20px 0;
        }
        
        .export-option-row {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 15px;
            padding-bottom: 15px;
            border-bottom: 1px solid var(--beige-sable);
        }
        
        .export-option-row:last-child {
            border-bottom: none;
            margin-bottom: 0;
            padding-bottom: 0;
        }
        
        .export-option-label {
            font-weight: 500;
            color: var(--gris-texte);
            flex: 1;
        }
        
        .export-option-control {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .export-option-control input[type="checkbox"] {
            width: 20px;
            height: 20px;
            cursor: pointer;
        }
        
        .export-option-control select {
            padding: 8px 12px;
            border: 2px solid var(--beige-sable);
            border-radius: 8px;
            font-family: Montserrat;
            font-size: 0.9em;
        }
        
        .export-preview {
            background: var(--blanc);
            border: 2px solid var(--beige-sable);
            border-radius: 10px;
            padding: 20px;
            margin: 20px 0;
            font-family: 'Courier New', monospace;
            font-size: 0.9em;
            max-height: 400px;
            overflow-y: auto;
        }
        
        .export-preview-header {
            font-weight: 600;
            color: var(--mer);
            margin-bottom: 15px;
            font-family: Montserrat;
        }
        
        .export-buttons {
            display: flex;
            gap: 15px;
            justify-content: center;
            margin: 25px 0;
            flex-wrap: wrap;
        }
        
        .export-all-btn {
            background: linear-gradient(135deg, var(--mer), var(--vert-sauge));
            color: var(--blanc);
            padding: 15px 40px;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            font-size: 1.1em;
            cursor: pointer;
            transition: transform 0.3s;
        }
        
        .export-all-btn:hover {
            transform: scale(1.05);
        }
        
        .export-all-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
        /* RESPONSIVE */
        /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
        
        @media (max-width: 768px) {
            .container {
                padding: 20px;
            }
            
            h1 {
                font-size: 1.8em;
            }
            
            h2 {
                font-size: 1.5em;
            }
            
            .config-grid {
                grid-template-columns: 1fr;
            }
            
            .platform-selector {
                grid-template-columns: 1fr;
            }
            
            .slider-item {
                grid-template-columns: 1fr;
            }
            
            .format-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }
        
        /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
        /* API V6.0 - MODAL & STRATEGIES */
        /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
        
        #promptModal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.7);
            z-index: 10000;
            overflow-y: auto;
            padding: 20px;
        }
        
        .modal-content {
            background: white;
            max-width: 1200px;
            margin: 20px auto;
            border-radius: 16px;
            padding: 40px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
        }
        
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 2px solid var(--vert-sauge);
        }
        
        .modal-close {
            font-size: 32px;
            cursor: pointer;
            color: var(--gris-secondaire);
            transition: color 0.2s;
        }
        
        .modal-close:hover {
            color: var(--mer);
        }
        
        .strategies-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .strategy-card {
            padding: 25px;
            border: 2px solid var(--vert-sauge);
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.3s;
            background: linear-gradient(135deg, var(--blanc) 0%, var(--sable) 100%);
        }
        
        .strategy-card:hover {
            border-color: var(--mer);
            transform: translateY(-3px);
            box-shadow: 0 8px 20px rgba(143, 175, 177, 0.3);
        }
        
        .strategy-card.selected {
            border-color: var(--mer);
            background: linear-gradient(135deg, #E8F5F9 0%, var(--vert-sauge) 100%);
        }
        
        .strategy-card h4 {
            margin-bottom: 10px;
            color: var(--mer);
        }
        
        .strategy-content {
            display: none;
            margin-top: 30px;
            padding: 25px;
            background: #f8f9fa;
            border-radius: 12px;
        }
        
        .strategy-content.active {
            display: block;
        }
        
        /* API Configuration Panel */
        .api-config-panel {
            background: white;
            padding: 25px;
            border-radius: 12px;
            border: 2px solid var(--vert-sauge);
            margin-top: 20px;
        }
        
        .api-mode-switch {
            display: flex;
            gap: 20px;
            margin-bottom: 20px;
            padding: 15px;
            background: #e8f4f8;
            border-radius: 8px;
        }
        
        .api-mode-switch label {
            display: flex;
            align-items: center;
            gap: 10px;
            cursor: pointer;
            padding: 10px 15px;
            border-radius: 6px;
            transition: background 0.2s;
        }
        
        .api-mode-switch label:hover {
            background: rgba(255,255,255,0.7);
        }
        
        .api-mode-switch input[type="radio"]:checked + span {
            font-weight: 600;
            color: var(--mer);
        }
        
        .user-keys-panel {
            background: #fff3cd;
            padding: 20px;
            border-radius: 8px;
            margin-top: 15px;
            border: 2px solid #ffc107;
        }
        
        .key-input-group {
            margin-bottom: 15px;
        }
        
        .key-input-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
            color: var(--gris-texte);
        }
        
        .key-input-group input {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-family: monospace;
        }
        
        .model-selector {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-top: 15px;
        }
        
        .model-selector select {
            padding: 10px;
            border: 1px solid var(--vert-sauge);
            border-radius: 6px;
            font-family: 'Montserrat', sans-serif;
        }
        
        .api-params {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-top: 15px;
        }
        
        .cost-estimate {
            background: #e8f5e9;
            padding: 15px;
            border-radius: 8px;
            margin-top: 15px;
            text-align: center;
        }
        
        .cost-estimate strong {
            color: #2e7d32;
            font-size: 1.2em;
        }
        
        /* API Result Modal */
        #apiResultModal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.7);
            z-index: 10001;
            overflow-y: auto;
            padding: 20px;
        }
        
        .api-result-content {
            background: white;
            max-width: 1000px;
            margin: 20px auto;
            border-radius: 16px;
            padding: 40px;
        }
        
        .result-metadata {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 15px;
            margin-bottom: 25px;
        }
        
        .metadata-item {
            text-align: center;
            padding: 15px;
            background: var(--sable);
            border-radius: 8px;
        }
        
        .metadata-value {
            font-size: 1.5em;
            font-weight: 700;
            color: var(--mer);
        }
        
        .metadata-label {
            font-size: 0.9em;
            color: var(--gris-secondaire);
            margin-top: 5px;
        }
        
        .json-display {
            background: #1e1e1e;
            color: #d4d4d4;
            padding: 20px;
            border-radius: 8px;
            overflow-x: auto;
            font-family: 'Courier New', monospace;
            max-height: 500px;
            overflow-y: auto;
        }
        
        .result-actions {
            display: flex;
            gap: 15px;
            margin-top: 25px;
        }
        
        /* Progress Bar */
        .api-progress {
            margin-top: 20px;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 8px;
            display: none;
        }
        
        /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
        /* 3 MODES INTERFACE */
        /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
        
        .mode-section {
            margin-bottom: 20px;
            border: 2px solid transparent;
            border-radius: 12px;
            overflow: hidden;
            transition: all 0.3s ease;
        }
        
        .mode-section.active {
            border-color: var(--mer);
            box-shadow: 0 4px 12px rgba(143, 175, 177, 0.2);
        }
        
        .mode-header {
            background: linear-gradient(135deg, var(--vert-sauge), var(--beige-sable));
            padding: 20px;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: all 0.3s ease;
        }
        
        .mode-header:hover {
            background: linear-gradient(135deg, var(--mer), var(--vert-sauge));
        }
        
        .mode-section.active .mode-header {
            background: linear-gradient(135deg, var(--mer), var(--vert-sauge));
        }
        
        .mode-header h3 {
            margin: 0;
            color: var(--gris-texte);
            font-size: 1.3em;
        }
        
        .mode-badge {
            background: white;
            color: var(--mer);
            padding: 6px 16px;
            border-radius: 20px;
            font-size: 0.85em;
            font-weight: 600;
        }
        
        .mode-badge-premium {
            background: linear-gradient(135deg, #8FAFB1 0%, #C8D0C3 100%);
            color: white;
        }
        
        .mode-badge-free {
            background: linear-gradient(135deg, #8FAFB1 0%, #C8D0C3 100%);
            color: white;
        }
        
        .mode-content {
            padding: 25px;
            background: white;
        }
        
        .mode-actions {
            display: flex;
            gap: 15px;
            margin-top: 20px;
            flex-wrap: wrap;
        }
        
        .mode-actions .btn {
            flex: 1;
            min-width: 200px;
        }
        
        .api-config-box {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 8px;
            margin-top: 15px;
        }
        
        .key-input-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-bottom: 15px;
        }
        
        .key-input-row:last-child {
            grid-template-columns: auto 1fr auto;
        }
        
        .api-params-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-top: 15px;
        }
        
        .cost-display {
            background: #e8f5e9;
            padding: 12px;
            border-radius: 6px;
            margin-top: 15px;
            text-align: center;
            font-size: 1.1em;
        }
        
        .worker-info {
            background: #fff3cd;
            border-left: 4px solid #ffc107;
            padding: 15px;
            border-radius: 6px;
            margin-bottom: 20px;
        }
        
        .worker-toggle {
            display: flex;
            align-items: center;
            gap: 15px;
            padding: 15px;
            background: linear-gradient(135deg, #E6D7C3 0%, #D8CDBB 100%);
            border-radius: 8px;
            border-left: 4px solid #8FAFB1;
        }
        
        .toggle-switch {
            position: relative;
            display: inline-block;
            width: 60px;
            height: 34px;
        }
        
        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }
        
        .toggle-slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            transition: 0.4s;
            border-radius: 34px;
        }
        
        .toggle-slider:before {
            position: absolute;
            content: "";
            height: 26px;
            width: 26px;
            left: 4px;
            bottom: 4px;
            background-color: white;
            transition: 0.4s;
            border-radius: 50%;
        }
        
        input:checked + .toggle-slider {
            background-color: var(--mer);
        }
        
        input:checked + .toggle-slider:before {
            transform: translateX(26px);
        }
        
        #workerStatus {
            font-weight: 600;
            color: var(--gris-texte);
        }
        }
        
        .api-progress.active {
            display: block;
        }
        
        .progress-bar {
            width: 100%;
            height: 30px;
            background: #e9ecef;
            border-radius: 15px;
            overflow: hidden;
            margin-top: 10px;
        }
        
        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--mer), var(--vert-sauge));
            transition: width 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 600;
        }
        
        /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
        /* MODE SELECTION CARDS */
        /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
        
        .mode-selection-section {
            background: linear-gradient(135deg, rgba(143, 175, 177, 0.1), rgba(208, 194, 173, 0.1));
            padding: 30px;
            border-radius: 16px;
            margin-bottom: 30px;
        }
        
        .mode-cards-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 20px;
        }
        
        .mode-card {
            background: white;
            border: 3px solid var(--beige-sable);
            border-radius: 16px;
            padding: 0;
            cursor: pointer;
            transition: all 0.3s ease;
            overflow: hidden;
        }
        
        .mode-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.15);
        }
        
        .mode-card-active {
            border-color: var(--mer);
            box-shadow: 0 6px 16px rgba(143, 175, 177, 0.3);
        }
        
        .mode-card-active .mode-card-header {
            background: linear-gradient(135deg, var(--mer), var(--vert-sauge));
        }
        
        .mode-card-header {
            background: linear-gradient(135deg, var(--vert-sauge), var(--beige-sable));
            padding: 20px;
            text-align: center;
            transition: all 0.3s ease;
        }
        
        .mode-card-icon {
            font-size: 48px;
            margin-bottom: 10px;
        }
        
        .mode-card-header h3 {
            margin: 10px 0;
            color: var(--noir-principal);
            font-size: 18px;
        }
        
        .mode-card-active .mode-card-header h3 {
            color: white;
        }
        
        .mode-card-badge {
            display: inline-block;
            padding: 6px 16px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 700;
            margin-top: 8px;
        }
        
        .mode-badge-default {
            background: white;
            color: var(--mer);
        }
        
        .mode-badge-premium {
            background: linear-gradient(135deg, #8FAFB1 0%, #C8D0C3 100%);
            color: white;
        }
        
        .mode-badge-free {
            background: linear-gradient(135deg, #8FAFB1 0%, #C8D0C3 100%);
            color: white;
        }
        
        .mode-card-content {
            padding: 20px;
        }
        
        .mode-card-content p {
            color: var(--noir-principal);
            margin-bottom: 15px;
        }
        
        .mode-card-content ul {
            list-style: none;
            padding: 0;
            margin: 0;
        }
        
        .mode-card-content ul li {
            padding: 8px 0;
            color: var(--gris-secondaire);
            font-size: 14px;
        }
        
        .mode-card-config {
            margin-top: 15px;
            padding-top: 15px;
            border-top: 2px solid var(--beige-sable);
        }
        
        .toggle-switch {
            position: relative;
            display: inline-block;
            width: 60px;
            height: 34px;
        }
        
        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }
        
        .toggle-slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            transition: 0.4s;
            border-radius: 34px;
        }
        
        .toggle-slider:before {
            position: absolute;
            content: "";
            height: 26px;
            width: 26px;
            left: 4px;
            bottom: 4px;
            background-color: white;
            transition: 0.4s;
            border-radius: 50%;
        }
        
        .toggle-switch input:checked + .toggle-slider {
            background-color: var(--mer);
        }
        
        .toggle-switch input:checked + .toggle-slider:before {
            transform: translateX(26px);
        }
        
        /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
        /* PROVIDER ACCORDION SYSTEM */
        /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
        
        .provider-accordion {
            background: white;
            border: 2px solid var(--beige-sable);
            border-radius: 8px;
            margin-bottom: 12px;
            overflow: hidden;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        .provider-accordion:hover {
            box-shadow: 0 3px 10px rgba(0,0,0,0.08);
        }
        
        .provider-accordion.active {
            border-color: var(--mer);
            box-shadow: 0 4px 12px rgba(143, 175, 177, 0.25);
        }
        
        .accordion-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 18px;
            cursor: pointer;
            transition: background 0.2s ease;
        }
        
        .accordion-header:hover {
            background: linear-gradient(135deg, rgba(143, 175, 177, 0.05), rgba(208, 194, 173, 0.05));
        }
        
        .accordion-icon {
            font-size: 1.2em;
            transition: transform 0.3s ease;
            color: var(--gris-secondaire);
        }
        
        .provider-accordion.active .accordion-icon {
            transform: rotate(90deg);
            color: var(--mer);
        }
        
        .accordion-content {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        .provider-accordion.active .accordion-content {
            max-height: 600px;
        }
        
        /* COST ESTIMATOR */
        .cost-estimator {
            background: #F5F5F5;
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
        }
        
        .cost-item {
            display: flex;
            justify-content: space-between;
            padding: 6px 0;
            font-size: 0.9em;
        }
        
        .cost-total {
            display: flex;
            justify-content: space-between;
            padding: 10px 0;
            border-top: 2px solid var(--beige-sable);
            margin-top: 10px;
        }
        
        /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
        /* TABS MODERNES POUR LES MODES */
        /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
        
        /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
        /* MODE RADIOS - MINIMALISTE */
        /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
        
        .mode-radios {
            display: flex;
            gap: 12px;
            margin: 15px 0 20px 0;
            justify-content: center;
            max-width: 600px;
            margin-left: auto;
            margin-right: auto;
        }
        
        .mode-radio {
            display: flex;
            align-items: center;
            gap: 8px;
            cursor: pointer;
            padding: 10px 15px;
            border: 1px solid #C8D0C3;  /* CHARTE: vert pÃ¢le */
            border-radius: 6px;
            transition: all 0.2s ease;
            background: white;
            flex: 1;  /* Largeur Ã©gale */
            justify-content: center;
            min-width: 0;
            max-width: 120px;  /* âœ¨ LARGEUR MAX pour harmoniser */
        }
        
        .mode-radio:hover {
            border-color: #8FAFB1;  /* CHARTE: bleu-vert */
            background: #E6D7C3;  /* CHARTE: beige clair */
        }
        
        .mode-radio input[type="radio"] {
            width: 16px;
            height: 16px;
            cursor: pointer;
            accent-color: #8FAFB1;  /* CHARTE: couleur du radio */
            flex-shrink: 0;  /* âœ¨ Ne pas rÃ©trÃ©cir */
        }
        
        .mode-radio input[type="radio"]:checked + span {
            font-weight: 600;
            color: #8FAFB1;  /* CHARTE */
        }
        
        .mode-radio span {
            font-size: 0.85em;
            color: #333;
            white-space: nowrap;
            overflow: hidden;  /* âœ¨ EmpÃªcher dÃ©bordement */
            text-overflow: ellipsis;  /* âœ¨ Points de suspension si trop long */
        }
        
        /* PANELS MINIMALISTES */
        .mode-panels {
            margin-top: 15px;
            max-width: 600px;  /* âœ¨ LARGEUR RÃ‰DUITE */
            margin-left: auto;
            margin-right: auto;
        }
        
        .mode-panel {
            display: none;
        }
        
        .mode-panel.active {
            display: block;
        }
        
        /* PROVIDER MINI ACCORDIONS */
        .provider-mini {
            background: white;
            border: 1px solid #C8D0C3;  /* CHARTE: vert pÃ¢le */
            border-radius: 6px;
            margin-bottom: 8px;
            transition: all 0.2s ease;
            position: relative;  /* Pour la croix */
        }
        
        .provider-mini:hover {
            border-color: #8FAFB1;  /* CHARTE: bleu-vert */
            box-shadow: 0 2px 6px rgba(143, 175, 177, 0.2);  /* CHARTE: shadow avec primaire */
        }
        
        .provider-mini-header {
            padding: 10px 12px;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 0.9em;
            user-select: none;
        }
        
        .provider-mini-header:hover {
            background: #E6D7C3;  /* CHARTE: beige clair */
        }
        
        /* CROIX DE FERMETURE */
        .mini-close {
            position: absolute;
            top: 8px;
            right: 8px;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: #E6D7C3;  /* CHARTE */
            color: #8FAFB1;  /* CHARTE */
            border: 1px solid #C8D0C3;  /* CHARTE */
            display: none;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-size: 0.8em;
            font-weight: 600;
            z-index: 10;
            transition: all 0.2s ease;
        }
        
        .mini-close:hover {
            background: #8FAFB1;  /* CHARTE */
            color: white;
            transform: rotate(90deg);
        }
        
        .provider-mini.active .mini-close {
            display: flex;
        }
        
        .mini-arrow {
            font-size: 0.8em;
            color: #999;
            transition: transform 0.2s ease;
        }
        
        .provider-mini.active .mini-arrow {
            transform: rotate(90deg);
            color: #8FAFB1;  /* CHARTE */
        }
        
        .provider-mini-body {
            display: none;
            padding: 0 12px 12px 12px;
            border-top: 1px solid #E6D7C3;  /* CHARTE: beige clair */
            animation: slideDown 0.2s ease;
        }
        
        .provider-mini.active .provider-mini-body {
            display: block;
        }
        
        @keyframes slideDown {
            from { opacity: 0; max-height: 0; }
            to { opacity: 1; max-height: 200px; }
        }
        
        /* CONFIRMATION SAUVEGARDE */
        .save-confirmed {
            background: #8FAFB1 !important;  /* CHARTE: vert-bleu */
            color: white !important;
            pointer-events: none;
        }
        
        .save-confirmed::after {
            content: " âœ“";
            margin-left: 5px;
        }

        
        /* SMOOTH SCROLL GLOBAL */
        html {
            scroll-behavior: smooth;
        }
        
        /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
        /* API QUICK ACTIONS */
        /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
        
        .api-quick-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }
        
        .api-quick-card {
            background: white;
            border: 2px solid var(--beige-sable);
            border-radius: 12px;
            padding: 20px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .api-quick-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 16px rgba(0,0,0,0.15);
            border-color: var(--mer);
        }
        
        .api-quick-icon {
            font-size: 3em;
            margin-bottom: 10px;
        }
        
        .api-quick-card h4 {
            margin: 10px 0 5px 0;
            color: var(--noir-principal);
        }
        
        .api-quick-card p {
            font-size: 0.9em;
            color: var(--gris-secondaire);
            margin-bottom: 15px;
        }
        
        .api-quick-badge {
            display: inline-block;
            padding: 8px 16px;
            background: var(--mer);
            color: white;
            border-radius: 20px;
            font-weight: 600;
            font-size: 0.9em;
        }
        
        /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
        /* TABS MODERNES */
        /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
        
        .mode-tabs-container {
            background: white;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            overflow: hidden;
            margin-bottom: 30px;
        }
        
        .mode-tabs-header {
            display: flex;
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            border-bottom: 2px solid var(--beige-sable);
        }
        
        .mode-tab {
            flex: 1;
            padding: 18px 20px;
            text-align: center;
            cursor: pointer;
            border: none;
            background: transparent;
            transition: all 0.3s ease;
            position: relative;
            font-weight: 500;
            color: var(--gris-secondaire);
            border-right: 1px solid rgba(0,0,0,0.05);
        }
        
        .mode-tab:last-child {
            border-right: none;
        }
        
        .mode-tab:hover:not(.mode-tab-active) {
            background: rgba(255,255,255,0.5);
            color: var(--noir-principal);
        }
        
        .mode-tab-active {
            background: white;
            color: var(--mer);
            font-weight: 700;
        }
        
        .mode-tab-active::after {
            content: '';
            position: absolute;
            bottom: -2px;
            left: 0;
            right: 0;
            height: 3px;
            background: linear-gradient(90deg, var(--mer), var(--violet-profond));
        }
        
        .mode-tab-icon {
            font-size: 1.5em;
            display: block;
            margin-bottom: 5px;
        }
        
        .mode-tab-badge {
            display: inline-block;
            margin-left: 8px;
            padding: 3px 8px;
            border-radius: 12px;
            font-size: 0.7em;
            font-weight: 600;
        }
        
        .mode-tab-badge-default {
            background: #E3F2FD;
            color: #1976D2;
        }
        
        .mode-tab-badge-premium {
            background: linear-gradient(135deg, #8FAFB1 0%, #C8D0C3 100%);
            color: white;
        }
        
        .mode-tab-badge-free {
            background: linear-gradient(135deg, #E6D7C3 0%, #D8CDBB 100%);
            color: #8FAFB1;
        }
        
        .mode-tabs-content {
            padding: 25px;
            min-height: 300px;
            max-height: 700px;
            overflow-y: auto;
            scroll-behavior: smooth;
        }
        
        .mode-tab-panel {
            display: none;
            animation: fadeIn 0.4s ease;
        }
        
        .mode-tab-panel-active {
            display: block;
        }
        
        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
        /* SMOOTH SCROLL GLOBAL */
        /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
        
        html {
            scroll-behavior: smooth;
        }
        
        .scroll-highlight {
            animation: highlightPulse 2s ease;
        }
        
        @keyframes highlightPulse {
            0%, 100% {
                box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            }
            50% {
                box-shadow: 0 0 20px rgba(82, 143, 173, 0.6),
                            0 0 40px rgba(82, 143, 173, 0.3);
            }
        }
        
        @keyframes pulse {
            0%, 100% {
                transform: scale(1);
                box-shadow: 0 2px 8px rgba(76, 175, 80, 0.3);
            }
            50% {
                transform: scale(1.05);
                box-shadow: 0 4px 20px rgba(76, 175, 80, 0.6);
            }
        }
        
        /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
        /* TABS MODERNES */
        /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
        
        .mode-tabs-header {
            display: flex;
            gap: 0;
            border-bottom: 3px solid var(--beige-sable);
            margin-bottom: 30px;
            background: linear-gradient(180deg, #ffffff, #f8f9fa);
            border-radius: 12px 12px 0 0;
            overflow: hidden;
        }
        
        .mode-tab {
            flex: 1;
            padding: 20px 15px;
            background: transparent;
            border: none;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 12px;
            font-size: 14px;
            font-weight: 500;
            color: #666;
        }
        
        .mode-tab::after {
            content: '';
            position: absolute;
            bottom: -3px;
            left: 0;
            right: 0;
            height: 3px;
            background: var(--violet-profond);
            transform: scaleX(0);
            transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        .mode-tab:hover {
            background: rgba(139, 92, 246, 0.05);
            color: var(--noir-principal);
        }
        
        .mode-tab-active {
            color: var(--violet-profond);
            font-weight: 600;
            background: rgba(139, 92, 246, 0.08);
        }
        
        .mode-tab-active::after {
            transform: scaleX(1);
        }
        
        .mode-tab-icon {
            font-size: 24px;
            display: block;
        }
        
        .mode-tab > div {
            display: flex;
            flex-direction: column;
            align-items: flex-start;
            gap: 4px;
            line-height: 1.2;
        }
        
        .mode-tab-badge {
            font-size: 10px;
            font-weight: 600;
            padding: 3px 8px;
            border-radius: 12px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .mode-tab-badge-default {
            background: linear-gradient(135deg, #E3F2FD, #BBDEFB);
            color: #1976D2;
        }
        
        .mode-tab-badge-premium {
            background: linear-gradient(135deg, #F3E5F5, #E1BEE7);
            color: #7B1FA2;
        }
        
        .mode-tab-badge-free {
            background: linear-gradient(135deg, #E6D7C3 0%, #D8CDBB 100%);
            color: #8FAFB1;
        }
        
        .mode-tabs-content {
            position: relative;
            min-height: 300px;
        }
        
        .mode-tab-panel {
            display: none;
            animation: fadeIn 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        .mode-tab-panel-active {
            display: block;
        }
        
        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        /* Highlight temporaire aprÃ¨s scroll */
        @keyframes highlightPulse {
            0%, 100% {
                box-shadow: 0 0 0 0 rgba(139, 92, 246, 0);
            }
            50% {
                box-shadow: 0 0 0 8px rgba(139, 92, 246, 0.2);
            }
        }
        
        .highlight-element {
            animation: highlightPulse 1.5s ease-out;
            border: 2px solid var(--violet-profond) !important;
        }
        
        /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
        /* MAX-HEIGHT + SCROLL INTERNE */
        /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
        
        .provider-grid {
            max-height: 400px;
            overflow-y: auto;
            padding-right: 10px;
        }
        
        .provider-grid::-webkit-scrollbar {
            width: 8px;
        }
        
        .provider-grid::-webkit-scrollbar-track {
            background: var(--beige-sable);
            border-radius: 4px;
        }
        
        .provider-grid::-webkit-scrollbar-thumb {
            background: var(--mer);
            border-radius: 4px;
        }
        
        .provider-grid::-webkit-scrollbar-thumb:hover {
            background: var(--violet-profond);
        }
        
        #batchList {
            max-height: 500px;
            overflow-y: auto;
        }
        
        #batchList::-webkit-scrollbar {
            width: 8px;
        }
        
        #batchList::-webkit-scrollbar-track {
            background: var(--beige-sable);
            border-radius: 4px;
        }
        
        #batchList::-webkit-scrollbar-thumb {
            background: var(--mer);
            border-radius: 4px;
        }
        
        /* Sections avec beaucoup de contenu */
        .mode-card-config,
        .provider-config,
        .api-quick-section {
            max-height: 600px;
            overflow-y: auto;
            padding-right: 10px;
        }
        
        .mode-card-config::-webkit-scrollbar,
        .provider-config::-webkit-scrollbar,
        .api-quick-section::-webkit-scrollbar {
            width: 8px;
        }
        
        .mode-card-config::-webkit-scrollbar-track,
        .provider-config::-webkit-scrollbar-track,
        .api-quick-section::-webkit-scrollbar-track {
            background: var(--beige-sable);
            border-radius: 4px;
        }
        
        .mode-card-config::-webkit-scrollbar-thumb,
        .provider-config::-webkit-scrollbar-thumb,
        .api-quick-section::-webkit-scrollbar-thumb {
            background: var(--mer);
            border-radius: 4px;
        }
        
        .mode-card-config::-webkit-scrollbar-thumb:hover,
        .provider-config::-webkit-scrollbar-thumb:hover,
        .api-quick-section::-webkit-scrollbar-thumb:hover {
            background: var(--violet-profond);
        }
        
        /* Smooth scroll pour toute la page */
        html {
            scroll-behavior: smooth;
        }
        
        /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
        /* RESPONSIVE */
        /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
        
        @media (max-width: 768px) {
            .mode-cards-grid {
                grid-template-columns: 1fr;
            }
            
            .strategies-grid {
                grid-template-columns: 1fr;
            }
            
            .model-selector {
                grid-template-columns: 1fr;
            }
            
            .api-params {
                grid-template-columns: 1fr;
            }
            
            .result-metadata {
                grid-template-columns: repeat(2, 1fr);
            }
        }
        
        /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
        /* ANIMATIONS SMOOTH & TRANSITIONS OPTIMISÃ‰ES */
        /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
        
        /* Animation pour Ã©lÃ©ments qui apparaissent/disparaissent */
        #providerConfig,
        #apiQuickActions,
        #workerActivePanel {
            animation: slideDown 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        @keyframes slideDown {
            from {
                opacity: 0;
                transform: translateY(-8px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        /* Smooth scroll highlight subtil */
        .scroll-highlight {
            animation: pulseHighlight 1.2s ease;
        }
        
        @keyframes pulseHighlight {
            0%, 100% {
                box-shadow: inherit;
            }
            50% {
                box-shadow: 0 0 0 6px rgba(143, 175, 177, 0.25);
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
        <!-- HEADER -->
        <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
        <div class="header">
            <h1>OCR Universel V6.7.0 KB ENGINE</h1>
            <span class="version-badge">Multi-LLM ParallÃ¨le â€¢ Worker 4x â€¢ Production Ready â€¢ C Concept&Dev</span>
            <p class="subtitle">
                21 formats supportÃ©s â€¢ Mode ENSEMBLE intelligent â€¢ 4 Workers Cloudflare â€¢ API Multi-Provider â€¢ Production Ready
            </p>
        </div>

        <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
        <!-- MODE DE TRAITEMENT -->
        <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
        <div class="section mode-selection-section" id="modeSelectionSection">
            <h2 style="font-size:1.4em;margin-bottom:15px;color:#8FAFB1;">Mode</h2>
            
            <!-- RADIO BUTTONS MINIMALISTES -->
            <div class="mode-radios">
                <label class="mode-radio">
                    <input type="radio" name="mode" value="manual" checked onchange="switchMode('manual')">
                    <span>Manuel</span>
                </label>
                <label class="mode-radio">
                    <input type="radio" name="mode" value="user-keys" onchange="switchMode('user-keys')">
                    <span>API Multi-LLM</span>
                </label>
                <label class="mode-radio">
                    <input type="radio" name="mode" value="ensemble" onchange="switchMode('ensemble')">
                    <span>ENSEMBLE</span>
                </label>
                <label class="mode-radio">
                    <input type="radio" name="mode" value="worker" onchange="switchMode('worker')">
                    <span>API Worker</span>
                </label>
                <label class="mode-radio">
                    <input type="radio" name="mode" value="batch" onchange="switchMode('batch')">
                    <span>BATCH</span>
                </label>
            </div>
            
            <!-- PANELS MINIMALISTES -->
            <div class="mode-panels">
                <!-- PANEL MANUEL -->
                <div class="mode-panel active" id="panelManual" data-mode="manual">
                    <p style="margin:10px 0;color:#666;font-size:0.9em;text-align:center;">
                        Uploadez un PDF â†’ Prompt gÃ©nÃ©rÃ© automatiquement
                    </p>
                </div>
                
                <!-- PANEL API Multi-LLM - V14 WORKFLOW INTÃ‰GRÃ‰ (zone upload supprimÃ©e) -->
                <div class="mode-panel" id="panelUserKeys" data-mode="user-keys">
                    
                    <!-- âœ… V14: ACCORDÃ‰ONS CLÃ‰S API MINI (sans Google/Gemini) -->
                    
                    <!-- GROQ -->
                    <div class="provider-mini" data-provider="groq">
                        <button class="mini-close" onclick="event.stopPropagation(); closeMini('groq')" title="Fermer">Ã—</button>
                        <div class="provider-mini-header" onclick="toggleMini('groq')">
                            <span><b>Groq</b> <small style="color:#8FAFB1;">GRATUIT</small></span>
                            <span class="mini-arrow">â–¶</span>
                        </div>
                        <div class="provider-mini-body" id="mini-groq">
                            <select id="model-groq" onchange="updateMiniCost('groq')" style="width:48%;padding:8px;font-size:0.85em;border:1px solid #C8D0C3;border-radius:4px;">
                                <option value="llama-3.3-70b-versatile">Llama 3.3 70B</option>
                                <option value="llama-3.1-70b-versatile">Llama 3.1 70B</option>
                                <option value="mixtral-8x7b-32768">Mixtral 8x7B</option>
                            </select>
                            <input type="password" id="key-groq" placeholder="gsk_..." style="width:48%;padding:8px;font-size:0.85em;border:1px solid #C8D0C3;border-radius:4px;">
                            <button class="save-btn" id="save-groq" onclick="saveMiniKey('groq')" style="width:100%;padding:8px;margin-top:8px;background:#8FAFB1;color:white;border:none;border-radius:4px;cursor:pointer;font-size:0.85em;font-weight:600;">
                                Sauvegarder
                            </button>
                            <div style="margin-top:8px;font-size:0.75em;color:#8FAFB1;font-weight:600;">
                                <span>Gratuit (pas de coÃ»t)</span>
                            </div>
                        </div>
                    </div>

                    <!-- ANTHROPIC -->
                    <div class="provider-mini" data-provider="anthropic">
                        <button class="mini-close" onclick="event.stopPropagation(); closeMini('anthropic')" title="Fermer">Ã—</button>
                        <div class="provider-mini-header" onclick="toggleMini('anthropic')">
                            <span><b>Anthropic</b> <small style="color:#8FAFB1;">$3.00/M</small></span>
                            <span class="mini-arrow">â–¶</span>
                        </div>
                        <div class="provider-mini-body" id="mini-anthropic">
                            <select id="model-anthropic" onchange="updateMiniCost('anthropic')" style="width:48%;padding:8px;font-size:0.85em;border:1px solid #C8D0C3;border-radius:4px;">
                                <option value="claude-sonnet-4-5-20250929">Sonnet 4.5 â­</option>
                                <option value="claude-opus-4-5-20251101">Opus 4.5</option>
                                <option value="claude-haiku-4-5-20251001">Haiku 4.5</option>
                                <option value="claude-sonnet-4-20250514">Sonnet 4</option>
                                <option value="claude-opus-4-1-20250805">Opus 4.1</option>
                            </select>
                            <input type="password" id="key-anthropic" placeholder="sk-ant-..." style="width:48%;padding:8px;font-size:0.85em;border:1px solid #C8D0C3;border-radius:4px;">
                            <button class="save-btn" id="save-anthropic" onclick="saveMiniKey('anthropic')" style="width:100%;padding:8px;margin-top:8px;background:#8FAFB1;color:white;border:none;border-radius:4px;cursor:pointer;font-size:0.85em;font-weight:600;">
                                Sauvegarder
                            </button>
                            <div style="margin-top:8px;font-size:0.75em;color:#666;">
                                <span>CoÃ»t estimÃ©: <b id="cost-anthropic" style="color:#8FAFB1;">$0.2100</b></span>
                            </div>
                        </div>
                    </div>

                    <!-- OPENAI -->
                    <div class="provider-mini" data-provider="openai">
                        <button class="mini-close" onclick="event.stopPropagation(); closeMini('openai')" title="Fermer">Ã—</button>
                        <div class="provider-mini-header" onclick="toggleMini('openai')">
                            <span><b>OpenAI</b> <small style="color:#8FAFB1;">$2.50/M</small></span>
                            <span class="mini-arrow">â–¶</span>
                        </div>
                        <div class="provider-mini-body" id="mini-openai">
                            <select id="model-openai" onchange="updateMiniCost('openai')" style="width:48%;padding:8px;font-size:0.85em;border:1px solid #C8D0C3;border-radius:4px;">
                                <option value="gpt-5.2-pro">GPT-5.2 Pro ğŸ† (Premium Max)</option>
                                <option value="gpt-5.2-pro-2025-12-11">GPT-5.2 Pro 2025-12-11</option>
                                <option value="gpt-5.2">GPT-5.2 â­ (Exceptionnel)</option>
                                <option value="gpt-5.2-chat-latest">GPT-5.2 Chat Latest</option>
                                <option value="gpt-5-pro">GPT-5 Pro ğŸ†</option>
                                <option value="gpt-5-pro-2025-10-06">GPT-5 Pro 2025-10-06</option>
                                <option value="gpt-5" selected>GPT-5 â­ (RecommandÃ©)</option>
                                <option value="gpt-5-chat-latest">GPT-5 Chat Latest</option>
                                <option value="gpt-4.1">GPT-4.1</option>
                                <option value="gpt-4.1-mini">GPT-4.1 Mini</option>
                                <option value="gpt-4.1-nano">GPT-4.1 Nano (Ã‰conomique)</option>
                                <option value="gpt-4o">GPT-4o</option>
                                <option value="gpt-4o-mini">GPT-4o Mini</option>
                                <option value="o1">o1 (Raisonnement)</option>
                            </select>
                            <input type="password" id="key-openai" placeholder="sk-..." style="width:48%;padding:8px;font-size:0.85em;border:1px solid #C8D0C3;border-radius:4px;">
                            <button class="save-btn" id="save-openai" onclick="saveMiniKey('openai')" style="width:100%;padding:8px;margin-top:8px;background:#8FAFB1;color:white;border:none;border-radius:4px;cursor:pointer;font-size:0.85em;font-weight:600;">
                                Sauvegarder
                            </button>
                            <div style="margin-top:8px;font-size:0.75em;color:#666;">
                                <span>CoÃ»t estimÃ©: <b id="cost-openai" style="color:#8FAFB1;">$0.1650</b></span>
                            </div>
                        </div>
                    </div>


                </div>
                
                <!-- PANEL WORKER -->
                <div class="mode-panel" id="panelWorker" data-mode="worker">
                    <!-- TOGGLE -->
                    <div style="padding:12px;background:#E6D7C3;border-left:4px solid #8FAFB1;border-radius:6px;margin-bottom:12px;text-align:center;">
                        <label style="display:flex;align-items:center;justify-content:center;gap:10px;cursor:pointer;">
                            <span style="font-size:0.9em;font-weight:600;">Activer Worker Mode</span>
                            <input type="checkbox" id="workerToggle" onchange="toggleWorkerMode()" style="width:20px;height:20px;">
                        </label>
                    </div>
                    
                    <!-- PANEL ACTIF -->
                    <div id="workerActivePanel" style="display:none;">
                        <!-- SÃ©lecteur de Provider -->
                        <div style="margin-bottom:15px;">
                            <label style="display:block;margin-bottom:5px;font-size:0.9em;font-weight:600;color:#333;">ğŸ”Œ Provider API</label>
                            <select id="workerProvider" onchange="updateWorkerModels()" style="width:100%;padding:12px;border:2px solid #8FAFB1;border-radius:6px;font-size:0.9em;font-family:Montserrat;background:linear-gradient(135deg, #8FAFB1 0%, #C8D0C3 100%);color:white;font-weight:600;">
                                <option value="anthropic">ğŸŒŠ Claude (Anthropic)</option>
                                <option value="openai">ğŸŒŠ ChatGPT (OpenAI)</option>
                                <option value="groq">ğŸŒŠ Groq (Ultra-rapide)</option>
                            </select>
                        </div>
                        
                        <!-- SÃ©lecteur modÃ¨le -->
                        <div style="margin-bottom:15px;">
                            <label style="display:block;margin-bottom:5px;font-size:0.9em;font-weight:600;color:#333;">ğŸ¤– ModÃ¨le</label>
                            <select id="workerModel" style="width:100%;padding:12px;border:2px solid #8FAFB1;border-radius:6px;font-size:0.9em;font-family:Montserrat;background:white;">
                                <option value="claude-sonnet-4-5-20250929">Claude Sonnet 4.5 â­ (RecommandÃ© - Ã‰quilibrÃ©)</option>
                                <option value="claude-opus-4-5-20251101">Claude Opus 4.5 (Premium - QualitÃ© max)</option>
                                <option value="claude-haiku-4-5-20251001">Claude Haiku 4.5 (Rapide - Ã‰conomique)</option>
                                <option value="claude-sonnet-4-20250514">Claude Sonnet 4</option>
                                <option value="claude-opus-4-1-20250805">Claude Opus 4.1</option>
                            </select>
                        </div>
                        
                        <!-- INFO BOX CHARTE C CONCEPT&DEV -->
                        <div style="padding:15px;background:linear-gradient(135deg, #E6D7C3 0%, #D8CDBB 100%);border-radius:8px;border-left:4px solid #8FAFB1;">
                            <h4 style="margin:0 0 10px 0;color:#8FAFB1;font-size:0.95em;">âœ… Worker Mode activÃ©</h4>
                            <ul style="margin:0;padding-left:20px;color:#5a5a5a;font-size:0.85em;">
                                <li>Aucune clÃ© API requise cÃ´tÃ© client</li>
                                <li>Traitement via Cloudflare Worker (gratuit)</li>
                                <li>ClÃ©s sÃ©curisÃ©es cÃ´tÃ© serveur</li>
                            </ul>
                            <p style="margin:15px 0 0 0;padding-top:12px;border-top:1px solid rgba(143, 175, 177, 0.3);color:#8FAFB1;font-size:0.85em;font-weight:600;">
                                ğŸ‘‰ Utilisez maintenant <strong>Batch Processing</strong> ou <strong>Upload Document</strong> normalement
                            </p>
                        </div>
                    </div>
                </div>
                
                <!-- PANEL ENSEMBLE -->
                <div class="mode-panel" id="panelEnsemble" data-mode="ensemble">
                    <div style="padding:15px;background:linear-gradient(135deg, #E6D7C3 0%, #D8CDBB 100%);border-radius:8px;border-left:4px solid #8FAFB1;margin-bottom:15px;">
                        <h4 style="margin:0 0 10px 0;color:#8FAFB1;font-size:1.1em;">âš¡ Mode ENSEMBLE - Multi-LLM ParallÃ¨le</h4>
                        <p style="margin:0;color:#333;font-size:0.9em;line-height:1.6;">
                            Traitement parallÃ¨le intelligent avec 4 providers diffÃ©rents.<br>
                            <strong>60% plus rapide â€¢ 30% moins cher â€¢ 15% meilleure qualitÃ©</strong>
                        </p>
                    </div>
                    
                    <!-- TASK ASSIGNMENTS -->
                    <div style="background:white;padding:15px;border-radius:8px;margin-bottom:15px;border:2px solid #C8D0C3;">
                        <h4 style="margin:0 0 12px 0;font-size:0.95em;color:#333;">RÃ©partition des TÃ¢ches</h4>
                        <div style="display:grid;gap:10px;">
                            <div style="display:flex;justify-content:space-between;align-items:center;padding:8px;background:#E6D7C3;border-radius:6px;">
                                <span style="font-size:0.85em;font-weight:600;">Structure</span>
                                <span style="font-size:0.75em;color:#666;">Groq â†’ Haiku 4.5 â†’ Claude</span>
                            </div>
                            <div style="display:flex;justify-content:space-between;align-items:center;padding:8px;background:#E6D7C3;border-radius:6px;">
                                <span style="font-size:0.85em;font-weight:600;">Concepts</span>
                                <span style="font-size:0.75em;color:#666;">Claude â†’ OpenAI</span>
                            </div>
                            <div style="display:flex;justify-content:space-between;align-items:center;padding:8px;background:#E6D7C3;border-radius:6px;">
                                <span style="font-size:0.85em;font-weight:600;">Relations</span>
                                <span style="font-size:0.75em;color:#666;">Haiku 4.5 â†’ Claude</span>
                            </div>
                            <div style="display:flex;justify-content:space-between;align-items:center;padding:8px;background:#E6D7C3;border-radius:6px;">
                                <span style="font-size:0.85em;font-weight:600;">RÃ©sumÃ©s</span>
                                <span style="font-size:0.75em;color:#666;">OpenAI â†’ Claude</span>
                            </div>
                            <div style="display:flex;justify-content:space-between;align-items:center;padding:8px;background:#E6D7C3;border-radius:6px;">
                                <span style="font-size:0.85em;font-weight:600;">MÃ©tadonnÃ©es</span>
                                <span style="font-size:0.75em;color:#666;">Groq â†’ Haiku 4.5</span>
                            </div>
                            <div style="display:flex;justify-content:space-between;align-items:center;padding:8px;background:#E6D7C3;border-radius:6px;">
                                <span style="font-size:0.85em;font-weight:600;">Citations</span>
                                <span style="font-size:0.75em;color:#666;">Claude â†’ OpenAI</span>
                            </div>
                        </div>
                    </div>
                    
                    <!-- WORKERS STATUS -->
                    <div style="background:white;padding:15px;border-radius:8px;border:2px solid #C8D0C3;">
                        <h4 style="margin:0 0 12px 0;font-size:0.95em;color:#333;">Workers Cloudflare ConfigurÃ©s</h4>
                        <div style="display:grid;gap:8px;font-size:0.8em;">
                            <div style="padding:8px;background:#E6D7C3;border-radius:6px;display:flex;justify-content:space-between;">
                                <span><strong>Claude:</strong> ocr-universel-proxy</span>
                                <span style="color:#8FAFB1;">âœ“</span>
                            </div>
                            <div style="padding:8px;background:#E6D7C3;border-radius:6px;display:flex;justify-content:space-between;">
                                <span><strong>Groq:</strong> groq-proxy</span>
                                <span style="color:#8FAFB1;">âœ“</span>
                            </div>
                            <div style="padding:8px;background:#E6D7C3;border-radius:6px;display:flex;justify-content:space-between;">
                                <span><strong>OpenAI:</strong> openai-proxy</span>
                                <span style="color:#8FAFB1;">âœ“</span>
                            </div>
                        </div>
                    </div>
                    
                    <!-- CONFIG NOTE -->
                    <div style="margin-top:15px;padding:12px;background:linear-gradient(135deg, #E6D7C3 0%, #D8CDBB 100%);border-radius:8px;border-left:4px solid #C8D0C3;">
                        <p style="margin:0;font-size:0.85em;color:#5a5a5a;">
                            <strong style="color:#8FAFB1;">âš ï¸ Configuration requise:</strong> Ajoutez vos clÃ©s API dans le mode "API Multi-LLM" pour activer ENSEMBLE.
                        </p>
                    </div>
                    
                    <!-- BOUTON LANCER ENSEMBLE -->
                    <button class="btn" onclick="sendWithUserKeys()" style="width:100%;margin-top:20px;padding:18px;font-size:1.1em;">
                        âš¡ Lancer ENSEMBLE (6 tÃ¢ches parallÃ¨les)
                    </button>
                    
                    <p style="text-align:center;margin-top:10px;font-size:0.85em;color:#666;">
                        Uploadez d'abord un document ci-dessus, puis cliquez ici
                    </p>
                </div>
                
                <!-- âœ… PANEL BATCH (300-1000 PAGES) -->
                <div class="mode-panel" id="panelBatch" data-mode="batch">
                    <div style="padding:20px;background:linear-gradient(135deg, #8FAFB1 0%, #C8D0C3 100%);border-radius:12px;margin-bottom:20px;color:white;">
                        <h3 style="margin:0 0 10px 0;font-size:1.3em;">MODE BATCH - Documents 300-1000 pages</h3>
                        <p style="margin:0;font-size:0.95em;line-height:1.6;">
                            Traitement asynchrone via Batch API Anthropic<br>
                            <strong>âœ“ Aucun timeout</strong> â€¢ <strong>âœ“ Chunking auto</strong> â€¢ <strong>âœ“ Fermez la page et revenez plus tard!</strong>
                        </p>
                    </div>
                    
                    <!-- CLÃ‰ API ANTHROPIC - STYLE API MULTI-LLM -->
                    <div class="provider-mini" data-provider="anthropic" style="margin-bottom:20px;">
                        <div class="provider-mini-header" onclick="toggleBatchMini('batch-anthropic')" style="background:#8FAFB1;color:white;padding:12px;border-radius:8px;cursor:pointer;display:flex;justify-content:space-between;align-items:center;">
                            <span><b>ğŸ”‘ ClÃ© API Anthropic</b> <small style="opacity:0.8;">(requise pour Batch)</small></span>
                            <span class="mini-arrow" id="arrow-batch-anthropic">â–¼</span>
                        </div>
                        <div class="provider-mini-body" id="mini-batch-anthropic" style="display:block;padding:15px;background:#f8f9fa;border:2px solid #C8D0C3;border-top:none;border-radius:0 0 8px 8px;">
                            <div style="margin-bottom:10px;">
                                <label style="display:block;margin-bottom:5px;font-size:0.85em;font-weight:600;color:#333;">ğŸ¤– ModÃ¨le Claude</label>
                                <select id="batchAnthropicModel" style="width:100%;padding:10px;font-size:0.9em;border:1px solid #C8D0C3;border-radius:4px;">
                                    <option value="claude-sonnet-4-5-20250929" selected>Claude Sonnet 4.5 â­ (RecommandÃ©)</option>
                                    <option value="claude-opus-4-5-20251101">Claude Opus 4.5 (Premium)</option>
                                    <option value="claude-haiku-4-5-20251001">Claude Haiku 4.5 (Rapide)</option>
                                    <option value="claude-sonnet-4-20250514">Claude Sonnet 4</option>
                                    <option value="claude-opus-4-1-20250805">Claude Opus 4.1</option>
                                </select>
                            </div>
                            <input type="password" id="batchAnthropicKey" placeholder="sk-ant-api03-..." 
                                style="width:100%;padding:10px;font-size:0.9em;border:1px solid #C8D0C3;border-radius:4px;margin-bottom:8px;">
                            <button class="save-btn" id="save-batch-anthropic" onclick="saveBatchKey('anthropic')" 
                                style="width:100%;padding:10px;background:#8FAFB1;color:white;border:none;border-radius:4px;cursor:pointer;font-size:0.9em;font-weight:600;">
                                Sauvegarder
                            </button>
                            <div id="batch-anthropic-status" style="margin-top:8px;font-size:0.8em;color:#666;text-align:center;"></div>
                        </div>
                    </div>
                    
                    <div style="padding:15px;background:#E6D7C3;border-radius:8px;margin-bottom:20px;">
                        <h4 style="margin:0 0 10px 0;color:#8FAFB1;font-size:1em;">ğŸ“‹ Fonctionnement</h4>
                        <ul style="margin:0;padding-left:20px;color:#5a5a5a;font-size:0.85em;line-height:1.8;">
                            <li>Upload â†’ Estimation tokens auto</li>
                            <li>Chunking si >150K tokens (chunks 140K)</li>
                            <li>Batch API â†’ Traitement 1-3h</li>
                            <li>Polling auto toutes les 30s</li>
                            <li>Fusion intelligente + dÃ©duplication</li>
                            <li>Download knowledge.json</li>
                        </ul>
                    </div>
                    
                    <div id="batchStatus" style="display:none;padding:15px;background:white;border:2px solid #8FAFB1;border-radius:8px;margin-bottom:15px;">
                        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:10px;">
                            <strong style="color:#8FAFB1;">Batch en cours...</strong>
                            <span id="batchTimer" style="font-size:0.9em;color:#666;">â±ï¸ 0min</span>
                        </div>
                        <div style="background:#E6D7C3;border-radius:6px;height:8px;overflow:hidden;margin-bottom:10px;">
                            <div id="batchProgress" style="background:#8FAFB1;height:100%;width:0%;transition:width 0.3s;"></div>
                        </div>
                        <div style="font-size:0.85em;color:#666;">
                            <div id="batchStatusText">PrÃ©paration...</div>
                            <div id="batchDetails" style="margin-top:5px;color:#999;"></div>
                        </div>
                    </div>
                    
                    <p style="text-align:center;margin:20px 0 0 0;font-size:0.9em;color:#666;">
                        ğŸ‘† Uploadez votre document ci-dessus<br>
                        DÃ©tection et traitement BATCH automatique
                    </p>
                </div>
            </div>
        </div>

        <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
        <!-- BATCH PROCESSING -->
        <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
        <div class="section batch-section" id="batchSection">
            <h2>Batch Processing</h2>
            
            <!-- Batch Templates -->
            <div class="card">
                <h4>Templates Batch</h4>
                <p style="margin-bottom:15px;color:var(--gris-secondaire);">Configurations prÃ©-dÃ©finies pour traitement de dossiers</p>
                <div class="batch-templates">
                    <div class="batch-template-card" onclick="applyBatchTemplate('books_documents')">
                        <h5>ğŸ“š Livres & Documents</h5>
                        <p>Livres, manuels, guides</p>
                        <span class="template-badge">Mixte</span>
                    </div>
                    <div class="batch-template-card" onclick="applyBatchTemplate('media_collection')">
                        <h5>ğŸ¨ Collection MÃ©dia</h5>
                        <p>Images, scans, photos</p>
                        <span class="template-badge">ScannÃ©</span>
                    </div>
                    <div class="batch-template-card" onclick="applyBatchTemplate('academic_research')">
                        <h5>ğŸ”¬ AcadÃ©mique & Recherche</h5>
                        <p>Articles, thÃ¨ses, Ã©tudes</p>
                        <span class="template-badge">Digital</span>
                    </div>
                    <div class="batch-template-card" onclick="applyBatchTemplate('business_docs')">
                        <h5>ğŸ’¼ Documents Professionnels</h5>
                        <p>Rapports, contrats, factures</p>
                        <span class="template-badge">Digital</span>
                    </div>
                    <div class="batch-template-card" onclick="applyBatchTemplate('custom')">
                        <h5>âš™ï¸ PersonnalisÃ©</h5>
                        <p>Configuration manuelle</p>
                        <span class="template-badge">Config</span>
                    </div>
                </div>
            </div>
            
            <!-- Batch Configuration -->
            <div class="batch-config-section">
                <h4>Configuration Batch</h4>
                <div class="batch-config-row">
                    <div class="batch-config-item">
                        <label>Fichiers simultanÃ©s: <span style="color: #8FAFB1; font-size: 0.9em;">(1-10, recommandÃ©: 3-5)</span></label>
                        <input type="number" id="batchMaxConcurrent" value="3" min="1" max="10" onchange="updateBatchConfig()">
                    </div>
                    <div class="batch-config-item">
                        <label>Tentatives retry:</label>
                        <input type="number" id="batchRetryAttempts" value="2" min="0" max="5" onchange="updateBatchConfig()">
                    </div>
                </div>
                <div class="batch-config-row">
                    <div class="batch-config-item">
                        <label>
                            <input type="checkbox" id="batchContinueOnError" checked onchange="updateBatchConfig()">
                            Continuer si erreur
                        </label>
                    </div>
                    <div class="batch-config-item">
                        <label>StratÃ©gie de fusion:</label>
                        <select id="batchMergeStrategy" onchange="updateBatchConfig()">
                            <option value="chronological">Chronologique</option>
                            <option value="by_type">Par type</option>
                            <option value="alphabetical">AlphabÃ©tique</option>
                            <option value="flat">Plat (pas de fusion)</option>
                        </select>
                    </div>
                </div>
            </div>
            
            <!-- Upload Multiple Files -->
            <div class="batch-upload">
                <input type="file" id="batchFileInput" multiple accept=".pdf,.docx,.doc,.xlsx,.xls,.pptx,.ppt,.epub,.html,.htm,.md,.markdown,.txt,.png,.jpg,.jpeg,.gif,.webp,.tiff,.tif,.svg,.rtf,.odt,.ods,.odp,.csv,.tsv,.json,.xml,.yaml,.yml,.mobi,.azw,.azw3,.cbz,.cbr,.eml,.msg,.ics,.vcf,.gpx,.kml,.tex,.bib,.zip">
                <label for="batchFileInput" class="batch-upload-label">
                    SÃ©lectionner plusieurs fichiers
                </label>
                <p style="margin-top:15px;color:var(--gris-secondaire);">Glissez-dÃ©posez plusieurs fichiers ou cliquez pour sÃ©lectionner</p>
            </div>
            
            <!-- Batch Queue -->
            <div id="batchQueue" class="batch-queue"></div>
            
            <!-- Batch Controls -->
            <div class="batch-controls">
                <button class="btn" onclick="startBatch()" id="batchStartBtn">
                    DÃ©marrer le Batch
                </button>
                <button class="btn btn-secondary" onclick="pauseBatch()" id="batchPauseBtn" disabled>
                    Pause
                </button>
                <button class="btn btn-secondary" onclick="resumeBatch()" id="batchResumeBtn" disabled>
                    Reprendre
                </button>
                <button class="btn btn-secondary" onclick="exportPartialBatch()" id="batchExportBtn" disabled>
                    Exporter rÃ©sultats partiels
                </button>
                <button class="btn" onclick="openPromptModal()" id="batchPromptBtn" disabled style="background:linear-gradient(135deg, #11998e, #38ef7d);">
                    ğŸ¯ GÃ©nÃ©rer Prompt ConsolidÃ©
                </button>
                <button class="btn btn-danger" onclick="clearBatch()">
                    Tout effacer
                </button>
            </div>
            
            <!-- Batch Statistics -->
            <div class="batch-stats" id="batchStats" style="display:none;">
                <div class="batch-stat">
                    <div class="batch-stat-value" id="batchStatTotal">0</div>
                    <div class="batch-stat-label">Total</div>
                </div>
                <div class="batch-stat">
                    <div class="batch-stat-value" id="batchStatCompleted">0</div>
                    <div class="batch-stat-label">ComplÃ©tÃ©s</div>
                </div>
                <div class="batch-stat">
                    <div class="batch-stat-value" id="batchStatErrors">0</div>
                    <div class="batch-stat-label">Erreurs</div>
                </div>
                <div class="batch-stat">
                    <div class="batch-stat-value" id="batchStatTime">0s</div>
                    <div class="batch-stat-label">Temps Ã©coulÃ©</div>
                </div>
            </div>
        </div>

        <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
        <!-- UPLOAD ZONE -->
        <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
        <div class="section">
            <h2>Upload Document</h2>
            
            <div class="drop-zone" id="dropZone">
                <input type="file" id="fileInput" accept=".pdf,.docx,.doc,.xlsx,.xls,.pptx,.ppt,.epub,.html,.htm,.md,.markdown,.txt,.png,.jpg,.jpeg,.gif,.webp,.tiff,.tif,.svg,.rtf,.odt,.ods,.odp,.csv,.tsv,.json,.xml,.yaml,.yml,.mobi,.azw,.azw3,.cbz,.cbr,.eml,.msg,.ics,.vcf,.gpx,.kml,.tex,.bib,.zip">
                
                <div class="drop-zone-content">
                    <div class="drop-zone-icon">ğŸ“„</div>
                    <h3>Glissez-dÃ©posez ou cliquez pour sÃ©lectionner</h3>
                    <p>21 formats supportÃ©s â€¢ Analyse multi-dimensionnelle â€¢ OCR intelligent</p>
                </div>
            </div>
        </div>

        <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
        <!-- PROGRESS -->
        <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
        <div class="progress-container" id="progressContainer">
            <h3>Traitement en cours...</h3>
            <div class="progress-bar-container">
                <div class="progress-bar-fill" id="progressBar">0%</div>
            </div>
            <div class="progress-detail" id="progressDetail">
                <span id="progressStage">Initialisation...</span>
                <span id="progressText">Chargement...</span>
            </div>
        </div>

        <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
        <!-- STATUS MESSAGE -->
        <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
        <div class="status-message" id="statusMessage"></div>

        <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
        <!-- DETECTION RESULT -->
        <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
        <div class="section" id="detectionSection" style="display:none;">
            <!-- Rempli dynamiquement -->
        </div>

        <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
        <!-- COMPOSITION OVERRIDE -->
        <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
        <div id="compositionSection" class="composition-section">
            <h3>Ajustement Composition (Optionnel)</h3>
            
            <div class="card">
                <h4>Format Technique</h4>
                <select id="technicalOverride" onchange="updateTechnicalFormat()" style="width:100%;padding:12px;border-radius:8px;border:2px solid var(--beige-sable);font-family:Montserrat;font-size:15px;">
                    <option value="auto">DÃ©tection auto</option>
                    <option value="scanned">Document scannÃ© (OCR requis)</option>
                    <option value="digital">Texte digital (natif)</option>
                    <option value="manuscrit">Manuscrit / Ã‰criture manuelle</option>
                    <option value="photo">Photo / Capture</option>
                    <option value="image">Image vectorielle</option>
                    <option value="hybrid">Hybride (scannÃ© + digital)</option>
                </select>
            </div>
            
            <div class="card">
                <h4>Types de Contenu (Multi-sÃ©lection)</h4>
                <p style="margin-bottom:15px;color:var(--gris-secondaire);">Cochez tous les types prÃ©sents dans le document:</p>
                
                <div id="contentCheckboxes" class="content-checkboxes">
                    <!-- TYPES UNIVERSELS (10) -->
                    <div style="margin-bottom:20px;border-bottom:2px solid var(--beige-sable);padding-bottom:15px;">
                        <h5 style="color:var(--vert-sauge);margin-bottom:10px;font-size:14px;">Types Universels</h5>
                        <label class="checkbox-label">
                            <input type="checkbox" value="text_paragraphs" onchange="updateComposition()">
                            ğŸ“ Texte & Paragraphes
                        </label>
                        <label class="checkbox-label">
                            <input type="checkbox" value="images_photos" onchange="updateComposition()">
                            ğŸ–¼ï¸ Images & Photos
                        </label>
                        <label class="checkbox-label">
                            <input type="checkbox" value="tables_data" onchange="updateComposition()">
                            ğŸ“Š Tableaux & DonnÃ©es
                        </label>
                        <label class="checkbox-label">
                            <input type="checkbox" value="charts_graphs" onchange="updateComposition()">
                            ğŸ“ˆ Graphiques & Courbes
                        </label>
                        <label class="checkbox-label">
                            <input type="checkbox" value="diagrams_schemas" onchange="updateComposition()">
                            ğŸ”· Diagrammes & SchÃ©mas
                        </label>
                        <label class="checkbox-label">
                            <input type="checkbox" value="forms_templates" onchange="updateComposition()">
                            ğŸ“‹ Formulaires & ModÃ¨les
                        </label>
                        <label class="checkbox-label">
                            <input type="checkbox" value="lists_bullet_points" onchange="updateComposition()">
                            â€¢ Listes & Points
                        </label>
                        <label class="checkbox-label">
                            <input type="checkbox" value="code_technical" onchange="updateComposition()">
                            ğŸ’» Code & Technique
                        </label>
                        <label class="checkbox-label">
                            <input type="checkbox" value="mathematical_formulas" onchange="updateComposition()">
                            ğŸ§® Formules MathÃ©matiques
                        </label>
                        <label class="checkbox-label">
                            <input type="checkbox" value="annotations_highlights" onchange="updateComposition()">
                            âœï¸ Annotations & Surlignages
                        </label>
                    </div>
                    
                    <!-- TYPES COMPLÃ‰MENTAIRES (8) -->
                    <div>
                        <h5 style="color:var(--bleu-mer);margin-bottom:10px;font-size:14px;">Types ComplÃ©mentaires</h5>
                        <label class="checkbox-label">
                            <input type="checkbox" value="musical_notation" onchange="updateComposition()">
                            ğŸ¼ Notation Musicale
                        </label>
                        <label class="checkbox-label">
                            <input type="checkbox" value="citations_references" onchange="updateComposition()">
                            ğŸ“– Citations & RÃ©fÃ©rences
                        </label>
                        <label class="checkbox-label">
                            <input type="checkbox" value="exercises_questions" onchange="updateComposition()">
                            â“ Exercices & Questions
                        </label>
                        <label class="checkbox-label">
                            <input type="checkbox" value="callouts_boxes" onchange="updateComposition()">
                            ğŸ’¬ EncadrÃ©s SpÃ©ciaux
                        </label>
                        <label class="checkbox-label">
                            <input type="checkbox" value="index_glossary" onchange="updateComposition()">
                            ğŸ“‘ Index & Glossaires
                        </label>
                        <label class="checkbox-label">
                            <input type="checkbox" value="case_studies" onchange="updateComposition()">
                            ğŸ“š Ã‰tudes de Cas
                        </label>
                        <label class="checkbox-label">
                            <input type="checkbox" value="links_urls" onchange="updateComposition()">
                            ğŸ”— Liens & URLs
                        </label>
                        <label class="checkbox-label">
                            <input type="checkbox" value="infographics" onchange="updateComposition()">
                            ğŸ¨ Infographies
                        </label>
                    </div>
                </div>
                
                <div id="weightsSection" class="weights-section" style="display:none;">
                    <h5>PondÃ©ration (auto-normalisÃ©e)</h5>
                    <div id="slidersList"></div>
                    <button class="btn btn-secondary btn-small" onclick="resetWeights()" style="margin-top:15px;">
                        RÃ©initialiser poids automatiques
                    </button>
                </div>
            </div>
        </div>

        <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
        <!-- CONFIGURATION -->
        <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
        <div class="section" id="configSection" style="display:none;">
            <h2>Configuration</h2>
            
            <div class="config-grid">
                <div class="config-section">
                    <h4>Plateforme IA</h4>
                    <div class="platform-selector">
                        <div class="platform-option selected" id="platformChatGPT" onclick="selectPlatform('chatgpt')">
                            <strong>ChatGPT</strong>
                            <p>GPT-4o / o1</p>
                        </div>
                        <div class="platform-option" id="platformClaude" onclick="selectPlatform('claude')">
                            <strong>Claude</strong>
                            <p>Sonnet 4 / Opus 4</p>
                        </div>
                    </div>
                    
                    <div id="gptSelectorGroup" class="model-selector" style="display:block;">
                        <label>ModÃ¨le ChatGPT:</label>
                        <select id="gptSelector" onchange="updateIndicators()">
                            <option value="gpt-5.2-pro">GPT-5.2 Pro ğŸ† (Premium Max)</option>
                            <option value="gpt-5.2-pro-2025-12-11">GPT-5.2 Pro 2025-12-11</option>
                            <option value="gpt-5.2">GPT-5.2 â­ (Exceptionnel)</option>
                            <option value="gpt-5.2-chat-latest">GPT-5.2 Chat Latest</option>
                            <option value="gpt-5-pro">GPT-5 Pro ğŸ†</option>
                            <option value="gpt-5-pro-2025-10-06">GPT-5 Pro 2025-10-06</option>
                            <option value="gpt-5" selected>GPT-5 â­ (RecommandÃ©)</option>
                            <option value="gpt-5-chat-latest">GPT-5 Chat Latest</option>
                            <option value="gpt-4.1">GPT-4.1</option>
                            <option value="gpt-4.1-mini">GPT-4.1 Mini</option>
                            <option value="gpt-4.1-nano">GPT-4.1 Nano (Ã‰conomique)</option>
                            <option value="gpt-4o">GPT-4o (Rapide, Ã©quilibrÃ©)</option>
                            <option value="gpt-4o-mini">GPT-4o Mini</option>
                            <option value="o1">o1 (Raisonnement profond)</option>
                            <option value="o1-mini">o1-mini (Rapide, efficace)</option>
                        </select>
                    </div>
                    
                    <div id="claudeSelectorGroup" class="model-selector">
                        <label>ModÃ¨le Claude:</label>
                        <select id="claudeSelector" onchange="updateIndicators()">
                            <option value="claude-sonnet-4-5-20250929" selected>Claude Sonnet 4.5 â­ (Optimal)</option>
                            <option value="claude-opus-4-5-20251101">Claude Opus 4.5 (Maximum qualitÃ©)</option>
                            <option value="claude-haiku-4-5-20251001">Claude Haiku 4.5 (Rapide)</option>
                            <option value="claude-sonnet-4-20250514">Claude Sonnet 4</option>
                            <option value="claude-opus-4-1-20250805">Claude Opus 4.1</option>
                        </select>
                    </div>
                    
                    <div class="indicator-grid">
                        <div class="indicator">
                            <div class="indicator-label">QualitÃ©</div>
                            <div class="indicator-value" id="qualityIndicator">Ã‰levÃ©e</div>
                        </div>
                        <div class="indicator">
                            <div class="indicator-label">Vitesse</div>
                            <div class="indicator-value" id="speedIndicator">Rapide</div>
                        </div>
                        <div class="indicator">
                            <div class="indicator-label">DÃ©tails</div>
                            <div class="indicator-value" id="detailsIndicator">Complets</div>
                        </div>
                    </div>
                </div>
                
                <div class="config-section">
                    <h4>Format Extraction</h4>
                    <select id="formatSelector" onchange="updateIndicators()" style="width:100%;padding:12px;border-radius:8px;border:2px solid var(--beige-sable);font-family:Montserrat;font-size:15px;margin-bottom:15px;">
                        <option value="7">Standard (7 modules)</option>
                        <option value="32" selected>R&D Complet (32 modules)</option>
                    </select>
                    
                    <div id="formatDesc" style="padding:15px;background:var(--blanc);border-radius:8px;"></div>
                </div>
            </div>
            
            <div style="text-align:center;margin-top:30px;">
                <button class="btn" onclick="processFile()">
                    Lancer le Traitement
                </button>
            </div>
        </div>

        <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
        <!-- PARTS CONTAINER -->
        <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
        <div class="section" id="phase2" style="display:none;">
            <h2>Traitement par Parties</h2>
            <div id="partsContainer"></div>
        </div>

        <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
        <!-- EXPORT FORMATS -->
        <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
        <div class="section export-section" id="exportSection" style="display:none;">
            <h2>Export Multi-Format</h2>
            <p style="color:var(--gris-secondaire);margin-bottom:25px;">
                Exportez vos donnÃ©es extraites dans 8 formats diffÃ©rents pour une intÃ©gration optimale avec vos outils
            </p>
            
            <!-- Export Options -->
            <div class="export-options">
                <h4>Options d'Export</h4>
                <div class="export-option-row">
                    <span class="export-option-label">Inclure mÃ©tadonnÃ©es</span>
                    <div class="export-option-control">
                        <input type="checkbox" id="exportIncludeMetadata" checked>
                    </div>
                </div>
                <div class="export-option-row">
                    <span class="export-option-label">Format d'analyse</span>
                    <div class="export-option-control">
                        <select id="exportAnalysisFormat">
                            <option value="complete">ComplÃ¨te</option>
                            <option value="summary">RÃ©sumÃ©</option>
                            <option value="none">Sans analyse</option>
                        </select>
                    </div>
                </div>
                <div class="export-option-row">
                    <span class="export-option-label">Inclure texte brut</span>
                    <div class="export-option-control">
                        <input type="checkbox" id="exportIncludeRawText" checked>
                    </div>
                </div>
            </div>
            
            <!-- V6.3.0 - EXPORTS RAPIDES -->
            <div class="export-section-header">
                <h3 class="export-section-title">ğŸ“¦ Exports Rapides</h3>
            </div>
            <div class="export-formats-grid">
                <div class="export-format-card" onclick="exportFormat('markdown')">
                    <div class="export-format-icon">ğŸ“</div>
                    <div class="export-format-name">Markdown</div>
                    <div class="export-format-desc">Documentation structurÃ©e avec formatage</div>
                    <span class="export-format-badge">.md</span>
                </div>
                
                <div class="export-format-card" onclick="exportFormat('pdf')">
                    <div class="export-format-icon">ğŸ“„</div>
                    <div class="export-format-name">PDF Report</div>
                    <div class="export-format-desc">Rapport professionnel imprimable</div>
                    <span class="export-format-badge">.pdf</span>
                </div>
                
                <div class="export-format-card" onclick="exportFormat('excel')">
                    <div class="export-format-icon">ğŸ“Š</div>
                    <div class="export-format-name">Excel</div>
                    <div class="export-format-desc">Feuilles de calcul avec donnÃ©es tabulaires</div>
                    <span class="export-format-badge">.xlsx</span>
                </div>
            </div>
            
            <!-- V6.3.0 - EXPORTS AVANCÃ‰S (toggle) -->
            <div class="export-section-header">
                <h3 class="export-section-title">ğŸ”§ Exports AvancÃ©s</h3>
                <button class="export-toggle-btn" onclick="toggleAdvancedExports()">
                    <span id="toggleAdvancedText">â–¼ Afficher (5 formats)</span>
                </button>
            </div>
            <div class="export-advanced-section" id="advancedExportsSection">
                <div class="export-formats-grid">
                <div class="export-format-card" onclick="exportFormat('jsonld')">
                    <div class="export-format-icon">ğŸ”—</div>
                    <div class="export-format-name">JSON-LD</div>
                    <div class="export-format-desc">Knowledge graph (Schema.org)</div>
                    <span class="export-format-badge">.jsonld</span>
                </div>
                
                <div class="export-format-card" onclick="exportFormat('yaml')">
                    <div class="export-format-icon">âš™ï¸</div>
                    <div class="export-format-name">YAML</div>
                    <div class="export-format-desc">Configuration lisible</div>
                    <span class="export-format-badge">.yaml</span>
                </div>
                
                <div class="export-format-card" onclick="exportFormat('obsidian')">
                    <div class="export-format-icon">ğŸ’</div>
                    <div class="export-format-name">Obsidian</div>
                    <div class="export-format-desc">Vault avec backlinks</div>
                    <span class="export-format-badge">.md + links</span>
                </div>
                
                <div class="export-format-card" onclick="exportFormat('notion')">
                    <div class="export-format-icon">ğŸ“š</div>
                    <div class="export-format-name">Notion</div>
                    <div class="export-format-desc">Import CSV pour database</div>
                    <span class="export-format-badge">.csv</span>
                </div>
                
                <div class="export-format-card" onclick="exportFormat('anki')">
                    <div class="export-format-icon">ğŸ´</div>
                    <div class="export-format-name">Anki</div>
                    <div class="export-format-desc">Flashcards pour mÃ©morisation</div>
                    <span class="export-format-badge">.txt</span>
                </div>
            </div>
            
            <!-- Export All Button -->
            <div class="export-buttons">
                <button class="export-all-btn" onclick="exportAllFormats()">
                    Exporter Tous les Formats
                </button>
            </div>
            
            <!-- Export Preview -->
            <div id="exportPreview" style="display:none;">
                <h4>AperÃ§u Export</h4>
                <div class="export-preview" id="exportPreviewContent"></div>
            </div>
        </div>

        <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
        <!-- STATISTICS -->
        <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
        <div class="section" id="statsSection" style="display:none;">
            <h2>Statistiques</h2>
            <div class="stats-grid" id="statsGrid"></div>
        </div>

        <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
        <!-- FOOTER -->
        <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
        <div class="footer">
            OCR Universel V6.7.0 KB ENGINE - Multi-LLM Intelligent - C Concept&Dev
        </div>
    </div>

    <script>
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // GLOBAL STATE
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        
        const STATE = {
            file: null,
            fileName: '',
            fileType: '',
            totalPages: 1,
            extractedText: '',
            analysis: null,
            documentType: '',
            detectionResult: null,
            format: 32,
            platform: 'chatgpt',
            processingMode: 'manual', // manual | user-keys | worker
            selectedProvider: null, // deepseek | groq | anthropic | openai
            
            // Batch processing state
            batch: {
                queue: [],              // Array of BatchItem
                status: 'idle',         // idle | running | paused | completed
                currentIndex: 0,
                startTime: null,
                pausedAt: null,
                stats: {
                    total: 0,
                    completed: 0,
                    errors: 0,
                    skipped: 0
                },
                config: {
                    maxConcurrent: 3,   // 3 files in parallel
                    retryAttempts: 2,
                    continueOnError: true,
                    autoMerge: false,
                    mergeStrategy: 'chronological' // chronological | by_type | alphabetical | flat
                }
            },
            gptModel: 'gpt-5',
            claudeModel: 'claude-sonnet-4-20250514',
            parts: [],
            currentPartIndex: 0,
            startTime: null,
            batchSize: 30,
            ocrCache: null,
            ocrWorkerPool: null
        };

        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // CONFIGURATION
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        
        const CONFIG = {
            gpt: {
                'gpt-5.2': {
                    quality: 'Exceptionnelle',
                    speed: 'Optimal',
                    details: 'Ultra-complets'
                },
                'gpt-5.2-chat-latest': {
                    quality: 'Exceptionnelle',
                    speed: 'Optimal',
                    details: 'Ultra-complets'
                },
                'gpt-5.2-pro': {
                    quality: 'Premium Max',
                    speed: 'ModÃ©rÃ©',
                    details: 'Exhaustifs Premium'
                },
                'gpt-5.2-pro-2025-12-11': {
                    quality: 'Premium Max',
                    speed: 'ModÃ©rÃ©',
                    details: 'Exhaustifs Premium'
                },
                'gpt-5': {
                    quality: 'TrÃ¨s Ã©levÃ©e',
                    speed: 'Rapide',
                    details: 'TrÃ¨s complets'
                },
                'gpt-5-chat-latest': {
                    quality: 'TrÃ¨s Ã©levÃ©e',
                    speed: 'Rapide',
                    details: 'TrÃ¨s complets'
                },
                'gpt-5-pro': {
                    quality: 'Premium',
                    speed: 'ModÃ©rÃ©',
                    details: 'Exhaustifs'
                },
                'gpt-5-pro-2025-10-06': {
                    quality: 'Premium',
                    speed: 'ModÃ©rÃ©',
                    details: 'Exhaustifs'
                },
                'gpt-4.1': {
                    quality: 'TrÃ¨s Ã©levÃ©e',
                    speed: 'Rapide',
                    details: 'TrÃ¨s complets'
                },
                'gpt-4.1-mini': {
                    quality: 'Ã‰levÃ©e',
                    speed: 'TrÃ¨s rapide',
                    details: 'Complets'
                },
                'gpt-4.1-nano': {
                    quality: 'Bonne',
                    speed: 'Ultra-rapide',
                    details: 'Essentiels'
                },
                'gpt-4o': {
                    quality: 'Ã‰levÃ©e',
                    speed: 'Rapide',
                    details: 'Complets'
                },
                'gpt-4o-mini': {
                    quality: 'Bonne',
                    speed: 'TrÃ¨s rapide',
                    details: 'Essentiels'
                },
                'o1': {
                    quality: 'Maximale',
                    speed: 'Lent',
                    details: 'Exhaustifs'
                },
                'o1-mini': {
                    quality: 'Bonne',
                    speed: 'TrÃ¨s rapide',
                    details: 'Essentiels'
                }
            },
            claude: {
                'claude-sonnet-4-5-20250929': {
                    quality: 'TrÃ¨s Ã©levÃ©e',
                    speed: 'Optimal',
                    details: 'TrÃ¨s complets'
                },
                'claude-opus-4-5-20251101': {
                    quality: 'Maximale',
                    speed: 'ModÃ©rÃ©',
                    details: 'Exhaustifs'
                },
                'claude-haiku-4-5-20251001': {
                    quality: 'Bonne',
                    speed: 'TrÃ¨s rapide',
                    details: 'Complets'
                },
                'claude-sonnet-4-20250514': {
                    quality: 'Ã‰levÃ©e',
                    speed: 'Optimal',
                    details: 'Complets'
                },
                'claude-opus-4-1-20250805': {
                    quality: 'Maximale',
                    speed: 'ModÃ©rÃ©',
                    details: 'Exhaustifs'
                }
            },
            format: {
                7: 'Structure hiÃ©rarchique, index conceptuel, contenu enrichi, graphe de connaissances, taxonomie, analytics (7 modules essentiels)',
                32: 'Tous les modules Standard PLUS : sÃ©mantique avancÃ©e, pÃ©dagogie, multimodal, Ã©valuation, rÃ©fÃ©rences, citations, contexte historique, applications, controverses, glossaire, stats, comparaisons, implÃ©mentation, public cible, ressources, validation, mÃ©ta-analyse, liens, temporalitÃ©, patterns, insights, analytics (32 modules R&D)'
            },
            BATCH_FACTORS: {
                base_batch_size: 30,
                technical: {
                    'scanned': 0.7,
                    'photo': 0.6,
                    'manuscrit': 0.5,
                    'digital': 1.2,
                    'image': 1.0,
                    'hybrid': 0.8
                },
                content: {
                    'partition_musicale': 0.8,
                    'tablature': 0.7,
                    'texte_pedagogique': 1.0,
                    'regles_jeu': 0.9,
                    'document_therapie': 1.1,
                    'questionnaire_psy': 1.2,
                    'paper_scientifique': 0.9,
                    'manuel_technique': 1.0,
                    'text_standard': 1.0
                }
            },
            PATTERNS: {
                technical: {
                    density_thresholds: {
                        digital_low: 0.15,
                        scanned_high: 0.5,
                        hybrid_variance: 0.1
                    }
                },
                content: {
                    partition_musicale: {
                        filename: ['partition', 'score', 'sheet', 'realbook', 'fake book', 'songbook', 'lead sheet', 'transcription', 'music', 'sade', 'aebersold'],
                        metadata: ['music', 'musical', 'score', 'composition', 'composer'],
                        text: [
                            /\b[A-G][#bâ™¯â™­]?(m|maj|min|M|dim|aug|sus)?[0-9]?\b/g,
                            /\b[A-G][#bâ™¯â™­]?7(b9|#9|b5|#5|#11)?\b/g,
                            'â™¯', 'â™­', 'â™®', 'verse', 'chorus', 'bridge', 'intro', 'outro', 'solo',
                            'refrain', 'couplet', 'walking bass', 'chord changes', 'turnaround',
                            'ii-v-i', 'cadence', 'swing', 'bossa', 'groove', 'tempo', 'bpm'
                        ]
                    },
                    tablature: {
                        filename: ['tab', 'tablature', 'guitar tab', 'bass tab'],
                        text: ['tab', 'tablature', 'fret', 'string', /[EADGBE][-|0-9]+/]
                    },
                    texte_pedagogique: {
                        filename: ['cours', 'lesson', 'tutorial', 'guide', 'method'],
                        text: ['learn', 'practice', 'exercise', 'lesson', 'apprendre', 'exercice']
                    },
                    regles_jeu: {
                        filename: ['rules', 'game', 'jeu', 'rÃ¨gles'],
                        text: ['player', 'turn', 'round', 'winner', 'joueur', 'tour', 'gagnant']
                    },
                    document_therapie: {
                        filename: ['therapy', 'couple', 'thÃ©rapie', 'therapist'],
                        text: ['therapist', 'patient', 'session', 'thÃ©rapeute', 'sÃ©ance']
                    },
                    questionnaire_psy: {
                        filename: ['questionnaire', 'test', 'evaluation', 'assessment'],
                        text: ['question', 'answer', 'score', 'Ã©chelle', 'agree', 'disagree']
                    },
                    paper_scientifique: {
                        filename: ['paper', 'article', 'research', 'Ã©tude'],
                        text: ['abstract', 'introduction', 'methodology', 'results', 'conclusion']
                    },
                    manuel_technique: {
                        filename: ['manual', 'guide', 'documentation', 'specs'],
                        text: ['installation', 'configuration', 'troubleshooting', 'specification']
                    }
                }
            }
        };

        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // MULTI-LLM API MANAGER V6.0
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        
        class MultiLLMManager {
            constructor() {
                // 4 Workers Cloudflare configurÃ©s
                this.workers = {
                    'anthropic': 'https://ocr-universel-proxy.11drumboy11.workers.dev',
                    'groq': 'https://groq-proxy.11drumboy11.workers.dev',
                    'openai': 'https://openai-proxy.11drumboy11.workers.dev'
                };
                this.workerURL = this.workers.anthropic; // Keep for compatibility
                this.mode = 'worker'; // 'worker' ou 'user_keys'
                this.userKeys = {};
                this.loadUserKeys();
                
                console.log('[MultiLLM] ğŸš€ Manager initialized (V6.7.0 KB ENGINE)');
                console.log(`[MultiLLM] Mode: ${this.mode}`);
                console.log(`[MultiLLM] Workers configured:`, Object.keys(this.workers).length);
            }
            
            // â•â•â• CONFIGURATION â•â•â•
            
            switchMode(newMode) {
                if (!['worker', 'user_keys'].includes(newMode)) {
                    console.error('[MultiLLM] Mode invalide:', newMode);
                    return false;
                }
                
                this.mode = newMode;
                localStorage.setItem('multiLLM_mode', newMode);
                console.log(`[MultiLLM] ğŸ”€ Mode switched to: ${newMode}`);
                return true;
            }
            
            setUserKey(provider, apiKey, model = null) {
                if (!this.validateKey(provider, apiKey)) {
                    console.error('[MultiLLM] âŒ ClÃ© invalide pour provider:', provider);
                    return false;
                }
                
                this.userKeys[provider] = this.xorEncrypt(apiKey, 'ocr-v6-secret-2025');
                this.saveUserKeys();
                console.log(`[MultiLLM] âœ… ClÃ© ${provider} sauvegardÃ©e`);
                return true;
            }
            
            validateKey(provider, key) {
                const patterns = {
                    'anthropic': /^sk-ant-api03-[A-Za-z0-9_-]{95,}$/,
                    'openai': /^sk-[A-Za-z0-9_-]{20,}$/,
                    'deepseek': /^sk-[A-Za-z0-9_-]{20,}$/,
                    'groq': /^gsk_[A-Za-z0-9_-]{20,}$/
                };
                
                return patterns[provider] && patterns[provider].test(key);
            }
            
            // â•â•â• STORAGE â•â•â•
            
            saveUserKeys() {
                try {
                    localStorage.setItem('multiLLM_keys', JSON.stringify(this.userKeys));
                } catch (error) {
                    console.error('[MultiLLM] Erreur sauvegarde clÃ©s:', error);
                }
            }
            
            loadUserKeys() {
                try {
                    const saved = localStorage.getItem('multiLLM_keys');
                    const mode = localStorage.getItem('multiLLM_mode');
                    
                    if (saved) {
                        this.userKeys = JSON.parse(saved);
                    }
                    
                    if (mode) {
                        this.mode = mode;
                    }
                } catch (error) {
                    console.error('[MultiLLM] Erreur chargement clÃ©s:', error);
                }
            }
            
            getUserKey(provider) {
                if (!this.userKeys[provider]) {
                    return null;
                }
                
                try {
                    return this.xorDecrypt(this.userKeys[provider], 'ocr-v6-secret-2025');
                } catch (error) {
                    console.error('[MultiLLM] Erreur dÃ©chiffrement clÃ©:', error);
                    return null;
                }
            }
            
            xorEncrypt(text, key) {
                let result = '';
                for (let i = 0; i < text.length; i++) {
                    result += String.fromCharCode(text.charCodeAt(i) ^ key.charCodeAt(i % key.length));
                }
                return btoa(result);
            }
            
            xorDecrypt(encrypted, key) {
                try {
                    const text = atob(encrypted);
                    let result = '';
                    for (let i = 0; i < text.length; i++) {
                        result += String.fromCharCode(text.charCodeAt(i) ^ key.charCodeAt(i % key.length));
                    }
                    return result;
                } catch (error) {
                    return null;
                }
            }
            
            // â•â•â• API CALLS â•â•â•
            
            async sendPrompt(promptText, options = {}) {
                const {
                    provider = 'anthropic',
                    model = 'claude-sonnet-4-20250514',
                    max_tokens = 32000,  // âœ… AugmentÃ© Ã  32000 pour JSON 32 modules volumineux (Ã©tait 16000)
                    temperature = 0.3
                } = options;
                
                console.log(`[MultiLLM] ğŸ“¤ Sending to ${provider}/${model}`);
                
                try {
                    let response;
                    
                    // âœ… FORCER APPEL DIRECT pour Groq et DeepSeek (Worker ne les supporte pas)
                    const directProviders = ['groq', 'deepseek'];
                    // âœ… FORCER WORKER pour Anthropic (CORS restrictions en mode direct)
                    const workerOnlyProviders = ['anthropic'];
                    
                    const useDirectAPI = directProviders.includes(provider) || 
                                       (this.mode === 'user_keys' && !workerOnlyProviders.includes(provider));
                    
                    if ((this.mode === 'worker' || workerOnlyProviders.includes(provider)) && !directProviders.includes(provider)) {
                        console.log('[MultiLLM] Using Worker (Cloudflare)');
                        response = await this.callViaWorker(provider, model, promptText, max_tokens, temperature);
                    } else {
                        console.log('[MultiLLM] Using Direct API call');
                        response = await this.callDirectAPI(provider, model, promptText, max_tokens, temperature);
                    }
                    
                    console.log('[MultiLLM] âœ… Response received');
                    return this.parseResponse(provider, response);
                    
                } catch (error) {
                    console.error('[MultiLLM] âŒ Error:', error);
                    throw error;
                }
            }
            
            async callViaWorker(provider, model, prompt, max_tokens, temperature) {
                // ğŸ”§ FIX: Utiliser le worker spÃ©cifique au provider
                const workerURL = this.workers[provider] || this.workers.anthropic;
                
                console.log(`[MultiLLM] ğŸŒ Worker URL: ${workerURL}`);
                
                // ğŸ¯ PATCH V6.9: Routing endpoint pour OpenAI
                let endpoint = null;
                let apiPayload = null;
                
                if (provider === 'openai') {
                    endpoint = getOpenAIEndpoint(model);
                    console.log(`[MultiLLM] ğŸ”€ OpenAI endpoint: ${endpoint}`);
                    // Utiliser buildOpenAIPayload pour construire le bon format
                    apiPayload = buildOpenAIPayload(model, prompt, max_tokens, temperature);
                } else {
                    // Pour les autres providers, format standard
                    apiPayload = {
                        model,
                        max_tokens,
                        temperature,
                        messages: [{ role: 'user', content: prompt }]
                    };
                }
                
                // âœ… FIX V6.8.2: Structure correcte attendue par le worker
                const payload = {
                    apiKey: "WORKER_MODE", // Dummy non vide - clÃ© rÃ©elle stockÃ©e cÃ´tÃ© serveur
                    payload: {
                        provider,
                        ...apiPayload  // Spread le payload construit
                    }
                };
                
                // ğŸ¯ PATCH V6.9: Ajouter endpoint pour OpenAI
                if (endpoint) {
                    payload.endpoint = endpoint;
                }
                
                console.log('[MultiLLM] ğŸ“¤ Sending payload to worker:', {
                    provider,
                    model,
                    messageLength: prompt.length,
                    endpoint: endpoint || 'default',
                    payloadStructure: Object.keys(apiPayload)
                });
                
                // ğŸ” DIAGNOSTIC V6.9.5: Log payload structure (sans afficher tout le contenu)
                const payloadPreview = {
                    model: apiPayload.model,
                    max_output_tokens: apiPayload.max_output_tokens,
                    max_tokens: apiPayload.max_tokens,
                    reasoning: apiPayload.reasoning,
                    temperature: apiPayload.temperature,
                    inputLength: apiPayload.input?.length || apiPayload.messages?.[0]?.content?.length || 0,
                    inputPreview: (apiPayload.input || apiPayload.messages?.[0]?.content || '').substring(0, 100) + '...'
                };
                console.log('[DIAGNOSTIC] ğŸ“‹ Payload structure:', payloadPreview);
                console.log('[DIAGNOSTIC] ğŸ” Has reasoning:', !!apiPayload.reasoning);
                console.log('[DIAGNOSTIC] ğŸ” Has reasoning_effort:', !!apiPayload.reasoning_effort);
                if (apiPayload.reasoning) {
                    console.log('[DIAGNOSTIC] âœ… reasoning.effort:', apiPayload.reasoning.effort);
                }
                if (apiPayload.reasoning_effort) {
                    console.log('[DIAGNOSTIC] âŒ WARNING: reasoning_effort found:', apiPayload.reasoning_effort);
                }
                
                const response = await fetch(workerURL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(payload)
                });
                
                if (!response.ok) {
                    const error = await response.text();
                    throw new Error(`Worker error: ${error}`);
                }
                
                return await response.json();
            }
            
            async callDirectAPI(provider, model, prompt, max_tokens, temperature) {
                const apiKey = this.xorDecrypt(this.userKeys[provider], 'ocr-v6-secret-2025');
                
                if (!apiKey) {
                    throw new Error(`ClÃ© API ${provider} non configurÃ©e`);
                }
                
                // âœ… ENDPOINTS + TES PROXIES CLOUDFLARE 
                const endpoints = {
                    'anthropic': 'https://clone-proxy.11drumboy11.workers.dev/',
                    'openai': 'https://openai-proxy.11drumboy11.workers.dev/',
                    'deepseek': 'https://api.deepseek.com/v1/chat/completions',
                    'groq': 'https://groq-proxy.11drumboy11.workers.dev/'
                };
                
                if (provider === 'anthropic') {
                    const response = await fetch(endpoints.anthropic, {
                        method: 'POST',
                        headers: {
                            'x-api-key': apiKey,
                            'anthropic-version': '2023-06-01',
                            'content-type': 'application/json'
                        },
                        body: JSON.stringify({
                            model,
                            max_tokens,
                            temperature,
                            messages: [{ role: 'user', content: prompt }]
                        })
                    });
                    
                    if (!response.ok) {
                        throw new Error(`API Anthropic error: ${response.status}`);
                    }
                    
                    return await response.json();
                }
                
                
                // ğŸ¯ PATCH V6.9: OpenAI avec routing endpoint
                if (provider === 'openai') {
                    const endpoint = getOpenAIEndpoint(model);
                    const fullURL = `https://api.openai.com${endpoint}`;
                    const payload = buildOpenAIPayload(model, prompt, max_tokens, temperature);
                    
                    console.log(`[MultiLLM] ğŸ“¤ OpenAI Direct API: ${fullURL}`, {
                        model,
                        endpoint,
                        type: OPENAI_MODEL_CONFIG[model]?.type || 'unknown'
                    });
                    
                    const response = await fetch(fullURL, {
                        method: 'POST',
                        headers: {
                            'Authorization': `Bearer ${apiKey}`,
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(payload)
                    });
                    
                    if (!response.ok) {
                        const errorText = await response.text();
                        throw new Error(`API OpenAI error: ${response.status} - ${errorText}`);
                    }
                    
                    return await response.json();
                }
                
                // DeepSeek, Groq (format compatible OpenAI)
                if (['deepseek', 'groq'].includes(provider)) {
                    const response = await fetch(endpoints[provider], {
                        method: 'POST',
                        headers: {
                            'Authorization': `Bearer ${apiKey}`,
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            model,
                            max_tokens,
                            temperature,
                            messages: [{ role: 'user', content: prompt }]
                        })
                    });
                    
                    if (!response.ok) {
                        const errorText = await response.text();
                        throw new Error(`API ${provider} error: ${response.status} - ${errorText}`);
                    }
                    
                    return await response.json();
                }
                
                throw new Error(`Provider ${provider} non supportÃ© en mode direct`);
            }
            
            parseResponse(provider, response) {
                // âœ… SÃ‰CURITÃ‰: VÃ©rifier que la rÃ©ponse existe
                if (!response) {
                    throw new Error(`RÃ©ponse vide de ${provider}`);
                }
                
                if (provider === 'anthropic') {
                    // VÃ©rifier que content existe et n'est pas vide
                    if (!response.content || !Array.isArray(response.content) || response.content.length === 0) {
                        throw new Error('RÃ©ponse Anthropic invalide: content manquant');
                    }
                    
                    const text = response.content[0].text?.trim() || '';
                    
                    // Auto-nettoyage JSON sÃ©curisÃ©
                    let cleaned = text.replace(/```json\n?/g, '').replace(/```\n?/g, '').trim();
                    
                    try {
                        return {
                            text,
                            json: JSON.parse(cleaned),
                            usage: response.usage,
                            model: response.model
                        };
                    } catch (e) {
                        return {
                            text,
                            json: null,
                            usage: response.usage,
                            model: response.model
                        };
                    }
                }
                
                /**
                 * Extrait le texte d'une rÃ©ponse OpenAI (compatible Responses API + Chat Completions)
                 * @param {Object} response - RÃ©ponse de l'API OpenAI
                 * @returns {string} - Texte extrait
                 */
                function extractOpenAIText(response) {
                    console.log('[PARSER] ğŸ” Extracting from OpenAI response...');
                    
                    // ğŸ†• NOUVEAU FORMAT: Responses API (gpt-5.2-pro, o1-pro, o3, o4-mini)
                    // Plusieurs variantes possibles selon le status
                    
                    // Variante 1: response.output_text (quand status = "complete")
                    if (response.output_text && typeof response.output_text === 'string') {
                        console.log('[PARSER] âœ… Format: output_text (Responses API - direct)');
                        return response.output_text.trim();
                    }
                    
                    // Variante 2: response.output[].content[].text (structure complÃ¨te)
                    if (response.output && Array.isArray(response.output) && response.output.length > 0) {
                        let fullText = "";
                        
                        for (const outputItem of response.output) {
                            if (outputItem.content && Array.isArray(outputItem.content)) {
                                for (const contentBlock of outputItem.content) {
                                    // Type "output_text" ou "text"
                                    if ((contentBlock.type === 'output_text' || contentBlock.type === 'text') && contentBlock.text) {
                                        fullText += contentBlock.text;
                                    }
                                }
                            }
                        }
                        
                        if (fullText.trim()) {
                            console.log('[PARSER] âœ… Format: output[].content[] (Responses API)');
                            
                            // âš ï¸ VÃ©rifier si rÃ©ponse incomplÃ¨te
                            if (response.status === 'incomplete') {
                                console.warn('[PARSER] âš ï¸ RÃ‰PONSE INCOMPLÃˆTE (status: incomplete) - Augmenter max_output_tokens');
                            }
                            
                            return fullText.trim();
                        }
                    }
                    
                    // ğŸ§± ANCIEN FORMAT: Chat Completions (gpt-4o-mini, gpt-4, etc.)
                    // Structure: { choices: [{ message: { content: "..." } }] }
                    if (response.choices && Array.isArray(response.choices) && response.choices.length > 0) {
                        const content = response.choices[0].message?.content;
                        if (content) {
                            console.log('[PARSER] âœ… Format: choices[].message (Chat Completions)');
                            return content.trim();
                        }
                    }
                    
                    // âŒ Format inconnu - Log dÃ©taillÃ© pour debug
                    console.error('[PARSER] âŒ Format de rÃ©ponse OpenAI inconnu');
                    console.error('[PARSER] Response keys:', Object.keys(response));
                    console.error('[PARSER] Response sample:', JSON.stringify(response).substring(0, 500));
                    
                    throw new Error('Format de rÃ©ponse OpenAI non reconnu (ni output ni choices)');
                }
                
                // Format OpenAI-compatible (OpenAI, DeepSeek, Groq)
                if (['openai', 'deepseek', 'groq'].includes(provider)) {
                    // âœ… PARSER UNIVERSEL: Support Responses API + Chat Completions
                    const text = extractOpenAIText(response);
                    
                    // Auto-nettoyage JSON sÃ©curisÃ©
                    let cleaned = text.replace(/```json\n?/g, '').replace(/```\n?/g, '').trim();
                    
                    try {
                        return {
                            text,
                            json: JSON.parse(cleaned),
                            usage: response.usage,
                            model: response.model
                        };
                    } catch (e) {
                        return {
                            text,
                            json: null,
                            usage: response.usage,
                            model: response.model
                        };
                    }
                }
                
                return response;
            }
            
            // â•â•â• COST ESTIMATION â•â•â•
            
            estimateCost(provider, model, inputTokens, outputTokens) {
                const pricing = {
                    anthropic: {
                        'claude-sonnet-4-5-20250929': { input: 3, output: 15 },
                        'claude-opus-4-5-20251101': { input: 15, output: 75 },
                        'claude-haiku-4-5-20251001': { input: 0.8, output: 4 },
                        'claude-sonnet-4-20250514': { input: 3, output: 15 },
                        'claude-opus-4-1-20250805': { input: 15, output: 75 }
                    },
                    openai: {
                        'gpt-5.2': { input: 12, output: 50 },
                        'gpt-5.2-chat-latest': { input: 12, output: 50 },
                        'gpt-5.2-pro': { input: 20, output: 80 },
                        'gpt-5.2-pro-2025-12-11': { input: 20, output: 80 },
                        'gpt-5': { input: 8, output: 35 },
                        'gpt-5-chat-latest': { input: 8, output: 35 },
                        'gpt-5-pro': { input: 15, output: 60 },
                        'gpt-5-pro-2025-10-06': { input: 15, output: 60 },
                        'gpt-4.1': { input: 5, output: 20 },
                        'gpt-4.1-mini': { input: 0.5, output: 2 },
                        'gpt-4.1-nano': { input: 0.1, output: 0.4 },
                        'gpt-4o': { input: 2.5, output: 10 },
                        'gpt-4o-mini': { input: 0.15, output: 0.6 },
                        'o1': { input: 15, output: 60 }
                    },
                    deepseek: {
                        'deepseek-chat': { input: 0.27, output: 1.10 },
                        'deepseek-reasoner': { input: 0.55, output: 2.19 }
                    },
                    groq: {
                        'llama-3.3-70b-versatile': { input: 0, output: 0 },
                        'llama-3.1-70b-versatile': { input: 0, output: 0 },
                        'mixtral-8x7b-32768': { input: 0, output: 0 }
                    }
                };
                
                const rates = pricing[provider]?.[model];
                if (!rates) return { cost: 0, currency: 'USD' };
                
                const cost = (inputTokens / 1000000 * rates.input) + (outputTokens / 1000000 * rates.output);
                
                return {
                    cost: cost.toFixed(4),
                    currency: 'USD',
                    breakdown: {
                        input: (inputTokens / 1000000 * rates.input).toFixed(4),
                        output: (outputTokens / 1000000 * rates.output).toFixed(4)
                    }
                };
            }
        }
        
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // ENSEMBLE MANAGER - Multi-LLM Parallel Processing
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        
        class EnsembleManager {
            constructor(multiLLM) {
                this.multiLLM = multiLLM;
                
                // âœ… Rate Limits Management - Intelligent delays
                this.delay = (ms) => new Promise(resolve => setTimeout(resolve, ms));
                this.rateLimitConfig = {
                    anthropic: 3000,  // 3s between Anthropic calls
                    openai: 2000,     // 2s between OpenAI calls  
                    groq: 4000        // 4s between Groq calls
                };
                this.lastCallTimes = {};
                
                // Task assignments with provider priorities and fallbacks
                this.taskAssignments = {
                    'structure_hierarchique': [
                        { provider: 'groq', model: 'llama-3.3-70b-versatile' },
                        { provider: 'anthropic', model: 'claude-sonnet-4-20250514' }
                    ],
                    'index_conceptuel': [
                        { provider: 'openai', model: 'gpt-5.2' },  // Premium - Meilleure extraction concepts
                        { provider: 'anthropic', model: 'claude-sonnet-4-20250514' },
                        { provider: 'openai', model: 'gpt-5' },
                        { provider: 'openai', model: 'gpt-4o' }
                    ],
                    'contenu_enrichi': [
                        { provider: 'openai', model: 'gpt-5.2' },  // Premium - Enrichissement approfondi
                        { provider: 'anthropic', model: 'claude-sonnet-4-20250514' },
                        { provider: 'openai', model: 'gpt-5' },
                        { provider: 'openai', model: 'gpt-4o' }
                    ],
                    'graphe_connaissances': [
                        { provider: 'anthropic', model: 'claude-haiku-4-5-20251001' },
                        { provider: 'openai', model: 'gpt-4.1' },
                        { provider: 'anthropic', model: 'claude-sonnet-4-20250514' }
                    ],
                    'taxonomie': [
                        { provider: 'openai', model: 'gpt-4.1-mini' },
                        { provider: 'openai', model: 'gpt-4o-mini' },
                        { provider: 'groq', model: 'llama-3.3-70b-versatile' }
                    ],
                    'glossaire': [
                        { provider: 'anthropic', model: 'claude-sonnet-4-20250514' },
                        { provider: 'openai', model: 'gpt-5' },  // GPT-5 pour glossaire prÃ©cis
                        { provider: 'openai', model: 'gpt-4.1' },
                        { provider: 'openai', model: 'gpt-4o' }
                    ]
                };
                
                console.log('[Ensemble] Manager initialized');
                console.log('[Ensemble] 6 tasks configured with fallback chains');
            }
            
            async processDocument(documentText, options = {}) {
                console.log('[Ensemble] ğŸš€ Starting SEQUENTIAL processing (rate limit optimized)...');
                
                const tasks = Object.keys(this.taskAssignments);
                const results = {};
                const totalTasks = tasks.length;
                
                // âœ… AFFICHER SABLIER DISCRET
                showProcessingLoader('ğŸš€ Mode ENSEMBLE : DÃ©marrage du traitement sÃ©quentiel...', {
                    percent: 0,
                    text: `0/${totalTasks} tÃ¢ches complÃ©tÃ©es`
                });
                
                // âœ… SEQUENTIAL processing with intelligent delays to avoid rate limits
                for (let i = 0; i < tasks.length; i++) {
                    const task = tasks[i];
                    const taskNumber = i + 1;
                    
                    try {
                        // Mettre Ã  jour le sablier pour la tÃ¢che en cours
                        showProcessingLoader(`âš™ï¸ Traitement: ${task}`, {
                            percent: Math.round((i / totalTasks) * 100),
                            text: `${i}/${totalTasks} tÃ¢ches complÃ©tÃ©es`
                        });
                        
                        console.log(`[Ensemble] ğŸ”„ Processing task: ${task}`);
                        
                        const result = await this.executeTask(task, documentText, options);
                        results[task] = result;
                        
                        console.log(`[Ensemble] âœ“ Task ${task} completed (${result.provider})`);
                        
                        // Mettre Ã  jour progression aprÃ¨s succÃ¨s
                        showProcessingLoader(`âœ… TerminÃ©: ${task} (${result.provider})`, {
                            percent: Math.round(((i + 1) / totalTasks) * 100),
                            text: `${taskNumber}/${totalTasks} tÃ¢ches complÃ©tÃ©es`
                        });
                        
                        // âœ… Smart delay based on provider used (sauf pour la derniÃ¨re tÃ¢che)
                        if (i < tasks.length - 1) {
                            const delay = this.rateLimitConfig[result.provider] || 2000;
                            
                            // Afficher countdown pendant le dÃ©lai
                            showProcessingLoader(`â³ Attente ${delay/1000}s avant prochaine tÃ¢che...`, {
                                percent: Math.round(((i + 1) / totalTasks) * 100),
                                text: `${taskNumber}/${totalTasks} tÃ¢ches complÃ©tÃ©es - Pause rate limits`
                            });
                            
                            console.log(`[Ensemble] â³ Waiting ${delay}ms before next task...`);
                            await this.delay(delay);
                        }
                        
                    } catch (error) {
                        console.error(`[Ensemble] âœ— Task ${task} failed:`, error);
                        results[task] = { error: error.message, status: 'failed' };
                        
                        // Afficher erreur
                        showProcessingLoader(`âŒ Ã‰chec: ${task} - ${error.message}`, {
                            percent: Math.round(((i + 1) / totalTasks) * 100),
                            text: `${taskNumber}/${totalTasks} tÃ¢ches (erreur)`
                        });
                        
                        // âœ… Even on failure, wait before next task
                        if (i < tasks.length - 1) {
                            await this.delay(1000);
                        }
                    }
                }
                
                // âœ… FINAL SUCCESS
                showProcessingLoader(`ğŸ‰ ENSEMBLE terminÃ© avec succÃ¨s !`, {
                    percent: 100,
                    text: `${totalTasks}/${totalTasks} tÃ¢ches complÃ©tÃ©es - Fusion en cours...`
                });
                
                console.log('[Ensemble] âœ… All tasks completed');
                return this.mergeResults(results);
            }
            
            async executeTask(taskName, documentText, options) {
                const providers = this.taskAssignments[taskName];
                let lastError = null;
                
                // Try each provider in priority order (fallback chain)
                for (const providerConfig of providers) {
                    const { provider, model } = providerConfig;
                    
                    // âœ… MODE WORKER : Skip check clÃ©s API (workers cÃ´tÃ© serveur)
                    if (!options.useWorker) {
                        // Check if API key is configured (mode user_keys seulement)
                        if (!this.multiLLM.getUserKey(provider)) {
                            console.log(`[Ensemble] âš ï¸ ${provider} key not configured for ${taskName}, trying next...`);
                            continue;
                        }
                    }
                    
                    try {
                        console.log(`[Ensemble] â†’ ${taskName}: trying ${provider}...`);
                        
                        const prompt = this.generatePrompt(taskName, documentText);
                        
                        let result;
                        if (options.useWorker) {
                            // âœ… NOUVEAU: Mode Worker ENSEMBLE  
                            console.log(`[Ensemble] ğŸ”„ Using Worker for ${provider}`);
                            result = await this.multiLLM.callViaWorker(provider, model, prompt, 32000, 0.3);
                        } else {
                            // Mode classique avec clÃ©s utilisateur
                            result = await this.multiLLM.sendPrompt(prompt, {
                                provider,
                                model,
                                max_tokens: 32000,
                                temperature: 0.3
                            });
                        }
                        
                        return {
                            provider,
                            model,
                            data: result.json || result.text,
                            usage: result.usage,
                            status: 'success'
                        };
                        
                    } catch (error) {
                        console.error(`[Ensemble] âœ— ${provider} failed for ${taskName}:`, error.message);
                        lastError = error;
                        // Continue to next provider in fallback chain
                    }
                }
                
                // All providers failed
                throw new Error(`All providers failed for task "${taskName}": ${lastError?.message || 'Unknown error'}`);
            }
            
            generatePrompt(taskName, documentText) {
                // Truncate to first 15K chars for KB analysis
                const truncated = documentText.substring(0, 15000);
                
                const prompts = {
                    'structure_hierarchique': `Tu es un expert en analyse de livres et documents thÃ©rapeutiques. Analyse la structure hiÃ©rarchique complÃ¨te de ce document.

DOCUMENT Ã€ ANALYSER:
${truncated}

EXTRAIT REQUIS - FORMAT JSON STRICT:
{
  "metadata": {
    "titre": "Titre exact du livre/document",
    "auteur": "Nom de l'auteur",
    "pages": nombre_total_pages,
    "langue": "fr"
  },
  "chapitres": [
    {
      "numero": 1,
      "titre": "Titre du chapitre",
      "sections": ["Section 1", "Section 2"],
      "page_debut": 10,
      "page_fin": 25
    }
  ],
  "organisation": {
    "parties": ["Partie 1", "Partie 2"],
    "structure": "Description de l'organisation globale"
  }
}

Return ONLY valid JSON, no preamble.`,
                    
                    'index_conceptuel': `Tu es un expert en indexation de concepts thÃ©rapeutiques. Extrait l'index conceptuel complet de ce document.

DOCUMENT Ã€ ANALYSER:
${truncated}

EXTRAIT REQUIS - FORMAT JSON STRICT:
{
  "concepts_cles": [
    {
      "terme": "Concept principal",
      "definition": "DÃ©finition claire et concise",
      "synonymes": ["terme1", "terme2"],
      "chapitres": [1, 3, 5]
    }
  ],
  "themes_principaux": [
    {
      "theme": "ThÃ¨me majeur",
      "description": "Description du thÃ¨me",
      "concepts_associes": ["concept1", "concept2"]
    }
  ],
  "terminologie_specifique": {
    "terme_technique": "Explication",
    "concept_clinique": "DÃ©finition clinique"
  }
}

Return ONLY valid JSON, no preamble.`,
                    
                    'contenu_enrichi': `Tu es un expert en extraction de contenu pÃ©dagogique. Extrait tous les exercices, Ã©tudes de cas, outils pratiques et exemples concrets.

DOCUMENT Ã€ ANALYSER:
${truncated}

EXTRAIT REQUIS - FORMAT JSON STRICT:
{
  "exercices": [
    {
      "numero": 1,
      "titre": "Titre de l'exercice",
      "description": "Description complÃ¨te",
      "objectif": "Objectif pÃ©dagogique",
      "duree": "15 minutes",
      "chapitre": 2
    }
  ],
  "etudes_cas": [
    {
      "titre": "Titre du cas",
      "contexte": "Contexte dÃ©taillÃ©",
      "problematique": "ProblÃ¨me central",
      "resolution": "Approche de rÃ©solution",
      "apprentissage": "LeÃ§ons clÃ©s"
    }
  ],
  "outils_pratiques": [
    {
      "nom": "Nom de l'outil",
      "type": "questionnaire/grille/schema",
      "usage": "Comment l'utiliser",
      "benefices": "Avantages cliniques"
    }
  ],
  "exemples": [
    {
      "contexte": "Situation concrÃ¨te",
      "illustration": "Exemple dÃ©taillÃ©"
    }
  ]
}

Return ONLY valid JSON, no preamble.`,
                    
                    'graphe_connaissances': `Tu es un expert en cartographie conceptuelle. CrÃ©e un graphe de connaissances montrant les relations entre tous les concepts.

DOCUMENT Ã€ ANALYSER:
${truncated}

EXTRAIT REQUIS - FORMAT JSON STRICT:
{
  "nodes": [
    {
      "id": "concept_1",
      "label": "Nom du concept",
      "type": "concept_principal/theme/technique",
      "description": "Description brÃ¨ve",
      "importance": "haute/moyenne/basse"
    }
  ],
  "edges": [
    {
      "source": "concept_1",
      "target": "concept_2",
      "relation": "cause/prerequis/complement/illustre",
      "force": 0.8
    }
  ],
  "clusters": [
    {
      "nom": "Groupe thÃ©matique",
      "concepts": ["concept_1", "concept_2"]
    }
  ]
}

Return ONLY valid JSON, no preamble.`,
                    
                    'taxonomie': `Tu es un expert en classification du savoir thÃ©rapeutique. CrÃ©e une taxonomie complÃ¨te du document.

DOCUMENT Ã€ ANALYSER:
${truncated}

EXTRAIT REQUIS - FORMAT JSON STRICT:
{
  "domaine_principal": "ThÃ©rapie de couple",
  "sous_domaines": [
    {
      "nom": "Communication",
      "categories": ["Ã‰coute active", "Expression Ã©motionnelle"],
      "approches": ["Approche 1", "Approche 2"]
    }
  ],
  "niveau_expertise": "dÃ©butant/intermÃ©diaire/avancÃ©",
  "public_cible": ["thÃ©rapeutes", "couples"],
  "applications": [
    {
      "contexte": "Situation clinique",
      "methodes": ["MÃ©thode 1", "MÃ©thode 2"]
    }
  ],
  "references_theoriques": [
    {
      "auteur": "John Gottman",
      "theorie": "ThÃ©orie des quatre cavaliers",
      "application": "Usage dans le document"
    }
  ]
}

Return ONLY valid JSON, no preamble.`,
                    
                    'glossaire': `Tu es un expert en lexicographie thÃ©rapeutique. CrÃ©e un glossaire exhaustif avec toutes les dÃ©finitions clÃ©s.

DOCUMENT Ã€ ANALYSER:
${truncated}

EXTRAIT REQUIS - FORMAT JSON STRICT:
{
  "glossaire": [
    {
      "terme": "Terme technique",
      "definition": "DÃ©finition complÃ¨te et claire",
      "contexte_usage": "Comment et oÃ¹ c'est utilisÃ©",
      "exemple": "Exemple d'utilisation",
      "voir_aussi": ["terme_lie_1", "terme_lie_2"]
    }
  ],
  "acronymes": {
    "TCC": "ThÃ©rapie Cognitivo-Comportementale"
  },
  "expressions_cles": [
    {
      "expression": "Expression idiomatique",
      "signification": "Sens dans le contexte",
      "origine": "Origine thÃ©orique si applicable"
    }
  ]
}

Return ONLY valid JSON, no preamble.`
                };
                
                return prompts[taskName] || truncated;
            }
            
            mergeResults(results) {
                console.log('[KB Engine] ğŸ”„ Merging results into Knowledge Base format...');
                
                const completed = Object.keys(results).filter(k => results[k].status !== 'failed');
                const failed = Object.keys(results).filter(k => results[k].status === 'failed');
                
                // Parse JSON from each task
                const parsedData = {};
                for (const taskName of completed) {
                    try {
                        const content = results[taskName]?.data; // âœ… CORRIGÃ‰: data au lieu de content
                        
                        // âœ… SÃ‰CURITÃ‰: VÃ©rifier que content existe
                        if (!content) {
                            console.warn(`[KB Engine] No data for ${taskName}:`, results[taskName]);
                            parsedData[taskName] = { raw: 'Aucune donnÃ©e retournÃ©e' };
                            continue;
                        }
                        
                        // âœ… Si c'est dÃ©jÃ  un objet JSON parsÃ©, l'utiliser directement
                        if (typeof content === 'object' && content !== null) {
                            parsedData[taskName] = content;
                            continue;
                        }
                        
                        // âœ… Si c'est une string, essayer de parser le JSON
                        if (typeof content === 'string') {
                            // Try to extract JSON from response
                            const jsonMatch = content.match(/\{[\s\S]*\}/);
                            if (jsonMatch) {
                                parsedData[taskName] = JSON.parse(jsonMatch[0]);
                            } else {
                                parsedData[taskName] = { raw: content };
                            }
                            continue;
                        }
                        
                        // âœ… Fallback pour autres types
                        parsedData[taskName] = { raw: String(content) };
                        
                    } catch (e) {
                        console.warn(`[KB Engine] Failed to parse JSON for ${taskName}:`, e);
                        parsedData[taskName] = { raw: results[taskName]?.data || 'Erreur de parsing' };
                    }
                }
                
                // Build knowledge_index.json structure (32 modules)
                const knowledgeIndex = this.buildKnowledgeIndex(parsedData, results);
                
                return {
                    merged: true,
                    timestamp: new Date().toISOString(),
                    format: 'knowledge_base',
                    knowledge_index: knowledgeIndex,
                    tasks: results,
                    summary: {
                        completed: completed.length,
                        failed: failed.length,
                        total: Object.keys(results).length,
                        successRate: ((completed.length / Object.keys(results).length) * 100).toFixed(1) + '%'
                    },
                    metadata: {
                        providers_used: [...new Set(completed.map(k => results[k].provider))],
                        total_tokens: completed.reduce((sum, k) => {
                            const usage = results[k].usage || {};
                            return sum + (usage.input_tokens || 0) + (usage.output_tokens || 0);
                        }, 0)
                    }
                };
            }
            
            buildKnowledgeIndex(parsedData, results) {
                // Extract metadata
                const metadata = parsedData.structure_hierarchique?.metadata || {};
                
                // Build 32-module knowledge base
                return {
                    "version": "6.7.0",
                    "generated_at": new Date().toISOString(),
                    "document": {
                        "titre": metadata.titre || "Document sans titre",
                        "auteur": metadata.auteur || "Auteur inconnu",
                        "pages": metadata.pages || 0,
                        "langue": metadata.langue || "fr"
                    },
                    
                    // Module 1: MÃ©tadonnÃ©es gÃ©nÃ©rales
                    "metadonnees": metadata,
                    
                    // Module 2: Structure hiÃ©rarchique
                    "structure": parsedData.structure_hierarchique || {},
                    
                    // Module 3: Chapitres dÃ©taillÃ©s
                    "chapitres": parsedData.structure_hierarchique?.chapitres || [],
                    
                    // Module 4: Index conceptuel
                    "index_conceptuel": parsedData.index_conceptuel?.concepts_cles || [],
                    
                    // Module 5: ThÃ¨mes principaux
                    "themes": parsedData.index_conceptuel?.themes_principaux || [],
                    
                    // Module 6: Terminologie spÃ©cifique
                    "terminologie": parsedData.index_conceptuel?.terminologie_specifique || {},
                    
                    // Module 7: Exercices pratiques
                    "exercices": parsedData.contenu_enrichi?.exercices || [],
                    
                    // Module 8: Ã‰tudes de cas
                    "etudes_cas": parsedData.contenu_enrichi?.etudes_cas || [],
                    
                    // Module 9: Outils pratiques
                    "outils": parsedData.contenu_enrichi?.outils_pratiques || [],
                    
                    // Module 10: Exemples concrets
                    "exemples": parsedData.contenu_enrichi?.exemples || [],
                    
                    // Module 11: Graphe de connaissances (nodes)
                    "graphe_nodes": parsedData.graphe_connaissances?.nodes || [],
                    
                    // Module 12: Graphe de connaissances (edges)
                    "graphe_edges": parsedData.graphe_connaissances?.edges || [],
                    
                    // Module 13: Clusters conceptuels
                    "clusters": parsedData.graphe_connaissances?.clusters || [],
                    
                    // Module 14: Taxonomie - Domaine principal
                    "domaine": parsedData.taxonomie?.domaine_principal || "",
                    
                    // Module 15: Taxonomie - Sous-domaines
                    "sous_domaines": parsedData.taxonomie?.sous_domaines || [],
                    
                    // Module 16: Niveau d'expertise requis
                    "niveau_expertise": parsedData.taxonomie?.niveau_expertise || "intermÃ©diaire",
                    
                    // Module 17: Public cible
                    "public_cible": parsedData.taxonomie?.public_cible || [],
                    
                    // Module 18: Applications cliniques
                    "applications": parsedData.taxonomie?.applications || [],
                    
                    // Module 19: RÃ©fÃ©rences thÃ©oriques
                    "references_theoriques": parsedData.taxonomie?.references_theoriques || [],
                    
                    // Module 20: Glossaire principal
                    "glossaire": parsedData.glossaire?.glossaire || [],
                    
                    // Module 21: Acronymes
                    "acronymes": parsedData.glossaire?.acronymes || {},
                    
                    // Module 22: Expressions clÃ©s
                    "expressions_cles": parsedData.glossaire?.expressions_cles || [],
                    
                    // Module 23: Bibliographie (si dÃ©tectÃ©e)
                    "bibliographie": [],
                    
                    // Module 24: Index alphabÃ©tique (gÃ©nÃ©rÃ©)
                    "index_alphabetique": this.generateAlphabeticIndex(parsedData),
                    
                    // Module 25: Statistiques du document
                    "statistiques": this.generateStatistics(parsedData),
                    
                    // Module 26: Chemins d'apprentissage suggÃ©rÃ©s
                    "chemins_apprentissage": this.generateLearningPaths(parsedData),
                    
                    // Module 27: Relations inter-chapitres
                    "relations_chapitres": this.generateChapterRelations(parsedData),
                    
                    // Module 28: Points clÃ©s par chapitre
                    "points_cles": this.generateKeyPoints(parsedData),
                    
                    // Module 29: Questions de rÃ©flexion
                    "questions_reflexion": this.generateReflectionQuestions(parsedData),
                    
                    // Module 30: Ressources complÃ©mentaires
                    "ressources_complementaires": [],
                    
                    // Module 31: Cartes mentales suggÃ©rÃ©es
                    "cartes_mentales": this.generateMindMapSuggestions(parsedData),
                    
                    // Module 32: MÃ©ta-analyse
                    "meta_analyse": {
                        "generation_info": {
                            "provider": results[Object.keys(results)[0]]?.provider || "ensemble",
                            "model": results[Object.keys(results)[0]]?.model || "multi-llm",
                            "timestamp": new Date().toISOString(),
                            "tasks_completed": Object.keys(results).filter(k => results[k].status !== 'failed').length,
                            "total_tasks": Object.keys(results).length
                        }
                    }
                };
            }
            
            generateAlphabeticIndex(parsedData) {
                const index = {};
                const concepts = parsedData.index_conceptuel?.concepts_cles || [];
                const glossaire = parsedData.glossaire?.glossaire || [];
                
                [...concepts, ...glossaire].forEach(item => {
                    const terme = item.terme || item.term;
                    if (terme) {
                        const letter = terme[0].toUpperCase();
                        if (!index[letter]) index[letter] = [];
                        index[letter].push({
                            terme: terme,
                            type: item.definition ? 'concept' : 'glossaire',
                            reference: item.chapitres || []
                        });
                    }
                });
                
                return index;
            }
            
            generateStatistics(parsedData) {
                return {
                    nombre_chapitres: (parsedData.structure_hierarchique?.chapitres || []).length,
                    nombre_concepts: (parsedData.index_conceptuel?.concepts_cles || []).length,
                    nombre_exercices: (parsedData.contenu_enrichi?.exercices || []).length,
                    nombre_etudes_cas: (parsedData.contenu_enrichi?.etudes_cas || []).length,
                    nombre_outils: (parsedData.contenu_enrichi?.outils_pratiques || []).length,
                    nombre_themes: (parsedData.index_conceptuel?.themes_principaux || []).length,
                    densite_conceptuelle: ((parsedData.index_conceptuel?.concepts_cles || []).length / Math.max((parsedData.structure_hierarchique?.chapitres || []).length, 1)).toFixed(2)
                };
            }
            
            generateLearningPaths(parsedData) {
                const chapters = parsedData.structure_hierarchique?.chapitres || [];
                if (chapters.length === 0) return [];
                
                return [
                    {
                        nom: "Parcours sÃ©quentiel complet",
                        description: "Suivre tous les chapitres dans l'ordre",
                        chapitres: chapters.map(ch => ch.numero),
                        duree_estimee: `${chapters.length * 60} minutes`
                    },
                    {
                        nom: "Parcours fondamentaux",
                        description: "Chapitres essentiels uniquement",
                        chapitres: chapters.slice(0, Math.ceil(chapters.length / 2)).map(ch => ch.numero),
                        duree_estimee: `${Math.ceil(chapters.length / 2) * 60} minutes`
                    }
                ];
            }
            
            generateChapterRelations(parsedData) {
                const chapters = parsedData.structure_hierarchique?.chapitres || [];
                const edges = parsedData.graphe_connaissances?.edges || [];
                
                return chapters.map(ch => ({
                    chapitre: ch.numero,
                    titre: ch.titre,
                    prerequis: ch.numero > 1 ? [ch.numero - 1] : [],
                    connexions: edges.filter(e => e.source.includes(String(ch.numero))).length,
                    themes_abordes: []
                }));
            }
            
            generateKeyPoints(parsedData) {
                const chapters = parsedData.structure_hierarchique?.chapitres || [];
                const concepts = parsedData.index_conceptuel?.concepts_cles || [];
                
                return chapters.map(ch => ({
                    chapitre: ch.numero,
                    titre: ch.titre,
                    points_cles: concepts
                        .filter(c => (c.chapitres || []).includes(ch.numero))
                        .map(c => c.terme)
                        .slice(0, 5)
                }));
            }
            
            generateReflectionQuestions(parsedData) {
                const themes = parsedData.index_conceptuel?.themes_principaux || [];
                
                return themes.map(theme => ({
                    theme: theme.theme,
                    questions: [
                        `Comment appliquer ${theme.theme} dans votre pratique ?`,
                        `Quels sont les dÃ©fis liÃ©s Ã  ${theme.theme} ?`,
                        `Quelles sont vos expÃ©riences avec ${theme.theme} ?`
                    ]
                }));
            }
            
            generateMindMapSuggestions(parsedData) {
                const themes = parsedData.index_conceptuel?.themes_principaux || [];
                const clusters = parsedData.graphe_connaissances?.clusters || [];
                
                return [
                    {
                        titre: "Carte conceptuelle principale",
                        centre: themes[0]?.theme || "Concepts principaux",
                        branches: themes.map(t => t.theme),
                        type: "radial"
                    },
                    {
                        titre: "Organisation par clusters",
                        elements: clusters.map(c => c.nom),
                        type: "hierarchique"
                    }
                ];
            }
            
            // AUTO-GENERATORS FOR FILES
            generateKnowledgeMD(knowledgeIndex) {
                console.log('[KB Engine] ğŸ“ Generating knowledge.md...');
                
                let md = `# ${knowledgeIndex.document.titre}\n\n`;
                md += `**Auteur:** ${knowledgeIndex.document.auteur}  \n`;
                md += `**Pages:** ${knowledgeIndex.document.pages}  \n`;
                md += `**Langue:** ${knowledgeIndex.document.langue}  \n\n`;
                md += `**GÃ©nÃ©rÃ© le:** ${new Date(knowledgeIndex.generated_at).toLocaleString('fr-FR')}  \n`;
                md += `**Version:** ${knowledgeIndex.version}\n\n`;
                md += `---\n\n`;
                
                // Structure
                md += `## ğŸ“š Structure du Document\n\n`;
                (knowledgeIndex.chapitres || []).forEach(ch => {
                    md += `### ${ch.numero}. ${ch.titre}\n`;
                    if (ch.sections && ch.sections.length > 0) {
                        md += `**Sections:** ${ch.sections.join(', ')}  \n`;
                    }
                    md += `**Pages:** ${ch.page_debut} - ${ch.page_fin}\n\n`;
                });
                
                // Index Conceptuel
                md += `## ğŸ§  Index Conceptuel\n\n`;
                (knowledgeIndex.index_conceptuel || []).forEach(concept => {
                    md += `### ${concept.terme}\n`;
                    md += `${concept.definition}\n\n`;
                    if (concept.synonymes && concept.synonymes.length > 0) {
                        md += `**Synonymes:** ${concept.synonymes.join(', ')}  \n`;
                    }
                    if (concept.chapitres && concept.chapitres.length > 0) {
                        md += `**Chapitres:** ${concept.chapitres.join(', ')}  \n`;
                    }
                    md += `\n`;
                });
                
                // ThÃ¨mes Principaux
                md += `## ğŸ¯ ThÃ¨mes Principaux\n\n`;
                (knowledgeIndex.themes || []).forEach(theme => {
                    md += `### ${theme.theme}\n`;
                    md += `${theme.description}\n\n`;
                    if (theme.concepts_associes && theme.concepts_associes.length > 0) {
                        md += `**Concepts associÃ©s:** ${theme.concepts_associes.join(', ')}  \n\n`;
                    }
                });
                
                // Exercices
                if (knowledgeIndex.exercices && knowledgeIndex.exercices.length > 0) {
                    md += `## ğŸ’ª Exercices Pratiques\n\n`;
                    knowledgeIndex.exercices.forEach(ex => {
                        md += `### Exercice ${ex.numero}: ${ex.titre}\n`;
                        md += `${ex.description}\n\n`;
                        md += `**Objectif:** ${ex.objectif}  \n`;
                        md += `**DurÃ©e:** ${ex.duree}  \n`;
                        md += `**Chapitre:** ${ex.chapitre}\n\n`;
                    });
                }
                
                // Ã‰tudes de Cas
                if (knowledgeIndex.etudes_cas && knowledgeIndex.etudes_cas.length > 0) {
                    md += `## ğŸ“‹ Ã‰tudes de Cas\n\n`;
                    knowledgeIndex.etudes_cas.forEach(cas => {
                        md += `### ${cas.titre}\n`;
                        md += `**Contexte:** ${cas.contexte}\n\n`;
                        md += `**ProblÃ©matique:** ${cas.problematique}\n\n`;
                        md += `**RÃ©solution:** ${cas.resolution}\n\n`;
                        md += `**Apprentissage:** ${cas.apprentissage}\n\n`;
                    });
                }
                
                // Glossaire
                md += `## ğŸ“– Glossaire\n\n`;
                (knowledgeIndex.glossaire || []).forEach(entry => {
                    md += `**${entry.terme}**: ${entry.definition}\n\n`;
                });
                
                // Statistiques
                md += `## ğŸ“Š Statistiques\n\n`;
                const stats = knowledgeIndex.statistiques || {};
                md += `- **Chapitres:** ${stats.nombre_chapitres || 0}\n`;
                md += `- **Concepts:** ${stats.nombre_concepts || 0}\n`;
                md += `- **Exercices:** ${stats.nombre_exercices || 0}\n`;
                md += `- **Ã‰tudes de cas:** ${stats.nombre_etudes_cas || 0}\n`;
                md += `- **Outils:** ${stats.nombre_outils || 0}\n`;
                md += `- **DensitÃ© conceptuelle:** ${stats.densite_conceptuelle || 0} concepts/chapitre\n\n`;
                
                md += `---\n\n`;
                md += `*Base de connaissances gÃ©nÃ©rÃ©e par OCR Universel V6.7.0 KB ENGINE*\n`;
                
                return md;
            }
            
            generateREADME(knowledgeIndex, originalFileName, provider, model) {
                console.log('[KB Engine] ğŸ“„ Generating README.md...');
                
                let readme = `# Base de Connaissances: ${knowledgeIndex.document.titre}\n\n`;
                readme += `## ğŸ“‹ Information du Document\n\n`;
                readme += `- **Titre:** ${knowledgeIndex.document.titre}\n`;
                readme += `- **Auteur:** ${knowledgeIndex.document.auteur}\n`;
                readme += `- **Pages:** ${knowledgeIndex.document.pages}\n`;
                readme += `- **Langue:** ${knowledgeIndex.document.langue}\n`;
                readme += `- **Fichier original:** ${originalFileName}\n\n`;
                
                readme += `## ğŸ¤– GÃ©nÃ©ration\n\n`;
                readme += `- **Date:** ${new Date(knowledgeIndex.generated_at).toLocaleString('fr-FR')}\n`;
                readme += `- **Outil:** OCR Universel V6.7.0 KB ENGINE\n`;
                readme += `- **Provider:** ${provider}\n`;
                readme += `- **ModÃ¨le:** ${model}\n`;
                readme += `- **Format:** Base de Connaissances (32 modules)\n\n`;
                
                readme += `## ğŸ“ Contenu du Package\n\n`;
                readme += `Ce ZIP contient 5 fichiers:\n\n`;
                readme += `1. **${originalFileName}** - Fichier EPUB original\n`;
                readme += `2. **knowledge_index.json** - Base de connaissances complÃ¨te (32 modules)\n`;
                readme += `3. **knowledge.md** - Version Markdown lisible\n`;
                readme += `4. **README.md** - Ce fichier\n`;
                readme += `5. **index.html** - Moteur de recherche interactif\n\n`;
                
                readme += `## ğŸ” Utilisation du Moteur de Recherche\n\n`;
                readme += `**Ouvrez \`index.html\` dans votre navigateur** pour accÃ©der au moteur de recherche avancÃ©:\n\n`;
                readme += `- **Recherche full-text** dans tous les modules\n`;
                readme += `- **Filtres multiples** (chapitres, concepts, exercices)\n`;
                readme += `- **Visualisation du graphe** de connaissances\n`;
                readme += `- **Export de sections** individuelles\n`;
                readme += `- **Navigation interactive** avec statistiques\n\n`;
                
                readme += `## ğŸ“Š Contenu Extrait\n\n`;
                const stats = knowledgeIndex.statistiques || {};
                readme += `- **${stats.nombre_chapitres || 0}** chapitres analysÃ©s\n`;
                readme += `- **${stats.nombre_concepts || 0}** concepts identifiÃ©s\n`;
                readme += `- **${stats.nombre_exercices || 0}** exercices pratiques\n`;
                readme += `- **${stats.nombre_etudes_cas || 0}** Ã©tudes de cas\n`;
                readme += `- **${stats.nombre_outils || 0}** outils pratiques\n`;
                readme += `- **${stats.nombre_themes || 0}** thÃ¨mes principaux\n\n`;
                
                readme += `## ğŸ—‚ï¸ Structure des 32 Modules\n\n`;
                readme += `Le fichier \`knowledge_index.json\` est organisÃ© en 32 modules:\n\n`;
                readme += `1. MÃ©tadonnÃ©es gÃ©nÃ©rales\n2. Structure hiÃ©rarchique\n3. Chapitres dÃ©taillÃ©s\n`;
                readme += `4. Index conceptuel\n5. ThÃ¨mes principaux\n6. Terminologie spÃ©cifique\n`;
                readme += `7. Exercices pratiques\n8. Ã‰tudes de cas\n9. Outils pratiques\n`;
                readme += `10. Exemples concrets\n11-13. Graphe de connaissances\n`;
                readme += `14-19. Taxonomie et applications\n20-22. Glossaire et expressions\n`;
                readme += `23-32. Analyses complÃ©mentaires\n\n`;
                
                readme += `## ğŸ’¡ Conseils d'Utilisation\n\n`;
                readme += `### Pour lire le contenu:\n`;
                readme += `- Ouvrez **knowledge.md** dans n'importe quel lecteur Markdown\n`;
                readme += `- Format structurÃ© et lisible avec tous les contenus clÃ©s\n\n`;
                
                readme += `### Pour explorer interactivement:\n`;
                readme += `- Ouvrez **index.html** dans votre navigateur\n`;
                readme += `- Utilisez la recherche pour trouver des concepts spÃ©cifiques\n`;
                readme += `- Explorez le graphe de connaissances visuellement\n\n`;
                
                readme += `### Pour intÃ©grer dans vos outils:\n`;
                readme += `- Utilisez **knowledge_index.json** comme source de donnÃ©es\n`;
                readme += `- Format JSON structurÃ© compatible avec la plupart des outils\n`;
                readme += `- Peut Ãªtre importÃ© dans des systÃ¨mes de gestion de connaissances\n\n`;
                
                readme += `## ğŸ› ï¸ Format Knowledge Base\n\n`;
                readme += `Le format Knowledge Base est conÃ§u pour:\n`;
                readme += `- PrÃ©server la structure originale du document\n`;
                readme += `- Enrichir avec des analyses conceptuelles\n`;
                readme += `- Faciliter la recherche et la navigation\n`;
                readme += `- Permettre l'export et la rÃ©utilisation\n\n`;
                
                readme += `## âš ï¸ Notes Importantes\n\n`;
                readme += `- Cette base de connaissances est gÃ©nÃ©rÃ©e automatiquement par IA\n`;
                readme += `- La prÃ©cision dÃ©pend de la qualitÃ© du document source\n`;
                readme += `- VÃ©rifiez toujours les informations critiques dans le document original\n`;
                readme += `- Les analyses sont basÃ©es sur les premiers 15K caractÃ¨res de chaque section\n\n`;
                
                readme += `## ğŸ“§ Support\n\n`;
                readme += `Pour toute question ou problÃ¨me avec ce package:\n`;
                readme += `- Consultez la documentation d'OCR Universel\n`;
                readme += `- VÃ©rifiez que vous utilisez un navigateur moderne pour index.html\n`;
                readme += `- Le fichier JSON peut Ãªtre ouvert avec n'importe quel Ã©diteur de texte\n\n`;
                
                readme += `---\n\n`;
                readme += `*GÃ©nÃ©rÃ© par **OCR Universel V6.7.0 KB ENGINE** - C CONCEPT&DEV*\n`;
                
                return readme;
            }
            
            generateIndexHTML(knowledgeIndex) {
                console.log('[KB Engine] ğŸ” Generating search engine (index.html)...');
                
                // ULTRA-SAFE VERSION: All quotes properly escaped
                var html = '<!DOCTYPE html>\n';
                html += '<html lang="fr">\n';
                html += '<head>\n';
                html += '<meta charset="UTF-8">\n';
                html += '<meta name="viewport" content="width=device-width, initial-scale=1.0">\n';
                html += '<title>' + knowledgeIndex.document.titre + ' - Base de Connaissances</title>\n';
                html += '<style>\n';
                html += '* { margin: 0; padding: 0; box-sizing: border-box; }\n';
                html += ':root { --primary: #8FAFB1; --secondary: #C8D0C3; --accent: #D8CDBB; --dark: #333; --light: #fff; }\n';
                html += 'body { font-family: Segoe UI, Tahoma, Geneva, Verdana, sans-serif; background: linear-gradient(135deg, var(--accent) 0%, var(--secondary) 100%); padding: 20px; line-height: 1.6; }\n';
                html += '.container { max-width: 1400px; margin: 0 auto; }\n';
                html += 'header { background: var(--light); padding: 30px; border-radius: 15px; margin-bottom: 20px; box-shadow: 0 5px 20px rgba(0,0,0,0.1); }\n';
                html += 'h1 { color: var(--primary); font-size: 2.5em; margin-bottom: 10px; }\n';
                html += '.subtitle { color: var(--dark); opacity: 0.7; }\n';
                html += '#searchBar { width: 100%; padding: 15px 20px; font-size: 1.1em; border: 2px solid #ddd; border-radius: 10px; margin: 20px 0; }\n';
                html += '#searchBar:focus { border-color: var(--primary); outline: none; box-shadow: 0 0 10px rgba(143, 175, 177, 0.2); }\n';
                html += '.stats-panel { background: var(--light); padding: 20px; border-radius: 15px; box-shadow: 0 5px 20px rgba(0,0,0,0.1); margin-bottom: 20px; }\n';
                html += '.stat-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px; }\n';
                html += '.stat-item { text-align: center; padding: 15px; background: var(--accent); border-radius: 10px; }\n';
                html += '.stat-value { font-size: 2em; color: var(--primary); font-weight: 700; }\n';
                html += '.stat-label { font-size: 0.9em; color: var(--dark); margin-top: 5px; }\n';
                html += '.results { background: var(--light); padding: 30px; border-radius: 15px; box-shadow: 0 5px 20px rgba(0,0,0,0.1); min-height: 400px; }\n';
                html += '.results-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; padding-bottom: 15px; border-bottom: 2px solid var(--secondary); }\n';
                html += '.result-item { padding: 20px; margin-bottom: 15px; border: 1px solid #ddd; border-radius: 10px; cursor: pointer; transition: all 0.3s ease; }\n';
                html += '.result-item:hover { border-color: var(--primary); box-shadow: 0 5px 15px rgba(143, 175, 177, 0.2); transform: translateY(-2px); }\n';
                html += '.result-title { font-size: 1.3em; color: var(--primary); margin-bottom: 10px; font-weight: 600; }\n';
                html += '.badge { display: inline-block; padding: 3px 8px; background: var(--secondary); border-radius: 12px; font-size: 0.75em; margin-left: 8px; }\n';
                html += '.result-content { color: var(--dark); margin-top: 10px; }\n';
                html += '.highlight { background: yellow; font-weight: 600; padding: 2px 4px; border-radius: 3px; }\n';
                html += '.no-results { text-align: center; padding: 60px 20px; color: var(--dark); opacity: 0.6; }\n';
                html += '<\/style>\n';
                html += '<\/head>\n';
                html += '<body>\n';
                html += '<div class="container">\n';
                html += '<header>\n';
                html += '<h1 id="docTitle"></h1>\n';
                html += '<div class="subtitle"><strong>Auteur:</strong> <span id="docAuthor"></span> | <strong>Pages:</strong> <span id="docPages"></span></div>\n';
                html += '</header>\n';
                html += '<div class="stats-panel"><div class="stat-grid" id="statsGrid"></div></div>\n';
                html += '<input type="search" id="searchBar" placeholder="Rechercher...">\n';
                html += '<div class="results"><div class="results-header"><div id="resultsCount">Chargement...</div></div><div id="resultsContainer"></div></div>\n';
                html += '</div>\n';
                html += '<script>\n';
                html += 'var kb = ' + JSON.stringify(knowledgeIndex) + ';\n';
                html += 'var searchQuery = "";\n';
                html += 'var allResults = [];\n';
                html += 'document.getElementById("docTitle").textContent = kb.document.titre;\n';
                html += 'document.getElementById("docAuthor").textContent = kb.document.auteur;\n';
                html += 'document.getElementById("docPages").textContent = kb.document.pages;\n';
                html += 'function initStats() {\n';
                html += '  var stats = kb.statistiques || {};\n';
                html += '  var grid = document.getElementById("statsGrid");\n';
                html += '  var items = [{label: "Chapitres", value: stats.nombre_chapitres || 0}, {label: "Concepts", value: stats.nombre_concepts || 0}, {label: "Exercices", value: stats.nombre_exercices || 0}, {label: "Outils", value: stats.nombre_outils || 0}];\n';
                html += '  var h = "";\n';
                html += '  for (var i = 0; i < items.length; i++) {\n';
                html += '    h += "<div class=\'stat-item\'><div class=\'stat-value\'>" + items[i].value + "</div><div class=\'stat-label\'>" + items[i].label + "</div></div>";\n';
                html += '  }\n';
                html += '  grid.innerHTML = h;\n';
                html += '}\n';
                html += 'function performSearch() {\n';
                html += '  allResults = [];\n';
                html += '  if (kb.index_conceptuel) {\n';
                html += '    for (var i = 0; i < kb.index_conceptuel.length; i++) {\n';
                html += '      var c = kb.index_conceptuel[i];\n';
                html += '      var txt = (c.terme || "") + " " + (c.definition || "");\n';
                html += '      if (!searchQuery || txt.toLowerCase().indexOf(searchQuery) > -1) {\n';
                html += '        allResults.push({type: "Concept", title: c.terme, content: c.definition});\n';
                html += '      }\n';
                html += '    }\n';
                html += '  }\n';
                html += '  if (kb.chapitres) {\n';
                html += '    for (var i = 0; i < kb.chapitres.length; i++) {\n';
                html += '      var ch = kb.chapitres[i];\n';
                html += '      if (!searchQuery || ch.titre.toLowerCase().indexOf(searchQuery) > -1) {\n';
                html += '        allResults.push({type: "Chapitre", title: "Chapitre " + ch.numero + ": " + ch.titre, content: "Pages " + ch.page_debut + "-" + ch.page_fin});\n';
                html += '      }\n';
                html += '    }\n';
                html += '  }\n';
                html += '  if (kb.exercices) {\n';
                html += '    for (var i = 0; i < kb.exercices.length; i++) {\n';
                html += '      var ex = kb.exercices[i];\n';
                html += '      var txt = (ex.titre || "") + " " + (ex.description || "");\n';
                html += '      if (!searchQuery || txt.toLowerCase().indexOf(searchQuery) > -1) {\n';
                html += '        allResults.push({type: "Exercice", title: "Exercice " + ex.numero + ": " + ex.titre, content: ex.description});\n';
                html += '      }\n';
                html += '    }\n';
                html += '  }\n';
                html += '  if (kb.glossaire) {\n';
                html += '    for (var i = 0; i < kb.glossaire.length; i++) {\n';
                html += '      var g = kb.glossaire[i];\n';
                html += '      var txt = (g.terme || "") + " " + (g.definition || "");\n';
                html += '      if (!searchQuery || txt.toLowerCase().indexOf(searchQuery) > -1) {\n';
                html += '        allResults.push({type: "Glossaire", title: g.terme, content: g.definition});\n';
                html += '      }\n';
                html += '    }\n';
                html += '  }\n';
                html += '  renderResults();\n';
                html += '}\n';
                html += 'function renderResults() {\n';
                html += '  var countEl = document.getElementById("resultsCount");\n';
                html += '  var container = document.getElementById("resultsContainer");\n';
                html += '  countEl.textContent = allResults.length + " rÃ©sultat" + (allResults.length > 1 ? "s" : "");\n';
                html += '  if (allResults.length === 0) {\n';
                html += '    container.innerHTML = "<div class=\'no-results\'><div style=\'font-size:3em;margin-bottom:20px;\'>ğŸ”</div><h3>Aucun rÃ©sultat trouvÃ©</h3></div>";\n';
                html += '    return;\n';
                html += '  }\n';
                html += '  var h = "";\n';
                html += '  for (var i = 0; i < allResults.length; i++) {\n';
                html += '    var r = allResults[i];\n';
                html += '    h += "<div class=\'result-item\'>";\n';
                html += '    h += "<div class=\'result-title\'>" + r.title + "<span class=\'badge\'>" + r.type + "</span></div>";\n';
                html += '    h += "<div class=\'result-content\'>" + truncate(r.content, 200) + "</div>";\n';
                html += '    h += "</div>";\n';
                html += '  }\n';
                html += '  container.innerHTML = h;\n';
                html += '}\n';
                html += 'function truncate(text, length) {\n';
                html += '  if (!text || text.length <= length) return text || "";\n';
                html += '  return text.substring(0, length) + "...";\n';
                html += '}\n';
                html += 'initStats();\n';
                html += 'performSearch();\n';
                html += 'document.getElementById("searchBar").addEventListener("input", function(e) {\n';
                html += '  var val = e.target.value.toLowerCase();\n';
                html += '  setTimeout(function() { searchQuery = val; performSearch(); }, 300);\n';
                html += '});\n';
                html += '<\/script>\n';
                html += '<\/body>\n';
                html += '<\/html>';
                
                console.log('[KB Engine] âœ… Search engine generated (' + html.length + ' chars)');
                return html;
            }
            async createCompleteZIP(knowledgeIndex, originalFile, provider, model) {
                console.log('[KB Engine] ğŸ“¦ Creating complete ZIP package...');
                
                try {
                    const zip = new JSZip();
                    
                    // 1. Add original file (convert to ArrayBuffer for JSZip compatibility)
                    if (originalFile) {
                        try {
                            const arrayBuffer = await originalFile.arrayBuffer();
                            zip.file(originalFile.name, arrayBuffer);
                            console.log('[KB Engine] âœ… Added original file:', originalFile.name);
                        } catch (fileError) {
                            console.warn('[KB Engine] âš ï¸ Could not add original file:', fileError);
                            // Continue without original file if it fails
                        }
                    }
                    
                    // 2. Add knowledge_index.json
                    const jsonContent = JSON.stringify(knowledgeIndex, null, 2);
                    zip.file('knowledge_index.json', jsonContent);
                    console.log('[KB Engine] âœ… Added knowledge_index.json');
                    
                    // 3. Generate and add knowledge.md
                    const mdContent = this.generateKnowledgeMD(knowledgeIndex);
                    zip.file('knowledge.md', mdContent);
                    console.log('[KB Engine] âœ… Added knowledge.md');
                    
                    // 4. Generate and add README.md
                    const readmeContent = this.generateREADME(knowledgeIndex, originalFile.name, provider, model);
                    zip.file('README.md', readmeContent);
                    console.log('[KB Engine] âœ… Added README.md');
                    
                    // 5. Generate and add index.html (search engine)
                    const htmlContent = this.generateIndexHTML(knowledgeIndex);
                    zip.file('index.html', htmlContent);
                    console.log('[KB Engine] âœ… Added index.html (search engine)');
                    
                    // Generate ZIP blob
                    const zipBlob = await zip.generateAsync({
                        type: 'blob',
                        compression: 'DEFLATE',
                        compressionOptions: { level: 9 }
                    });
                    
                    console.log('[KB Engine] âœ… ZIP generated successfully');
                    
                    // Create download
                    const baseFilename = originalFile.name.replace(/\.[^/.]+$/, '');
                    const zipFilename = baseFilename + '_' + provider + '_complete.zip';
                    
                    const url = URL.createObjectURL(zipBlob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = zipFilename;
                    a.click();
                    URL.revokeObjectURL(url);
                    
                    console.log('[KB Engine] ğŸ‰ ZIP downloaded:', zipFilename);
                    
                    return {
                        success: true,
                        filename: zipFilename,
                        size: zipBlob.size
                    };
                    
                } catch (error) {
                    console.error('[KB Engine] âŒ ZIP generation failed:', error);
                    throw error;
                }
            }
        }
        
        // Instance globale
        let multiLLM = new MultiLLMManager();
        let ensemble = new EnsembleManager(multiLLM);

        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // PROMPT MODULES (FROM V4)
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        
        const PROMPT_MODULES = {
            technical: {
                scanned: `âš ï¸ DOCUMENT SCANNÃ‰ - OCR REQUIS
- QualitÃ© variable, possibles erreurs OCR
- VÃ©rifier cohÃ©rence texte extrait
- Signaler ambiguÃ¯tÃ©s dans notes`,
                
                digital: `âœ“ DOCUMENT DIGITAL NATIF
- Texte propre, extraction fiable
- Structure prÃ©servÃ©e`,
                
                manuscrit: `âš ï¸ Ã‰CRITURE MANUSCRITE - OCR DIFFICILE
- InterprÃ©ter au mieux
- Signaler parties illisibles`,
                
                photo: `âš ï¸ PHOTO/CAPTURE - OCR REQUIS
- QualitÃ© image variable
- Possible distorsion perspective`,
                
                image: `ğŸ–¼ï¸ IMAGE/VECTORIEL
- Possible contenu graphique dominant
- Texte peut Ãªtre secondaire`,
                
                hybrid: `âš ï¸ DOCUMENT HYBRIDE (MIXTE)
- Pages scannÃ©es + pages digitales
- Adapter traitement par section`
            },
            
            content: {
                partition_musicale: `ğŸ¸ EXTRACTION PARTITION MUSICALE

CRITICAL: Extract ALL musical content with COMPLETE accuracy.

Structure JSON:
{
  "morceaux": [
    {
      "titre": "exact title",
      "tonalite": "key (e.g. Bb, F#m)",
      "tempo": "tempo/feel (e.g. Medium Swing, 120 bpm)",
      "grille_accords": {
        "nombre_mesures": NUMBER,
        "structure": "form (AABA, Blues, etc)",
        "mesures": ["Gm7", "C7", "Fm7", "Bb7", ...]
      },
      "techniques_requises": ["Walking bass", "Chord tones", ...],
      "analyse_harmonique": {
        "cadences": ["ii-V-I bars 5-8", ...],
        "substitutions": ["tritone sub bar 12", ...],
        "modulations": [...]
      }
    }
  ]
}

INSTRUCTIONS:
1. EXTRACT ALL chord charts measure by measure
2. IDENTIFY ii-V-I cadences, turnarounds
3. NOTE bass techniques (walking, chord tones, chromatic approaches)
4. ANALYZE harmony (substitutions, modulations)
5. TRANSCRIBE tablature if present`,
                
                tablature: `ğŸ¼ EXTRACTION TABLATURE

Structure JSON:
{
  "tablatures": [
    {
      "titre": "title",
      "instrument": "4-string bass",
      "accordage": "standard (E-A-D-G)",
      "notation_complete": "E|------|\\nA|------|\\n...",
      "techniques": ["hammer-on", "pull-off", "slide", ...],
      "fingering": "1-3-4-3-1"
    }
  ]
}

INSTRUCTIONS:
1. TRANSCRIBE complete notation line by line
2. IDENTIFY techniques (H=hammer, P=pull-off, /=slide)
3. NOTE fingering if indicated`,
                
                texte_pedagogique: `ğŸ“š EXTRACTION PÃ‰DAGOGIQUE

Structure JSON:
{
  "objectifs_apprentissage": ["clear learning objectives"],
  "prerequis": ["required prior knowledge"],
  "progression": {
    "etapes": [
      {
        "numero": 1,
        "titre": "step title",
        "objectif": "step objective",
        "duree_estimee": "estimated time",
        "exercices": [...]
      }
    ]
  }
}

INSTRUCTIONS:
1. IDENTIFY explicit learning objectives
2. LIST prerequisites
3. STRUCTURE pedagogical progression
4. EXTRACT all exercises with instructions`,
                
                regles_jeu: `ğŸ² EXTRACTION RÃˆGLES JEU

Structure JSON:
{
  "nom_jeu": "game name",
  "nombre_joueurs": "player count",
  "composants": [{"nom": "component", "quantite": "quantity"}],
  "mise_en_place": {"etapes": ["setup steps"]},
  "deroulement": {"phases_tour": ["turn phases"]},
  "conditions_victoire": "win conditions"
}

INSTRUCTIONS:
1. LIST all components
2. DESCRIBE setup step by step
3. STRUCTURE turn sequence`,
                
                document_therapie: `ğŸ’‘ EXTRACTION DOCUMENT THÃ‰RAPIE

Structure JSON:
{
  "type_document": "protocole | cas_clinique | evaluation",
  "domaine": "couple | individuel | famille",
  "cas_cliniques": [
    {
      "presentation": "case presentation",
      "problematique": "issue",
      "intervention": "therapeutic intervention",
      "evolution": "outcome"
    }
  ],
  "outils_therapeutiques": [...]
}

INSTRUCTIONS:
1. IDENTIFY document type
2. EXTRACT complete clinical cases
3. LIST tools used`,
                
                questionnaire_psy: `ğŸ“‹ EXTRACTION QUESTIONNAIRE PSY

Structure JSON:
{
  "nom_questionnaire": "Big Five | NEO-PI | Gottman",
  "echelles": [
    {
      "nom": "scale name",
      "description": "what it measures",
      "items": [1, 6, 11, ...]
    }
  ],
  "items": [
    {
      "numero": 1,
      "texte": "item text",
      "echelle_inversee": true/false
    }
  ]
}

INSTRUCTIONS:
1. IDENTIFY questionnaire
2. LIST all scales/dimensions
3. EXTRACT ALL items in order`,
                
                paper_scientifique: `ğŸ”¬ EXTRACTION PAPER SCIENTIFIQUE

Structure JSON:
{
  "titre": "paper title",
  "auteurs": ["author list"],
  "abstract": "complete abstract",
  "methodologie": {
    "participants": "sample description",
    "procedure": "research procedure"
  },
  "resultats": {
    "principaux": ["key findings"]
  },
  "bibliographie": [...]
}

INSTRUCTIONS:
1. EXTRACT complete abstract
2. STRUCTURE methodology
3. LIST key results`,
                
                manuel_technique: `ğŸ”§ EXTRACTION MANUEL TECHNIQUE

Structure JSON:
{
  "produit": "product name",
  "specifications": ["technical specs"],
  "installation": {
    "prerequis": ["requirements"],
    "etapes": ["steps"]
  },
  "procedures": [...],
  "troubleshooting": [...]
}

INSTRUCTIONS:
1. LIST technical specifications
2. STRUCTURE installation procedure
3. COMPILE troubleshooting guide`
            }
        };

        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // OCR CACHE (IndexedDB)
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        
        async function initOCRCache() {
            if (!window.idb) {
                console.warn('IndexedDB not available');
                return null;
            }
            
            try {
                const db = await idb.openDB('ocr-cache-v5', 1, {
                    upgrade(db) {
                        if (!db.objectStoreNames.contains('texts')) {
                            db.createObjectStore('texts', { keyPath: 'hash' });
                        }
                    }
                });
                
                return {
                    async get(fileHash) {
                        return await db.get('texts', fileHash);
                    },
                    
                    async set(fileHash, result) {
                        await db.put('texts', {
                            hash: fileHash,
                            result,
                            timestamp: Date.now(),
                            filename: STATE.fileName
                        });
                    },
                    
                    async hashFile(file) {
                        const buffer = await file.arrayBuffer();
                        const hashBuffer = await crypto.subtle.digest('SHA-256', buffer);
                        return Array.from(new Uint8Array(hashBuffer))
                            .map(b => b.toString(16).padStart(2, '0'))
                            .join('');
                    }
                };
            } catch (error) {
                console.error('Failed to init OCR cache:', error);
                return null;
            }
        }

        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // OCR WORKER POOL (PARALLEL)
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        
        class OCRWorkerPool {
            constructor() {
                const memory = navigator.deviceMemory || 4;
                const cores = navigator.hardwareConcurrency || 2;
                
                this.maxWorkers = Math.min(
                    Math.floor(memory / 0.2),
                    cores,
                    4
                );
                
                this.workers = [];
                this.queue = [];
                
                console.log(`OCR Worker Pool: ${this.maxWorkers} workers max`);
            }
            
            async recognize(file) {
                if (STATE.ocrCache) {
                    const fileHash = await STATE.ocrCache.hashFile(file);
                    const cached = await STATE.ocrCache.get(fileHash);
                    
                    if (cached && Date.now() - cached.timestamp < 7 * 24 * 3600 * 1000) {
                        console.log('Cache hit:', file.name);
                        showStatus('Texte trouvÃ© en cache !', 'success');
                        return cached.result;
                    }
                }
                
                return new Promise((resolve, reject) => {
                    this.queue.push({ file, resolve, reject });
                    this.processQueue();
                });
            }
            
            async processQueue() {
                while (this.workers.length < this.maxWorkers && this.queue.length > 0) {
                    const job = this.queue.shift();
                    
                    this.executeOCR(job);
                }
            }
            
            async executeOCR(job) {
                const workerIndex = this.workers.length;
                this.workers.push(job);
                
                try {
                    showStatus(`OCR en cours (worker ${workerIndex + 1})...`, 'info');
                    
                    const { data: { text, confidence } } = await Tesseract.recognize(
                        job.file,
                        'fra+eng',
                        {
                            logger: m => {
                                if (m.status === 'recognizing text') {
                                    const pct = Math.round(m.progress * 100);
                                    updateProgress(30 + pct * 0.5, `OCR Worker ${workerIndex + 1}`, `${pct}%`);
                                }
                            }
                        }
                    );
                    
                    const result = {
                        text: text.trim(),
                        confidence: confidence / 100,
                        wordCount: text.split(/\s+/).length,
                        method: 'tesseract_ocr_parallel'
                    };
                    
                    if (STATE.ocrCache) {
                        const fileHash = await STATE.ocrCache.hashFile(job.file);
                        await STATE.ocrCache.set(fileHash, result);
                    }
                    
                    job.resolve(result);
                    
                } catch (error) {
                    console.error('OCR error:', error);
                    job.reject(error);
                    
                } finally {
                    this.workers = this.workers.filter(w => w !== job);
                    this.processQueue();
                }
            }
        }

        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // BATCH PROGRESS TRACKER
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        
        class BatchProgressTracker {
            constructor() {
                this.items = new Map(); // fileId -> progress data
            }
            
            initFile(fileId, fileName, totalPages) {
                this.items.set(fileId, {
                    fileId,
                    fileName,
                    totalPages,
                    currentPage: 0,
                    phase: 'queued', // queued | extracting | analyzing | generating | completed | error
                    progress: 0,     // 0-100%
                    startTime: null,
                    endTime: null,
                    error: null,
                    lastMessage: ''
                });
            }
            
            updateProgress(fileId, phase, progress, message = '') {
                const item = this.items.get(fileId);
                if (!item) return;
                
                item.phase = phase;
                item.progress = Math.min(100, Math.max(0, progress));
                item.lastMessage = message;
                
                if (phase === 'extracting' && !item.startTime) {
                    item.startTime = Date.now();
                }
                
                if (phase === 'completed' || phase === 'error') {
                    item.endTime = Date.now();
                }
                
                // Update UI
                this.renderFileProgress(fileId);
            }
            
            setError(fileId, error) {
                const item = this.items.get(fileId);
                if (!item) return;
                
                item.phase = 'error';
                item.error = error;
                item.endTime = Date.now();
                
                this.renderFileProgress(fileId);
            }
            
            renderFileProgress(fileId) {
                const item = this.items.get(fileId);
                if (!item) return;
                
                const card = document.querySelector(`[data-file-id="${fileId}"]`);
                if (!card) return;
                
                // Update progress bar
                const progressBar = card.querySelector('.batch-progress-fill');
                if (progressBar) {
                    progressBar.style.width = `${item.progress}%`;
                }
                
                // Update status badge
                const statusBadge = card.querySelector('.batch-file-status');
                if (statusBadge) {
                    statusBadge.textContent = this.getPhaseLabel(item.phase);
                    statusBadge.className = `batch-file-status status-${item.phase}`;
                }
                
                // Update message
                const messageDiv = card.querySelector('.batch-progress-message');
                if (messageDiv) {
                    messageDiv.textContent = item.lastMessage || '';
                }
                
                // Show/hide error message
                let errorDiv = card.querySelector('.batch-error-message');
                if (item.error) {
                    if (!errorDiv) {
                        errorDiv = document.createElement('div');
                        errorDiv.className = 'batch-error-message';
                        card.appendChild(errorDiv);
                    }
                    errorDiv.textContent = item.error;
                } else if (errorDiv) {
                    errorDiv.remove();
                }
            }
            
            getPhaseLabel(phase) {
                const labels = {
                    queued: 'En attente',
                    extracting: 'Extraction...',
                    analyzing: 'Analyse...',
                    generating: 'GÃ©nÃ©ration prompts...',
                    completed: 'TerminÃ©',
                    error: 'Erreur'
                };
                return labels[phase] || phase;
            }
            
            getFileData(fileId) {
                return this.items.get(fileId);
            }
            
            getAllCompleted() {
                return Array.from(this.items.values()).filter(item => item.phase === 'completed');
            }
            
            getAllErrors() {
                return Array.from(this.items.values()).filter(item => item.phase === 'error');
            }
            
            clear() {
                this.items.clear();
            }
        }

        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // BATCH ERROR HANDLER
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        
        class BatchErrorHandler {
            constructor(config) {
                this.maxRetries = config.retryAttempts || 2;
                this.continueOnError = config.continueOnError !== false;
                this.errors = new Map(); // fileId -> error details
            }
            
            async processWithRetry(fileId, processFunc) {
                let attempt = 0;
                let lastError = null;
                
                while (attempt <= this.maxRetries) {
                    try {
                        const result = await processFunc();
                        return { success: true, result };
                        
                    } catch (error) {
                        lastError = error;
                        attempt++;
                        
                        console.error(`Attempt ${attempt}/${this.maxRetries + 1} failed for ${fileId}:`, error);
                        
                        if (attempt <= this.maxRetries) {
                            // Exponential backoff: 2^attempt seconds
                            const backoffMs = Math.pow(2, attempt) * 1000;
                            console.log(`Waiting ${backoffMs}ms before retry...`);
                            await this.sleep(backoffMs);
                        }
                    }
                }
                
                // All retries exhausted
                this.logError(fileId, lastError, attempt);
                
                if (this.continueOnError) {
                    return { success: false, error: lastError };
                } else {
                    throw lastError;
                }
            }
            
            logError(fileId, error, attempts) {
                this.errors.set(fileId, {
                    error: error.message || String(error),
                    stack: error.stack,
                    attempts,
                    timestamp: Date.now()
                });
            }
            
            sleep(ms) {
                return new Promise(resolve => setTimeout(resolve, ms));
            }
            
            getErrorReport() {
                const report = [];
                this.errors.forEach((details, fileId) => {
                    report.push({
                        fileId,
                        error: details.error,
                        attempts: details.attempts,
                        timestamp: new Date(details.timestamp).toISOString()
                    });
                });
                return report;
            }
            
            clearErrors() {
                this.errors.clear();
            }
            
            hasErrors() {
                return this.errors.size > 0;
            }
        }

        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // BATCH CONTROLLER
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        
        class BatchController {
            constructor() {
                this.status = 'idle';
                this.pauseRequested = false;
                this.progressTracker = new BatchProgressTracker();
                this.errorHandler = new BatchErrorHandler(STATE.batch.config);
            }
            
            async startBatch() {
                console.log(`[BATCH] ğŸš€ startBatch() appelÃ©`);
                console.log(`[BATCH] ğŸ“Š STATE.mode="${STATE.mode}", STATE.processingMode="${STATE.processingMode}"`);
                console.log(`[BATCH] ğŸ“Š Fichiers dans la queue: ${STATE.batch.queue.length}`);
                
                if (this.status === 'running') {
                    console.warn('Batch already running');
                    return;
                }
                
                if (STATE.batch.queue.length === 0) {
                    showStatus('Aucun fichier dans la file batch', 'warning');
                    return;
                }
                
                this.status = 'running';
                this.pauseRequested = false;
                STATE.batch.status = 'running';
                STATE.batch.startTime = Date.now();
                
                // Update UI
                updateBatchButtons();
                document.getElementById('batchStats').style.display = 'grid';
                
                // âœ… Afficher le loader
                showProcessingLoader('DÃ©marrage du batch...', {
                    percent: 0,
                    text: `0/${STATE.batch.queue.length} documents`
                });
                
                showStatus('DÃ©marrage du batch...', 'info');
                
                await this.processBatchQueue();
            }
            
            pauseBatch() {
                if (this.status !== 'running') return;
                
                this.pauseRequested = true;
                STATE.batch.status = 'paused';
                STATE.batch.pausedAt = Date.now();
                
                updateBatchButtons();
                showStatus('Pause demandÃ©e... Fin du fichier en cours', 'info');
            }
            
            async resumeBatch() {
                if (this.status !== 'paused') return;
                
                this.pauseRequested = false;
                this.status = 'running';
                STATE.batch.status = 'running';
                
                updateBatchButtons();
                showStatus('Reprise du batch...', 'success');
                
                await this.processBatchQueue();
            }
            
            async processBatchQueue() {
                const queue = STATE.batch.queue;
                const config = STATE.batch.config;
                
                // âœ… V6.6.0 - DÃ©tecter mode ENSEMBLE et forcer sÃ©quentiel
                const currentMode = STATE.mode || STATE.processingMode;
                const isEnsembleMode = (currentMode === 'ensemble');
                
                console.log(`[BATCH] ğŸ” processBatchQueue() - Mode dÃ©tectÃ©: "${currentMode}"`);
                console.log(`[BATCH] ğŸ“Š isEnsembleMode: ${isEnsembleMode}`);
                console.log(`[BATCH] ğŸ“Š STATE.mode="${STATE.mode}", STATE.processingMode="${STATE.processingMode}"`);
                
                if (isEnsembleMode) {
                    console.log('[BATCH-ENSEMBLE] Mode ENSEMBLE dÃ©tectÃ© â†’ Traitement SÃ‰QUENTIEL forcÃ© (rate limits)');
                    config.maxConcurrent = 1; // Force sÃ©quentiel
                }
                
                // âœ… Afficher le loader avec progression
                const totalFiles = queue.length;
                let completedFiles = 0;
                
                while (STATE.batch.currentIndex < queue.length && !this.pauseRequested) {
                    const concurrentPromises = [];
                    
                    // Process maxConcurrent files in parallel
                    for (let i = 0; i < config.maxConcurrent && STATE.batch.currentIndex < queue.length; i++) {
                        const index = STATE.batch.currentIndex++;
                        const item = queue[index];
                        
                        // Skip already completed or errored
                        if (item.status === 'completed' || item.status === 'error') continue;
                        
                        const promise = this.processFileInBatch(item, index).then(() => {
                            completedFiles++;
                            const percent = Math.floor((completedFiles / totalFiles) * 100);
                            showProcessingLoader('Traitement batch en cours...', {
                                percent,
                                text: `${completedFiles}/${totalFiles} documents traitÃ©s`
                            });
                        });
                        concurrentPromises.push(promise);
                    }
                    
                    await Promise.all(concurrentPromises);
                    
                    // âœ… V6.6.0 - DÃ©lai entre fichiers en mode ENSEMBLE (rate limits)
                    if (isEnsembleMode && STATE.batch.currentIndex < queue.length && !this.pauseRequested) {
                        console.log('[BATCH-ENSEMBLE] â±ï¸ Waiting 90s (rate limit protection)...');
                        showProcessingLoader('Mode ENSEMBLE: Pause 90s pour rate limits...', {
                            percent: Math.floor((completedFiles / totalFiles) * 100),
                            text: `${completedFiles}/${totalFiles} documents traitÃ©s`
                        });
                        await new Promise(resolve => setTimeout(resolve, 90000));
                    }
                    
                    // Update stats
                    updateBatchStats();
                }
                
                // âœ… Masquer le loader
                hideProcessingLoader();
                
                // Check if paused or completed
                if (this.pauseRequested) {
                    this.status = 'paused';
                    showStatus('Batch en pause', 'info');
                } else {
                    this.status = 'completed';
                    STATE.batch.status = 'completed';
                    
                    // â•â•â• CONSOLIDATION DES RÃ‰SULTATS â•â•â•
                    STATE.batch.consolidatedResults = [];
                    for (const item of queue) {
                        if (item.status === 'completed' && item.result) {
                            const result = item.result;
                            STATE.batch.consolidatedResults.push({
                                filename: result.fileName || item.file.name,
                                pages: result.analysis?.structure?.page_count || 1,
                                wordCount: result.analysis?.text_metrics?.word_count || 
                                          (result.extractedText ? result.extractedText.split(/\s+/).length : 0),
                                text: result.extractedText || '',
                                analysis: result.analysis,
                                prompt: result.prompt,
                                zipFilename: result.zipFilename
                            });
                        }
                    }
                    console.log(`[Batch] ${STATE.batch.consolidatedResults.length} rÃ©sultats consolidÃ©s`);
                    
                    const successCount = STATE.batch.stats.completed;
                    const errorCount = STATE.batch.stats.errors;
                    let statusMsg = `Batch terminÃ© ! ${successCount} fichier(s) traitÃ©(s)`;
                    if (errorCount > 0) {
                        statusMsg += ` (${errorCount} erreur(s))`;
                    }
                    showStatus(statusMsg, errorCount > 0 ? 'warning' : 'success');
                    updateBatchButtons();
                }
            }
            
            async processFileInBatch(item, index) {
                console.log(`[BATCH] ğŸ”„ processFileInBatch() START pour ${item.file.name}`);
                console.log(`[BATCH] ğŸ“Š STATE.mode="${STATE.mode}", STATE.processingMode="${STATE.processingMode}"`);
                
                try {
                    item.status = 'processing';
                    this.progressTracker.initFile(item.id, item.file.name, 1);
                    
                    // Update UI
                    renderBatchItem(item, index);
                    
                    // Process with retry logic
                    const result = await this.errorHandler.processWithRetry(
                        item.id,
                        async () => await this.processFile(item)
                    );
                    
                    if (result.success) {
                        item.status = 'completed';
                        item.result = result.result;
                        STATE.batch.stats.completed++;
                        this.progressTracker.updateProgress(item.id, 'completed', 100, 'Fichier traitÃ© avec succÃ¨s');
                    } else {
                        item.status = 'error';
                        item.error = result.error.message || String(result.error);
                        STATE.batch.stats.errors++;
                        this.progressTracker.setError(item.id, item.error);
                    }
                    
                } catch (error) {
                    item.status = 'error';
                    item.error = error.message || String(error);
                    STATE.batch.stats.errors++;
                    this.progressTracker.setError(item.id, item.error);
                }
                
                renderBatchItem(item, index);
            }
            
            async processFile(item) {
                // Phase 1: Extraction
                this.progressTracker.updateProgress(item.id, 'extracting', 10, 'Extraction du texte...');
                
                const fileType = item.file.name.split('.').pop().toLowerCase();
                let extractedText = '';
                
                // Extract text based on file type
                try {
                    if (fileType === 'pdf') {
                        extractedText = await this.extractPDFText(item.file);
                    } else if (['txt', 'md', 'markdown'].includes(fileType)) {
                        extractedText = await item.file.text();
                    } else if (['docx', 'doc'].includes(fileType)) {
                        extractedText = await this.extractDOCXText(item.file);
                    } else if (['xlsx', 'xls'].includes(fileType)) {
                        extractedText = await this.extractExcelText(item.file);
                    } else if (['epub'].includes(fileType)) {
                        extractedText = await this.extractEPUBText(item.file);
                    } else if (['html', 'htm'].includes(fileType)) {
                        extractedText = await this.extractHTMLText(item.file);
                    } else if (['csv', 'tsv'].includes(fileType)) {
                        extractedText = await this.extractCSVText(item.file);
                    } else if (['json'].includes(fileType)) {
                        extractedText = await this.extractJSONText(item.file);
                    } else if (['xml'].includes(fileType)) {
                        extractedText = await this.extractXMLText(item.file);
                    } else if (['yaml', 'yml'].includes(fileType)) {
                        extractedText = await this.extractYAMLText(item.file);
                    } else if (['png', 'jpg', 'jpeg', 'gif', 'webp', 'tiff', 'tif'].includes(fileType)) {
                        // Images need OCR
                        extractedText = await this.extractImageTextOCR(item.file);
                    } else {
                        // Generic text extraction attempt
                        extractedText = await item.file.text();
                    }
                } catch (error) {
                    console.error(`Error extracting ${fileType}:`, error);
                    throw new Error(`Impossible d'extraire le texte de ${fileType}: ${error.message}`);
                }
                
                this.progressTracker.updateProgress(item.id, 'extracting', 30, 'Texte extrait');
                
                // Phase 2: Analysis
                this.progressTracker.updateProgress(item.id, 'analyzing', 40, 'Analyse du contenu...');
                
                // Create extractedData object with required properties
                const extractedData = {
                    text: extractedText,
                    method: `batch_${fileType}`,
                    confidence: 0.9,
                    wordCount: extractedText.split(/\s+/).length
                };
                
                // âœ… CrÃ©er un objet analysis simple (fonction detectDocumentMultiDimensionalFromText supprimÃ©e)
                const analysis = {
                    extractedData: extractedData,
                    documentType: fileType,
                    metadata: {
                        fileName: item.file.name,
                        fileSize: item.file.size,
                        wordCount: extractedData.wordCount
                    }
                };
                
                this.progressTracker.updateProgress(item.id, 'analyzing', 50, 'Analyse terminÃ©e');
                
                // Phase 3: API Processing
                this.progressTracker.updateProgress(item.id, 'api_call', 60, 'Appel API en cours...');
                
                // âœ… V6.8.4 - DÃ©tecter mode BATCH pour utiliser la vraie Batch API
                const currentMode = STATE.mode || STATE.processingMode;
                
                // ğŸ” DEBUG COMPLET
                console.log(`[DEBUG] ========================================`);
                console.log(`[DEBUG] ğŸ“ Fichier: ${item.file.name}`);
                console.log(`[DEBUG] ğŸ¯ currentMode = "${currentMode}"`);
                console.log(`[DEBUG] ğŸ“Š STATE.mode = "${STATE.mode}"`);
                console.log(`[DEBUG] ğŸ“Š STATE.processingMode = "${STATE.processingMode}"`);
                console.log(`[DEBUG] âš–ï¸ Condition (currentMode === 'batch') = ${currentMode === 'batch'}`);
                console.log(`[DEBUG] ========================================`);
                
                let apiResponse;
                
                if (currentMode === 'batch') {
                    console.log(`[BATCH] ğŸš€ âœ… VRAIE BATCH API SÃ‰LECTIONNÃ‰E pour ${item.file.name}`);
                    this.progressTracker.updateProgress(item.id, 'api_call', 65, 'BATCH API: Soumission...');
                    
                    // âœ… Utiliser la VRAIE Batch API d'Anthropic (fonction globale, pas mÃ©thode de classe)
                    try {
                        const batchResult = await processSingleFileBatchMode(extractedText, item.file.name, item.id);
                        apiResponse = batchResult;
                        
                        // GÃ©nÃ©rer un prompt descriptif pour le ZIP
                        const promptBatch = `ğŸ“‹ MODE BATCH API ANTHROPIC

Fichier: ${item.file.name}
Date: ${new Date().toISOString()}
Provider: Anthropic Batch API
ModÃ¨le: claude-sonnet-4-5-20250929

ğŸ”§ Configuration:
- Chunking automatique: ${batchResult.metadata.chunks_count} chunk(s)
- Traitement asynchrone
- Temps de traitement: ${batchResult.metadata.processing_time_minutes} min
- Batch ID: ${batchResult.metadata.batch_id}

âœ… Avantages Batch API:
- Aucun rate limit
- -50% coÃ»t
- Traitement optimisÃ©

ğŸ“¦ Le rÃ©sultat a Ã©tÃ© gÃ©nÃ©rÃ© via l'API Batch d'Anthropic et fusionnÃ© automatiquement.`;
                        
                        // Stocker le prompt pour le ZIP
                        apiResponse.prompt = promptBatch;
                        
                        // DÃ©finir aussi prompt comme variable locale pour downloadResultAsZIP
                        var prompt = apiResponse.prompt;
                        
                        console.log(`[BATCH] âœ… ${item.file.name}: Batch completÃ©`);
                        this.progressTracker.updateProgress(item.id, 'api_call', 80, 'BATCH: TerminÃ©');
                    } catch (error) {
                        console.error(`[BATCH] âŒ ${item.file.name}:`, error);
                        this.progressTracker.updateProgress(item.id, 'api_call', 80, `Erreur: ${error.message}`);
                        throw error;
                    }
                    
                } else if (currentMode === 'ensemble') {
                    console.log(`[BATCH-ENSEMBLE] âš¡ Processing ${item.file.name} with 6 parallel tasks`);
                    this.progressTracker.updateProgress(item.id, 'api_call', 65, 'ENSEMBLE: 6 tÃ¢ches parallÃ¨les...');
                    
                    // Appel ENSEMBLE pour ce fichier
                    apiResponse = await ensemble.processDocument(extractedText, {
                        useWorker: false
                    });
                    
                    console.log(`[BATCH-ENSEMBLE] âœ“ ${item.file.name}: ${apiResponse.summary.completed}/${apiResponse.summary.total} tÃ¢ches rÃ©ussies`);
                    this.progressTracker.updateProgress(item.id, 'api_call', 80, `ENSEMBLE: ${apiResponse.summary.completed}/${apiResponse.summary.total} tÃ¢ches OK`);
                    
                } else {
                    // Mode normal (single provider)
                    // âœ… BATCH MODE: TOUJOURS utiliser la clÃ© API utilisateur, JAMAIS le Worker
                    
                    console.log(`[DEBUG] âŒ FALLBACK vers MultiLLM (pas BATCH API)`);
                    console.log(`[DEBUG] ğŸ“Š currentMode="${currentMode}" !== "batch"`);
                    
                    // Forcer le mode user_keys pour utiliser la clÃ© sauvegardÃ©e
                    const previousMode = multiLLM.mode;
                    multiLLM.mode = 'user_keys';
                    
                    // VÃ©rifier que la clÃ© Anthropic est bien sauvegardÃ©e
                    const batchKey = localStorage.getItem('batch_anthropic_key');
                    if (!batchKey) {
                        throw new Error('âŒ ClÃ© API Anthropic requise! Sauvegardez votre clÃ© dans le panneau BATCH.');
                    }
                    
                    // Stocker temporairement la clÃ© dans multiLLM si pas dÃ©jÃ  prÃ©sente
                    if (!multiLLM.getUserKey('anthropic')) {
                        multiLLM.userKeys.anthropic = multiLLM.xorEncrypt(batchKey, 'ocr-v6-secret-2025');
                    }
                    
                    const provider = 'anthropic';
                    // RÃ©cupÃ©rer le modÃ¨le sÃ©lectionnÃ© dans le panneau BATCH
                    const batchModelSelect = document.getElementById('batchAnthropicModel');
                    const model = batchModelSelect ? batchModelSelect.value : 'claude-sonnet-4-5-20250929';
                    
                    console.log(`[BATCH] âœ… Using USER KEY: ${provider}/${model} for ${item.file.name}`);
                    
                    // Generate prompt with extracted text
                    const prompt = generatePrompt({
                        file: item.file,
                        fileName: item.file.name,
                        extractedText: extractedText,  // âœ… Pass the text
                        text: extractedText,            // âœ… Alternative field
                        analysis,
                        totalPages: 1,
                        startPage: 1,
                        endPage: 1
                    });
                    
                    // Call API avec clÃ© utilisateur
                    apiResponse = await multiLLM.sendPrompt(prompt, {
                        provider: provider,
                        model: model,
                        max_tokens: 32000,
                        temperature: 0.3
                    });
                    
                    // Restaurer le mode prÃ©cÃ©dent
                    multiLLM.mode = previousMode;
                    
                    console.log('[BATCH] âœ… API call completed with user key');
                    
                    this.progressTracker.updateProgress(item.id, 'api_call', 80, 'RÃ©ponse API reÃ§ue');
                }
                
                // Phase 4: Generate and download ZIP
                this.progressTracker.updateProgress(item.id, 'packaging', 90, 'GÃ©nÃ©ration du ZIP...');
                
                // Create ZIP with sanitized filename
                const sanitizedName = item.file.name
                    .replace(/\.[^.]+$/, '') // Remove extension
                    .replace(/[^a-zA-Z0-9_-]/g, '_'); // Sanitize
                
                const zipFilename = `${sanitizedName}_OCR.zip`;
                
                // Download ZIP automatically
                await this.downloadResultAsZIP({
                    fileName: item.file.name,
                    extractedText,
                    analysis,
                    apiResponse,
                    prompt: (typeof prompt !== 'undefined' ? prompt : (apiResponse.prompt || null))
                }, zipFilename);
                
                this.progressTracker.updateProgress(item.id, 'completed', 100, 'ZIP tÃ©lÃ©chargÃ© âœ“');
                
                return {
                    fileName: item.file.name,
                    extractedText,
                    analysis,
                    prompt,
                    apiResponse,
                    zipFilename
                };
            }
            
            async downloadResultAsZIP(result, zipFilename) {
                // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
                // V6.7.0: Check if this is a Knowledge Base result
                // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
                if (result.apiResponse && result.apiResponse.format === 'knowledge_base' && result.apiResponse.knowledge_index) {
                    console.log('[KB Engine] ğŸ¯ Detected Knowledge Base format - using complete package');
                    
                    try {
                        // Use the ensemble createCompleteZIP method for KB format
                        const originalFile = {
                            name: result.fileName,
                            type: 'application/epub+zip'
                        };
                        
                        const provider = result.apiResponse.metadata.providers_used[0] || 'ensemble';
                        const firstTask = Object.values(result.apiResponse.tasks).find(t => t.status !== 'failed');
                        const model = firstTask?.model || 'multi-llm';
                        
                        await ensemble.createCompleteZIP(
                            result.apiResponse.knowledge_index,
                            originalFile,
                            provider,
                            model
                        );
                        
                        console.log('[KB Engine] âœ… Complete KB package downloaded');
                        return;
                        
                    } catch (error) {
                        console.error('[KB Engine] âŒ KB package failed, falling back to standard ZIP:', error);
                        // Fall through to standard ZIP creation
                    }
                }
                
                // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
                // Standard ZIP creation (non-KB formats)
                // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
                const zip = new JSZip();
                
                // Add original text
                zip.file('texte_extrait.txt', result.extractedText || '');
                
                // Add API response
                if (result.apiResponse && result.apiResponse.text) {
                    zip.file('analyse_ia.txt', result.apiResponse.text);
                }
                
                // Add analysis JSON
                if (result.analysis) {
                    zip.file('analyse_technique.json', JSON.stringify(result.analysis, null, 2));
                }
                
                // Add prompt
                if (result.prompt) {
                    zip.file('prompt_utilise.txt', result.prompt);
                }
                
                // Add metadata
                const metadata = {
                    fichier: result.fileName,
                    date: new Date().toISOString(),
                    provider: result.apiResponse?.provider || (multiLLM.mode === 'worker' ? 'anthropic (worker)' : STATE.selectedProvider),
                    model: result.apiResponse?.model || (multiLLM.mode === 'worker' ? 'claude-sonnet-4-20250514' : STATE.selectedModel)
                };
                zip.file('metadata.json', JSON.stringify(metadata, null, 2));
                
                // Generate and download
                const blob = await zip.generateAsync({ type: 'blob' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = zipFilename;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
                
                console.log(`[BATCH] ZIP downloaded: ${zipFilename}`);
            }
            
            async extractPDFText(file) {
                const arrayBuffer = await file.arrayBuffer();
                const pdfDoc = await pdfjsLib.getDocument({ data: arrayBuffer }).promise;
                let fullText = '';
                
                for (let i = 1; i <= pdfDoc.numPages; i++) {
                    const page = await pdfDoc.getPage(i);
                    const textContent = await page.getTextContent();
                    const pageText = textContent.items.map(item => item.str).join(' ');
                    fullText += pageText + '\n';
                }
                
                return fullText;
            }
            
            async extractDOCXText(file) {
                const arrayBuffer = await file.arrayBuffer();
                const result = await mammoth.extractRawText({ arrayBuffer });
                return result.value;
            }
            
            async extractExcelText(file) {
                const arrayBuffer = await file.arrayBuffer();
                const data = new Uint8Array(arrayBuffer);
                const workbook = XLSX.read(data, { type: 'array' });
                let text = '';
                
                workbook.SheetNames.forEach(sheetName => {
                    const sheet = workbook.Sheets[sheetName];
                    const csv = XLSX.utils.sheet_to_csv(sheet);
                    text += `Sheet: ${sheetName}\n${csv}\n\n`;
                });
                
                return text;
            }
            
            async extractEPUBText(file) {
                try {
                    console.log('[BATCH-EPUB] Starting extraction for:', file.name);
                    const zip = await JSZip.loadAsync(file);
                    console.log('[BATCH-EPUB] ZIP loaded, files:', Object.keys(zip.files).length);
                    
                    let allText = '';
                    
                    // Chercher tous les fichiers HTML/XHTML dans tout le ZIP
                    const contentFiles = Object.keys(zip.files).filter(name => 
                        (name.endsWith('.html') || name.endsWith('.xhtml')) && !zip.files[name].dir
                    );
                    
                    console.log('[BATCH-EPUB] Content files found:', contentFiles.length);
                    
                    for (const filename of contentFiles) {
                        try {
                            const content = await zip.file(filename).async('string');
                            
                            // Essayer plusieurs mÃ©thodes d'extraction
                            let text = '';
                            
                            // MÃ©thode 1: DOMParser (pour HTML propre)
                            try {
                                const parser = new DOMParser();
                                const doc = parser.parseFromString(content, 'text/html');
                                
                                // Retirer les balises script et style
                                doc.querySelectorAll('script, style').forEach(el => el.remove());
                                
                                text = doc.body ? doc.body.textContent : doc.documentElement.textContent;
                            } catch (e) {
                                console.log('[BATCH-EPUB] DOMParser failed for', filename);
                            }
                            
                            // MÃ©thode 2: Regex simple si DOMParser Ã©choue ou retourne vide
                            if (!text || text.trim().length < 50) {
                                // Retirer balises HTML
                                text = content
                                    .replace(/<script[^>]*>[\s\S]*?<\/script>/gi, '')
                                    .replace(/<style[^>]*>[\s\S]*?<\/style>/gi, '')
                                    .replace(/<[^>]+>/g, ' ')
                                    .replace(/&nbsp;/g, ' ')
                                    .replace(/&lt;/g, '<')
                                    .replace(/&gt;/g, '>')
                                    .replace(/&amp;/g, '&')
                                    .replace(/&quot;/g, '"')
                                    .replace(/&#39;/g, "'");
                            }
                            
                            const cleanText = text.replace(/\s+/g, ' ').trim();
                            
                            if (cleanText.length > 10) {
                                allText += cleanText + '\n\n';
                            }
                        } catch (err) {
                            console.error('[BATCH-EPUB] Error processing', filename, err);
                        }
                    }
                    
                    const finalText = allText.trim();
                    console.log('[BATCH-EPUB] Total text extracted:', finalText.length, 'chars');
                    
                    return finalText || 'Unable to extract EPUB text';
                    
                } catch (error) {
                    console.error('[BATCH-EPUB] ERROR:', error);
                    return 'EPUB extraction failed: ' + error.message;
                }
            }
            
            async extractHTMLText(file) {
                const content = await file.text();
                // Create temporary div to parse HTML
                const div = document.createElement('div');
                div.innerHTML = content;
                return div.textContent || div.innerText || '';
            }
            
            async extractCSVText(file) {
                const content = await file.text();
                const parsed = Papa.parse(content);
                return parsed.data.map(row => row.join(' | ')).join('\n');
            }
            
            async extractJSONText(file) {
                const content = await file.text();
                const json = JSON.parse(content);
                return JSON.stringify(json, null, 2);
            }
            
            async extractXMLText(file) {
                const content = await file.text();
                // Strip XML tags for simple text extraction
                return content.replace(/<[^>]*>/g, ' ').replace(/\s+/g, ' ');
            }
            
            async extractYAMLText(file) {
                const content = await file.text();
                try {
                    const data = jsyaml.load(content);
                    return JSON.stringify(data, null, 2);
                } catch (error) {
                    return content; // Return raw if parsing fails
                }
            }
            
            async extractImageTextOCR(file) {
                // Check cache first
                if (STATE.ocrCache) {
                    const fileHash = await STATE.ocrCache.hashFile(file);
                    const cached = await STATE.ocrCache.get(fileHash);
                    if (cached) {
                        return cached.result.text;
                    }
                }
                
                // Perform OCR
                const { data: { text } } = await Tesseract.recognize(
                    file,
                    'fra+eng',
                    {
                        logger: () => {} // Silent for batch
                    }
                );
                
                // Cache result
                if (STATE.ocrCache) {
                    const fileHash = await STATE.ocrCache.hashFile(file);
                    await STATE.ocrCache.set(fileHash, { text, confidence: 0.9, method: 'batch_ocr' });
                }
                
                return text;
            }
        }

        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // EXPORT MANAGER
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        
        class ExportManager {
            constructor() {
                this.formats = ['markdown', 'pdf', 'excel', 'jsonld', 'yaml', 'obsidian', 'notion', 'anki'];
                this.options = {
                    includeMetadata: true,
                    analysisFormat: 'complete',
                    includeRawText: true
                };
            }
            
            updateOptions() {
                this.options.includeMetadata = document.getElementById('exportIncludeMetadata')?.checked || true;
                this.options.analysisFormat = document.getElementById('exportAnalysisFormat')?.value || 'complete';
                this.options.includeRawText = document.getElementById('exportIncludeRawText')?.checked || true;
            }
            
            // â•â•â• MARKDOWN EXPORT â•â•â•
            async exportMarkdown() {
                this.updateOptions();
                
                let markdown = `# ${STATE.fileName}\n\n`;
                
                // Metadata
                if (this.options.includeMetadata) {
                    markdown += `## MÃ©tadonnÃ©es\n\n`;
                    markdown += `- **Fichier**: ${STATE.fileName}\n`;
                    markdown += `- **Pages**: ${STATE.totalPages}\n`;
                    markdown += `- **Format**: ${STATE.fileType.toUpperCase()}\n`;
                    markdown += `- **Date**: ${new Date().toLocaleDateString('fr-FR')}\n`;
                    markdown += `- **Taille**: ${(STATE.fileSize / 1024 / 1024).toFixed(2)} MB\n\n`;
                }
                
                // Analysis
                if (this.options.analysisFormat !== 'none' && STATE.analysis) {
                    markdown += `## Analyse\n\n`;
                    
                    if (STATE.analysis.technical) {
                        markdown += `### Technique\n\n`;
                        markdown += `- **Format**: ${STATE.analysis.technical.format}\n`;
                        markdown += `- **QualitÃ©**: ${STATE.analysis.technical.quality || 'N/A'}\n`;
                        markdown += `- **OCR requis**: ${STATE.analysis.technical.ocr_required ? 'Oui' : 'Non'}\n\n`;
                    }
                    
                    if (STATE.analysis.composition) {
                        markdown += `### Composition\n\n`;
                        markdown += `- **Type primaire**: ${STATE.analysis.composition.primary}\n`;
                        if (STATE.analysis.composition.secondary?.length > 0) {
                            markdown += `- **Types secondaires**: ${STATE.analysis.composition.secondary.join(', ')}\n`;
                        }
                        markdown += `\n`;
                    }
                }
                
                // Content
                if (this.options.includeRawText && STATE.extractedText) {
                    markdown += `## Contenu Extrait\n\n`;
                    markdown += `\`\`\`\n${STATE.extractedText.substring(0, 5000)}\n\`\`\`\n\n`;
                    if (STATE.extractedText.length > 5000) {
                        markdown += `*... (${STATE.extractedText.length - 5000} caractÃ¨res supplÃ©mentaires)*\n\n`;
                    }
                }
                
                // Parts/Sections
                if (STATE.parts && STATE.parts.length > 0) {
                    markdown += `## Parties\n\n`;
                    STATE.parts.forEach((part, index) => {
                        markdown += `### Partie ${index + 1} (Pages ${part.startPage}-${part.endPage})\n\n`;
                        if (part.json) {
                            markdown += `- **Statut**: ${part.status}\n`;
                            markdown += `- **Modules**: ${Object.keys(part.json).length}\n\n`;
                        }
                    });
                }
                
                markdown += `---\n\n*GÃ©nÃ©rÃ© avec OCR Universel V6.0 ULTIMATE - API Multi-LLM*\n`;
                
                return markdown;
            }
            
            // â•â•â• YAML EXPORT â•â•â•
            async exportYAML() {
                this.updateOptions();
                
                const data = {
                    metadata: {
                        fileName: STATE.fileName,
                        totalPages: STATE.totalPages,
                        fileType: STATE.fileType,
                        fileSize: STATE.fileSize,
                        exportDate: new Date().toISOString(),
                        generator: 'OCR Universel V6.0 ULTIMATE - API Multi-LLM'
                    }
                };
                
                if (this.options.analysisFormat !== 'none' && STATE.analysis) {
                    data.analysis = {
                        technical: STATE.analysis.technical || {},
                        composition: STATE.analysis.composition || {},
                        content: STATE.analysis.content || {}
                    };
                }
                
                if (this.options.includeRawText && STATE.extractedText) {
                    data.content = {
                        text: STATE.extractedText,
                        wordCount: STATE.extractedText.split(/\s+/).length,
                        characterCount: STATE.extractedText.length
                    };
                }
                
                if (STATE.parts && STATE.parts.length > 0) {
                    data.parts = STATE.parts.map((part, index) => ({
                        partNumber: index + 1,
                        startPage: part.startPage,
                        endPage: part.endPage,
                        status: part.status,
                        hasJSON: !!part.json
                    }));
                }
                
                return jsyaml.dump(data, { indent: 2, lineWidth: 120 });
            }
            
            // â•â•â• JSON-LD EXPORT (Knowledge Graph) â•â•â•
            async exportJSONLD() {
                this.updateOptions();
                
                const jsonld = {
                    "@context": "https://schema.org",
                    "@type": "DigitalDocument",
                    "name": STATE.fileName,
                    "encodingFormat": STATE.fileType,
                    "contentSize": `${(STATE.fileSize / 1024 / 1024).toFixed(2)} MB`,
                    "dateCreated": new Date().toISOString(),
                    "creator": {
                        "@type": "SoftwareApplication",
                        "name": "OCR Universel V6.0 ULTIMATE - API Multi-LLM",
                        "applicationCategory": "OCR Software",
                        "operatingSystem": "Web Browser"
                    }
                };
                
                if (STATE.analysis) {
                    jsonld.about = {
                        "@type": "Thing",
                        "name": STATE.analysis.composition?.primary || "Document",
                        "description": `Type: ${STATE.analysis.technical?.format || 'unknown'}`
                    };
                }
                
                if (STATE.extractedText && this.options.includeRawText) {
                    jsonld.text = STATE.extractedText.substring(0, 1000);
                    jsonld.wordCount = STATE.extractedText.split(/\s+/).length;
                }
                
                if (STATE.parts && STATE.parts.length > 0) {
                    jsonld.hasPart = STATE.parts.map((part, index) => ({
                        "@type": "Chapter",
                        "position": index + 1,
                        "pageStart": part.startPage,
                        "pageEnd": part.endPage
                    }));
                }
                
                return JSON.stringify(jsonld, null, 2);
            }
            
            // â•â•â• EXCEL EXPORT â•â•â•
            async exportExcel() {
                this.updateOptions();
                
                const workbook = XLSX.utils.book_new();
                
                // Sheet 1: Metadata
                const metadataData = [
                    ['PropriÃ©tÃ©', 'Valeur'],
                    ['Nom du fichier', STATE.fileName],
                    ['Pages totales', STATE.totalPages],
                    ['Type de fichier', STATE.fileType],
                    ['Taille', `${(STATE.fileSize / 1024 / 1024).toFixed(2)} MB`],
                    ['Date export', new Date().toLocaleDateString('fr-FR')]
                ];
                
                if (STATE.analysis) {
                    metadataData.push(['Format technique', STATE.analysis.technical?.format || 'N/A']);
                    metadataData.push(['Type primaire', STATE.analysis.composition?.primary || 'N/A']);
                }
                
                const ws1 = XLSX.utils.aoa_to_sheet(metadataData);
                XLSX.utils.book_append_sheet(workbook, ws1, 'MÃ©tadonnÃ©es');
                
                // Sheet 2: Analysis
                if (STATE.analysis && this.options.analysisFormat !== 'none') {
                    const analysisData = [['CatÃ©gorie', 'PropriÃ©tÃ©', 'Valeur']];
                    
                    if (STATE.analysis.technical) {
                        Object.entries(STATE.analysis.technical).forEach(([key, value]) => {
                            analysisData.push(['Technique', key, String(value)]);
                        });
                    }
                    
                    if (STATE.analysis.composition) {
                        Object.entries(STATE.analysis.composition).forEach(([key, value]) => {
                            analysisData.push(['Composition', key, JSON.stringify(value)]);
                        });
                    }
                    
                    const ws2 = XLSX.utils.aoa_to_sheet(analysisData);
                    XLSX.utils.book_append_sheet(workbook, ws2, 'Analyse');
                }
                
                // Sheet 3: Parts
                if (STATE.parts && STATE.parts.length > 0) {
                    const partsData = [['Partie', 'Page dÃ©but', 'Page fin', 'Statut']];
                    STATE.parts.forEach((part, index) => {
                        partsData.push([index + 1, part.startPage, part.endPage, part.status]);
                    });
                    
                    const ws3 = XLSX.utils.aoa_to_sheet(partsData);
                    XLSX.utils.book_append_sheet(workbook, ws3, 'Parties');
                }
                
                return XLSX.write(workbook, { type: 'binary', bookType: 'xlsx' });
            }
            
            // â•â•â• OBSIDIAN VAULT EXPORT â•â•â•
            async exportObsidian() {
                this.updateOptions();
                
                const vaultName = STATE.fileName.replace(/\.[^/.]+$/, '');
                const zip = new JSZip();
                const folder = zip.folder(vaultName);
                
                // Main note
                let mainNote = `# ${STATE.fileName}\n\n`;
                mainNote += `[[Metadata]] | [[Analysis]] | [[Content]]\n\n`;
                mainNote += `## Vue d'ensemble\n\n`;
                mainNote += `Ce document a Ã©tÃ© traitÃ© avec OCR Universel V6.0.\n\n`;
                
                if (STATE.analysis) {
                    mainNote += `**Type**: #${STATE.analysis.composition?.primary || 'document'}\n`;
                    mainNote += `**Format**: ${STATE.analysis.technical?.format || 'unknown'}\n\n`;
                }
                
                folder.file(`${vaultName}.md`, mainNote);
                
                // Metadata note
                let metadataNote = `# Metadata\n\n`;
                metadataNote += `[[${vaultName}|â† Retour]]\n\n`;
                metadataNote += `- Fichier: ${STATE.fileName}\n`;
                metadataNote += `- Pages: ${STATE.totalPages}\n`;
                metadataNote += `- Taille: ${(STATE.fileSize / 1024 / 1024).toFixed(2)} MB\n`;
                folder.file('Metadata.md', metadataNote);
                
                // Analysis note
                if (STATE.analysis) {
                    let analysisNote = `# Analysis\n\n`;
                    analysisNote += `[[${vaultName}|â† Retour]]\n\n`;
                    analysisNote += `## Technique\n\n`;
                    analysisNote += `\`\`\`json\n${JSON.stringify(STATE.analysis.technical, null, 2)}\n\`\`\`\n\n`;
                    folder.file('Analysis.md', analysisNote);
                }
                
                // Content note
                if (STATE.extractedText && this.options.includeRawText) {
                    let contentNote = `# Content\n\n`;
                    contentNote += `[[${vaultName}|â† Retour]]\n\n`;
                    contentNote += STATE.extractedText;
                    folder.file('Content.md', contentNote);
                }
                
                return await zip.generateAsync({ type: 'blob' });
            }
            
            // â•â•â• NOTION CSV EXPORT â•â•â•
            async exportNotion() {
                this.updateOptions();
                
                const rows = [
                    ['Nom', 'Type', 'Pages', 'Taille', 'Format technique', 'Type primaire', 'Date']
                ];
                
                rows.push([
                    STATE.fileName,
                    STATE.fileType,
                    STATE.totalPages,
                    `${(STATE.fileSize / 1024 / 1024).toFixed(2)} MB`,
                    STATE.analysis?.technical?.format || 'N/A',
                    STATE.analysis?.composition?.primary || 'N/A',
                    new Date().toLocaleDateString('fr-FR')
                ]);
                
                return Papa.unparse(rows);
            }
            
            // â•â•â• ANKI FLASHCARDS EXPORT â•â•â•
            async exportAnki() {
                this.updateOptions();
                
                let ankiText = '';
                
                // Main card
                ankiText += `Document: ${STATE.fileName}\t`;
                ankiText += `Type: ${STATE.analysis?.composition?.primary || 'Document'}, `;
                ankiText += `${STATE.totalPages} pages, `;
                ankiText += `Format: ${STATE.analysis?.technical?.format || 'unknown'}\n`;
                
                // Analysis cards
                if (STATE.analysis && this.options.analysisFormat !== 'none') {
                    if (STATE.analysis.technical) {
                        ankiText += `Format technique de ${STATE.fileName}\t${STATE.analysis.technical.format}\n`;
                        ankiText += `QualitÃ© OCR de ${STATE.fileName}\t${STATE.analysis.technical.quality || 'N/A'}\n`;
                    }
                    
                    if (STATE.analysis.composition) {
                        ankiText += `Type primaire de ${STATE.fileName}\t${STATE.analysis.composition.primary}\n`;
                        if (STATE.analysis.composition.weights) {
                            Object.entries(STATE.analysis.composition.weights).forEach(([type, weight]) => {
                                ankiText += `Poids ${type} dans ${STATE.fileName}\t${Math.round(weight * 100)}%\n`;
                            });
                        }
                    }
                }
                
                // Parts cards
                if (STATE.parts && STATE.parts.length > 1) {
                    STATE.parts.forEach((part, index) => {
                        ankiText += `Partie ${index + 1} de ${STATE.fileName}\tPages ${part.startPage}-${part.endPage}\n`;
                    });
                }
                
                return ankiText;
            }
            
            // â•â•â• PDF REPORT EXPORT (using jsPDF via HTML) â•â•â•
            async exportPDF() {
                // Note: This is a simplified version
                // In production, you'd use jsPDF library
                showStatus('Export PDF: Utilisez le bouton "Imprimer" du navigateur et "Enregistrer en PDF"', 'info');
                
                // Evaluate all variables first
                const fileName = STATE.fileName || 'Document';
                const totalPages = STATE.totalPages || 0;
                const fileType = STATE.fileType ? STATE.fileType.toUpperCase() : 'N/A';
                const fileSize = STATE.file ? (STATE.fileSize / 1024 / 1024).toFixed(2) : '0';
                const currentDate = new Date().toLocaleDateString('fr-FR');
                
                const printWindow = window.open('', '_blank');
                let html = '<!DOCTYPE html><html><head>';
                html += '<title>' + fileName + ' - Report</title>';
                html += '<style>';
                html += 'body { font-family: Arial, sans-serif; padding: 40px; line-height: 1.6; }';
                html += 'h1 { color: #8FAFB1; border-bottom: 3px solid #C8D0C3; padding-bottom: 10px; }';
                html += 'h2 { color: #8FAFB1; margin-top: 30px; }';
                html += '.metadata { background: #E6D7C3; padding: 20px; border-radius: 8px; margin: 20px 0; }';
                html += '.metadata p { margin: 5px 0; }';
                html += 'table { width: 100%; border-collapse: collapse; margin: 20px 0; }';
                html += 'th, td { border: 1px solid #ddd; padding: 12px; text-align: left; }';
                html += 'th { background: #8FAFB1; color: white; }';
                html += '.footer { text-align: center; margin-top: 50px; color: #666; font-size: 12px; }';
                html += '<\/style><\/head><body>';
                html += '<h1>' + fileName + '</h1>';
                html += '<div class="metadata"><h2>MÃ©tadonnÃ©es</h2>';
                html += '<p><strong>Fichier:</strong> ' + fileName + '</p>';
                html += '<p><strong>Pages:</strong> ' + totalPages + '</p>';
                html += '<p><strong>Type:</strong> ' + fileType + '</p>';
                html += '<p><strong>Taille:</strong> ' + fileSize + ' MB</p>';
                html += '<p><strong>Date:</strong> ' + currentDate + '</p>';
                html += '</div>';
                
                if (STATE.analysis) {
                    const techFormat = STATE.analysis.technical?.format || 'N/A';
                    const techQuality = STATE.analysis.technical?.quality || 'N/A';
                    const compPrimary = STATE.analysis.composition?.primary || 'N/A';
                    
                    html += '<h2>Analyse</h2>';
                    html += '<table>';
                    html += '<tr><th>PropriÃ©tÃ©</th><th>Valeur</th></tr>';
                    html += '<tr><td>Format technique</td><td>' + techFormat + '</td></tr>';
                    html += '<tr><td>QualitÃ©</td><td>' + techQuality + '</td></tr>';
                    html += '<tr><td>Type primaire</td><td>' + compPrimary + '</td></tr>';
                    html += '</table>';
                }
                
                html += '<div class="footer">';
                html += 'GÃ©nÃ©rÃ© avec OCR Universel V6.0 ULTIMATE - API Multi-LLM - ' + currentDate;
                html += '<\/div><\/body><\/html>';
                
                printWindow.document.write(html);
                printWindow.document.close();
                
                return null; // User handles print/save
            }
        }

        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // INITIALIZATION
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        
        (async () => {
            STATE.ocrCache = await initOCRCache();
            STATE.ocrWorkerPool = new OCRWorkerPool();
            STATE.batchController = new BatchController();
            STATE.exportManager = new ExportManager();
        })();

        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // TEMPLATES
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        
        const TEMPLATES = {
            realbook_jazz: {
                name: 'Real Book Jazz',
                analysis: {
                    technical: { format: 'scanned', quality: 'medium', ocr_required: true },
                    content: {
                        detected: [
                            { type: 'partition_musicale', score: 85, confidence: 0.85 },
                            { type: 'texte_pedagogique', score: 35, confidence: 0.35 }
                        ],
                        selected: ['partition_musicale', 'texte_pedagogique']
                    },
                    composition: {
                        primary: 'partition_musicale',
                        secondary: ['texte_pedagogique'],
                        weights: { partition_musicale: 0.70, texte_pedagogique: 0.30 },
                        auto_weights: { partition_musicale: 0.70, texte_pedagogique: 0.30 }
                    }
                },
                format: 32,
                platform: 'chatgpt',
                model: 'gpt-4o'
            },
            
            sade_songbook: {
                name: 'Sade Songbook',
                analysis: {
                    technical: { format: 'digital', quality: 'high', ocr_required: false },
                    content: {
                        detected: [{ type: 'partition_musicale', score: 100, confidence: 1.0 }],
                        selected: ['partition_musicale']
                    },
                    composition: {
                        primary: 'partition_musicale',
                        secondary: [],
                        weights: { partition_musicale: 1.0 },
                        auto_weights: { partition_musicale: 1.0 }
                    }
                },
                format: 32,
                platform: 'chatgpt',
                model: 'gpt-4o'
            },
            
            therapy_doc: {
                name: 'Document ThÃ©rapie',
                analysis: {
                    technical: { format: 'digital', quality: 'high', ocr_required: false },
                    content: {
                        detected: [
                            { type: 'document_therapie', score: 80, confidence: 0.80 },
                            { type: 'questionnaire_psy', score: 20, confidence: 0.20 }
                        ],
                        selected: ['document_therapie', 'questionnaire_psy']
                    },
                    composition: {
                        primary: 'document_therapie',
                        secondary: ['questionnaire_psy'],
                        weights: { document_therapie: 0.80, questionnaire_psy: 0.20 },
                        auto_weights: { document_therapie: 0.80, questionnaire_psy: 0.20 }
                    }
                },
                format: 32,
                platform: 'claude',
                model: 'claude-sonnet-4-20250514'
            },
            
            scientific_paper: {
                name: 'Paper Scientifique',
                analysis: {
                    technical: { format: 'digital', quality: 'high', ocr_required: false },
                    content: {
                        detected: [{ type: 'paper_scientifique', score: 100, confidence: 1.0 }],
                        selected: ['paper_scientifique']
                    },
                    composition: {
                        primary: 'paper_scientifique',
                        secondary: [],
                        weights: { paper_scientifique: 1.0 },
                        auto_weights: { paper_scientifique: 1.0 }
                    }
                },
                format: 32,
                platform: 'chatgpt',
                model: 'gpt-4o'
            }
        };
        
        function loadTemplate(templateId) {
            const template = TEMPLATES[templateId];
            if (!template) return;
            
            showStatus(`Template "${template.name}" chargÃ© !`, 'success');
            
            STATE.format = template.format;
            STATE.platform = template.platform;
            STATE.gptModel = template.model;
            STATE.analysis = template.analysis;
            
            document.getElementById('dropZone').scrollIntoView({ behavior: 'smooth' });
        }

        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // DRAG & DROP
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        
        const dropZone = document.getElementById('dropZone');
        const fileInput = document.getElementById('fileInput');
        
        dropZone.addEventListener('click', () => fileInput.click());
        
        dropZone.addEventListener('dragover', (e) => {
            e.preventDefault();
            dropZone.classList.add('drag-over');
        });
        
        dropZone.addEventListener('dragleave', () => {
            dropZone.classList.remove('drag-over');
        });
        
        dropZone.addEventListener('drop', (e) => {
            e.preventDefault();
            dropZone.classList.remove('drag-over');
            
            const files = e.dataTransfer.files;
            if (files.length > 0) {
                handleFile(files[0]).then(() => {
                    // âœ… SCROLL vers section traitement aprÃ¨s upload
                    scrollToProcessingSection();
                });
            }
        });
        
        fileInput.addEventListener('change', async (e) => {
            const file = e.target.files[0];
            if (file) {
                await handleFile(file);
                // âœ… SCROLL vers section traitement aprÃ¨s upload
                scrollToProcessingSection();
            }
        });

        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // FILE HANDLING (V14 INTEGRATION)
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        
        // âœ… V14: DÃ‰TECTION FICHIER LOURD
        function checkIfHeavyFile(file) {
            const sizeMB = file.size / 1024 / 1024;
            const fileType = file.name.split('.').pop().toLowerCase();
            
            // Seuils par type de fichier
            const thresholds = {
                'pdf': 50,      // 50 MB pour PDFs
                'png': 20,      // 20 MB pour images (Tesseract lourd)
                'jpg': 20,
                'jpeg': 20,
                'tiff': 30,
                'default': 100  // 100 MB pour autres formats
            };
            
            const threshold = thresholds[fileType] || thresholds['default'];
            const isHeavy = sizeMB > threshold;
            
            let message = '';
            let recommendation = '';
            
            if (isHeavy) {
                if (fileType === 'pdf') {
                    message = `Document volumineux (${sizeMB.toFixed(1)} MB). Analyse complÃ¨te peut prendre plusieurs minutes.`;
                    recommendation = 'ConsidÃ©rez une analyse par Ã©chantillonnage pour plus de rapiditÃ©.';
                } else if (['png', 'jpg', 'jpeg', 'tiff'].includes(fileType)) {
                    message = `Image volumineuse (${sizeMB.toFixed(1)} MB). OCR Tesseract peut Ãªtre lent.`;
                    recommendation = 'Sur mobile ou connexion lente, prÃ©fÃ©rez une rÃ©solution rÃ©duite.';
                } else {
                    message = `Fichier volumineux (${sizeMB.toFixed(1)} MB).`;
                    recommendation = 'Le traitement peut prendre du temps.';
                }
            }
            
            return {
                isHeavy,
                sizeMB,
                threshold,
                message,
                recommendation,
                fileType
            };
        }
        
        async function handleFile(file) {
            // âœ… V6.4.4 - RÃ©initialiser complÃ¨tement STATE pour nouveau fichier
            STATE.file = file;
            STATE.fileName = file.name;
            STATE.fileSize = file.size;
            STATE.fileType = file.name.split('.').pop().toLowerCase();
            STATE.startTime = Date.now();
            
            // âœ… STOCKER le fichier original pour la gÃ©nÃ©ration ZIP
            STATE.currentFile = file;
            STATE.fileName = file.name;
            
            // âœ… VIDER les donnÃ©es du fichier prÃ©cÃ©dent
            STATE.extractedText = '';
            STATE.detectionResult = null;
            STATE.documentType = null;
            STATE.analysis = null;
            STATE.totalPages = 0;
            
            console.log('[DEBUG] handleFile - STATE reset for new file:', STATE.fileName);
            
            showStatus(`Fichier chargÃ©: ${file.name} (${(file.size / 1024 / 1024).toFixed(2)} MB)`, 'success');
            
            // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
            // V6.3.0 - DÃ‰TECTION FICHIER LOURD
            // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
            const isHeavy = checkIfHeavyFile(file);
            if (isHeavy.isHeavy) {
                showStatus(`âš ï¸ ${isHeavy.message}`, 'warning');
                console.log('[PERF] Heavy file detected:', isHeavy);
            }
            // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
            
            updateProgress(10, 'Analyse du fichier', 'DÃ©tection du format...');
            
            try {
                // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
                // V6.7.2: EXTRACTION DIRECTE (simplifiÃ© sans detectDocumentType)
                // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
                const fileExt = file.name.split('.').pop().toLowerCase();
                STATE.documentType = fileExt;
                
                console.log(`[DEBUG] Extracting text from ${fileExt.toUpperCase()} file...`);
                
                updateProgress(30, 'Extraction du contenu', `Format: ${fileExt.toUpperCase()}`);
                
                // Extraction directe basÃ©e sur l'extension
                if (fileExt === 'pdf') {
                    const arrayBuffer = await file.arrayBuffer();
                    const pdfDoc = await pdfjsLib.getDocument({ data: arrayBuffer }).promise;
                    STATE.totalPages = pdfDoc.numPages;
                    
                    console.log(`[DEBUG] Extracting text from ${STATE.totalPages} pages...`);
                    let fullText = '';
                    
                    for (let i = 1; i <= pdfDoc.numPages; i++) {
                        const page = await pdfDoc.getPage(i);
                        const textContent = await page.getTextContent();
                        const pageText = textContent.items.map(item => item.str).join(' ');
                        fullText += pageText + '\n';
                        updateProgress(30 + (i / pdfDoc.numPages * 50), 'Extraction des pages', `Page ${i}/${pdfDoc.numPages}`);
                    }
                    
                    STATE.extractedText = fullText;
                    console.log(`[DEBUG] Full text extracted, length: ${fullText.length}`);
                    
                } else if (fileExt === 'epub') {
                    console.log('[EPUB] Starting EPUB extraction...');
                    const arrayBuffer = await file.arrayBuffer();
                    const zip = await JSZip.loadAsync(arrayBuffer);
                    let fullText = '';
                    
                    // Extraire le texte des fichiers .xhtml
                    const promises = [];
                    zip.forEach((relativePath, file) => {
                        if (relativePath.endsWith('.xhtml') || relativePath.endsWith('.html')) {
                            promises.push(
                                file.async('text').then(content => {
                                    const parser = new DOMParser();
                                    const doc = parser.parseFromString(content, 'text/html');
                                    return doc.body ? doc.body.textContent || doc.body.innerText : '';
                                })
                            );
                        }
                    });
                    
                    const textParts = await Promise.all(promises);
                    STATE.extractedText = textParts.join('\n');
                    STATE.totalPages = promises.length;
                    
                    console.log(`[EPUB] Extraction complete, text length: ${STATE.extractedText.length}`);
                    
                } else {
                    // Pour les autres formats, extraction simple en text
                    const text = await file.text();
                    STATE.extractedText = text;
                    STATE.totalPages = 1;
                }
                
                // CrÃ©er un objet dÃ©tection simple
                STATE.detectionResult = {
                    type: fileExt,
                    extractedData: {
                        text: STATE.extractedText,
                        totalPages: STATE.totalPages
                    },
                    metadata: {
                        fileName: file.name,
                        fileSize: file.size,
                        fileType: fileExt
                    }
                };
                
                console.log('[DEBUG] handleFile - extractedText length:', STATE.extractedText?.length || 0);
                console.log('[DEBUG] handleFile - totalPages:', STATE.totalPages);
                
                // âœ… V6.8.3: DÃ‰TECTION AUTO MODE BATCH
                if (STATE.extractedText) {
                    const estimatedTokens = estimateTokens(STATE.extractedText);
                    console.log(`[BATCH DETECT] ${estimatedTokens} tokens estimÃ©s`);
                    
                    if (STATE.mode === 'batch' && estimatedTokens > 150000) {
                        console.log('[BATCH DETECT] ğŸš€ Mode BATCH + Gros document â†’ AUTO BATCH');
                        showStatus(`ğŸ“¦ Document volumineux (${estimatedTokens.toLocaleString()} tokens) â†’ Mode BATCH`, 'info');
                        
                        setTimeout(async () => {
                            await processBatchMode(STATE.extractedText, STATE.fileName);
                        }, 1000);
                    } else if (estimatedTokens > 150000 && STATE.mode !== 'batch') {
                        showStatus(`âš ï¸ Document volumineux (${estimatedTokens.toLocaleString()} tokens). RecommandÃ©: Mode BATCH`, 'warning');
                    }
                }
                
                // Afficher les rÃ©sultats
                updateProgress(90, 'Finalisation', 'PrÃ©paration de l\'affichage...');
                
                if (typeof displayDetectionResult === 'function') {
                    displayDetectionResult(STATE.detectionResult);
                } else {
                    console.log('[DEBUG] displayDetectionResult not available, skipping...');
                }
                
                updateProgress(100, 'Analyse terminÃ©e', 'PrÃªt Ã  traiter');
                
                document.getElementById('detectionSection').style.display = 'block';
                // âœ… V6.4.4 - SupprimÃ© apiQuickActions (workflow unifiÃ© pour tous les modes)
                document.getElementById('compositionSection').style.display = 'block';
                document.getElementById('configSection').style.display = 'block';
                
                // âœ… SCROLL AUTOMATIQUE aprÃ¨s upload
                scrollAfterUpload();
                
                // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
                // âœ¨ V6.4.4 - WORKER MODE (seulement si radio Worker cochÃ©)
                // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
                const radioWorker = document.querySelector('input[name="mode"][value="worker"]');
                const workerToggle = document.getElementById('workerToggle');
                
                // âœ… VÃ‰RIFIER QUE LE RADIO WORKER EST COCHÃ‰ (sinon c'est Manuel ou API Multi-LLM)
                if (radioWorker && radioWorker.checked) {
                    // On est en mode Worker â†’ activer Worker dans multiLLM
                    if (workerToggle && workerToggle.checked) {
                        console.log('[WORKER MODE] ActivÃ© - utilisation du Worker pour API');
                        multiLLM.switchMode('worker');
                    }
                } else {
                    // On est en mode Manuel ou API Multi-LLM â†’ NE PAS activer Worker
                    console.log('[MANUAL/USER-KEYS MODE] Worker non activÃ©');
                    
                    // VÃ©rifier si on est en mode API Multi-LLM
                    const radioUserKeys = document.querySelector('input[name="mode"][value="user-keys"]');
                    if (radioUserKeys && radioUserKeys.checked) {
                        console.log('[USER-KEYS MODE] Mode API Multi-LLM actif');
                        multiLLM.switchMode('user_keys');
                    }
                }
                // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
                
            } catch (error) {
                console.error('Error handling file:', error);
                showStatus('Erreur lors de l\'analyse: ' + error.message, 'error');
            }
        }
        
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // STATUS & PROGRESS
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        
        function showStatus(message, type = 'info') {
            const statusEl = document.getElementById('statusMessage');
            statusEl.textContent = message;
            statusEl.className = 'status-message status-' + type;
            statusEl.style.display = 'block';
            
            setTimeout(() => {
                statusEl.style.display = 'none';
            }, 5000);
        }
        
        /**
         * âœ¨ V6.4.4 - Afficher loader discret pendant traitement API
         */
        function showProcessingLoader(message = 'Traitement en cours...', progress = null) {
            // CrÃ©er le loader s'il n'existe pas
            let loader = document.getElementById('processingLoader');
            
            if (!loader) {
                loader = document.createElement('div');
                loader.id = 'processingLoader';
                loader.style.cssText = `
                    position: fixed;
                    bottom: 0;
                    left: 0;
                    right: 0;
                    background: linear-gradient(135deg, #8FAFB1 0%, #C8D0C3 100%);
                    color: white;
                    padding: 15px 30px;
                    display: flex;
                    flex-direction: column;
                    gap: 10px;
                    z-index: 9999;
                    box-shadow: 0 -4px 20px rgba(0,0,0,0.15);
                    font-weight: 600;
                    font-size: 0.95em;
                `;
                
                loader.innerHTML = `
                    <div style="display:flex;align-items:center;justify-content:center;gap:15px;">
                        <div class="hourglass-spinner" style="font-size:1.5em;">â³</div>
                        <div id="loaderMessage"></div>
                    </div>
                    <div id="loaderProgressContainer" style="display:none;">
                        <div style="background:rgba(255,255,255,0.3);border-radius:10px;height:20px;overflow:hidden;">
                            <div id="loaderProgressBar" style="background:rgba(255,255,255,0.9);height:100%;width:0%;transition:width 0.3s ease;border-radius:10px;"></div>
                        </div>
                        <div id="loaderProgressText" style="text-align:center;margin-top:5px;font-size:0.9em;opacity:0.9;"></div>
                    </div>
                `;
                
                document.body.appendChild(loader);
                
                // Ajouter animation CSS pour le sablier
                const style = document.createElement('style');
                style.textContent = `
                    @keyframes rotate-hourglass {
                        0% { transform: rotate(0deg); }
                        50% { transform: rotate(180deg); }
                        100% { transform: rotate(360deg); }
                    }
                    .hourglass-spinner {
                        animation: rotate-hourglass 2s ease-in-out infinite;
                        display: inline-block;
                    }
                `;
                document.head.appendChild(style);
            }
            
            // Mettre Ã  jour le message
            const messageEl = document.getElementById('loaderMessage');
            if (messageEl) {
                messageEl.textContent = message;
            }
            
            // Mettre Ã  jour la barre de progression
            const progressContainer = document.getElementById('loaderProgressContainer');
            const progressBar = document.getElementById('loaderProgressBar');
            const progressText = document.getElementById('loaderProgressText');
            
            if (progress !== null && progressContainer && progressBar && progressText) {
                progressContainer.style.display = 'block';
                progressBar.style.width = `${progress.percent}%`;
                progressText.textContent = progress.text || '';
            } else if (progressContainer) {
                progressContainer.style.display = 'none';
            }
            
            loader.style.display = 'flex';
        }
        
        /**
         * âœ¨ V6.4.4 - Cacher le loader
         */
        function hideProcessingLoader() {
            const loader = document.getElementById('processingLoader');
            if (loader) {
                loader.style.display = 'none';
            }
        }
        
        function updateProgress(percent, stage, text) {
            const progressBar = document.getElementById('progressBar');
            const progressStage = document.getElementById('progressStage');
            const progressText = document.getElementById('progressText');
            const progressContainer = document.getElementById('progressContainer');
            
            progressContainer.style.display = 'block';
            progressBar.style.width = percent + '%';
            progressBar.textContent = Math.round(percent) + '%';
            progressStage.textContent = stage;
            progressText.textContent = text;
        }

        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // BATCH FUNCTIONS
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        
        // Setup batch file input and drag & drop listeners
        document.addEventListener('DOMContentLoaded', () => {
            const batchInput = document.getElementById('batchFileInput');
            const batchUploadZone = document.querySelector('.batch-upload');
            
            // File input change listener
            if (batchInput) {
                batchInput.addEventListener('change', (e) => {
                    console.log(`[BATCH] ğŸ“ FILE INPUT CHANGE dÃ©tectÃ©`);
                    console.log(`[BATCH] ğŸ“Š STATE.mode="${STATE.mode}", STATE.processingMode="${STATE.processingMode}"`);
                    
                    const files = Array.from(e.target.files);
                    addFilesToBatch(files);
                    e.target.value = ''; // Reset input
                });
            }
            
            // Drag & Drop listeners
            if (batchUploadZone) {
                batchUploadZone.addEventListener('dragover', (e) => {
                    e.preventDefault();
                    e.stopPropagation();
                    batchUploadZone.style.borderColor = 'var(--mer)';
                    batchUploadZone.style.backgroundColor = 'var(--vert-sauge)';
                });
                
                batchUploadZone.addEventListener('dragleave', (e) => {
                    e.preventDefault();
                    e.stopPropagation();
                    batchUploadZone.style.borderColor = '';
                    batchUploadZone.style.backgroundColor = '';
                });
                
                batchUploadZone.addEventListener('drop', (e) => {
                    e.preventDefault();
                    e.stopPropagation();
                    batchUploadZone.style.borderColor = '';
                    batchUploadZone.style.backgroundColor = '';
                    
                    console.log(`[BATCH] ğŸ¯ DROP EVENT dÃ©tectÃ© dans batchUploadZone`);
                    console.log(`[BATCH] ğŸ“Š STATE.mode="${STATE.mode}", STATE.processingMode="${STATE.processingMode}"`);
                    
                    const files = Array.from(e.dataTransfer.files);
                    if (files.length > 0) {
                        addFilesToBatch(files);
                    }
                });
            }
            
            // âœ… V6.7.0 KB ENGINE: Initialize worker models
            console.log('[INIT] âš™ï¸ Initializing worker provider selector...');
            if (document.getElementById('workerProvider')) {
                updateWorkerModels();
                console.log('[INIT] âœ… Worker models initialized');
            }
        });
        
        function addFilesToBatch(files) {
            if (!files || files.length === 0) return;
            
            console.log(`[BATCH] ğŸ“¥ addFilesToBatch() appelÃ© avec ${files.length} fichier(s)`);
            console.log(`[BATCH] ğŸ“Š STATE.mode="${STATE.mode}", STATE.processingMode="${STATE.processingMode}"`);
            
            // âš ï¸ Warning pour grands batches
            const newTotal = STATE.batch.queue.length + files.length;
            if (newTotal > 50 && newTotal <= 100) {
                const proceed = confirm(
                    `âš ï¸ ATTENTION: Vous allez traiter ${newTotal} fichiers.\n\n` +
                    `Recommandations:\n` +
                    `â€¢ 1-25 fichiers: Rapide et fiable\n` +
                    `â€¢ 26-50 fichiers: OK mais peut Ãªtre long\n` +
                    `â€¢ 51-100 fichiers: Risque de lenteur/timeout\n\n` +
                    `Voulez-vous continuer ?`
                );
                if (!proceed) return;
            } else if (newTotal > 100) {
                alert(
                    `âŒ LIMITE DÃ‰PASSÃ‰E: ${newTotal} fichiers\n\n` +
                    `Maximum recommandÃ©: 100 fichiers par batch\n\n` +
                    `Pour traiter de gros volumes:\n` +
                    `â€¢ Divisez en plusieurs batches de 50 fichiers\n` +
                    `â€¢ Ou utilisez un script externe en ligne de commande`
                );
                return;
            }
            
            files.forEach(file => {
                const fileId = crypto.randomUUID();
                const batchItem = {
                    id: fileId,
                    file: file,
                    status: 'queued',
                    progress: 0,
                    error: null,
                    result: null
                };
                
                STATE.batch.queue.push(batchItem);
                STATE.batch.stats.total++;
            });
            
            renderBatchQueue();
            updateBatchStats();
            updateBatchButtons();
            
            showStatus(`${files.length} fichier(s) ajoutÃ©(s) Ã  la file batch`, 'success');
        }
        
        function renderBatchQueue() {
            const queueContainer = document.getElementById('batchQueue');
            
            if (STATE.batch.queue.length === 0) {
                queueContainer.innerHTML = `
                    <div class="batch-empty">
                        <div class="batch-empty-icon">ğŸ“„</div>
                        <p>Aucun fichier dans la file batch</p>
                        <p style="font-size:0.9em;">SÃ©lectionnez plusieurs fichiers pour commencer</p>
                    </div>
                `;
                return;
            }
            
            queueContainer.innerHTML = '';
            STATE.batch.queue.forEach((item, index) => {
                renderBatchItem(item, index);
            });
        }
        
        function renderBatchItem(item, index) {
            const queueContainer = document.getElementById('batchQueue');
            let card = document.querySelector(`[data-file-id="${item.id}"]`);
            
            if (!card) {
                card = document.createElement('div');
                card.className = 'batch-item';
                card.setAttribute('data-file-id', item.id);
                queueContainer.appendChild(card);
            }
            
            const fileSize = (item.file.size / 1024 / 1024).toFixed(2);
            
            card.innerHTML = `
                <div class="batch-item-header">
                    <span class="batch-file-name">${item.file.name} (${fileSize} MB)</span>
                    <span class="batch-file-status status-${item.status}">${getStatusLabel(item.status)}</span>
                    <button class="batch-remove-btn" onclick="removeBatchItem(${index})" ${item.status === 'processing' ? 'disabled' : ''}>Ã—</button>
                </div>
                <div class="batch-progress-bar">
                    <div class="batch-progress-fill" style="width: ${item.progress}%"></div>
                </div>
                <div class="batch-progress-message">${item.status === 'processing' ? 'Traitement en cours...' : ''}</div>
                ${item.error ? `<div class="batch-error-message">${item.error}</div>` : ''}
            `;
        }
        
        function getStatusLabel(status) {
            const labels = {
                queued: 'En attente',
                processing: 'En cours',
                completed: 'TerminÃ©',
                error: 'Erreur'
            };
            return labels[status] || status;
        }
        
        function removeBatchItem(index) {
            const item = STATE.batch.queue[index];
            if (!item) return;
            
            if (item.status === 'processing') {
                showStatus('Impossible de supprimer un fichier en cours de traitement', 'warning');
                return;
            }
            
            STATE.batch.queue.splice(index, 1);
            STATE.batch.stats.total--;
            
            if (item.status === 'completed') STATE.batch.stats.completed--;
            if (item.status === 'error') STATE.batch.stats.errors--;
            
            renderBatchQueue();
            updateBatchStats();
            updateBatchButtons();
        }
        
        function clearBatch() {
            if (STATE.batch.status === 'running') {
                showStatus('Impossible d\'effacer pendant le traitement. Mettez en pause d\'abord.', 'warning');
                return;
            }
            
            if (!confirm(`Effacer tous les ${STATE.batch.queue.length} fichiers ?`)) return;
            
            STATE.batch.queue = [];
            STATE.batch.currentIndex = 0;
            STATE.batch.stats = {
                total: 0,
                completed: 0,
                errors: 0,
                skipped: 0
            };
            
            if (STATE.batchController) {
                STATE.batchController.progressTracker.clear();
                STATE.batchController.errorHandler.clearErrors();
            }
            
            renderBatchQueue();
            updateBatchStats();
            updateBatchButtons();
            
            showStatus('File batch effacÃ©e', 'info');
        }
        
        async function startBatch() {
            if (!STATE.batchController) {
                showStatus('Batch controller non initialisÃ©', 'error');
                return;
            }
            
            await STATE.batchController.startBatch();
        }
        
        function pauseBatch() {
            if (!STATE.batchController) return;
            STATE.batchController.pauseBatch();
        }
        
        async function resumeBatch() {
            if (!STATE.batchController) return;
            await STATE.batchController.resumeBatch();
        }
        
        function updateBatchStats() {
            document.getElementById('batchStatTotal').textContent = STATE.batch.stats.total;
            document.getElementById('batchStatCompleted').textContent = STATE.batch.stats.completed;
            document.getElementById('batchStatErrors').textContent = STATE.batch.stats.errors;
            
            if (STATE.batch.startTime) {
                const elapsed = Math.floor((Date.now() - STATE.batch.startTime) / 1000);
                document.getElementById('batchStatTime').textContent = `${elapsed}s`;
            }
        }
        
        function updateBatchButtons() {
            const startBtn = document.getElementById('batchStartBtn');
            const pauseBtn = document.getElementById('batchPauseBtn');
            const resumeBtn = document.getElementById('batchResumeBtn');
            const exportBtn = document.getElementById('batchExportBtn');
            const promptBtn = document.getElementById('batchPromptBtn');
            
            const hasFiles = STATE.batch.queue.length > 0;
            const isRunning = STATE.batch.status === 'running';
            const isPaused = STATE.batch.status === 'paused';
            const hasCompleted = STATE.batch.stats.completed > 0;
            
            startBtn.disabled = !hasFiles || isRunning || isPaused;
            pauseBtn.disabled = !isRunning;
            resumeBtn.disabled = !isPaused;
            exportBtn.disabled = !hasCompleted;
            promptBtn.disabled = !hasCompleted;
        }
        
        function updateBatchConfig() {
            STATE.batch.config.maxConcurrent = parseInt(document.getElementById('batchMaxConcurrent').value) || 3;
            STATE.batch.config.retryAttempts = parseInt(document.getElementById('batchRetryAttempts').value) || 2;
            STATE.batch.config.continueOnError = document.getElementById('batchContinueOnError').checked;
            STATE.batch.config.mergeStrategy = document.getElementById('batchMergeStrategy').value;
            
            if (STATE.batchController) {
                STATE.batchController.errorHandler = new BatchErrorHandler(STATE.batch.config);
            }
        }
        
        function applyBatchTemplate(templateName) {
            const templates = {
                books_documents: {
                    name: 'ğŸ“š Livres & Documents',
                    config: {
                        maxConcurrent: 2,
                        retryAttempts: 2,
                        continueOnError: true,
                        mergeStrategy: 'by_type'
                    },
                    settings: {
                        platform: 'chatgpt',
                        model: 'gpt-4o',
                        format: 32
                    }
                },
                media_collection: {
                    name: 'ğŸ¨ Collection MÃ©dia',
                    config: {
                        maxConcurrent: 3,
                        retryAttempts: 2,
                        continueOnError: true,
                        mergeStrategy: 'chronological'
                    },
                    settings: {
                        platform: 'chatgpt',
                        model: 'gpt-4o',
                        format: 32
                    }
                },
                academic_research: {
                    name: 'ğŸ”¬ AcadÃ©mique & Recherche',
                    config: {
                        maxConcurrent: 3,
                        retryAttempts: 2,
                        continueOnError: true,
                        mergeStrategy: 'alphabetical'
                    },
                    settings: {
                        platform: 'claude',
                        model: 'claude-opus-4-5-20251101',
                        format: 32
                    }
                },
                business_docs: {
                    name: 'ğŸ’¼ Documents Professionnels',
                    config: {
                        maxConcurrent: 4,
                        retryAttempts: 1,
                        continueOnError: true,
                        mergeStrategy: 'chronological'
                    },
                    settings: {
                        platform: 'claude',
                        model: 'claude-sonnet-4-20250514',
                        format: 32
                    }
                }
            };

            // Mode personnalisÃ© : on laisse l'utilisateur rÃ©gler les champs Ã  la main
            if (templateName === 'custom') {
                showStatus('Mode batch personnalisÃ© : ajustez les paramÃ¨tres ci-dessous.', 'info');
                return;
            }

            const template = templates[templateName];
            if (!template) {
                console.error('[Batch] Template inconnu:', templateName);
                showStatus('Template batch inconnu.', 'error');
                return;
            }

            const { config, settings } = template;

            // Appliquer la configuration batch au STATE
            STATE.batch.config.maxConcurrent   = config.maxConcurrent;
            STATE.batch.config.retryAttempts   = config.retryAttempts;
            STATE.batch.config.continueOnError = config.continueOnError;
            STATE.batch.config.mergeStrategy   = config.mergeStrategy;

            // Mettre Ã  jour l'UI si les Ã©lÃ©ments existent
            const maxConcInput   = document.getElementById('batchMaxConcurrent');
            const retryInput     = document.getElementById('batchRetryAttempts');
            const contErrorInput = document.getElementById('batchContinueOnError');
            const mergeSelect    = document.getElementById('batchMergeStrategy');

            if (maxConcInput)   maxConcInput.value   = config.maxConcurrent;
            if (retryInput)     retryInput.value     = config.retryAttempts;
            if (contErrorInput) contErrorInput.checked = !!config.continueOnError;
            if (mergeSelect)    mergeSelect.value    = config.mergeStrategy;

            if (STATE.batchController) {
                STATE.batchController.errorHandler = new BatchErrorHandler(STATE.batch.config);
            }

            // Appliquer la plateforme / modÃ¨le / format
            if (settings) {
                selectPlatform(settings.platform);

                const formatSelector = document.getElementById('formatSelector');
                if (formatSelector) {
                    formatSelector.value = String(settings.format);
                    STATE.format = settings.format;
                }

                if (settings.platform === 'chatgpt') {
                    const gptSel = document.getElementById('gptSelector');
                    if (gptSel) {
                        gptSel.value = settings.model;
                        STATE.gptModel = settings.model;
                    }
                } else if (settings.platform === 'claude') {
                    const claudeSel = document.getElementById('claudeSelector');
                    if (claudeSel) {
                        claudeSel.value = settings.model;
                        STATE.claudeModel = settings.model;
                    }
                }

                updateIndicators();
            }

            showStatus('Template "' + template.name + '" appliquÃ©', 'success');
        }

        function displayWeightSliders(selectedTypes) {
            const weightsSection = document.getElementById('weightsSection');
            const slidersList = document.getElementById('slidersList');

            if (!weightsSection || !slidersList) return;

            if (!STATE.analysis || !STATE.analysis.composition || !selectedTypes || selectedTypes.length === 0) {
                weightsSection.style.display = 'none';
                return;
            }

            weightsSection.style.display = 'block';

            const weights = STATE.analysis.composition.weights || {};

            // âœ¨ MAPPING COMPLET: 18 types (10 universels + 8 complÃ©mentaires)
            const names = {
                // Types universels (10)
                'text_paragraphs': 'Texte',
                'images_photos': 'Images',
                'tables_data': 'Tableaux',
                'charts_graphs': 'Graphiques',
                'diagrams_schemas': 'Diagrammes',
                'forms_templates': 'Formulaires',
                'lists_bullet_points': 'Listes',
                'code_technical': 'Code',
                'mathematical_formulas': 'Math',
                'annotations_highlights': 'Annotations',
                // Types complÃ©mentaires (8)
                'musical_notation': 'Notation Musicale',
                'citations_references': 'Citations',
                'exercises_questions': 'Exercices',
                'callouts_boxes': 'EncadrÃ©s',
                'index_glossary': 'Index',
                'case_studies': 'Ã‰tudes de Cas',
                'links_urls': 'Liens',
                'infographics': 'Infographies',
                // Anciens types (compatibilitÃ© rÃ©tro-active)
                'partition_musicale': 'Partition',
                'tablature': 'Tablature',
                'texte_pedagogique': 'PÃ©dagogie',
                'regles_jeu': 'Jeu',
                'document_therapie': 'ThÃ©rapie',
                'questionnaire_psy': 'Questionnaire',
                'paper_scientifique': 'Scientifique',
                'manuel_technique': 'Technique'
            };

            let html = '';
            selectedTypes.forEach(function(type) {
                const weight = (weights[type] || 0) * 100;
                const name = names[type] || type;

                html += '<div class="slider-item">';
                html += '<label>' + name + '</label>';
                html += '<input type="range" min="0" max="100" value="' + Math.round(weight) + '" ';
                html += 'id="slider_' + type + '" oninput="updateWeightsManual()">';
                html += '<span id="value_' + type + '">' + Math.round(weight) + '%</span>';
                html += '</div>';
            });

            slidersList.innerHTML = html;
        }
        
        function recalculateWeights(selectedTypes) {
            const detected = STATE.analysis.content.detected;
            const totalScore = detected
                .filter(d => selectedTypes.includes(d.type))
                .reduce((sum, d) => sum + d.score, 0);
            
            const newWeights = {};
            selectedTypes.forEach(type => {
                const item = detected.find(d => d.type === type);
                newWeights[type] = item ? item.score / totalScore : 1 / selectedTypes.length;
            });
            
            STATE.analysis.composition.weights = newWeights;
            STATE.analysis.composition.primary = selectedTypes[0];
            STATE.analysis.composition.secondary = selectedTypes.slice(1);
            
            displayWeightSliders(selectedTypes);
        }
        
        function updateWeightsManual() {
            const checkboxes = document.querySelectorAll('#contentCheckboxes input[type="checkbox"]:checked');
            const selectedTypes = Array.from(checkboxes).map(cb => cb.value);
            
            let total = 0;
            const rawWeights = {};
            
            selectedTypes.forEach(type => {
                const slider = document.getElementById('slider_' + type);
                const value = parseInt(slider.value);
                rawWeights[type] = value;
                total += value;
            });
            
            const normalized = {};
            selectedTypes.forEach(type => {
                normalized[type] = total > 0 ? rawWeights[type] / total : 1 / selectedTypes.length;
                document.getElementById('value_' + type).textContent = Math.round(normalized[type] * 100) + '%';
            });
            
            STATE.analysis.composition.weights = normalized;
        }
        
        function resetWeights() {
            if (!STATE.analysis) return;
            
            STATE.analysis.composition.weights = { ...STATE.analysis.composition.auto_weights };
            STATE.analysis.composition.manual_override = false;
            
            const checkboxes = document.querySelectorAll('#contentCheckboxes input[type="checkbox"]:checked');
            const selectedTypes = Array.from(checkboxes).map(cb => cb.value);
            
            displayWeightSliders(selectedTypes);
        }
        
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // CONFIGURATION
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        
        function selectPlatform(platform) {
            STATE.platform = platform;
            
            document.getElementById('platformChatGPT').classList.remove('selected');
            document.getElementById('platformClaude').classList.remove('selected');
            
            if (platform === 'chatgpt') {
                document.getElementById('platformChatGPT').classList.add('selected');
                document.getElementById('gptSelectorGroup').style.display = 'block';
                document.getElementById('claudeSelectorGroup').style.display = 'none';
            } else {
                document.getElementById('platformClaude').classList.add('selected');
                document.getElementById('gptSelectorGroup').style.display = 'none';
                document.getElementById('claudeSelectorGroup').style.display = 'block';
            }
            
            updateIndicators();
        }
        
        function updateIndicators() {
            STATE.format = parseInt(document.getElementById('formatSelector').value);
            STATE.gptModel = document.getElementById('gptSelector').value;
            STATE.claudeModel = document.getElementById('claudeSelector').value;
            
            let config;
            if (STATE.platform === 'chatgpt') {
                config = CONFIG.gpt[STATE.gptModel];
            } else {
                config = CONFIG.claude[STATE.claudeModel];
            }
            
            document.getElementById('qualityIndicator').textContent = config.quality;
            document.getElementById('speedIndicator').textContent = config.speed;
            document.getElementById('detailsIndicator').textContent = config.details;
            
            document.getElementById('formatDesc').innerHTML = `
                <strong>${STATE.format === 32 ? 'Format R&D (32 modules)' : 'Format Standard (7 modules)'}</strong><br>
                <p style="margin-top:10px;">${CONFIG.format[STATE.format]}</p>
            `;
        }
        
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // PROCESSING WORKFLOW
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        
        function calculateAdaptiveBatchSize() {
            const analysis = STATE.analysis;
            if (!analysis || !analysis.technical || !analysis.composition) {
                return STATE.format === 32 ? 30 : 50;
            }
            
            const base = CONFIG.BATCH_FACTORS.base_batch_size;
            const tech = analysis.technical.format;
            const weights = analysis.composition.weights;
            
            const techFactor = CONFIG.BATCH_FACTORS.technical[tech] || 1.0;
            
            let contentFactor = 0;
            for (const [type, weight] of Object.entries(weights)) {
                const factor = CONFIG.BATCH_FACTORS.content[type] || 1.0;
                contentFactor += factor * weight;
            }
            
            if (contentFactor === 0) contentFactor = 1.0;
            
            const batchSize = Math.round(base * techFactor * contentFactor);
            const finalBatch = Math.max(5, Math.min(50, batchSize));
            
            console.log('Batch size:', finalBatch);
            
            return finalBatch;
        }
        
        async function processFile() {
            // âœ… V6.4.4 - DÃ©tecter le mode actif
            const radioWorker = document.querySelector('input[name="mode"][value="worker"]');
            const radioUserKeys = document.querySelector('input[name="mode"][value="user-keys"]');
            const workerToggle = document.getElementById('workerToggle');
            
            const isWorkerMode = radioWorker && radioWorker.checked && workerToggle && workerToggle.checked;
            const isAPIUserKeysMode = radioUserKeys && radioUserKeys.checked;
            
            if (isWorkerMode) {
                // â•â•â• MODE WORKER â•â•â•
                console.log('[WORKER MODE] Processing via API Worker');
                
                // ğŸ”§ FIX: RÃ©cupÃ©rer le provider ET le modÃ¨le sÃ©lectionnÃ©s
                const workerProvider = document.getElementById('workerProvider')?.value || 'anthropic';
                const workerModel = document.getElementById('workerModel')?.value || 'claude-sonnet-4-20250514';
                
                console.log('[WORKER MODE] Provider:', workerProvider);
                console.log('[WORKER MODE] Model:', workerModel);
                
                document.getElementById('configSection').style.display = 'none';
                showStatus(`ğŸš€ Envoi au Worker ${workerProvider}...`, 'info');
                
                try {
                    multiLLM.switchMode('worker');
                    await sendSingleFileToAPI(workerProvider, workerModel);
                    showStatus('âœ… Traitement terminÃ© avec succÃ¨s!', 'success');
                } catch (error) {
                    console.error('[WORKER MODE] Processing failed:', error);
                    showStatus('âŒ Erreur: ' + error.message, 'error');
                }
                
            } else if (isAPIUserKeysMode) {
                // â•â•â• MODE API MULTI-LLM â•â•â•
                console.log('[API USER-KEYS MODE] Processing via user API keys');
                
                // âœ… V6.4.4 - Utiliser le provider et modÃ¨le sauvegardÃ©s
                const userProvider = STATE.selectedProvider || 'anthropic';
                const userModel = STATE.selectedModel || 'claude-sonnet-4-20250514';
                
                console.log('[API USER-KEYS] Using provider:', userProvider);
                console.log('[API USER-KEYS] Using model:', userModel);
                
                document.getElementById('configSection').style.display = 'none';
                showStatus(`ğŸš€ Envoi Ã  ${userProvider}...`, 'info');
                
                try {
                    multiLLM.switchMode('user_keys');
                    await sendSingleFileToAPI(userProvider, userModel);
                    showStatus('âœ… Traitement terminÃ© avec succÃ¨s!', 'success');
                } catch (error) {
                    console.error('[API USER-KEYS MODE] Processing failed:', error);
                    showStatus('âŒ Erreur: ' + error.message, 'error');
                }
                
            } else {
                // â•â•â• MODE MANUEL â•â•â•
                console.log('[MANUAL MODE] Processing via copy/paste workflow');
                document.getElementById('configSection').style.display = 'none';
                document.getElementById('phase2').style.display = 'block';
                
                await splitDocument();
                
                document.getElementById('phase2').scrollIntoView({ 
                    behavior: 'smooth', 
                    block: 'start' 
                });
            }
        }
        
        async function splitDocument() {
            let maxPagesPerPart = calculateAdaptiveBatchSize();
            
            const numParts = Math.ceil(STATE.totalPages / maxPagesPerPart);
            STATE.parts = [];
            
            if (STATE.fileType === 'pdf') {
                const arrayBuffer = await STATE.file.arrayBuffer();
                const pdfDoc = await PDFLib.PDFDocument.load(arrayBuffer, {
                    ignoreEncryption: true
                });
                
                for (let i = 0; i < numParts; i++) {
                    const startPage = i * maxPagesPerPart + 1;
                    const endPage = Math.min((i + 1) * maxPagesPerPart, STATE.totalPages);
                    
                    const newPdf = await PDFLib.PDFDocument.create();
                    const pages = await newPdf.copyPages(pdfDoc, 
                        Array.from({length: endPage - startPage + 1}, (_, j) => startPage - 1 + j)
                    );
                    pages.forEach(page => newPdf.addPage(page));
                    
                    const pdfBytes = await newPdf.save();
                    const blob = new Blob([pdfBytes], { type: 'application/pdf' });
                    
                    STATE.parts.push({
                        num: i + 1,
                        startPage,
                        endPage,
                        file: blob,
                        status: 'pending',
                        json: null
                    });
                }
            } else {
                STATE.parts.push({
                    num: 1,
                    startPage: 1,
                    endPage: 1,
                    file: STATE.file,
                    status: 'pending',
                    json: null
                });
            }
            
            displayParts();
        }
        
        function displayParts() {
            let html = '';
            STATE.parts.forEach((part, index) => {
                html += `
                    <div class="part-card" id="part-${index}">
                        <div class="part-header">
                            <div class="part-title">Partie ${part.num} â€¢ Pages ${part.startPage}-${part.endPage}</div>
                            <span class="status-badge status-pending" id="status-${index}">En attente</span>
                        </div>
                        
                        <div class="prompt-output" id="prompt-${index}">${generatePrompt(part)}</div>
                        
                        <div class="btn-group">
                            <button class="btn btn-small" onclick="copyAndDownload(${index})">
                                Copier Prompt & TÃ©lÃ©charger PDF
                            </button>
                        </div>
                        
                        <div style="margin-top:20px;">
                            <label style="font-weight:600;display:block;margin-bottom:10px;">
                                Collez ici le JSON gÃ©nÃ©rÃ© :
                            </label>
                            <textarea id="json-text-${index}" placeholder="Collez le JSON ici..."></textarea>
                            <div class="btn-group">
                                <button class="btn btn-secondary btn-small" onclick="validateJSON(${index})">
                                    Valider JSON
                                </button>
                                <button class="btn btn-small" onclick="acceptJSON(${index})">
                                    Accepter & Continuer
                                </button>
                            </div>
                            <div id="validation-${index}" style="margin-top:15px;"></div>
                        </div>
                    </div>
                `;
            });
            document.getElementById('partsContainer').innerHTML = html;
        }
        
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // PROMPT GENERATION (ADAPTIVE)
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        
        function generatePrompt(part) {
            const analysis = STATE.analysis || {};
            const tech = analysis.technical || { format: 'digital', quality: 'medium', ocr_required: false };
            const comp = analysis.composition || { primary: 'text_standard', secondary: [], weights: {} };
            
            // âœ… EXTRACTION DU TEXTE
            const extractedText = part.extractedText || part.text || STATE.extractedText || '';
            const startPage = part.startPage || 1;
            const endPage = part.endPage || part.totalPages || 'fin';
            
            let prompt = `â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
CONTRAT R&D ANTHROPIC - PROMPT ADAPTATIF MULTI-DIMENSIONNEL
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

Document : ${STATE.fileName}
Pages ${startPage}-${endPage}
Format : ${STATE.format === 32 ? 'R&D COMPLET 32 MODULES' : 'STANDARD 7 MODULES'}

VOUS AVEZ DÃ‰JÃ€ ACCEPTÃ‰ ET VALIDÃ‰ :
â€¢ Format : ${STATE.format} MODULES R&D ANTHROPIC
â€¢ Citations : Texte simple dans champ "citation"
â€¢ Compression : Intelligente AUTOMATIQUE
â€¢ Questions : ZÃ‰RO

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
CONTEXTE TECHNIQUE
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
`;
            
            const techModule = PROMPT_MODULES.technical[tech.format] || '';
            if (techModule) {
                prompt += techModule + '\n';
            }
            
            prompt += `
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
MODULES CONTENU (COMPOSITION ADAPTATIVE)
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
`;
            
            const primaryModule = PROMPT_MODULES.content[comp.primary];
            const primaryWeight = comp.weights[comp.primary] || 1.0;
            
            if (primaryModule) {
                prompt += `
MODULE PRINCIPAL (${Math.round(primaryWeight * 100)}%)
${'â•'.repeat(80)}

${primaryModule}
`;
            }
            
            if (comp.secondary && comp.secondary.length > 0) {
                comp.secondary.forEach(type => {
                    const module = PROMPT_MODULES.content[type];
                    const weight = comp.weights[type] || 0;
                    
                    if (module && weight > 0) {
                        prompt += `
MODULE SECONDAIRE (${Math.round(weight * 100)}%)
${'-'.repeat(80)}

${module}
`;
                    }
                });
            }
            
            const jsonStructure = generateFusedJSONStructure(comp, STATE.format);
            
            prompt += `
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
STRUCTURE JSON FUSIONNÃ‰E ADAPTATIVE
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

${jsonStructure}

Remplir TOUTES les sections prÃ©sentes selon les modules activÃ©s.

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
RÃˆGLE ABSOLUE - FORMAT JSON PUR
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

GÃ‰NÃ‰REZ JSON PUR UNIQUEMENT.
Commence EXACTEMENT par {
Termine EXACTEMENT par }
RIEN avant le {
RIEN aprÃ¨s le }

TOUS LES MODULES INDIQUÃ‰S SONT OBLIGATOIRES.
`;
            
            if (STATE.platform === 'chatgpt') {
                prompt += `
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
INSTRUCTIONS CHATGPT ANTI-PROCRASTINATION
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

CRITICAL RULES FOR CHATGPT:
1. Start IMMEDIATELY with JSON. NO preamble, NO explanation.
2. Complete ALL fields. Empty fields = FAILURE.
3. NO placeholders [TBD]. Extract actual data or use null.
4. NO questions, NO clarifications. Execute NOW.
5. Format already agreed. Do NOT ask for confirmation.

YOU ALREADY AGREED to this format in our previous contract.
PROCEED IMMEDIATELY.
`;
            }
            
            // âœ… AJOUT DU CONTENU DU DOCUMENT
            prompt += `

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
CONTENU Ã€ ANALYSER
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

${extractedText}

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
FIN DU CONTENU
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

Analysez le contenu ci-dessus et gÃ©nÃ©rez le JSON complet maintenant.
`;
            
            return prompt;
        }
        
        function generateFusedJSONStructure(composition, formatLevel) {
            const types = Object.keys(composition.weights || {});
            
            let structure = {
                metadata: {
                    type_composition: types,
                    weights: composition.weights,
                    format_level: formatLevel
                }
            };
            
            structure.structure_hierarchique = {};
            structure.index_conceptuel = {};
            structure.contenu_enrichi = {};
            
            if (types.includes('partition_musicale') || types.includes('tablature')) {
                structure.morceaux = [];
                structure.grilles_accords = [];
            }
            
            if (types.includes('tablature')) {
                structure.tablatures = [];
            }
            
            if (types.includes('texte_pedagogique')) {
                structure.objectifs_apprentissage = [];
                structure.exercices = [];
                structure.progression = {};
            }
            
            if (types.includes('regles_jeu')) {
                structure.composants = [];
                structure.deroulement = {};
                structure.conditions_victoire = "";
            }
            
            if (types.includes('document_therapie')) {
                structure.cas_cliniques = [];
                structure.outils_therapeutiques = [];
            }
            
            if (types.includes('questionnaire_psy')) {
                structure.echelles = [];
                structure.items = [];
                structure.scoring = {};
            }
            
            if (types.includes('paper_scientifique')) {
                structure.abstract = "";
                structure.methodologie = {};
                structure.resultats = {};
                structure.bibliographie = [];
            }
            
            if (types.includes('manuel_technique')) {
                structure.specifications = [];
                structure.procedures = [];
            }
            
            if (formatLevel === 32) {
                structure.graphe_connaissances = {};
                structure.taxonomie = {};
                structure.semantique = {};
                structure.pedagogie = {};
                structure.multimodal = {};
                structure.evaluation = {};
                structure.references = {};
                structure.citations_semantiques = {};
                structure.contexte_historique = {};
                structure.applications_pratiques = {};
                structure.controverses = {};
                structure.glossaire = {};
                structure.donnees_statistiques = {};
                structure.comparaisons = {};
                structure.implementation = {};
                structure.public_cible = {};
                structure.ressources_complementaires = {};
                structure.validation_qualite = {};
                structure.meta_analyse = {};
                structure.liens_externes = {};
                structure.temporalite = {};
                structure.patterns = {};
                structure.insights = {};
                structure.analytics = {};
            } else {
                structure.graphe_connaissances = {};
                structure.taxonomie = {};
                structure.analytics = {};
            }
            
            return JSON.stringify(structure, null, 2);
        }
        
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // COPY & DOWNLOAD
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        
        async function copyAndDownload(index) {
            const part = STATE.parts[index];
            const prompt = generatePrompt(part);
            
            try {
                await navigator.clipboard.writeText(prompt);
                showStatus('Prompt copiÃ© dans le presse-papiers !', 'success');
            } catch (error) {
                console.error('Erreur copie:', error);
                showStatus('Erreur copie presse-papiers', 'error');
            }
            
            const url = URL.createObjectURL(part.file);
            const a = document.createElement('a');
            a.href = url;
            a.download = `${STATE.fileName.replace(/\.[^/.]+$/, '')}_part${part.num}.pdf`;
            a.click();
            URL.revokeObjectURL(url);
        }
        
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // JSON VALIDATION
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        
        function validateJSON(index) {
            const textarea = document.getElementById(`json-text-${index}`);
            const validationDiv = document.getElementById(`validation-${index}`);
            
            try {
                const text = textarea.value.trim();
                const json = JSON.parse(text);
                
                validationDiv.innerHTML = `
                    <div class="status-message status-success" style="display:block;">
                        JSON valide ! ${Object.keys(json).length} clÃ©s trouvÃ©es.
                    </div>
                `;
                
                STATE.parts[index].json = json;
                
            } catch (error) {
                validationDiv.innerHTML = `
                    <div class="status-message status-error" style="display:block;">
                        Erreur JSON : ${error.message}
                    </div>
                `;
            }
        }
        
        function acceptJSON(index) {
            const textarea = document.getElementById(`json-text-${index}`);
            
            try {
                const text = textarea.value.trim();
                const json = JSON.parse(text);
                
                STATE.parts[index].json = json;
                STATE.parts[index].status = 'completed';
                
                document.getElementById(`status-${index}`).textContent = 'TerminÃ©';
                document.getElementById(`status-${index}`).className = 'status-badge status-completed';
                
                showStatus(`Partie ${STATE.parts[index].num} acceptÃ©e !`, 'success');
                
                const allCompleted = STATE.parts.every(p => p.status === 'completed');
                if (allCompleted) {
                    showStatus('Toutes les parties terminÃ©es ! GÃ©nÃ©ration ZIP...', 'success');
                    setTimeout(() => {
                        downloadZIP();
                    }, 1000);
                }
                
            } catch (error) {
                showStatus('Erreur : JSON invalide', 'error');
            }
        }
        
        // âœ… NOUVEAU : TÃ©lÃ©charger le rÃ©sultat API comme ZIP complet
        async function downloadAPIResultAsZIP(jsonData, provider, model) {
            if (typeof JSZip === 'undefined') {
                alert('BibliothÃ¨que JSZip non chargÃ©e');
                return;
            }
            
            showStatus('GÃ©nÃ©ration du ZIP complet...', 'info');
            
            try {
                const zip = new JSZip();
                const folderName = STATE.fileName.replace(/\.[^/.]+$/, '');
                const folder = zip.folder(folderName);
                
                // 1. knowledge_index.json
                folder.file('knowledge_index.json', JSON.stringify(jsonData, null, 2));
                
                // 2. knowledge.md
                const markdownContent = generateKnowledgeMD(jsonData);
                folder.file('knowledge.md', markdownContent);
                
                // 3. index.html (viewer)
                const htmlContent = generateIndexHTML(jsonData);
                folder.file('index.html', htmlContent);
                
                // 4. README.md
                const readmeContent = `# ${folderName} - Base de Connaissances

## Document
- Nom : ${STATE.fileName}
- Pages : ${STATE.totalPages}
- Taille : ${((STATE.fileSize || 0) / 1024 / 1024).toFixed(2)} MB
- Provider : ${provider}
- Model : ${model}

## Fichiers
- **knowledge_index.json** : Base de connaissances structurÃ©e (32 modules)
- **knowledge.md** : Version Markdown lisible
- **index.html** : Viewer HTML interactif
- **README.md** : Ce fichier
- **${STATE.fileName}** : Document original

## Utilisation

### Consulter la base de connaissances
Ouvrez \`index.html\` dans votre navigateur pour une vue interactive.

### Utiliser le JSON
Le fichier \`knowledge_index.json\` contient 32 modules structurÃ©s :
- metadata, structure_hierarchique, index_conceptuel
- contenu_enrichi, graphe_connaissances, taxonomie
- semantique, pedagogie, multimodal, evaluation
- et 22 autres modules...

### Lire en Markdown
Le fichier \`knowledge.md\` est une version lisible pour Ã©dition.

---
GÃ©nÃ©rÃ© avec **OCR Universel V6.0 ULTIMATE**  
Provider: ${provider} | Model: ${model}  
Date: ${new Date().toLocaleString('fr-FR')}
`;
                folder.file('README.md', readmeContent);
                
                // 5. Document original
                folder.file(STATE.fileName, STATE.file);
                
                // GÃ©nÃ©rer et tÃ©lÃ©charger le ZIP
                const blob = await zip.generateAsync({
                    type: 'blob',
                    compression: 'DEFLATE',
                    compressionOptions: { level: 6 }
                });
                
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `${folderName}_${provider}_complete.zip`;
                a.click();
                URL.revokeObjectURL(url);
                
                showStatus('âœ… ZIP complet tÃ©lÃ©chargÃ© avec succÃ¨s !', 'success');
                
            } catch (error) {
                console.error('Error creating ZIP:', error);
                showStatus('âŒ Erreur lors de la crÃ©ation du ZIP', 'error');
            }
        }
        
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // EXPORT ZIP
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        
        async function downloadZIP() {
            if (typeof JSZip === 'undefined') {
                alert('BibliothÃ¨que JSZip non chargÃ©e');
                return;
            }
            
            const zip = new JSZip();
            const merged = mergeAllJSON();
            const folderName = STATE.fileName.replace(/\.[^/.]+$/, '');
            const folder = zip.folder(folderName);
            
            folder.file('knowledge_index.json', JSON.stringify(merged, null, 2));
            folder.file('README.md', generateREADME());
            folder.file(STATE.fileName, STATE.file);
            
            const blob = await zip.generateAsync({type: 'blob'});
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = folderName + '_OCR_v6.0.zip';
            a.click();
            URL.revokeObjectURL(url);
            
            showStatus('ZIP tÃ©lÃ©chargÃ© avec succÃ¨s !', 'success');
            
            showStatistics();
            showExportSection();
        }
        
        function mergeAllJSON() {
            if (STATE.parts.length === 1) return STATE.parts[0].json;
            
            const merged = JSON.parse(JSON.stringify(STATE.parts[0].json));
            
            for (let i = 1; i < STATE.parts.length; i++) {
                const part = STATE.parts[i].json;
                if (part.structure_hierarchique?.sections) {
                    merged.structure_hierarchique.sections.push(...part.structure_hierarchique.sections);
                }
            }
            
            return merged;
        }
        
        function generateREADME() {
            return `# ${STATE.fileName.replace(/\.[^/.]+$/, '')} - Base de Connaissances

## Document
- Nom : ${STATE.fileName}
- Pages : ${STATE.totalPages}
- Format : ${STATE.format} modules
- Plateforme : ${STATE.platform}

## Fichiers
- knowledge_index.json : Base de connaissances structurÃ©e
- knowledge.md : Version Markdown lisible
- index.html : Viewer HTML interactif
- README.md : Ce fichier
- ${STATE.fileName} : Document original

GÃ©nÃ©rÃ© avec OCR Universel V6.0 ULTIMATE - API Multi-LLM
`;
        }
        
        // âœ… NOUVEAU : GÃ©nÃ©rer knowledge.md
        function generateKnowledgeMD(jsonData) {
            let md = `# ${STATE.fileName.replace(/\.[^/.]+$/, '')} - Base de Connaissances\n\n`;
            
            // ========================================
            // MÃ‰TADONNÃ‰ES
            // ========================================
            md += `## ğŸ“‹ MÃ©tadonnÃ©es\n\n`;
            if (jsonData.metadata) {
                if (jsonData.metadata.type_composition) {
                    md += `**Types de composition :**\n`;
                    jsonData.metadata.type_composition.forEach(type => {
                        md += `- ${type}\n`;
                    });
                    md += `\n`;
                }
                if (jsonData.metadata.format_level) {
                    md += `**Format Level :** ${jsonData.metadata.format_level}\n\n`;
                }
                if (jsonData.metadata.weights) {
                    md += `**PondÃ©rations :**\n`;
                    Object.entries(jsonData.metadata.weights).forEach(([key, val]) => {
                        md += `- ${key}: ${val}\n`;
                    });
                    md += `\n`;
                }
            }
            
            // ========================================
            // STRUCTURE HIÃ‰RARCHIQUE
            // ========================================
            md += `## ğŸ“š Structure HiÃ©rarchique\n\n`;
            if (jsonData.structure_hierarchique?.ouvrage) {
                const ouvrage = jsonData.structure_hierarchique.ouvrage;
                md += `### Ouvrage\n\n`;
                md += `**Titre :** ${ouvrage.titre || 'N/A'}\n`;
                if (ouvrage.auteurs && Array.isArray(ouvrage.auteurs)) {
                    md += `**Auteurs :** ${ouvrage.auteurs.join(', ')}\n`;
                }
                md += `\n`;
                
                if (ouvrage.sections && Array.isArray(ouvrage.sections)) {
                    ouvrage.sections.forEach((section, idx) => {
                        if (section.type === 'chapitre' && section.numero) {
                            md += `#### Chapitre ${section.numero}: ${section.titre || ''}\n`;
                            if (section.axes && Array.isArray(section.axes)) {
                                section.axes.forEach(axe => md += `- ${axe}\n`);
                            }
                            if (section.etudes_de_cas && Array.isArray(section.etudes_de_cas)) {
                                md += `\n**Ã‰tudes de cas :**\n`;
                                section.etudes_de_cas.forEach(cas => md += `- ${cas}\n`);
                            }
                            md += `\n`;
                        } else if (section.type === 'preface' || section.type === 'introduction') {
                            md += `#### ${section.type.charAt(0).toUpperCase() + section.type.slice(1)}\n`;
                            if (section.titre) md += `**Titre :** ${section.titre}\n`;
                            if (section.auteur) md += `**Auteur :** ${section.auteur}\n`;
                            if (section.idees_clefs && Array.isArray(section.idees_clefs)) {
                                md += `**IdÃ©es clÃ©s :**\n`;
                                section.idees_clefs.forEach(idee => md += `- ${idee}\n`);
                            }
                            md += `\n`;
                        }
                    });
                }
            }
            
            // ========================================
            // INDEX CONCEPTUEL
            // ========================================
            md += `## ğŸ§  Index Conceptuel\n\n`;
            if (jsonData.index_conceptuel) {
                // Support des deux formats: concepts_operationnels (ancien) et concepts (nouveau)
                const concepts = jsonData.index_conceptuel.concepts || jsonData.index_conceptuel.concepts_operationnels;
                
                if (concepts && Array.isArray(concepts)) {
                    md += `### Concepts OpÃ©rationnels\n\n`;
                    concepts.forEach(concept => {
                        if (typeof concept === 'object' && concept.terme) {
                            md += `#### ${concept.terme}\n`;
                            if (concept.definition_operationnelle) {
                                md += `${concept.definition_operationnelle}\n\n`;
                            }
                            if (concept.contextes && Array.isArray(concept.contextes)) {
                                md += `**Contextes :** ${concept.contextes.join(', ')}\n`;
                            }
                            if (concept.outils && Array.isArray(concept.outils)) {
                                md += `**Outils :** ${concept.outils.join(', ')}\n`;
                            }
                            if (concept.applications && Array.isArray(concept.applications)) {
                                md += `**Applications :** ${concept.applications.join(', ')}\n`;
                            }
                            if (concept.fonctions && Array.isArray(concept.fonctions)) {
                                md += `**Fonctions :** ${concept.fonctions.join(', ')}\n`;
                            }
                            if (concept.mecanismes && Array.isArray(concept.mecanismes)) {
                                md += `**MÃ©canismes :** ${concept.mecanismes.join(', ')}\n`;
                            }
                            md += `\n`;
                        }
                    });
                }
                
                if (jsonData.index_conceptuel.mots_cles) {
                    md += `### Mots-clÃ©s\n\n`;
                    Object.entries(jsonData.index_conceptuel.mots_cles).forEach(([categorie, mots]) => {
                        md += `**${categorie} :**\n`;
                        if (Array.isArray(mots)) {
                            mots.forEach(mot => md += `- ${mot}\n`);
                        }
                        md += `\n`;
                    });
                }
            }
            
            // ========================================
            // CONTENU ENRICHI
            // ========================================
            if (jsonData.contenu_enrichi) {
                md += `## ğŸ“ Contenu Enrichi\n\n`;
                Object.entries(jsonData.contenu_enrichi).forEach(([key, value]) => {
                    md += `### ${key}\n`;
                    if (typeof value === 'string') {
                        md += `${value}\n\n`;
                    } else if (Array.isArray(value)) {
                        value.forEach(item => {
                            if (typeof item === 'string') {
                                md += `- ${item}\n`;
                            } else if (typeof item === 'object') {
                                md += `- ${JSON.stringify(item, null, 2)}\n`;
                            }
                        });
                        md += `\n`;
                    } else if (typeof value === 'object') {
                        md += `\`\`\`json\n${JSON.stringify(value, null, 2)}\n\`\`\`\n\n`;
                    }
                });
            }
            
            // ========================================
            // GRAPHE DE CONNAISSANCES
            // ========================================
            if (jsonData.graphe_connaissances) {
                md += `## ğŸ•¸ï¸ Graphe de Connaissances\n\n`;
                if (jsonData.graphe_connaissances.noeuds && Array.isArray(jsonData.graphe_connaissances.noeuds)) {
                    md += `### NÅ“uds (${jsonData.graphe_connaissances.noeuds.length})\n`;
                    jsonData.graphe_connaissances.noeuds.slice(0, 20).forEach(noeud => {
                        if (typeof noeud === 'object' && noeud.id) {
                            md += `- **${noeud.id}** (${noeud.type || 'concept'})\n`;
                        } else {
                            md += `- ${noeud}\n`;
                        }
                    });
                    if (jsonData.graphe_connaissances.noeuds.length > 20) {
                        md += `\n*... et ${jsonData.graphe_connaissances.noeuds.length - 20} autres nÅ“uds*\n`;
                    }
                    md += `\n`;
                }
                if (jsonData.graphe_connaissances.aretes && Array.isArray(jsonData.graphe_connaissances.aretes)) {
                    md += `### ArÃªtes (${jsonData.graphe_connaissances.aretes.length})\n`;
                    jsonData.graphe_connaissances.aretes.slice(0, 15).forEach(arete => {
                        if (typeof arete === 'object') {
                            md += `- ${arete.source || 'A'} â†’ ${arete.target || 'B'} (${arete.relation || 'relation'})\n`;
                        }
                    });
                    if (jsonData.graphe_connaissances.aretes.length > 15) {
                        md += `\n*... et ${jsonData.graphe_connaissances.aretes.length - 15} autres relations*\n`;
                    }
                    md += `\n`;
                }
            }
            
            // ========================================
            // AUTRES MODULES (aperÃ§u)
            // ========================================
            const otherModules = [
                'taxonomie', 'semantique', 'pedagogie', 'multimodal',
                'evaluation', 'references', 'glossaire', 'citations',
                'contexte_historique', 'applications_pratiques',
                'controverses', 'comparaisons', 'implementation',
                'public_cible', 'ressources', 'validation'
            ];
            
            otherModules.forEach(moduleName => {
                if (jsonData[moduleName]) {
                    md += `## ${moduleName.replace(/_/g, ' ').toUpperCase()}\n\n`;
                    
                    if (typeof jsonData[moduleName] === 'object' && !Array.isArray(jsonData[moduleName])) {
                        Object.entries(jsonData[moduleName]).slice(0, 10).forEach(([key, value]) => {
                            md += `**${key}:**\n`;
                            if (typeof value === 'string') {
                                md += `${value}\n\n`;
                            } else if (Array.isArray(value)) {
                                value.slice(0, 5).forEach(item => {
                                    md += `- ${typeof item === 'object' ? JSON.stringify(item) : item}\n`;
                                });
                                if (value.length > 5) md += `*... et ${value.length - 5} autres*\n`;
                                md += `\n`;
                            }
                        });
                    } else if (Array.isArray(jsonData[moduleName])) {
                        jsonData[moduleName].slice(0, 10).forEach(item => {
                            md += `- ${typeof item === 'object' ? JSON.stringify(item) : item}\n`;
                        });
                        if (jsonData[moduleName].length > 10) {
                            md += `\n*... et ${jsonData[moduleName].length - 10} autres Ã©lÃ©ments*\n`;
                        }
                        md += `\n`;
                    }
                }
            });
            
            // ========================================
            // FOOTER
            // ========================================
            md += `\n---\n\n`;
            md += `*Base de connaissances gÃ©nÃ©rÃ©e par **OCR Universel V6.9.6***\n`;
            md += `*Format : 32 modules R&D - ${new Date().toLocaleString('fr-FR')}*\n`;
            
            return md;
        }
        
        // âœ… NOUVEAU : GÃ©nÃ©rer index.html viewer
        function generateIndexHTML(jsonData) {
            const fileName = STATE.fileName.replace(/\.[^/.]+$/, '');
            return `<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>${fileName} - Knowledge Viewer</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { 
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            line-height: 1.6;
            color: #333;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 20px;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 16px;
            padding: 40px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
        }
        h1 { 
            color: #667eea;
            font-size: 2.5em;
            margin-bottom: 10px;
            background: linear-gradient(135deg, #667eea, #764ba2);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        h2 { 
            color: #764ba2;
            font-size: 1.8em;
            margin-top: 30px;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 2px solid #667eea;
        }
        h3 { 
            color: #667eea;
            font-size: 1.3em;
            margin-top: 20px;
            margin-bottom: 10px;
        }
        .metadata {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 8px;
            margin: 20px 0;
        }
        .metadata-item {
            display: inline-block;
            margin-right: 30px;
            margin-bottom: 10px;
        }
        .metadata-label {
            font-weight: 600;
            color: #666;
        }
        .metadata-value {
            color: #333;
        }
        .tag {
            display: inline-block;
            background: #667eea;
            color: white;
            padding: 5px 15px;
            border-radius: 20px;
            margin: 5px;
            font-size: 0.9em;
        }
        .card {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 8px;
            margin: 15px 0;
            border-left: 4px solid #667eea;
        }
        ul { 
            list-style: none;
            padding-left: 0;
        }
        li {
            padding: 8px 0;
            padding-left: 25px;
            position: relative;
        }
        li:before {
            content: "â–¸";
            position: absolute;
            left: 0;
            color: #667eea;
            font-weight: bold;
        }
        .footer {
            text-align: center;
            margin-top: 40px;
            padding-top: 20px;
            border-top: 1px solid #ddd;
            color: #666;
            font-size: 0.9em;
        }
        pre {
            background: #2d2d2d;
            color: #f8f8f2;
            padding: 20px;
            border-radius: 8px;
            overflow-x: auto;
            font-size: 0.9em;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ“š ${fileName}</h1>
        <p style="color: #666; font-size: 1.1em; margin-bottom: 20px;">Base de connaissances enrichie</p>
        
        <div class="metadata">
            <div class="metadata-item">
                <span class="metadata-label">Type:</span>
                <span class="metadata-value">${jsonData.metadata?.type_composition?.join(', ') || 'N/A'}</span>
            </div>
            <div class="metadata-item">
                <span class="metadata-label">Format:</span>
                <span class="metadata-value">${jsonData.metadata?.format_level || 'N/A'} modules</span>
            </div>
            <div class="metadata-item">
                <span class="metadata-label">Domaine:</span>
                <span class="metadata-value">${jsonData.taxonomie?.domaine || 'N/A'}</span>
            </div>
        </div>
        
        ${jsonData.structure_hierarchique?.chapitres ? `
        <h2>ğŸ“– Structure</h2>
        <div class="card">
            <h3>Chapitres</h3>
            <ul>
                ${jsonData.structure_hierarchique.chapitres.map(ch => `<li>${ch}</li>`).join('')}
            </ul>
        </div>
        ` : ''}
        
        ${jsonData.index_conceptuel?.mots_clÃ©s ? `
        <h2>ğŸ·ï¸ Mots-clÃ©s</h2>
        <div>
            ${jsonData.index_conceptuel.mots_clÃ©s.map(kw => `<span class="tag">${kw}</span>`).join('')}
        </div>
        ` : ''}
        
        ${jsonData.contenu_enrichi?.rÃ©sumÃ© ? `
        <h2>ğŸ“ RÃ©sumÃ©</h2>
        <div class="card">
            ${jsonData.contenu_enrichi.rÃ©sumÃ©}
        </div>
        ` : ''}
        
        ${jsonData.contenu_enrichi?.analyse ? `
        <h2>ğŸ” Analyse</h2>
        <div class="card">
            ${jsonData.contenu_enrichi.analyse}
        </div>
        ` : ''}
        
        ${jsonData.glossaire?.termes ? `
        <h2>ğŸ“š Glossaire</h2>
        ${jsonData.glossaire.termes.map((terme, i) => `
            <div class="card">
                <h3>${terme}</h3>
                <p>${jsonData.glossaire.dÃ©finitions?.[i] || 'N/A'}</p>
            </div>
        `).join('')}
        ` : ''}
        
        <h2>ğŸ—‚ï¸ DonnÃ©es complÃ¨tes (JSON)</h2>
        <pre>${JSON.stringify(jsonData, null, 2)}</pre>
        
        <div class="footer">
            <p>GÃ©nÃ©rÃ© avec <strong>OCR Universel V6.0 ULTIMATE</strong></p>
            <p>Multi-LLM API Manager | Format 32 modules</p>
        </div>
    </div>
</body>
</html>`;
        }
        
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // STATISTICS
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        
        function showStatistics() {
            const stats = {
                totalPages: STATE.totalPages,
                totalWords: STATE.extractedText ? STATE.extractedText.split(/\s+/).length : 0,
                avgConfidence: STATE.analysis?.technical?.ocr_confidence || 1.0,
                processingTime: STATE.startTime ? (Date.now() - STATE.startTime) / 1000 : 0,
                format: STATE.fileType.toUpperCase(),
                size: (STATE.fileSize / 1024 / 1024).toFixed(2) + ' MB'
            };
            
            const statsGrid = document.getElementById('statsGrid');
            statsGrid.innerHTML = `
                <div class="stat-card">
                    <div class="stat-value">${stats.totalPages}</div>
                    <div class="stat-label">Pages</div>
                </div>
                <div class="stat-card" style="background:linear-gradient(135deg, #11998e, #38ef7d);">
                    <div class="stat-value">${stats.totalWords.toLocaleString()}</div>
                    <div class="stat-label">Mots extraits</div>
                </div>
                <div class="stat-card" style="background:linear-gradient(135deg, #ee0979, #ff6a00);">
                    <div class="stat-value">${Math.round(stats.avgConfidence * 100)}%</div>
                    <div class="stat-label">Confiance</div>
                </div>
                <div class="stat-card" style="background:linear-gradient(135deg, #4568dc, #b06ab3);">
                    <div class="stat-value">${Math.round(stats.processingTime)}s</div>
                    <div class="stat-label">Temps</div>
                </div>
                <div class="stat-card" style="background:linear-gradient(135deg, #f093fb, #f5576c);">
                    <div class="stat-value">${stats.format}</div>
                    <div class="stat-label">Format</div>
                </div>
                <div class="stat-card" style="background:linear-gradient(135deg, #4facfe, #00f2fe);">
                    <div class="stat-value">${stats.size}</div>
                    <div class="stat-label">Taille</div>
                </div>
            `;
            
            document.getElementById('statsSection').style.display = 'block';
            document.getElementById('statsSection').scrollIntoView({ behavior: 'smooth' });
        }
        
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // API V6.0 - INTERFACE 3 MODES
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        
        function openPromptModal() {
            if (!STATE.batch || !STATE.batch.consolidatedResults || STATE.batch.consolidatedResults.length === 0) {
                showStatus('Aucun document traitÃ©. Lancez d\'abord le batch processing.', 'error');
                return;
            }
            
            document.getElementById('promptModal').style.display = 'block';
            selectMode('manual'); // Mode Manuel par dÃ©faut
        }
        
        function closePromptModal() {
            document.getElementById('promptModal').style.display = 'none';
        }
        
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // SYSTÃˆME DE TABS MODERNES + SMOOTH SCROLLING
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        
        // âœ… Fonction switchModeTab dÃ©placÃ©e plus bas (ligne ~8885)
        
        // âœ… SMOOTH SCROLL INTELLIGENT
        function smoothScrollToElement(element, offset = -20) {
            if (!element) return;
            
            const elementPosition = element.getBoundingClientRect().top;
            const offsetPosition = elementPosition + window.pageYOffset + offset;
            
            window.scrollTo({
                top: offsetPosition,
                behavior: 'smooth'
            });
            
            // Highlight temporaire
            highlightElement(element);
        }
        
        // âœ… HIGHLIGHT TEMPORAIRE
        function highlightElement(element) {
            if (!element) return;
            
            // Ajouter la class highlight
            element.classList.add('highlight-flash');
            
            // Retirer aprÃ¨s 2 secondes
            setTimeout(() => {
                element.classList.remove('highlight-flash');
            }, 2000);
        }
        
        // âœ… SCROLL APRÃˆS UPLOAD PDF
        function scrollToProcessingSection() {
            const section = document.getElementById('processingSection') || 
                           document.querySelector('.processing-status');
            if (section) {
                setTimeout(() => {
                    smoothScrollToElement(section, -100);
                }, 500);
            }
        }
        
        // âœ… SCROLL APRÃˆS SÃ‰LECTION PROVIDER
        function scrollToProviderConfig() {
            const config = document.getElementById('providerConfig');
            if (config && config.style.display !== 'none') {
                setTimeout(() => {
                    smoothScrollTo('providerConfig');
                }, 300);
            }
        }
        
        // âœ… SCROLL VERS DOCUMENT ACTIF EN BATCH
        function scrollToActiveDocument(documentIndex) {
            // Utiliser la nouvelle fonction
            scrollToBatchDocument(documentIndex);
        }
        
        // Fonction obsolÃ¨te, gardÃ©e pour compatibilitÃ©
        function smoothScrollToElement(element) {
            if (element) {
                element.scrollIntoView({ behavior: 'smooth', block: 'start' });
            }
        }
        
        // âœ… SCROLL VERS MODALE (CENTRE DE L'Ã‰CRAN)
        function centerModal(modalId) {
            const modal = document.getElementById(modalId);
            if (modal && modal.style.display !== 'none') {
                const modalContent = modal.querySelector('.modal-content, .api-result-content');
                if (modalContent) {
                    // Centre la modale verticalement
                    setTimeout(() => {
                        modalContent.scrollIntoView({ 
                            behavior: 'smooth', 
                            block: 'center' 
                        });
                        highlightElement(modalContent);
                    }, 100);
                }
            }
        }
        
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // ANCIENNE FONCTION selectMode (compatibilitÃ©)
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        
        function selectMode(modeName) {
            // Rediriger vers la nouvelle fonction
            switchModeTab(modeName);
        }
        
        // â•â•â• MODE 2: USER KEYS - PROVIDER SELECTION â•â•â•
        
        function selectProvider(providerId) {
            console.log('[DEBUG] selectProvider called with:', providerId);
            
            // DÃ©sÃ©lectionner toutes les cartes
            document.querySelectorAll('.provider-card').forEach(card => {
                card.classList.remove('selected');
            });
            
            // SÃ©lectionner la carte cliquÃ©e
            const selectedCard = document.querySelector(`[data-provider="${providerId}"]`);
            if (selectedCard) {
                selectedCard.classList.add('selected');
                console.log('[DEBUG] Card selected:', providerId);
            } else {
                console.error('[DEBUG] Card not found for:', providerId);
            }
            
            // Mettre Ã  jour la config
            const providerNames = {
                'anthropic': 'Anthropic Claude',
                'openai': 'OpenAI GPT',
                'deepseek': 'DeepSeek',
                'groq': 'Groq'
            };
            
            // Remplir les modÃ¨les
            const models = {
                'anthropic': [
                    { value: 'claude-sonnet-4-5-20250929', label: 'Claude Sonnet 4.5 â­ (RecommandÃ© - Ã‰quilibrÃ©)' },
                    { value: 'claude-opus-4-5-20251101', label: 'Claude Opus 4.5 (Premium - QualitÃ© max)' },
                    { value: 'claude-haiku-4-5-20251001', label: 'Claude Haiku 4.5 (Rapide - Ã‰conomique)' },
                    { value: 'claude-sonnet-4-20250514', label: 'Claude Sonnet 4' },
                    { value: 'claude-opus-4-1-20250805', label: 'Claude Opus 4.1' }
                ],
                'openai': [
                    { value: 'gpt-4o', label: 'GPT-4o' },
                    { value: 'gpt-4o-mini', label: 'GPT-4o Mini' },
                    { value: 'o1', label: 'o1 (Raisonnement)' }
                ],
                'deepseek': [
                    { value: 'deepseek-chat', label: 'DeepSeek-V3 (RecommandÃ© - $0.27/M)' },
                    { value: 'deepseek-reasoner', label: 'DeepSeek-R1 (Raisonnement - $0.55/M)' }
                ],
                'groq': [
                    { value: 'llama-3.3-70b-versatile', label: 'Llama 3.3 70B (GRATUIT) ğŸ' },
                    { value: 'llama-3.1-70b-versatile', label: 'Llama 3.1 70B (GRATUIT) ğŸ' },
                    { value: 'mixtral-8x7b-32768', label: 'Mixtral 8x7B (GRATUIT) ğŸ' }
                ]
            };
            
            const placeholders = {
                'anthropic': 'sk-ant-api03-...',
                'openai': 'sk-...',
                'deepseek': 'sk-...',
                'groq': 'gsk_...'
            };
            
            const labels = {
                'anthropic': 'ClÃ© API Anthropic:',
                'openai': 'ClÃ© API OpenAI:',
                'deepseek': 'ClÃ© API DeepSeek:',
                'groq': 'ClÃ© API Groq:'
            };
            
            const modelSelect = document.getElementById('userModel');
            modelSelect.innerHTML = '';
            models[providerId].forEach(model => {
                const option = document.createElement('option');
                option.value = model.value;
                option.textContent = model.label;
                modelSelect.appendChild(option);
            });
            console.log('[DEBUG] Models populated:', models[providerId].length, 'models');
            
            document.getElementById('userKeyLabel').textContent = labels[providerId];
            document.getElementById('userApiKey').placeholder = placeholders[providerId];
            document.getElementById('userApiKey').value = '';
            
            // Afficher la config
            document.getElementById('providerConfig').style.display = 'block';
            console.log('[DEBUG] Provider config displayed');
            
            // âœ… SCROLL AUTOMATIQUE VERS CONFIG
            scrollToProviderConfig();
            
            // Sauvegarder le provider sÃ©lectionnÃ©
            STATE.selectedProvider = providerId;
            console.log('[DEBUG] STATE.selectedProvider set to:', STATE.selectedProvider);
            
            // Calculer le coÃ»t
            updateUserCost();
            
            showStatus(`âœ… ${providerNames[providerId]} sÃ©lectionnÃ©`, 'success');
            console.log('[DEBUG] Status shown:', `${providerNames[providerId]} sÃ©lectionnÃ©`);
        }
        
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // NOUVEAU SYSTÃˆME ACCORDÃ‰ON
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        
        function toggleProviderAccordion(providerId) {
            console.log(`[ACCORDION] Toggling: ${providerId}`);
            
            // Fermer tous les autres accordÃ©ons
            document.querySelectorAll('.provider-accordion').forEach(acc => {
                if (acc.dataset.provider !== providerId) {
                    acc.classList.remove('active');
                    const content = acc.querySelector('.accordion-content');
                    if (content) content.style.display = 'none';
                }
            });
            
            // Toggle l'accordÃ©on cliquÃ©
            const accordion = document.querySelector(`.provider-accordion[data-provider="${providerId}"]`);
            const content = document.getElementById(`config-${providerId}`);
            
            if (accordion && content) {
                const isActive = accordion.classList.contains('active');
                
                if (isActive) {
                    // Fermer
                    accordion.classList.remove('active');
                    content.style.display = 'none';
                    console.log(`[ACCORDION] Closed: ${providerId}`);
                } else {
                    // Ouvrir
                    accordion.classList.add('active');
                    content.style.display = 'block';
                    console.log(`[ACCORDION] Opened: ${providerId}`);
                    
                    // Charger la clÃ© sauvegardÃ©e si elle existe
                    const savedKey = multiLLM.getUserKey(providerId);
                    if (savedKey) {
                        document.getElementById(`key-${providerId}`).value = 'â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢';
                    }
                    
                    // Calculer le coÃ»t
                    updateProviderCost(providerId);
                    
                    // Scroll smooth vers l'accordÃ©on
                    setTimeout(() => {
                        accordion.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
                    }, 100);
                }
            }
        }
        
        function saveProviderKey(providerId) {
            console.log(`[SAVE] Saving key for: ${providerId}`);
            
            const keyInput = document.getElementById(`key-${providerId}`);
            const modelSelect = document.getElementById(`model-${providerId}`);
            
            if (!keyInput || !modelSelect) {
                console.error(`[SAVE] Missing inputs for ${providerId}`);
                return;
            }
            
            const apiKey = keyInput.value.trim();
            const model = modelSelect.value;
            
            // VÃ©rifier si la clÃ© est dÃ©jÃ  masquÃ©e
            if (apiKey.startsWith('â€¢â€¢â€¢â€¢')) {
                showStatus('â„¹ï¸ ClÃ© dÃ©jÃ  sauvegardÃ©e', 'info');
                return;
            }
            
            if (!apiKey) {
                showStatus('âŒ Veuillez entrer une clÃ© API', 'error');
                return;
            }
            
            // Sauvegarder via multiLLM
            const success = multiLLM.setUserKey(providerId, apiKey, model);
            
            if (success) {
                // Masquer la clÃ©
                keyInput.value = 'â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢';
                showStatus(`âœ… ClÃ© ${providerId} sauvegardÃ©e`, 'success');
                
                // Afficher Quick Actions
                document.getElementById('apiQuickActions').style.display = 'block';
                
                console.log(`[SAVE] Key saved successfully for ${providerId}`);
            } else {
                showStatus('âŒ Erreur de sauvegarde', 'error');
            }
        }
        
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // V6.6.4 FIX: Display Saved Keys Function
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        function displaySavedKeys() {
            console.log('[UI] ğŸ”‘ Displaying saved keys in interface...');
            const providers = ['anthropic', 'openai', 'groq', 'deepseek'];
            let keysDisplayed = 0;
            
            providers.forEach(provider => {
                const keyInput = document.getElementById(`key-${provider}`);
                if (keyInput && multiLLM.getUserKey(provider)) {
                    keyInput.value = 'â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢';
                    keysDisplayed++;
                    console.log(`[UI] âœ… Key displayed for ${provider}`);
                }
            });
            
            // Show Quick Actions if keys exist
            if (keysDisplayed > 0) {
                const quickActions = document.getElementById('apiQuickActions');
                if (quickActions) {
                    quickActions.style.display = 'block';
                }
            }
            
            console.log(`[UI] âœ… Displayed ${keysDisplayed}/${providers.length} saved keys`);
        }
        
        function updateProviderCost(providerId) {
            const modelSelect = document.getElementById(`model-${providerId}`);
            if (!modelSelect) return;
            
            const model = modelSelect.value;
            
            // Prix par provider/model (input/output per 1M tokens)
            const pricing = {
                'deepseek': {
                    'deepseek-chat': { input: 0.27, output: 1.10 },
                    'deepseek-reasoner': { input: 0.55, output: 2.19 }
                },
                'groq': {
                    'llama-3.3-70b-versatile': { input: 0, output: 0 },
                    'llama-3.1-70b-versatile': { input: 0, output: 0 },
                    'mixtral-8x7b-32768': { input: 0, output: 0 }
                },
                'anthropic': {
                    'claude-sonnet-4-5-20250929': { input: 3.00, output: 15.00 },
                    'claude-opus-4-5-20251101': { input: 15.00, output: 75.00 },
                    'claude-haiku-4-5-20251001': { input: 0.80, output: 4.00 },
                    'claude-sonnet-4-20250514': { input: 3.00, output: 15.00 },
                    'claude-opus-4-1-20250805': { input: 15.00, output: 75.00 }
                },
                'openai': {
                    'gpt-5.2': { input: 12.00, output: 50.00 },
                    'gpt-5.2-chat-latest': { input: 12.00, output: 50.00 },
                    'gpt-5.2-pro': { input: 20.00, output: 80.00 },
                    'gpt-5.2-pro-2025-12-11': { input: 20.00, output: 80.00 },
                    'gpt-5': { input: 8.00, output: 35.00 },
                    'gpt-5-chat-latest': { input: 8.00, output: 35.00 },
                    'gpt-5-pro': { input: 15.00, output: 60.00 },
                    'gpt-5-pro-2025-10-06': { input: 15.00, output: 60.00 },
                    'gpt-4.1': { input: 5.00, output: 20.00 },
                    'gpt-4.1-mini': { input: 0.50, output: 2.00 },
                    'gpt-4.1-nano': { input: 0.10, output: 0.40 },
                    'gpt-4o': { input: 2.50, output: 10.00 },
                    'gpt-4o-mini': { input: 0.15, output: 0.60 },
                    'o1': { input: 15.00, output: 60.00 }
                }
            };
            
            const price = pricing[providerId]?.[model] || { input: 0, output: 0 };
            
            // Calcul pour 50K input, 4K output
            const inputCost = (50 / 1000) * price.input;
            const outputCost = (4 / 1000) * price.output;
            const totalCost = inputCost + outputCost;
            
            // Mise Ã  jour de l'affichage
            document.getElementById(`cost-input-${providerId}`).textContent = `$${inputCost.toFixed(4)}`;
            document.getElementById(`cost-output-${providerId}`).textContent = `$${outputCost.toFixed(4)}`;
            document.getElementById(`cost-total-${providerId}`).textContent = `$${totalCost.toFixed(4)}`;
        }
        
        function updateUserModels() {
            // Fonction maintenue pour compatibilitÃ© mais obsolÃ¨te
            // La sÃ©lection se fait dÃ©sormais via selectProvider()
        }
        
        function updateUserCost() {
            if (!STATE.selectedProvider) return;
            
            const provider = STATE.selectedProvider;
            const model = document.getElementById('userModel').value;
            
            // Estimation pour un document OCR moyen
            const inputTokens = 50000;
            const outputTokens = 4000;
            
            const estimate = multiLLM.estimateCost(provider, model, inputTokens, outputTokens);
            
            document.getElementById('costInput').textContent = `$${estimate.breakdown.input}`;
            document.getElementById('costOutput').textContent = `$${estimate.breakdown.output}`;
            document.getElementById('costTotal').textContent = `$${estimate.cost}`;
        }
        
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // V6.3.0 - GESTION SÃ‰CURITÃ‰ & LIMITES
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        
        function showSecurityWarning() {
            const warning = document.getElementById('securityWarning');
            if (warning && !localStorage.getItem('securityWarningAccepted')) {
                warning.classList.add('visible');
            }
        }
        
        function acceptSecurityWarning() {
            const warning = document.getElementById('securityWarning');
            if (warning) {
                warning.classList.remove('visible');
                localStorage.setItem('securityWarningAccepted', 'true');
                console.log('[SECURITY] User accepted security warning');
            }
        }
        
        function learnMoreSecurity() {
            alert(`DÃ‰TAILS TECHNIQUES SUR LA SÃ‰CURITÃ‰

MODE USER KEYS :
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
â€¢ Stockage : localStorage du navigateur (non chiffrÃ©)
â€¢ Obfuscation : XOR simple avec clÃ© statique
â€¢ Protection : Aucune encryption forte
â€¢ Exposition : Code JavaScript peut accÃ©der aux clÃ©s

RISQUES :
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
âš ï¸ Toute extension malveillante peut lire les clÃ©s
âš ï¸ XOR est facilement rÃ©versible
âš ï¸ Les clÃ©s transitent en clair dans le navigateur
âš ï¸ Pas de protection contre l'inspection rÃ©seau

RECOMMANDATIONS :
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
âœ… Mode Worker : clÃ©s sÃ©curisÃ©es cÃ´tÃ© serveur
âœ… Usage limitÃ© : tests & dÃ©veloppement uniquement
âœ… Jamais en production avec donnÃ©es sensibles
âœ… CrÃ©ez des clÃ©s API dÃ©diÃ©es avec quotas limitÃ©s

Pour plus d'infos : https://docs.anthropic.com/en/api/security`);
        }
        
        // Afficher l'avertissement au chargement du Mode 2
        window.addEventListener('load', () => {
            // VÃ©rifier si on est en Mode 2 (user-keys)
            const mode2Radio = document.querySelector('input[value="user-keys"]');
            if (mode2Radio) {
                mode2Radio.addEventListener('change', function() {
                    if (this.checked && !localStorage.getItem('securityWarningAccepted')) {
                        setTimeout(showSecurityWarning, 300);
                    }
                });
            }
        });
        
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        
        function saveUserKey() {
            console.log('[DEBUG] saveUserKey called');
            
            const provider = STATE.selectedProvider;
            console.log('[DEBUG] provider:', provider);
            
            const key = document.getElementById('userApiKey').value.trim();
            console.log('[DEBUG] key length:', key.length);
            console.log('[DEBUG] key starts with:', key.substring(0, 4));
            
            if (!provider) {
                console.error('[DEBUG] No provider selected!');
                showStatus('SÃ©lectionnez d\'abord un provider', 'error');
                return;
            }
            
            if (!key) {
                console.error('[DEBUG] Empty key!');
                showStatus('ClÃ© API vide', 'error');
                return;
            }
            
            // Si le champ contient des points, la clÃ© est dÃ©jÃ  sauvegardÃ©e
            if (key.startsWith('â€¢â€¢â€¢â€¢')) {
                console.log('[DEBUG] Key already saved (dots detected)');
                showStatus(`âœ… ClÃ© ${provider} dÃ©jÃ  sauvegardÃ©e !`, 'info');
                return;
            }
            
            console.log('[DEBUG] Calling multiLLM.setUserKey...');
            const result = multiLLM.setUserKey(provider, key);
            console.log('[DEBUG] setUserKey result:', result);
            
            if (result) {
                console.log('[DEBUG] Key saved successfully!');
                showStatus(`âœ… ClÃ© ${provider} sauvegardÃ©e avec succÃ¨s !`, 'success');
                document.getElementById('userApiKey').value = 'â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢';
                
                // Changer le texte du bouton
                const saveBtn = document.getElementById('saveKeyButton');
                if (saveBtn) {
                    const originalText = saveBtn.innerHTML;
                    saveBtn.innerHTML = 'âœ… ClÃ© sauvegardÃ©e';
                    saveBtn.style.background = 'linear-gradient(135deg, #8FAFB1 0%, #C8D0C3 100%)';
                    
                    // RÃ©activer aprÃ¨s 3 secondes
                    setTimeout(() => {
                        saveBtn.innerHTML = originalText;
                        saveBtn.style.background = 'linear-gradient(135deg, #8FAFB1 0%, #C8D0C3 100%)';
                    }, 3000);
                }
            } else {
                console.error('[DEBUG] Invalid key format!');
                showStatus(`âŒ Format de clÃ© ${provider} invalide`, 'error');
            }
        }
        
        async function sendWithUserKeys() {
            // âœ… V6.6.0 - DÃ©tecter si mode ENSEMBLE
            const currentMode = STATE.mode || STATE.processingMode;
            
            if (currentMode === 'ensemble') {
                console.log('[API] ğŸš€ Mode ENSEMBLE dÃ©tectÃ© - Redirection vers sendToEnsemble');
                return await sendToEnsemble();
            }
            
            // Mode normal (single provider)
            const provider = STATE.selectedProvider;
            const model = document.getElementById('userModel').value;
            
            if (!provider) {
                showStatus('SÃ©lectionnez d\'abord un provider', 'error');
                return;
            }
            
            const maxTokens = 32000;  // âœ… AugmentÃ© pour JSON 32 modules (Ã©tait 4096)
            const temperature = 0.3;  // Fixed for OCR
            
            const consolidatedPrompt = generateConsolidatedPrompt();
            
            const progress = document.getElementById('apiProgress');
            progress.style.display = 'block';
            const progressFill = document.getElementById('apiProgressFill');
            const progressText = document.getElementById('apiProgressText');
            
            progressFill.style.width = '20%';
            progressText.textContent = 'Envoi...';
            
            try {
                const startTime = Date.now();
                
                progressFill.style.width = '40%';
                progressText.textContent = 'Traitement...';
                
                const response = await multiLLM.sendPrompt(consolidatedPrompt, {
                    provider,
                    model,
                    max_tokens: maxTokens,
                    temperature
                });
                
                const duration = ((Date.now() - startTime) / 1000).toFixed(1);
                
                progressFill.style.width = '100%';
                progressText.textContent = 'TerminÃ© !';
                
                const cost = multiLLM.estimateCost(
                    provider,
                    model,
                    response.usage?.input_tokens || 50000,
                    response.usage?.output_tokens || 4000
                );
                
                showAPIResult(response, { provider, model, duration, cost });
                
                setTimeout(() => {
                    progress.style.display = 'none';
                }, 2000);
                
            } catch (error) {
                console.error('API Error:', error);
                showStatus('Erreur API : ' + error.message, 'error');
                progress.style.display = 'none';
            }
        }
        
        // â•â•â• SINGLE FILE API â•â•â•
        // âœ… SYSTÃˆME DE FALLBACK INTELLIGENT

        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // ğŸ¯ PATCH V6.9 - MATRICE MODÃˆLES OPENAI (endpoints + limites)
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        
        const OPENAI_MODEL_CONFIG = {
            // ğŸ† GPT-5 SERIES (Reasoning/Completion models)
            'gpt-5.2-pro': { 
                endpoint: '/v1/responses', 
                type: 'reasoning',
                tpm_limit: 80000,
                context_window: 200000,
                cost: { input: 20, output: 80 }
            },
            'gpt-5.2-pro-2025-12-11': { 
                endpoint: '/v1/responses', 
                type: 'reasoning',
                tpm_limit: 80000,
                context_window: 200000,
                cost: { input: 20, output: 80 }
            },
            'gpt-5-pro': { 
                endpoint: '/v1/responses', 
                type: 'reasoning',
                tpm_limit: 60000,
                context_window: 128000,
                cost: { input: 15, output: 60 }
            },
            'gpt-5-pro-2025-10-06': { 
                endpoint: '/v1/responses', 
                type: 'reasoning',
                tpm_limit: 60000,
                context_window: 128000,
                cost: { input: 15, output: 60 }
            },
            
            // ğŸ’¬ GPT-5 CHAT SERIES (Chat models)
            'gpt-5.2-chat-latest': { 
                endpoint: '/v1/chat/completions', 
                type: 'chat',
                tpm_limit: 100000,
                context_window: 200000,
                cost: { input: 10, output: 40 }
            },
            'gpt-5-chat-latest': { 
                endpoint: '/v1/chat/completions', 
                type: 'chat',
                tpm_limit: 80000,
                context_window: 128000,
                cost: { input: 8, output: 32 }
            },
            'gpt-5.2': { 
                endpoint: '/v1/chat/completions', 
                type: 'chat',
                tpm_limit: 100000,
                context_window: 200000,
                cost: { input: 10, output: 40 }
            },
            'gpt-5': { 
                endpoint: '/v1/chat/completions', 
                type: 'chat',
                tpm_limit: 80000,
                context_window: 128000,
                cost: { input: 8, output: 32 }
            },
            
            // ğŸ§  O-SERIES (Reasoning models)
            'o1': { 
                endpoint: '/v1/responses', 
                type: 'reasoning',
                tpm_limit: 100000,
                context_window: 200000,
                cost: { input: 15, output: 60 }
            },
            'o1-mini': { 
                endpoint: '/v1/responses', 
                type: 'reasoning',
                tpm_limit: 100000,
                context_window: 128000,
                cost: { input: 3, output: 12 }
            },
            'o1-pro': { 
                endpoint: '/v1/responses', 
                type: 'reasoning',
                tpm_limit: 100000,
                context_window: 200000,
                cost: { input: 20, output: 80 }
            },
            'o3': { 
                endpoint: '/v1/responses', 
                type: 'reasoning',
                tpm_limit: 100000,
                context_window: 200000,
                cost: { input: 25, output: 100 }
            },
            'o4-mini': { 
                endpoint: '/v1/responses', 
                type: 'reasoning',
                tpm_limit: 100000,
                context_window: 128000,
                cost: { input: 3, output: 12 }
            },
            
            // ğŸš€ GPT-4 SERIES (Chat models)
            'gpt-4o': { 
                endpoint: '/v1/chat/completions', 
                type: 'chat',
                tpm_limit: 30000,
                context_window: 128000,
                cost: { input: 2.5, output: 10 }
            },
            'gpt-4o-2024-11-20': { 
                endpoint: '/v1/chat/completions', 
                type: 'chat',
                tpm_limit: 30000,
                context_window: 128000,
                cost: { input: 2.5, output: 10 }
            },
            'gpt-4o-mini': { 
                endpoint: '/v1/chat/completions', 
                type: 'chat',
                tpm_limit: 200000,
                context_window: 128000,
                cost: { input: 0.15, output: 0.6 }
            },
            'gpt-4.1': { 
                endpoint: '/v1/chat/completions', 
                type: 'chat',
                tpm_limit: 40000,
                context_window: 128000,
                cost: { input: 3, output: 12 }
            },
            'gpt-4.1-mini': { 
                endpoint: '/v1/chat/completions', 
                type: 'chat',
                tpm_limit: 150000,
                context_window: 128000,
                cost: { input: 0.4, output: 1.6 }
            },
            'gpt-4-turbo': { 
                endpoint: '/v1/chat/completions', 
                type: 'chat',
                tpm_limit: 30000,
                context_window: 128000,
                cost: { input: 10, output: 30 }
            },
            'gpt-4': { 
                endpoint: '/v1/chat/completions', 
                type: 'chat',
                tpm_limit: 10000,
                context_window: 8192,
                cost: { input: 30, output: 60 }
            }
        };
        
        const MODEL_FALLBACKS = {
            'groq': [
                'llama-3.3-70b-versatile',
                'llama-3.1-70b-versatile',
                'llama3-70b-8192',
                'mixtral-8x7b-32768',
                'llama-3.3-70b-8192'
            ],
            'deepseek': [
                'deepseek-chat',
                'deepseek-coder',
                'deepseek-v3'
            ],
            'anthropic': [
                'claude-sonnet-4-5-20250929',
                'claude-opus-4-5-20251101',
                'claude-haiku-4-5-20251001',
                'claude-sonnet-4-20250514',
                'claude-opus-4-1-20250805'
            ],
            'openai': [
                'gpt-5.2-pro',          // 1ï¸âƒ£ Premium Max (80k TPM) - /v1/responses
                'o1-pro',               // 2ï¸âƒ£ Reasoning Pro (100k TPM) - /v1/responses
                'gpt-4o-mini',          // 3ï¸âƒ£ FALLBACK FIABLE (200k TPM) - /v1/chat/completions
                'gpt-4.1-mini',         // 4ï¸âƒ£ Alternative (150k TPM)
                'gpt-5.2-chat-latest'   // 5ï¸âƒ£ Chat premium (100k TPM)
                // âŒ SKIP: gpt-4o (30k TPM - trop faible pour OCR longs)
            ]
        };
        
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // ğŸ”§ PATCH V6.9 - FONCTIONS UTILITAIRES
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        
        /**
         * DÃ©termine l'endpoint OpenAI correct selon le modÃ¨le
         */
        function getOpenAIEndpoint(model) {
            const config = OPENAI_MODEL_CONFIG[model];
            
            if (!config) {
                console.warn(`[PATCH] ModÃ¨le inconnu: ${model}, fallback vers /v1/chat/completions`);
                return '/v1/chat/completions';
            }
            
            console.log(`[PATCH] âœ… Model ${model} â†’ endpoint ${config.endpoint}`);
            return config.endpoint;
        }
        
        /**
         * VÃ©rifie si le modÃ¨le peut gÃ©rer le nombre de tokens estimÃ©s
         */
        function canModelHandleTokens(model, estimatedTokens) {
            const config = OPENAI_MODEL_CONFIG[model];
            
            if (!config) {
                console.warn(`[PATCH] ModÃ¨le inconnu: ${model}, skip check TPM`);
                return true;
            }
            
            const canHandle = estimatedTokens <= config.tpm_limit;
            
            if (!canHandle) {
                console.warn(`[PATCH] âš ï¸ Model ${model} TPM limit: ${config.tpm_limit}, Requested: ${estimatedTokens} â†’ SKIP`);
            } else {
                console.log(`[PATCH] âœ… Model ${model} can handle ${estimatedTokens} tokens (limit: ${config.tpm_limit})`);
            }
            
            return canHandle;
        }
        
        /**
         * Estime le nombre de tokens depuis une chaÃ®ne de caractÃ¨res
         */
        function estimateTokens(text) {
            if (!text) return 0;
            return Math.ceil(text.length / 3.5);
        }
        
        /**
         * Filtre les modÃ¨les de fallback selon la capacitÃ© token
         */
        function getTokenAwareFallbacks(provider, primaryModel, estimatedTokens) {
            const allFallbacks = MODEL_FALLBACKS[provider] || [];
            
            if (provider !== 'openai') {
                return allFallbacks.filter(m => m !== primaryModel);
            }
            
            const compatibleFallbacks = allFallbacks.filter(model => {
                if (model === primaryModel) return false;
                return canModelHandleTokens(model, estimatedTokens);
            });
            
            console.log(`[PATCH] ğŸ¯ Token-aware fallbacks for ${estimatedTokens} tokens:`, compatibleFallbacks);
            
            return compatibleFallbacks;
        }
        
        /**
         * Construit le payload API selon le type de modÃ¨le
         */
        function buildOpenAIPayload(model, prompt, max_tokens, temperature) {
            const config = OPENAI_MODEL_CONFIG[model];
            
            if (!config || config.type === 'chat') {
                // âœ… PATCH V6.9.6: Utiliser max_completion_tokens pour les modÃ¨les rÃ©cents
                const useLegacyParam = model.includes('gpt-4o') || model.includes('gpt-3.5');
                
                return {
                    model,
                    [useLegacyParam ? 'max_tokens' : 'max_completion_tokens']: max_tokens,
                    temperature,
                    messages: [{ role: 'user', content: prompt }]
                };
            }
            
            // Format pour /v1/responses (reasoning models)
            return {
                model,
                max_output_tokens: max_tokens,  // âœ… max_output_tokens pour Responses API
                reasoning: {
                    effort: 'high'  // âœ… Objet imbriquÃ©
                },
                input: prompt  // âœ… 'input' au lieu de 'messages'
            };
        }
        
        /**
         * Corrige le double encodage UTF-8
         */
        function fixUTF8Encoding(text) {
            if (!text) return text;
            
            try {
                const decoded = decodeURIComponent(escape(text));
                return decoded;
            } catch (e) {
                console.warn('[PATCH] UTF-8 fix failed, using original');
                return text;
            }
        }
        

        // âœ… RÃ‰CUPÃ‰RATION DYNAMIQUE DES MODÃˆLES DISPONIBLES
        async function fetchAvailableModels(provider) {
            const apiKey = multiLLM.xorDecrypt(multiLLM.userKeys[provider], 'ocr-v6-secret-2025');
            if (!apiKey) return null;
            
            try {
                const endpoints = {
                    'openai': 'https://api.openai.com/v1/models',
                    'anthropic': null,  // Anthropic n'a pas d'endpoint /models
                    'groq': 'https://api.groq.com/openai/v1/models'
                };
                
                const endpoint = endpoints[provider];
                if (!endpoint) return null;
                
                const response = await fetch(endpoint, {
                    headers: {
                        'Authorization': `Bearer ${apiKey}`
                    }
                });
                
                if (!response.ok) return null;
                
                const data = await response.json();
                const models = data.data?.map(m => m.id) || [];
                
                console.log(`[DEBUG] Available ${provider} models:`, models);
                return models;
                
            } catch (error) {
                console.error(`[DEBUG] Failed to fetch ${provider} models:`, error);
                return null;
            }
        }
        
        async function sendSingleFileToAPI(provider, model) {
            console.log('[DEBUG] sendSingleFileToAPI called');
            console.log('[DEBUG] provider:', provider);
            console.log('[DEBUG] model:', model);
            console.log('[DEBUG] STATE.file:', STATE.file?.name);
            console.log('[DEBUG] STATE.extractedText length:', STATE.extractedText?.length);
            console.log('[DEBUG] STATE.detectionResult:', STATE.detectionResult);
            console.log('[DEBUG] STATE.documentType:', STATE.documentType);
            
            // VÃ©rifier que le fichier est chargÃ©
            if (!STATE.file) {
                console.error('[DEBUG] No file in STATE');
                showStatus('âš ï¸ Veuillez d\'abord uploader un fichier', 'error');
                return;
            }
            
            // âœ… V6.4.4 - RÃ©cupÃ©ration amÃ©liorÃ©e de extractedText depuis plusieurs sources
            if (!STATE.extractedText || STATE.extractedText.length === 0) {
                console.log('[DEBUG] Attempting to recover extractedText from various sources...');
                
                // Essayer depuis detectionResult.extracted.text
                if (STATE.detectionResult?.extracted?.text) {
                    console.log('[DEBUG] Recovering from detectionResult.extracted.text');
                    STATE.extractedText = STATE.detectionResult.extracted.text;
                }
                // Essayer depuis analysis.extractedData.text
                else if (STATE.analysis?.extractedData?.text) {
                    console.log('[DEBUG] Recovering from analysis.extractedData.text');
                    STATE.extractedText = STATE.analysis.extractedData.text;
                }
                // Essayer de rÃ©-extraire le texte du fichier
                else if (STATE.file) {
                    console.log('[DEBUG] Re-extracting text from file...');
                    try {
                        const fileExt = STATE.fileType;
                        let extractedData = null;
                        
                        if (fileExt === 'epub') {
                            extractedData = await extractTextFromEPUB(STATE.file);
                        } else if (['png', 'jpg', 'jpeg', 'gif', 'webp', 'tiff', 'tif'].includes(fileExt)) {
                            extractedData = await extractTextFromImage(STATE.file);
                        } else if (['xlsx', 'xls', 'ods'].includes(fileExt)) {
                            extractedData = await extractTextFromExcel(STATE.file);
                        } else if (['docx', 'doc', 'odt'].includes(fileExt)) {
                            extractedData = await extractTextFromDOCX(STATE.file);
                        }
                        
                        if (extractedData && extractedData.text) {
                            STATE.extractedText = extractedData.text;
                            console.log('[DEBUG] Re-extraction successful:', STATE.extractedText.length, 'chars');
                        }
                    } catch (error) {
                        console.error('[DEBUG] Re-extraction failed:', error);
                    }
                }
            }
            
            if (!STATE.extractedText || STATE.extractedText.length === 0) {
                console.error('[DEBUG] No extractedText in STATE');
                hideProcessingLoader();
                showStatus('âš ï¸ Le texte n\'a pas Ã©tÃ© extrait. RÃ©essayez d\'uploader le fichier.', 'error');
                return;
            }
            
            console.log('[DEBUG] Final extractedText length:', STATE.extractedText.length);
            
            // âœ… V6.4.2 - Skip vÃ©rification clÃ©s en mode Worker (clÃ©s cÃ´tÃ© serveur)
            if (multiLLM.mode !== 'worker') {
                // VÃ©rifier que la clÃ© existe (seulement en mode user_keys)
                const encryptedKey = multiLLM.userKeys[provider];
                console.log('[DEBUG] encryptedKey exists:', !!encryptedKey);
                
                if (!encryptedKey) {
                    console.error('[DEBUG] No key for provider:', provider);
                    showStatus(`âš ï¸ ClÃ© ${provider} non configurÃ©e. Allez dans MODE 2 pour configurer.`, 'error');
                    // Scroll vers le mode 2
                    const panel = document.getElementById('panelUserKeys');
                    if (panel) panel.scrollIntoView({ behavior: 'smooth' });
                    return;
                }
            } else {
                console.log('[DEBUG] Worker Mode - Skip key verification (keys on server)');
            }
            
            // âœ… V6.4.4 - AFFICHER LOADER PENDANT TRAITEMENT
            const providerNames = {
                'groq': 'Groq',
                'deepseek': 'DeepSeek',
                'anthropic': 'Anthropic Claude',
                'openai': 'OpenAI',
            };
            showProcessingLoader(`Analyse en cours avec ${providerNames[provider] || provider}...`);
            
            showStatus(`Envoi Ã  ${provider}...`, 'info');
            console.log('[DEBUG] Starting API call...');
            
            try {
                // GÃ©nÃ©rer le prompt pour ce fichier
                console.log('[DEBUG] Generating prompt...');
                const prompt = generatePrompt({
                    file: STATE.file,
                    fileName: STATE.fileName,
                    fileType: STATE.fileType,
                    extractedText: STATE.extractedText,
                    totalPages: STATE.totalPages,
                    detectionResult: STATE.detectionResult,
                    documentType: STATE.documentType,
                    analysis: STATE.analysis
                });
                
                console.log('[DEBUG] Prompt length:', prompt.length);
                
                // ğŸ¯ PATCH V6.9: ESTIMATION TOKENS
                const estimatedTokens = estimateTokens(prompt);
                console.log(`[PATCH] ğŸ“Š Estimated tokens: ${estimatedTokens} (prompt: ${prompt.length} chars)`);
                
                // ğŸ¯ PATCH V6.9: VÃ‰RIFICATION TOKEN POUR LE MODÃˆLE PRINCIPAL
                if (provider === 'openai' && !canModelHandleTokens(model, estimatedTokens)) {
                    console.warn(`[PATCH] âš ï¸ Primary model ${model} cannot handle ${estimatedTokens} tokens, switching to fallback...`);
                    
                    const tokenAwareFallbacks = getTokenAwareFallbacks(provider, model, estimatedTokens);
                    
                    if (tokenAwareFallbacks.length === 0) {
                        throw new Error(`Aucun modÃ¨le ${provider} capable de gÃ©rer ${estimatedTokens} tokens. RÃ©duisez la taille du document.`);
                    }
                    
                    model = tokenAwareFallbacks[0];
                    console.log(`[PATCH] âœ… Using token-compatible model: ${model}`);
                    showStatus(`âš ï¸ ModÃ¨le original trop petit pour ${estimatedTokens} tokens, utilisation de ${model}`, 'warning');
                }
                
                const startTime = Date.now();
                
                // âœ… SYSTÃˆME DE FALLBACK AUTOMATIQUE
                let response;
                let actualModel = model;
                let fallbackUsed = false;
                
                // Essayer le modÃ¨le demandÃ©
                console.log('[DEBUG] Calling multiLLM.sendPrompt...');
                try {
                    response = await multiLLM.sendPrompt(prompt, {
                        provider,
                        model,
                        max_tokens: 32000,
                        temperature: 0.3
                    });
                    console.log('[DEBUG] API response received');
                } catch (error) {
                    console.log('[DEBUG] Primary model failed:', error.message);
                    
                    // ğŸ¯ PATCH V6.9: Fallbacks TOKEN-AWARE
                    const tokenAwareFallbacks = getTokenAwareFallbacks(provider, model, estimatedTokens);
                    console.log(`[PATCH] ğŸ”„ Trying ${tokenAwareFallbacks.length} token-aware fallbacks...`);
                    
                    if (error.message.includes('model') && error.message.includes('not') && tokenAwareFallbacks.length > 0) {
                        console.log('[DEBUG] Trying fallback models...');
                        const fallbacks = tokenAwareFallbacks;
                        
                        for (const fallbackModel of fallbacks) {
                            try {
                                console.log(`[DEBUG] Trying fallback: ${fallbackModel}`);
                                response = await multiLLM.sendPrompt(prompt, {
                                    provider,
                                    model: fallbackModel,
                                    max_tokens: 32000,
                                    temperature: 0.3
                                });
                                
                                actualModel = fallbackModel;
                                fallbackUsed = true;
                                console.log(`[DEBUG] âœ… Fallback successful with ${fallbackModel}`);
                                
                                showStatus(`âš ï¸ ModÃ¨le ${model} non disponible, utilisation de ${fallbackModel}`, 'warning');
                                
                                break;
                            } catch (fallbackError) {
                                console.log(`[DEBUG] Fallback ${fallbackModel} failed:`, fallbackError.message);
                                continue;
                            }
                        }
                        
                        // Si tous les fallbacks ont Ã©chouÃ©
                        if (!response) {
                            throw new Error(`Tous les modÃ¨les ${provider} ont Ã©chouÃ©. Le provider a peut-Ãªtre changÃ© ses modÃ¨les. VÃ©rifiez la documentation Ã  jour.`);
                        }
                    } else {
                        // Erreur non liÃ©e au modÃ¨le, re-throw
                        throw error;
                    }
                }
                
                console.log('[DEBUG] API response received');
                
                const duration = ((Date.now() - startTime) / 1000).toFixed(1);
                
                // Calculer le coÃ»t avec le modÃ¨le rÃ©ellement utilisÃ©
                const cost = multiLLM.estimateCost(
                    provider,
                    actualModel,  // âœ… Utiliser actualModel
                    response.usage?.input_tokens || 50000,
                    response.usage?.output_tokens || 4000
                );
                
                console.log('[DEBUG] Cost:', cost);
                console.log('[DEBUG] Model used:', actualModel, fallbackUsed ? '(fallback)' : '(primary)');
                
                // Sauvegarder dans STATE
                STATE.analysis = response.json;
                
                // Afficher le rÃ©sultat avec le bon modÃ¨le
                console.log('[DEBUG] Displaying result...');
                displaySingleFileAPIResult(response, { 
                    provider, 
                    model: actualModel,  // âœ… Afficher actualModel
                    duration, 
                    cost 
                });
                
                // Message adaptÃ© selon si fallback utilisÃ©
                const statusMsg = fallbackUsed 
                    ? `âœ… Analyse ${provider} terminÃ©e en ${duration}s (modÃ¨le ${actualModel}) !`
                    : `âœ… Analyse ${provider} terminÃ©e en ${duration}s !`;
                
                showStatus(statusMsg, 'success');
                
            } catch (error) {
                console.error('[DEBUG] API Error:', error);
                console.error('Single File API Error:', error);
                
                // âœ… V6.4.4 - Cacher le loader en cas d'erreur
                hideProcessingLoader();
                
                showStatus(`âŒ Erreur ${provider}: ${error.message}`, 'error');
            }
        }
        
        function displaySingleFileAPIResult(response, metadata) {
            const { provider, model, duration, cost } = metadata;
            
            // âœ… V6.4.4 - Cacher le loader
            hideProcessingLoader();
            
            // âœ… STOCKER dans STATE au lieu d'embedder dans onclick
            STATE.lastAPIResult = response.json || response.text;
            
            // CrÃ©er une modale pour afficher le rÃ©sultat
            const modal = document.createElement('div');
            modal.style.cssText = `
                position: fixed;
                top: 0; left: 0; right: 0; bottom: 0;
                background: rgba(0,0,0,0.7);
                display: flex;
                align-items: center;
                justify-content: center;
                z-index: 10000;
                padding: 20px;
            `;
            
            const providerIcons = {
                'groq': 'ğŸŒŠ',
                'deepseek': 'ğŸŒŠ',
                'anthropic': 'ğŸŒŠ',
                'openai': 'ğŸŒŠ',
            };
            
            const providerNames = {
                'groq': 'Groq',
                'deepseek': 'DeepSeek',
                'anthropic': 'Anthropic Claude',
                'openai': 'OpenAI GPT',
            };
            
            const jsonString = JSON.stringify(STATE.lastAPIResult, null, 2);
            
            modal.innerHTML = `
                <div style="background:white;border-radius:16px;max-width:900px;width:100%;max-height:90vh;overflow-y:auto;padding:30px;box-shadow:0 10px 40px rgba(0,0,0,0.3);">
                    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:20px;">
                        <h2 style="margin:0;color:var(--noir-principal);">${providerIcons[provider]} RÃ©sultat ${providerNames[provider]}</h2>
                        <button id="closeModalBtn" onclick="this.closest('div[style*=fixed]').remove()" style="background:none;border:none;font-size:28px;cursor:pointer;color:var(--gris-secondaire);">Ã—</button>
                    </div>
                    
                    <!-- SÃ‰LECTEUR FORMAT EXTRACTION - CHARTE: Vert sauge -->
                    <div style="margin-bottom:20px;padding:20px;background:linear-gradient(135deg, #C8D0C3 0%, #8FAFB1 100%);border-radius:12px;border-left:6px solid #8FAFB1;">
                        <h3 style="margin:0 0 12px 0;color:#2D4A4F;font-size:1.1em;">ğŸ“Š Format Extraction</h3>
                        <select id="formatSelector" style="width:100%;padding:12px;border:2px solid #8FAFB1;border-radius:8px;font-size:0.95em;font-weight:600;background:white;cursor:pointer;">
                            <option value="standard">Standard (7 modules) - Rapide</option>
                            <option value="complet" selected>R&D Complet (32 modules) - DÃ©taillÃ©</option>
                            <option value="minimal">Minimal (3 modules) - Essentiel</option>
                            <option value="custom">PersonnalisÃ© - Ã€ configurer</option>
                        </select>
                        <p style="margin:10px 0 0 0;font-size:0.85em;color:#2D4A4F;">
                            <strong>R&D Complet</strong> inclut: glossaire, controverses, statistiques, implÃ©mentation, sources, etc.
                        </p>
                    </div>
                    
                    <!-- MÃ‰TADONNÃ‰ES - CHARTE -->
                    <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(150px,1fr));gap:15px;margin-bottom:20px;">
                        <div style="padding:15px;background:#E6D7C3;border-radius:8px;">
                            <div style="font-size:0.85em;color:var(--gris-secondaire);">Provider</div>
                            <div style="font-weight:600;color:var(--noir-principal);">${providerNames[provider]}</div>
                        </div>
                        <div style="padding:15px;background:#C8D0C3;border-radius:8px;">
                            <div style="font-size:0.85em;color:var(--gris-secondaire);">ModÃ¨le</div>
                            <div style="font-weight:600;color:var(--noir-principal);">${model}</div>
                        </div>
                        <div style="padding:15px;background:#FFF3E0;border-radius:8px;">
                            <div style="font-size:0.85em;color:var(--gris-secondaire);">DurÃ©e</div>
                            <div style="font-weight:600;color:var(--noir-principal);">${duration}s</div>
                        </div>
                        <div style="padding:15px;background:#D8CDBB;border-radius:8px;">
                            <div style="font-size:0.85em;color:var(--gris-secondaire);">CoÃ»t</div>
                            <div style="font-weight:600;color:var(--noir-principal);">$${cost.cost}</div>
                        </div>
                    </div>
                    
                    <div style="background:#F5F5F5;padding:20px;border-radius:8px;margin-bottom:20px;">
                        <h3 style="margin:0 0 10px 0;">ğŸ“„ Document analysÃ©</h3>
                        <div style="font-size:0.9em;color:var(--gris-secondaire);">${STATE.fileName} (${STATE.fileType.toUpperCase()})</div>
                    </div>
                    
                    <div style="background:#F5F5F5;padding:20px;border-radius:8px;margin-bottom:20px;max-height:400px;overflow-y:auto;">
                        <h3 style="margin:0 0 15px 0;">ğŸ“Š RÃ©sultat JSON</h3>
                        <pre id="jsonResult" style="background:white;padding:15px;border-radius:6px;overflow-x:auto;font-size:0.85em;">${jsonString}</pre>
                    </div>
                    
                    <div style="display:flex;gap:10px;flex-wrap:wrap;">
                        <button id="copyJSONBtn" style="flex:1;min-width:150px;padding:12px;background:var(--mer);color:white;border:none;border-radius:8px;font-weight:600;cursor:pointer;">
                            ğŸ“‹ Copier le JSON
                        </button>
                        <button id="downloadJSONBtn" style="flex:1;min-width:150px;padding:12px;background:var(--accent);color:white;border:none;border-radius:8px;font-weight:600;cursor:pointer;">
                            ğŸ’¾ TÃ©lÃ©charger JSON
                        </button>
                        <button id="downloadZIPBtn" style="flex:1;min-width:200px;padding:15px;background:linear-gradient(135deg, #8FAFB1 0%, #C8D0C3 100%);color:white;border:none;border-radius:8px;font-weight:700;cursor:pointer;box-shadow:0 4px 15px rgba(143, 175, 177, 0.3);font-size:1.05em;">
                            ğŸ“¦ Sauvegarder ZIP Complet
                        </button>
                    </div>
                    <div id="zipInfo" style="margin-top:15px;padding:15px;background:linear-gradient(135deg, #E6D7C3 0%, #D8CDBB 100%);border-radius:8px;border-left:4px solid #8FAFB1;">
                        <p style="margin:0;font-size:0.9em;color:#5a5a5a;">
                            <strong style="color:#8FAFB1;">ğŸ“¦ ZIP Complet contient :</strong><br>
                            â€¢ knowledge_index.json (<span id="modulesCount">32 modules</span>)<br>
                            â€¢ knowledge.md (version Markdown)<br>
                            â€¢ index.html (viewer interactif)<br>
                            â€¢ README.md (mÃ©tadonnÃ©es)<br>
                            â€¢ ${STATE.fileName} (document original)
                        </p>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            
            // âœ… V6.4.4 - SCROLL AUTOMATIQUE VERS BOUTON SAUVEGARDER
            setTimeout(() => {
                const saveBtn = document.getElementById('downloadZIPBtn');
                if (saveBtn) {
                    saveBtn.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    highlightElement(saveBtn);
                }
            }, 300);
            
            // âœ… Ajouter event listeners APRÃˆS l'insertion dans le DOM
            
            // Listener pour le sÃ©lecteur de format
            document.getElementById('formatSelector').addEventListener('change', (e) => {
                const modulesCount = document.getElementById('modulesCount');
                const formatMap = {
                    'standard': '7 modules',
                    'complet': '32 modules',
                    'minimal': '3 modules',
                    'custom': 'modules personnalisÃ©s'
                };
                modulesCount.textContent = formatMap[e.target.value];
            });
            
            document.getElementById('copyJSONBtn').addEventListener('click', () => {
                navigator.clipboard.writeText(jsonString);
                alert('ğŸ“‹ JSON copiÃ© !');
            });
            
            document.getElementById('downloadJSONBtn').addEventListener('click', () => {
                downloadJSON(STATE.lastAPIResult, `${STATE.fileName}_${provider}_analysis.json`);
            });
            
            // âœ… NOUVEAU : Bouton ZIP complet avec choix de format
            document.getElementById('downloadZIPBtn').addEventListener('click', () => {
                const selectedFormat = document.getElementById('formatSelector').value;
                console.log('[DOWNLOAD] Format sÃ©lectionnÃ©:', selectedFormat);
                downloadAPIResultAsZIP(STATE.lastAPIResult, provider, model, selectedFormat);
                
                // âœ… V6.4.4 - AprÃ¨s tÃ©lÃ©chargement, scroll vers la croix pour fermer
                setTimeout(() => {
                    const closeBtn = document.getElementById('closeModalBtn');
                    if (closeBtn) {
                        closeBtn.scrollIntoView({ behavior: 'smooth', block: 'center' });
                        highlightElement(closeBtn);
                    }
                }, 800);
            });
        }
        
        function downloadJSON(data, filename) {
            const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            a.click();
            URL.revokeObjectURL(url);
        }
        
        // â•â•â• MODE 3: WORKER â•â•â•
        function toggleWorker() {
            const enabled = document.getElementById('workerEnabled').checked;
            const status = document.getElementById('workerStatus');
            const panel = document.getElementById('workerActivePanel');
            
            if (enabled) {
                multiLLM.switchMode('worker');  // â† V6.6.3 FIX: Switch to worker mode
                console.log('[WORKER] âœ… Mode switched to: worker');
                status.textContent = 'Mode Worker activÃ© âœ…';
                panel.style.display = 'block';
            } else {
                multiLLM.switchMode('user_keys');  // â† V6.6.3 FIX: Switch back to user_keys
                console.log('[WORKER] âœ… Mode switched to: user_keys');
                status.textContent = 'Mode Worker dÃ©sactivÃ©';
                panel.style.display = 'none';
            }
        }
        
        function updateWorkerModels() {
            const provider = document.getElementById('workerProvider').value;
            const modelSelect = document.getElementById('workerModel');
            
            if (!modelSelect) return;
            
            // Vider les options actuelles
            modelSelect.innerHTML = '';
            
            // DÃ©finir les modÃ¨les par provider
            const models = {
                anthropic: [
                    { value: 'claude-sonnet-4-5-20250929', label: 'Claude Sonnet 4.5 â­ (RecommandÃ© - Ã‰quilibrÃ©)' },
                    { value: 'claude-opus-4-5-20251101', label: 'Claude Opus 4.5 (Premium - QualitÃ© max)' },
                    { value: 'claude-haiku-4-5-20251001', label: 'Claude Haiku 4.5 (Rapide - Ã‰conomique)' },
                    { value: 'claude-sonnet-4-20250514', label: 'Claude Sonnet 4' },
                    { value: 'claude-opus-4-1-20250805', label: 'Claude Opus 4.1' }
                ],
                openai: [
                    { value: 'gpt-5.2-pro', label: 'GPT-5.2 Pro ğŸ† (Premium Max)' },
                    { value: 'gpt-5.2-pro-2025-12-11', label: 'GPT-5.2 Pro 2025-12-11' },
                    { value: 'gpt-5.2', label: 'GPT-5.2 â­ (Exceptionnel)' },
                    { value: 'gpt-5.2-chat-latest', label: 'GPT-5.2 Chat Latest' },
                    { value: 'gpt-5-pro', label: 'GPT-5 Pro ğŸ†' },
                    { value: 'gpt-5-pro-2025-10-06', label: 'GPT-5 Pro 2025-10-06' },
                    { value: 'gpt-5', label: 'GPT-5 â­' },
                    { value: 'gpt-5-chat-latest', label: 'GPT-5 Chat Latest' },
                    { value: 'gpt-4.1', label: 'GPT-4.1 (TrÃ¨s Ã©levÃ©)' },
                    { value: 'gpt-4.1-mini', label: 'GPT-4.1 Mini (Rapide)' },
                    { value: 'gpt-4.1-nano', label: 'GPT-4.1 Nano (Ã‰conomique)' },
                    { value: 'gpt-4o', label: 'GPT-4o (RecommandÃ© - Multimodal)' },
                    { value: 'gpt-4o-mini', label: 'GPT-4o Mini (Rapide & Ã‰conomique)' },
                    { value: 'gpt-4-turbo', label: 'GPT-4 Turbo (128K context)' },
                    { value: 'gpt-3.5-turbo', label: 'GPT-3.5 Turbo (TrÃ¨s Ã©conomique)' }
                ],
                groq: [
                    { value: 'llama-3.3-70b-versatile', label: 'Llama 3.3 70B (RecommandÃ© - Ultra-rapide)' },
                    { value: 'llama-3.1-70b-versatile', label: 'Llama 3.1 70B (Puissant)' },
                    { value: 'mixtral-8x7b-32768', label: 'Mixtral 8x7B (32K context)' },
                    { value: 'gemma2-9b-it', label: 'Gemma 2 9B (Rapide)' }
                ]
            };
            
            // Ajouter les options du provider sÃ©lectionnÃ©
            const providerModels = models[provider] || models.anthropic;
            providerModels.forEach(function(model) {
                const option = document.createElement('option');
                option.value = model.value;
                option.textContent = model.label;
                modelSelect.appendChild(option);
            });
            
            // ğŸ”§ FIX: SÃ©lectionner automatiquement le premier modÃ¨le (recommandÃ©)
            if (providerModels.length > 0) {
                modelSelect.value = providerModels[0].value;
            }
            
            console.log('[WORKER] âœ… Provider changed to:', provider);
            console.log('[WORKER] ğŸ“‹ Available models:', providerModels.length);
            console.log('[WORKER] ğŸ¯ Selected model:', modelSelect.value);
            
            // Mettre Ã  jour l'info box
            updateWorkerInfoBox(provider);
        }
        
        function updateWorkerInfoBox(provider) {
            const infoBox = document.querySelector('#workerActivePanel .info-box');
            if (!infoBox) return;
            
            const providerInfo = {
                anthropic: {
                    emoji: 'ğŸŒŠ',
                    name: 'Claude (Anthropic)',
                    worker: 'ocr-universel-proxy.11drumboy11.workers.dev',
                    features: [
                        'Analyse contextuelle approfondie',
                        'Meilleure comprÃ©hension des documents complexes',
                        'Excellent pour textes thÃ©rapeutiques et acadÃ©miques'
                    ]
                },
                openai: {
                    emoji: 'ğŸŒŠ',
                    name: 'ChatGPT (OpenAI)',
                    worker: 'openai-proxy.11drumboy11.workers.dev',
                    features: [
                        'Excellent pour rÃ©sumÃ©s et synthÃ¨ses',
                        'Support multimodal (texte + images)',
                        'TrÃ¨s bon pour traductions'
                    ]
                },
                groq: {
                    emoji: 'ğŸŒŠ',
                    name: 'Groq (Ultra-rapide)',
                    worker: 'groq-proxy.11drumboy11.workers.dev',
                    features: [
                        'Vitesse de traitement maximale (10x plus rapide)',
                        'IdÃ©al pour batch processing',
                        'ModÃ¨les Llama 3 et Mixtral'
                    ]
                }
            };
            
            const info = providerInfo[provider] || providerInfo.anthropic;
            const workerUrl = info.worker;
            
            // Afficher le worker actif dans la console
            console.log('[WORKER] ğŸŒ Active worker URL:', workerUrl);
        }
        
        async function sendWithWorker() {
            const provider = document.getElementById('workerProvider').value;  // â† NOUVEAU: Provider dynamique
            const model = document.getElementById('workerModel').value;
            const consolidatedPrompt = generateConsolidatedPrompt();
            
            const progress = document.getElementById('apiProgress');
            progress.style.display = 'block';
            const progressFill = document.getElementById('apiProgressFill');
            const progressText = document.getElementById('apiProgressText');
            
            progressFill.style.width = '20%';
            progressText.textContent = 'Envoi au Worker...';
            
            try {
                const startTime = Date.now();
                
                progressFill.style.width = '40%';
                progressText.textContent = 'Traitement via Cloudflare Worker (' + provider + ')...';  // â† MODIFIÃ‰: Affiche le provider
                
                console.log('[WORKER] ğŸš€ Calling worker with provider:', provider, 'model:', model);
                const response = await multiLLM.callViaWorker(provider, model, consolidatedPrompt, 32000, 0.3);  // âœ… AugmentÃ© Ã  16000
                
                const duration = ((Date.now() - startTime) / 1000).toFixed(1);
                
                progressFill.style.width = '100%';
                progressText.textContent = 'TerminÃ© !';
                
                const cost = { cost: '0.00 (gratuit)', breakdown: { input: '0.00', output: '0.00' } };
                
                showAPIResult(response, {
                    provider: provider,  // â† MODIFIÃ‰: Provider dynamique
                    model,
                    duration,
                    cost
                });
                
                setTimeout(() => {
                    progress.style.display = 'none';
                }, 2000);
                
            } catch (error) {
                console.error('[WORKER] âŒ Error:', error);
                showStatus('Erreur Worker (' + provider + '): ' + error.message, 'error');
                progress.style.display = 'none';
            }
        }
        
        // â•â•â• LEGACY FUNCTIONS (kept for compatibility) â•â•â•
        function selectStrategy(strategyName) {
            // No longer used but kept for compatibility
        }
        
        function updateAPIMode() {
            // No longer used
        }
        
        function updateModelsList() {
            // No longer used
        }
        
        function updateCostEstimate() {
            const provider = document.getElementById('apiProvider').value;
            const model = document.getElementById('apiModel').value;
            
            // Estimation basÃ©e sur 3 documents moyens = ~50K tokens input, ~4K output
            const estimate = multiLLM.estimateCost(provider, model, 50000, 4000);
            
            document.getElementById('costEstimate').innerHTML = `
                CoÃ»t estimÃ© : <strong>$${estimate.cost} USD</strong>
                <div style="font-size:0.85em;margin-top:5px;color:#555;">
                    Input: $${estimate.breakdown.input} â€¢ Output: $${estimate.breakdown.output}
                </div>
            `;
        }
        
        function saveAPIKey(provider) {
            const input = document.getElementById(`${provider}Key`);
            const key = input.value.trim();
            
            if (!key) {
                showStatus('ClÃ© API vide', 'error');
                return;
            }
            
            if (multiLLM.setUserKey(provider, key)) {
                showStatus(`ClÃ© ${provider} sauvegardÃ©e avec succÃ¨s !`, 'success');
                input.value = 'â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢';
            } else {
                showStatus(`Format de clÃ© ${provider} invalide`, 'error');
            }
        }
        
        async function sendToAPI() {
            // âœ… V6.6.0 - DÃ©tecter si mode ENSEMBLE
            const currentMode = STATE.mode || STATE.processingMode;
            
            if (currentMode === 'ensemble') {
                console.log('[API] ğŸš€ Mode ENSEMBLE dÃ©tectÃ© - Lancement traitement parallÃ¨le');
                return await sendToEnsemble();
            }
            
            // Mode normal (single provider)
            const provider = document.getElementById('apiProvider').value;
            const model = document.getElementById('apiModel').value;
            const maxTokens = parseInt(document.getElementById('apiMaxTokens').value);
            const temperature = parseFloat(document.getElementById('apiTemperature').value);
            
            // GÃ©nÃ©rer le prompt consolidÃ©
            const consolidatedPrompt = generateConsolidatedPrompt();
            
            // Afficher progress
            const progress = document.getElementById('apiProgress');
            progress.classList.add('active');
            
            const progressFill = document.getElementById('apiProgressFill');
            const progressText = document.getElementById('apiProgressText');
            
            progressFill.style.width = '20%';
            progressText.textContent = 'Envoi de la requÃªte...';
            
            try {
                const startTime = Date.now();
                
                progressFill.style.width = '40%';
                progressText.textContent = 'Traitement par l\'API...';
                
                const response = await multiLLM.sendPrompt(consolidatedPrompt, {
                    provider,
                    model,
                    max_tokens: maxTokens,
                    temperature
                });
                
                const duration = ((Date.now() - startTime) / 1000).toFixed(1);
                
                progressFill.style.width = '100%';
                progressText.textContent = 'TerminÃ© !';
                
                // Calculer le coÃ»t
                const cost = multiLLM.estimateCost(
                    provider,
                    model,
                    response.usage?.input_tokens || 0,
                    response.usage?.output_tokens || 0
                );
                
                // Afficher le rÃ©sultat
                showAPIResult(response, {
                    provider,
                    model,
                    duration,
                    cost
                });
                
                setTimeout(() => {
                    progress.classList.remove('active');
                }, 2000);
                
            } catch (error) {
                console.error('API Error:', error);
                showStatus('Erreur API : ' + error.message, 'error');
                progress.classList.remove('active');
            }
        }
        
        // âœ… NOUVEAU V6.7.9 - Mode WORKER ENSEMBLE (KB Engine gratuit)
        async function sendToEnsembleWorker() {
            console.log('[ENSEMBLE-WORKER] ğŸš€ Starting GRATUIT KB Engine processing...');
            
            // VÃ©rifier qu'on a du texte
            if (!STATE.extractedText || STATE.extractedText.length === 0) {
                showStatus('âš ï¸ Aucun texte extrait. Uploadez un document d\'abord.', 'warning');
                return;
            }
            
            // Afficher progress
            const progress = document.getElementById('apiProgress');
            progress.classList.add('active');
            
            const progressFill = document.getElementById('apiProgressFill');
            const progressText = document.getElementById('apiProgressText');
            
            progressFill.style.width = '10%';
            progressText.textContent = 'Lancement KB Engine gratuit (Workers)...';
            
            try {
                const startTime = Date.now();
                
                progressFill.style.width = '30%';
                progressText.textContent = 'Traitement gratuit via Workers Cloudflare...';
                
                // âœ… APPEL ENSEMBLE EN MODE WORKER (GRATUIT)
                const result = await ensemble.processDocument(STATE.extractedText, {
                    useWorker: true // âœ… Mode gratuit !
                });
                
                // âœ… CACHER LE SABLIER 
                hideProcessingLoader();
                
                const duration = ((Date.now() - startTime) / 1000).toFixed(1);
                
                progressFill.style.width = '100%';
                progressText.textContent = `âœ… KB Engine gratuit terminÃ© ! ${result.summary.completed}/${result.summary.total} tÃ¢ches`;
                
                console.log('[ENSEMBLE-WORKER] âœ… Results:', result);
                
                // âœ… AUTO-GENERATION KB ENGINE (mÃªme code que mode payant)
                if (result.format === 'knowledge_base' && result.knowledge_index) {
                    console.log('[KB Engine] ğŸš€ Auto-generating complete package (GRATUIT)...');
                    
                    try {
                        progressText.textContent = 'GÃ©nÃ©ration ZIP gratuit...';
                        
                        const originalFile = STATE.currentFile || {
                            name: result.knowledge_index.document.titre.replace(/[^a-z0-9]/gi, '_') + '.epub',
                            type: 'application/epub+zip'
                        };
                        
                        const provider = result.metadata.providers_used[0] || 'worker-ensemble';
                        const firstTask = Object.values(result.tasks).find(t => t.status !== 'failed');
                        const model = firstTask?.model || 'multi-llm-worker';
                        
                        const zipResult = await ensemble.createCompleteZIP(
                            result.knowledge_index,
                            originalFile,
                            'worker-gratuit',
                            'ensemble-gratuit'
                        );
                        
                        console.log('[KB Engine] âœ… ZIP GRATUIT gÃ©nÃ©rÃ©:', zipResult.filename);
                        console.log('[KB Engine] ğŸ“¦ ZIP size:', (zipResult.size / 1024 / 1024).toFixed(2), 'MB');
                        
                        progressText.textContent = `ğŸ‰ KB Engine GRATUIT tÃ©lÃ©chargÃ©: ${zipResult.filename}`;
                        
                    } catch (error) {
                        console.error('[KB Engine] âŒ ZIP generation failed:', error);
                        progressText.textContent = `âš ï¸ RÃ©sultats OK mais ZIP Ã©chouÃ©: ${error.message}`;
                    }
                }
                
                // Afficher rÃ©sultats
                showAPIResult(result, {
                    provider: 'worker-ensemble',
                    model: 'multi-llm-gratuit',
                    duration: duration + 's',
                    type: 'ensemble-worker'
                });
                
                setTimeout(() => {
                    progress.classList.remove('active');
                }, 2000);
                
            } catch (error) {
                console.error('[ENSEMBLE-WORKER] âŒ Error:', error);
                
                // âœ… CACHER LE SABLIER EN CAS D'ERREUR
                hideProcessingLoader();
                
                showStatus('Erreur ENSEMBLE Worker : ' + error.message, 'error');
                progress.classList.remove('active');
            }
        }
        
        // âœ… V6.6.0 - Fonction ENSEMBLE mode payant (garde l'existant)
        async function sendToEnsemble() {
            console.log('[ENSEMBLE] ğŸš€ Starting parallel processing...');
            
            // VÃ©rifier qu'on a du texte
            if (!STATE.extractedText || STATE.extractedText.length === 0) {
                showStatus('âš ï¸ Aucun texte extrait. Uploadez un document d\'abord.', 'warning');
                return;
            }
            
            // Afficher progress
            const progress = document.getElementById('apiProgress');
            progress.classList.add('active');
            
            const progressFill = document.getElementById('apiProgressFill');
            const progressText = document.getElementById('apiProgressText');
            
            progressFill.style.width = '10%';
            progressText.textContent = 'Lancement des 6 tÃ¢ches parallÃ¨les...';
            
            try {
                const startTime = Date.now();
                
                progressFill.style.width = '30%';
                progressText.textContent = 'Traitement en cours (4 providers)...';
                
                // âœ… Appel ENSEMBLE avec le texte extrait
                const result = await ensemble.processDocument(STATE.extractedText, {
                    useWorker: false // Utilise les clÃ©s directes
                });
                
                // âœ… CACHER LE SABLIER MAINTENANT QUE ENSEMBLE EST TERMINÃ‰
                hideProcessingLoader();
                
                const duration = ((Date.now() - startTime) / 1000).toFixed(1);
                
                progressFill.style.width = '100%';
                progressText.textContent = `TerminÃ© ! ${result.summary.completed}/${result.summary.total} tÃ¢ches rÃ©ussies`;
                
                console.log('[ENSEMBLE] âœ… Results:', result);
                
                // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
                // V6.7.0 AUTO-GENERATION: Create complete ZIP package
                // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
                if (result.format === 'knowledge_base' && result.knowledge_index) {
                    console.log('[KB Engine] ğŸš€ Auto-generating complete package...');
                    
                    try {
                        // Update progress for ZIP generation
                        progressText.textContent = 'GÃ©nÃ©ration du package ZIP...';
                        
                        // Get original file from STATE
                        const originalFile = STATE.currentFile || {
                            name: result.knowledge_index.document.titre.replace(/[^a-z0-9]/gi, '_') + '.epub',
                            type: 'application/epub+zip'
                        };
                        
                        // Get provider/model from result
                        const provider = result.metadata.providers_used[0] || 'ensemble';
                        const firstTask = Object.values(result.tasks).find(t => t.status !== 'failed');
                        const model = firstTask?.model || 'multi-llm';
                        
                        // Create complete ZIP with all 5 files
                        const zipResult = await ensemble.createCompleteZIP(
                            result.knowledge_index,
                            originalFile,
                            provider,
                            model
                        );
                        
                        console.log('[KB Engine] âœ… ZIP generated:', zipResult.filename);
                        console.log('[KB Engine] ğŸ“¦ ZIP size:', (zipResult.size / 1024 / 1024).toFixed(2), 'MB');
                        
                        progressText.textContent = `âœ… Package complet tÃ©lÃ©chargÃ©: ${zipResult.filename}`;
                        
                    } catch (error) {
                        console.error('[KB Engine] âŒ ZIP generation failed:', error);
                        progressText.textContent = `âš ï¸ RÃ©sultats OK mais ZIP Ã©chouÃ©: ${error.message}`;
                    }
                }
                
                // Afficher rÃ©sultats
                showAPIResult(result, {
                    provider: 'ENSEMBLE',
                    model: `Multi-LLM (${result.metadata.providers_used.join(', ')})`,
                    duration,
                    cost: { cost: '~' } // CoÃ»t calculÃ© plus tard
                });
                
                setTimeout(() => {
                    progress.classList.remove('active');
                }, 2000);
                
            } catch (error) {
                console.error('[ENSEMBLE] âŒ Error:', error);
                
                // âœ… CACHER LE SABLIER EN CAS D'ERREUR
                hideProcessingLoader();
                
                showStatus('Erreur ENSEMBLE : ' + error.message, 'error');
                progress.classList.remove('active');
            }
        }
        
        function generateConsolidatedPrompt() {
            const results = STATE.batch.consolidatedResults;
            const analysis = STATE.analysis;
            
            let prompt = `# ANALYSE BATCH OCR UNIVERSEL V6.0\n\n`;
            prompt += `**Documents traitÃ©s :** ${results.length}\n`;
            prompt += `**Type principal :** ${analysis?.composition?.primary || 'text_standard'}\n\n`;
            
            prompt += `## DOCUMENTS\n\n`;
            results.forEach((doc, idx) => {
                prompt += `### Document ${idx + 1}: ${doc.filename}\n`;
                prompt += `**Pages :** ${doc.pages}\n`;
                prompt += `**Mots :** ${doc.wordCount?.toLocaleString() || 'N/A'}\n\n`;
                prompt += `**Contenu :**\n\`\`\`\n${doc.text.substring(0, 5000)}${doc.text.length > 5000 ? '...' : ''}\n\`\`\`\n\n`;
            });
            
            prompt += `\n## INSTRUCTIONS\n\n`;
            prompt += `Analysez ces ${results.length} documents et extrayez les informations structurÃ©es au format JSON.\n`;
            prompt += `Respectez la structure adaptÃ©e au type de contenu dÃ©tectÃ©.\n`;
            
            return prompt;
        }
        
        function showAPIResult(response, metadata) {
            const modal = document.getElementById('apiResultModal');
            
            document.getElementById('resultProvider').textContent = metadata.provider.toUpperCase();
            document.getElementById('resultModel').textContent = metadata.model;
            document.getElementById('resultDuration').textContent = metadata.duration + 's';
            document.getElementById('resultCost').textContent = '$' + metadata.cost.cost;
            
            const jsonDisplay = document.getElementById('jsonDisplay');
            if (response.json) {
                jsonDisplay.textContent = JSON.stringify(response.json, null, 2);
            } else {
                jsonDisplay.textContent = response.text;
            }
            
            // Stocker pour tÃ©lÃ©chargement
            window.currentAPIResult = response;
            
            modal.style.display = 'block';
            
            // âœ… CENTRER LA MODALE ET HIGHLIGHT
            centerModal('apiResultModal');
        }
        
        function closeAPIResult() {
            document.getElementById('apiResultModal').style.display = 'none';
        }
        
        function downloadAPIResult() {
            if (!window.currentAPIResult) return;
            
            const result = window.currentAPIResult.json || { text: window.currentAPIResult.text };
            const blob = new Blob([JSON.stringify(result, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `api_result_${new Date().toISOString().slice(0,19).replace(/:/g,'-')}.json`;
            a.click();
            URL.revokeObjectURL(url);
            
            showStatus('RÃ©sultat tÃ©lÃ©chargÃ© !', 'success');
        }
        
        async function copyAPIResult() {
            if (!window.currentAPIResult) return;
            
            const text = JSON.stringify(window.currentAPIResult.json || window.currentAPIResult.text, null, 2);
            
            try {
                await navigator.clipboard.writeText(text);
                showStatus('RÃ©sultat copiÃ© !', 'success');
            } catch (error) {
                showStatus('Erreur copie', 'error');
            }
        }
        
        // StratÃ©gies manuelles (existantes)
        
        function copyAllPrompts() {
            const consolidatedPrompt = generateConsolidatedPrompt();
            
            navigator.clipboard.writeText(consolidatedPrompt).then(() => {
                showStatus('Prompt consolidÃ© copiÃ© !', 'success');
            }).catch(error => {
                showStatus('Erreur copie', 'error');
            });
        }
        
        function downloadPromptTXT() {
            const consolidatedPrompt = generateConsolidatedPrompt();
            
            const blob = new Blob([consolidatedPrompt], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `prompt_consolidated_${new Date().toISOString().slice(0,10)}.txt`;
            a.click();
            URL.revokeObjectURL(url);
            
            showStatus('Prompt tÃ©lÃ©chargÃ© !', 'success');
        }
        
        function downloadPromptJSON() {
            const results = STATE.batch.consolidatedResults;
            
            const jsonData = {
                metadata: {
                    generated: new Date().toISOString(),
                    documents_count: results.length,
                    tool: 'OCR Universel V6.0'
                },
                documents: results.map(doc => ({
                    filename: doc.filename,
                    pages: doc.pages,
                    wordCount: doc.wordCount,
                    text: doc.text
                }))
            };
            
            const blob = new Blob([JSON.stringify(jsonData, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `prompt_data_${new Date().toISOString().slice(0,10)}.json`;
            a.click();
            URL.revokeObjectURL(url);
            
            showStatus('JSON tÃ©lÃ©chargÃ© !', 'success');
        }

        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // MODE SELECTION FUNCTIONS
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // FONCTIONS MINIMALISTES
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        
        /**
         * Switch entre les modes (radio buttons)
         */
        function switchMode(mode) {
            console.log(`[MODE] ğŸ”„ Switching to: ${mode}`);
            console.log(`[MODE] ğŸ“Š AVANT - STATE.mode="${STATE.mode}", STATE.processingMode="${STATE.processingMode}"`);
            
            // âœ… FERMER TOUS LES ACCORDÃ‰ONS ACTIFS
            document.querySelectorAll('.provider-mini.active').forEach(mini => {
                mini.classList.remove('active');
            });
            
            // âœ… V6.4.4 - COMPORTEMENT SIMPLIFIÃ‰ (plus de toggle)
            // Cacher tous les panels
            document.querySelectorAll('.mode-panel').forEach(panel => {
                panel.classList.remove('active');
            });
            
            // Afficher le panel sÃ©lectionnÃ©
            const panel = document.querySelector(`.mode-panel[data-mode="${mode}"]`);
            if (panel) {
                panel.classList.add('active');
                console.log(`[MODE] âœ… Panel ${mode} activÃ©`);
            }
            
            // Mettre Ã  jour STATE
            STATE.processingMode = mode;
            STATE.mode = mode;
            
            console.log(`[MODE] ğŸ“Š APRÃˆS - STATE.mode="${STATE.mode}", STATE.processingMode="${STATE.processingMode}"`);
            console.log(`[MODE] âœ… Switch completed to: ${mode}`);
            
            // âœ… V6.4.4 - DÃ©sactiver Worker toggle si on quitte le mode Worker
            const workerToggle = document.getElementById('workerToggle');
            const workerPanel = document.getElementById('workerActivePanel');
            
            if (mode === 'worker') {
                // Mode Worker: gÃ©rer le toggle
                if (workerToggle && workerToggle.checked) {
                    if (workerPanel) workerPanel.style.display = 'block';
                }
            } else if (mode === 'ensemble') {
                // Mode ENSEMBLE: vÃ©rifier que les clÃ©s sont configurÃ©es
                const hasKeys = ['anthropic', 'groq', 'openai'].some(p => multiLLM.getUserKey(p));
                if (!hasKeys) {
                    console.warn('[MODE] âš ï¸ ENSEMBLE mode requires at least one API key');
                }
                console.log('[MODE] âœ“ ENSEMBLE mode active');
            } else {
                // Modes Manuel ou API Multi-LLM: dÃ©sactiver Worker
                if (workerToggle) {
                    workerToggle.checked = false;
                    if (workerPanel) workerPanel.style.display = 'none';
                    console.log('[MODE] Worker toggle dÃ©sactivÃ© (mode:', mode, ')');
                }
                // S'assurer que multiLLM est en mode correct
                if (mode === 'manual') {
                    multiLLM.switchMode('user_keys');  // Reset au mode par dÃ©faut
                } else if (mode === 'user-keys') {
                    multiLLM.switchMode('user_keys');
                }
            }
        }
        
        /**
         * âœ¨ V6.4.4 - GÃ©rer le clic sur label Mode 2
         * Ne plus faire de toggle - juste activer le mode normalement
         */
        function handleModeToggle(event, mode) {
            // âœ… Laisser le comportement normal du radio
            // Le onclick du label va cocher le radio
            // Le onchange du radio va appeler switchMode
            // Plus de toggle compliquÃ© !
        }
        
        /**
         * Toggle accordion mini provider
         */
        function toggleMini(providerId) {
            console.log(`[MINI] Toggling: ${providerId}`);
            
            // Fermer tous les autres
            document.querySelectorAll('.provider-mini').forEach(mini => {
                if (mini.dataset.provider !== providerId) {
                    mini.classList.remove('active');
                }
            });
            
            // Toggle le cliquÃ©
            const mini = document.querySelector(`.provider-mini[data-provider="${providerId}"]`);
            if (mini) {
                mini.classList.toggle('active');
                
                // Si ouvert, charger la clÃ© sauvegardÃ©e
                if (mini.classList.contains('active')) {
                    try {
                        const savedKey = multiLLM.getUserKey ? multiLLM.getUserKey(providerId) : null;
                        if (savedKey) {
                            document.getElementById(`key-${providerId}`).value = 'â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢';
                        }
                    } catch (e) {
                        console.log('[MINI] No saved key');
                    }
                    
                    // Calculer le coÃ»t
                    updateMiniCost(providerId);
                }
            }
        }
        
        /**
         * Fermer accordion mini (via croix)
         */
        function closeMini(providerId) {
            console.log(`[MINI] Closing: ${providerId}`);
            
            const mini = document.querySelector(`.provider-mini[data-provider="${providerId}"]`);
            if (mini) {
                mini.classList.remove('active');
            }
        }
        
        /**
         * Fermer tous les accordions au clic extÃ©rieur
         */
        document.addEventListener('click', function(event) {
            // Ne rien faire si on clique sur un accordion ou ses enfants
            if (event.target.closest('.provider-mini')) {
                return;
            }
            
            // Fermer tous les accordions
            document.querySelectorAll('.provider-mini.active').forEach(mini => {
                mini.classList.remove('active');
            });
        });
        
        /**
         * Sauvegarder clÃ© API mini
         */
        function saveMiniKey(providerId) {
            console.log(`[SAVE] Saving key for: ${providerId}`);
            
            const keyInput = document.getElementById(`key-${providerId}`);
            const modelSelect = document.getElementById(`model-${providerId}`);
            const saveBtn = document.getElementById(`save-${providerId}`);
            
            if (!keyInput || !modelSelect || !saveBtn) {
                showStatus('Erreur: champs manquants', 'error');
                return;
            }
            
            const apiKey = keyInput.value.trim();
            const model = modelSelect.value;
            
            // VÃ©rifier si dÃ©jÃ  masquÃ©
            if (apiKey.startsWith('â€¢â€¢â€¢â€¢')) {
                showStatus('ClÃ© dÃ©jÃ  sauvegardÃ©e', 'info');
                return;
            }
            
            if (!apiKey) {
                showStatus('Veuillez entrer une clÃ© API', 'error');
                return;
            }
            
            // Sauvegarder via multiLLM
            try {
                const success = multiLLM.setUserKey(providerId, apiKey, model);
                
                if (success) {
                    // âœ… CONFIRMATION VISUELLE
                    // 1. Masquer la clÃ©
                    keyInput.value = 'â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢';
                    
                    // 2. Changer le bouton (vert + coche)
                    saveBtn.classList.add('save-confirmed');
                    saveBtn.textContent = 'SauvegardÃ©';
                    
                    // 3. Toast success
                    showStatus(`ClÃ© ${providerId} sauvegardÃ©e`, 'success');
                    
                    // âœ… V6.4.4 - Stocker le provider et modÃ¨le sÃ©lectionnÃ©s
                    STATE.selectedProvider = providerId;
                    STATE.selectedModel = model;
                    console.log('[SAVE] STATE.selectedProvider =', providerId);
                    console.log('[SAVE] STATE.selectedModel =', model);
                    
                    // 4. âœ¨ FERMER L'ACCORDION
                    setTimeout(() => {
                        closeMini(providerId);
                    }, 500);
                    
                    // âœ… V6.4.4 - NE PLUS afficher Quick Actions (workflow unifiÃ©)
                    // const quickActions = document.getElementById('apiQuickActions');
                    // if (quickActions) quickActions.style.display = 'block';
                    
                    // âœ… V6.4.4 - NE PLUS cacher les accordÃ©ons (pour permettre de changer de provider)
                    // setTimeout(() => {
                    //     document.querySelectorAll('.provider-mini').forEach(mini => {
                    //         mini.style.display = 'none';
                    //     });
                    // }, 600);
                    
                    // 7. Remettre le bouton normal aprÃ¨s 3s
                    setTimeout(() => {
                        saveBtn.classList.remove('save-confirmed');
                        saveBtn.textContent = 'Sauvegarder';
                    }, 3000);
                    
                } else {
                    showStatus('Erreur de sauvegarde', 'error');
                }
            } catch (error) {
                console.error('[SAVE] Error:', error);
                showStatus('Erreur: ' + error.message, 'error');
            }
        }
        
        /**
         * Mettre Ã  jour le coÃ»t mini
         */
        function updateMiniCost(providerId) {
            const modelSelect = document.getElementById(`model-${providerId}`);
            if (!modelSelect) return;
            
            const model = modelSelect.value;
            
            // Prix par provider/model (input/output per 1M tokens)
            const pricing = {
                'deepseek': {
                    'deepseek-chat': { input: 0.27, output: 1.10 },
                    'deepseek-reasoner': { input: 0.55, output: 2.19 }
                },
                'groq': {
                    'llama-3.3-70b-versatile': { input: 0, output: 0 },
                    'llama-3.1-70b-versatile': { input: 0, output: 0 },
                    'mixtral-8x7b-32768': { input: 0, output: 0 }
                },
                'anthropic': {
                    'claude-sonnet-4-5-20250929': { input: 3.00, output: 15.00 },
                    'claude-opus-4-5-20251101': { input: 15.00, output: 75.00 },
                    'claude-haiku-4-5-20251001': { input: 0.80, output: 4.00 },
                    'claude-sonnet-4-20250514': { input: 3.00, output: 15.00 },
                    'claude-opus-4-1-20250805': { input: 15.00, output: 75.00 }
                },
                'openai': {
                    'gpt-5.2': { input: 12.00, output: 50.00 },
                    'gpt-5.2-chat-latest': { input: 12.00, output: 50.00 },
                    'gpt-5.2-pro': { input: 20.00, output: 80.00 },
                    'gpt-5.2-pro-2025-12-11': { input: 20.00, output: 80.00 },
                    'gpt-5': { input: 8.00, output: 35.00 },
                    'gpt-5-chat-latest': { input: 8.00, output: 35.00 },
                    'gpt-5-pro': { input: 15.00, output: 60.00 },
                    'gpt-5-pro-2025-10-06': { input: 15.00, output: 60.00 },
                    'gpt-4.1': { input: 5.00, output: 20.00 },
                    'gpt-4.1-mini': { input: 0.50, output: 2.00 },
                    'gpt-4.1-nano': { input: 0.10, output: 0.40 },
                    'gpt-4o': { input: 2.50, output: 10.00 },
                    'gpt-4o-mini': { input: 0.15, output: 0.60 },
                    'o1': { input: 15.00, output: 60.00 }
                }
            };
            
            const price = pricing[providerId]?.[model] || { input: 0, output: 0 };
            
            // Calcul pour 50K input, 4K output
            const inputCost = (50 / 1000) * price.input;
            const outputCost = (4 / 1000) * price.output;
            const totalCost = inputCost + outputCost;
            
            // Mise Ã  jour de l'affichage
            const costElem = document.getElementById(`cost-${providerId}`);
            if (costElem) {
                costElem.textContent = `$${totalCost.toFixed(4)}`;
            }
        }
        
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // QUICK ACTIONS - DRAG & DROP
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        
        let quickFile = null;
        
        /**
         * Gestion du drag over
         */
        function handleQuickDragOver(event) {
            event.preventDefault();
            event.stopPropagation();
            const dropZone = document.getElementById('quickDropZone');
            dropZone.style.borderColor = '#8FAFB1';
            dropZone.style.background = '#E6D7C3';
        }
        
        /**
         * Gestion du drag leave
         */
        function handleQuickDragLeave(event) {
            event.preventDefault();
            event.stopPropagation();
            const dropZone = document.getElementById('quickDropZone');
            dropZone.style.borderColor = '#C8D0C3';
            dropZone.style.background = 'white';
        }
        
        /**
         * Gestion du drop
         */
        function handleQuickDrop(event) {
            event.preventDefault();
            event.stopPropagation();
            
            const dropZone = document.getElementById('quickDropZone');
            dropZone.style.borderColor = '#C8D0C3';
            dropZone.style.background = 'white';
            
            const files = event.dataTransfer.files;
            if (files.length > 0) {
                const file = files[0];
                // âœ… Reset STATE pour le nouveau fichier
                STATE.file = null;
                STATE.fileName = '';
                STATE.extractedText = '';
                STATE.detectionResult = null;
                
                // âœ… ACCEPTER TOUS LES FORMATS
                quickFile = file;
                updateQuickFileInfo(file);
                enableQuickButtons();
            }
        }
        
        /**
         * Gestion de la sÃ©lection de fichier via input
         */
        function handleQuickFileSelect(event) {
            const file = event.target.files[0];
            if (file) {
                // âœ… Reset STATE pour le nouveau fichier
                STATE.file = null;
                STATE.fileName = '';
                STATE.extractedText = '';
                STATE.detectionResult = null;
                
                // âœ… ACCEPTER TOUS LES FORMATS
                quickFile = file;
                updateQuickFileInfo(file);
                enableQuickButtons();
            }
        }
        
        /**
         * Mettre Ã  jour l'affichage du fichier
         */
        function updateQuickFileInfo(file) {
            const fileInfo = document.getElementById('quickFileInfo');
            const sizeKB = (file.size / 1024).toFixed(1);
            fileInfo.innerHTML = `<b style="color:#8FAFB1;">${file.name}</b> (${sizeKB} KB)`;
        }
        
        /**
         * Activer les boutons providers
         */
        function enableQuickButtons() {
            const providers = ['groq', 'deepseek', 'anthropic', 'openai'];
            providers.forEach(provider => {
                const btn = document.getElementById(`quickBtn-${provider}`);
                if (btn) {
                    btn.disabled = false;
                    btn.style.background = 'white';
                    btn.style.color = '#333';
                    btn.style.cursor = 'pointer';
                    btn.onmouseover = function() {
                        this.style.background = '#E6D7C3';
                        this.style.borderColor = '#8FAFB1';
                    };
                    btn.onmouseout = function() {
                        this.style.background = 'white';
                        this.style.borderColor = '#C8D0C3';
                    };
                }
            });
        }
        
        /**
         * Traiter le fichier avec le provider sÃ©lectionnÃ©
         */
        async function processQuickFile(providerId, model) {
            if (!quickFile) {
                showStatus('Veuillez d\'abord dÃ©poser un fichier', 'error');
                return;
            }
            
            console.log(`[QUICK] Processing ${quickFile.name} with ${providerId}/${model}`);
            
            // VÃ©rifier que la clÃ© API est configurÃ©e
            const apiKey = multiLLM.getUserKey(providerId);
            if (!apiKey) {
                showStatus(`ClÃ© API ${providerId} non configurÃ©e`, 'error');
                return;
            }
            
            // DÃ©sactiver tous les boutons pendant le traitement
            const providers = ['groq', 'deepseek', 'anthropic', 'openai'];
            providers.forEach(p => {
                const btn = document.getElementById(`quickBtn-${p}`);
                if (btn) {
                    btn.disabled = true;
                    btn.style.background = '#f0f0f0';
                    btn.style.cursor = 'not-allowed';
                }
            });
            
            // Afficher progress
            showStatus(`Traitement avec ${providerId}...`, 'info');
            
            try {
                // âœ… METTRE LE FICHIER DANS STATE
                STATE.file = quickFile;
                STATE.fileName = quickFile.name;
                STATE.fileSize = quickFile.size;  // âœ… SAUVEGARDER LA TAILLE
                
                console.log(`[QUICK] âœ… STATE.file dÃ©fini:`, STATE.file.name);
                console.log(`[QUICK] âœ… STATE.fileName:`, STATE.fileName);
                console.log(`[QUICK] âœ… STATE.fileSize:`, STATE.fileSize, 'bytes');
                
                // âœ… Ã‰TAPE 1: EXTRAIRE LE TEXTE DU FICHIER (OCR)
                showStatus(`Extraction du texte de ${quickFile.name}...`, 'info');
                console.log(`[QUICK] ğŸ“„ DÃ©but extraction texte...`);
                
                // Appeler handleFile qui fait l'extraction
                await handleFile(quickFile);
                
                console.log(`[QUICK] âœ… Texte extrait: ${STATE.extractedText?.length} caractÃ¨res`);
                
                // VÃ©rifier que l'extraction a fonctionnÃ©
                if (!STATE.extractedText || STATE.extractedText.length === 0) {
                    throw new Error('Extraction du texte Ã©chouÃ©e');
                }
                
                // âœ… Ã‰TAPE 2: ENVOYER Ã€ L'API
                showStatus(`Envoi Ã  ${providerId}...`, 'info');
                console.log(`[QUICK] ğŸš€ Appel API ${providerId}...`);
                
                await sendSingleFileToAPI(providerId, model);
                
                console.log(`[QUICK] âœ… Traitement terminÃ© avec succÃ¨s`);
                
                // âœ… Reset UI seulement (pas STATE.file car le ZIP en a besoin)
                quickFile = null;
                document.getElementById('quickFileInfo').innerHTML = 'ou cliquez pour parcourir';
                
                // âš ï¸ NE PAS reset STATE.file, STATE.extractedText, STATE.fileName
                // car ils sont nÃ©cessaires pour tÃ©lÃ©charger le ZIP plus tard
                
                showStatus('âœ… Traitement terminÃ© - Cliquez "TÃ©lÃ©charger ZIP" ci-dessous', 'success');
                
                // RÃ©activer les boutons
                providers.forEach(p => {
                    const btn = document.getElementById(`quickBtn-${p}`);
                    if (btn) {
                        btn.disabled = true;
                        btn.style.background = '#f0f0f0';
                        btn.style.color = '#999';
                        btn.style.cursor = 'not-allowed';
                    }
                });
                
            } catch (error) {
                console.error('[QUICK] Error:', error);
                showStatus('Erreur de traitement', 'error');
                
                // RÃ©activer les boutons en cas d'erreur
                enableQuickButtons();
            }
        }
        
        // Clic sur la zone de drop pour ouvrir file picker
        document.addEventListener('DOMContentLoaded', function() {
            const dropZone = document.getElementById('quickDropZone');
            if (dropZone) {
                dropZone.addEventListener('click', function() {
                    document.getElementById('quickFileInput').click();
                });
            }
        });
        
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // GESTION DES TABS + SMOOTH SCROLLS
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        
        /**
         * Switch entre les tabs de mode
         */
        function switchModeTab(mode) {
            console.log(`[TAB] Switching to: ${mode}`);
            
            // âœ… REPLIER les accordÃ©ons et sections des autres modes
            const apiQuickActions = document.getElementById('apiQuickActions');
            const workerActivePanel = document.getElementById('workerActivePanel');
            
            // Masquer et replier les accordÃ©ons si on ne va PAS vers MODE 2
            if (mode !== 'user-keys') {
                if (apiQuickActions) apiQuickActions.style.display = 'none';
                // Replier tous les accordÃ©ons
                document.querySelectorAll('.provider-accordion').forEach(acc => {
                    acc.classList.remove('active');
                    const content = acc.querySelector('.accordion-content');
                    if (content) content.style.display = 'none';
                });
            } else {
                // âœ… V14 WORKFLOW: MONTRER Quick Actions quand on entre en mode user-keys
                if (apiQuickActions) apiQuickActions.style.display = 'block';
            }
            
            if (mode !== 'worker') {
                if (workerActivePanel) workerActivePanel.style.display = 'none';
                const workerToggle = document.getElementById('workerToggle');
                if (workerToggle) workerToggle.checked = false;
            }
            
            // DÃ©sactiver tous les tabs
            document.querySelectorAll('.mode-tab').forEach(tab => {
                tab.classList.remove('mode-tab-active');
            });
            
            // Masquer tous les panels
            document.querySelectorAll('.mode-tab-panel').forEach(panel => {
                panel.classList.remove('mode-tab-panel-active');
            });
            
            // Activer le tab et panel sÃ©lectionnÃ©s
            const tab = document.querySelector(`.mode-tab[data-mode="${mode}"]`);
            const panelId = mode === 'user-keys' ? 'panelUserKeys' : 
                           mode === 'manual' ? 'panelManual' : 
                           'panelWorker';
            const panel = document.getElementById(panelId);
            
            if (tab) tab.classList.add('mode-tab-active');
            if (panel) panel.classList.add('mode-tab-panel-active');
            
            // Sauvegarder le mode
            STATE.processingMode = mode;
            
            // Message de confirmation
            const modeNames = {
                'manual': 'Mode Manuel',
                'user-keys': 'Mode API Multi-LLM',
                'worker': 'Mode API Worker'
            };
            showStatus(`âœ… ${modeNames[mode]} activÃ©`, 'success');
            
            // Scroll minimal automatique
            setTimeout(() => smoothScrollTo('modeTabsContainer'), 100);
            
            console.log(`[MODE] Switched to: ${mode}`);
        }
        
        /**
         * Scroll smooth vers un Ã©lÃ©ment avec highlight
         */
        function smoothScrollTo(elementId, highlightDuration = 1500) {
            const element = document.getElementById(elementId);
            if (!element) {
                console.warn(`[SCROLL] Element ${elementId} not found`);
                return;
            }
            
            // Scroll minimal - juste pour rendre visible
            element.scrollIntoView({ 
                behavior: 'smooth', 
                block: 'nearest',  // âš¡ Scroll minimal
                inline: 'nearest'
            });
            
            // Highlight subtil
            element.classList.add('scroll-highlight');
            setTimeout(() => {
                element.classList.remove('scroll-highlight');
            }, highlightDuration);
            
            console.log(`[SCROLL] Scrolled to: ${elementId}`);
        }
        
        /**
         * Scroll aprÃ¨s upload de fichier
         */
        /**
         * âœ¨ OPTIMISATION: Scroll intelligent aprÃ¨s upload
         * DÃ©tecte automatiquement oÃ¹ l'utilisateur doit aller
         */
        function scrollAfterUpload() {
            setTimeout(() => {
                // âœ… V6.4.4 - TOUS LES MODES: scroll vers dÃ©tection (workflow unifiÃ©)
                const detectionSection = document.getElementById('detectionSection');
                if (detectionSection && detectionSection.style.display !== 'none') {
                    detectionSection.scrollIntoView({ 
                        behavior: 'smooth', 
                        block: 'start',
                        inline: 'nearest'
                    });
                    return;
                }
                
                // Fallback: scroll vers composition si dÃ©tection non visible
                const compositionSection = document.getElementById('compositionSection');
                if (compositionSection && compositionSection.style.display !== 'none') {
                    compositionSection.scrollIntoView({ 
                        behavior: 'smooth', 
                        block: 'start',
                        inline: 'nearest'
                    });
                }
            }, 300);  // RÃ©duit Ã  300ms pour plus de rÃ©activitÃ©
        }
        
        /**
         * âœ¨ Scroll aprÃ¨s sÃ©lection provider - Vers config ou gÃ©nÃ©ration prompt
         */
        function scrollAfterProviderSelect() {
            setTimeout(() => {
                // Scroll vers configuration si elle existe et est visible
                const configSection = document.getElementById('providerConfigSection');
                if (configSection && configSection.style.display !== 'none') {
                    configSection.scrollIntoView({ 
                        behavior: 'smooth', 
                        block: 'center',
                        inline: 'nearest'
                    });
                }
            }, 200);  // Rapide pour rÃ©activitÃ©
        }
        
        /**
         * Scroll aprÃ¨s analyse API vers rÃ©sultat
         */
        function scrollAfterAPIAnalysis() {
            // La modale s'ouvre, pas besoin de scroll
            // Mais on peut scroller vers le haut de la page
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }
        
        /**
         * Scroll dans navigation batch vers document actif
         */
        function scrollToBatchDocument(index) {
            const docElement = document.querySelector(`#batchList .batch-item[data-index="${index}"]`);
            if (docElement) {
                docElement.scrollIntoView({
                    behavior: 'smooth',
                    block: 'nearest'
                });
                
                // Highlight temporaire
                docElement.style.animation = 'highlightPulse 1s ease';
                setTimeout(() => {
                    docElement.style.animation = '';
                }, 1000);
            }
        }
        
        /**
         * Fonction de compatibilitÃ© - ancienne fonction selectProcessingMode
         */
        function selectProcessingMode(mode) {
            // Rediriger vers la nouvelle fonction tabs
            switchModeTab(mode);
        }
        
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // SYSTÃˆME DE TABS MODERNE AVEC SMOOTH SCROLLING
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        
        /* FONCTION DUPLIQUÃ‰E - COMMENTÃ‰E (version Ã  la ligne 9052 est utilisÃ©e)
        function switchModeTab(mode) {
            console.log('[MODE] Switching to:', mode);
            
            // 1. Mettre Ã  jour l'Ã©tat
            STATE.processingMode = mode;
            
            // 2. Mettre Ã  jour les boutons tabs
            document.querySelectorAll('.mode-tab').forEach(tab => {
                const tabMode = tab.getAttribute('data-mode');
                if (tabMode === mode) {
                    tab.classList.add('mode-tab-active');
                } else {
                    tab.classList.remove('mode-tab-active');
                }
            });
            
            // 3. Afficher le bon panel
            document.querySelectorAll('.mode-tab-panel').forEach(panel => {
                const panelMode = panel.getAttribute('data-mode');
                if (panelMode === mode) {
                    panel.classList.add('mode-tab-panel-active');
                } else {
                    panel.classList.remove('mode-tab-panel-active');
                }
            });
            
            // 4. Mettre Ã  jour les indicateurs
            multiLLM.setMode(mode);
            updateIndicators();
            
            // 5. âœ… SMOOTH SCROLL vers le contenu des tabs
            setTimeout(() => {
                const modeSection = document.querySelector('.mode-tabs-header');
                if (modeSection) {
                    smoothScrollToElement(modeSection, -20);
                }
            }, 100);
            
            // 6. âœ… HIGHLIGHT temporaire du panel actif
            setTimeout(() => {
                const activePanel = document.querySelector('.mode-tab-panel-active');
                if (activePanel) {
                    highlightElement(activePanel);
                }
            }, 400);
            
            // 7. Si mode API, scroll vers provider selection aprÃ¨s animation
            if (mode === 'user-keys') {
                setTimeout(() => {
                    const providerGrid = document.querySelector('.provider-grid');
                    if (providerGrid) {
                        smoothScrollToElement(providerGrid, -100);
                    }
                }, 600);
            }
        }
        */
        
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // FONCTIONS UTILITAIRES DE SCROLLING
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        
        /**
         * Scroll smooth vers un Ã©lÃ©ment avec offset optionnel
         * @param {HTMLElement|string} element - Element ou selector
         * @param {number} offset - Offset en pixels (nÃ©gatif = au-dessus)
         */
        function smoothScrollToElement(element, offset = 0) {
            const el = typeof element === 'string' 
                ? document.querySelector(element) 
                : element;
            
            if (!el) return;
            
            // Scroll minimal avec scrollIntoView
            el.scrollIntoView({
                behavior: 'smooth',
                block: 'nearest',  // âš¡ Scroll minimal
                inline: 'nearest'
            });
            
            console.log('[SCROLL] Scrolling to element:', el.id || el.className);
        }
        
        /**
         * Highlight temporaire d'un Ã©lÃ©ment (bordure + animation)
         * @param {HTMLElement|string} element - Element ou selector
         * @param {number} duration - DurÃ©e en ms
         */
        function highlightElement(element, duration = 1500) {
            const el = typeof element === 'string' 
                ? document.querySelector(element) 
                : element;
            
            if (!el) return;
            
            el.classList.add('highlight-element');
            
            setTimeout(() => {
                el.classList.remove('highlight-element');
            }, duration);
            
            console.log('[HIGHLIGHT] Element highlighted:', el.id || el.className);
        }
        
        /**
         * Scroll vers section aprÃ¨s upload PDF
         */
        function scrollToProcessingSection() {
            setTimeout(() => {
                const section = document.getElementById('strategySection') || 
                               document.querySelector('.strategies-section');
                if (section) {
                    smoothScrollToElement(section, -50);
                    highlightElement(section, 2000);
                }
            }, 300);
        }
        
        /**
         * Scroll vers batch item actif
         */
        function scrollToBatchItem(index) {
            setTimeout(() => {
                const item = document.querySelector(`[data-batch-index="${index}"]`);
                if (item) {
                    smoothScrollToElement(item, -100);
                    highlightElement(item, 1000);
                }
            }, 200);
        }
        
        /**
         * Scroll vers configuration provider aprÃ¨s sÃ©lection
         */
        function scrollToProviderConfig() {
            setTimeout(() => {
                const config = document.getElementById('providerConfig');
                if (config && config.style.display !== 'none') {
                    smoothScrollToElement(config, -80);
                    highlightElement(config, 2000);
                }
            }, 400);
        }
        
        /**
         * Scroll vers quick actions API
         */
        function scrollToAPIQuickActions() {
            setTimeout(() => {
                const section = document.querySelector('.api-quick-section');
                if (section) {
                    smoothScrollToElement(section, -100);
                    highlightElement(section);
                }
            }, 500);
        }
        
        function toggleWorkerMode() {
            const toggle = document.getElementById('workerToggle');
            const panel = document.getElementById('workerActivePanel');
            const enabled = toggle.checked;
            
            if (enabled) {
                multiLLM.switchMode('worker');
                panel.style.display = 'block';
                showStatus('âœ… Worker activÃ© - Glissez un fichier pour traitement automatique', 'success');
                console.log('[WORKER] Mode activÃ©, URL:', multiLLM.workerURL);
                
                // âœ… V6.7.0: Initialize worker models if not already done
                if (document.getElementById('workerProvider') && typeof updateWorkerModels === 'function') {
                    updateWorkerModels();
                    console.log('[WORKER] âœ… Models initialized for current provider');
                }
                
                // Scroll vers le panel
                setTimeout(() => {
                    smoothScrollToElement(panel, -20);
                }, 300);
            } else {
                multiLLM.switchMode('user_keys');
                panel.style.display = 'none';
                showStatus('Worker dÃ©sactivÃ©', 'info');
            }
        }


        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // ğŸš€ BATCH MODE - SYSTÃˆME COMPLET
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        
        const BATCH_CONFIG = {
            max_tokens_per_chunk: 140000,
            chunk_overlap: 5000,
            polling_interval: 30000,
            max_wait_time: 10800000,
        };
        
        let BATCH_STATE = {
            current_batch_id: null,
            start_time: null,
            polling_timer: null,
            timer_interval: null,
            chunks: [],
            results: [],
        };
        
        function saveBatchKey(provider) {
            const input = document.getElementById(`batch${provider.charAt(0).toUpperCase() + provider.slice(1)}Key`);
            const statusEl = document.getElementById(`batch-${provider}-status`);
            const saveBtn = document.getElementById(`save-batch-${provider}`);
            
            if (!input || !input.value.trim()) {
                if (statusEl) statusEl.innerHTML = '<span style="color:#d32f2f;">âŒ ClÃ© requise</span>';
                return;
            }
            
            const key = input.value.trim();
            
            // Validation format Anthropic
            if (provider === 'anthropic' && !key.startsWith('sk-ant-')) {
                if (statusEl) statusEl.innerHTML = '<span style="color:#d32f2f;">âŒ Format invalide (doit commencer par sk-ant-)</span>';
                return;
            }
            
            // Sauvegarder la clÃ©
            localStorage.setItem(`batch_${provider}_key`, key);
            
            // Sauvegarder le modÃ¨le si c'est Anthropic
            if (provider === 'anthropic') {
                const modelSelect = document.getElementById('batchAnthropicModel');
                if (modelSelect) {
                    localStorage.setItem('batch_anthropic_model', modelSelect.value);
                    console.log(`[BATCH] âœ… ModÃ¨le ${modelSelect.value} sauvegardÃ©`);
                }
            }
            
            console.log(`[BATCH] âœ… ClÃ© ${provider} sauvegardÃ©e`);
            
            // Feedback visuel
            if (saveBtn) {
                saveBtn.textContent = 'âœ“ SauvegardÃ©e';
                saveBtn.style.background = '#4CAF50';
            }
            
            if (statusEl) {
                statusEl.innerHTML = '<span style="color:#4CAF50;">âœ… ClÃ© validÃ©e et sauvegardÃ©e localement</span>';
            }
            
            showStatus(`âœ… ClÃ© ${provider} sauvegardÃ©e et validÃ©e`, 'success');
            
            // Reset button aprÃ¨s 2s
            setTimeout(() => {
                if (saveBtn) {
                    saveBtn.textContent = 'Sauvegarder';
                    saveBtn.style.background = '#8FAFB1';
                }
            }, 2000);
        }
        
        function toggleBatchMini(id) {
            const body = document.getElementById(`mini-${id}`);
            const arrow = document.getElementById(`arrow-${id}`);
            
            if (body && arrow) {
                if (body.style.display === 'none') {
                    body.style.display = 'block';
                    arrow.textContent = 'â–¼';
                } else {
                    body.style.display = 'none';
                    arrow.textContent = 'â–¶';
                }
            }
        }
        
        function loadBatchKeys() {
            const anthropicKey = localStorage.getItem('batch_anthropic_key');
            const anthropicModel = localStorage.getItem('batch_anthropic_model');
            
            if (anthropicKey) {
                const input = document.getElementById('batchAnthropicKey');
                const statusEl = document.getElementById('batch-anthropic-status');
                
                if (input) input.value = anthropicKey;
                if (statusEl) {
                    statusEl.innerHTML = '<span style="color:#4CAF50;">âœ… ClÃ© sauvegardÃ©e</span>';
                }
                
                console.log('[BATCH] ClÃ© chargÃ©e');
            }
            
            if (anthropicModel) {
                const modelSelect = document.getElementById('batchAnthropicModel');
                if (modelSelect) {
                    modelSelect.value = anthropicModel;
                    console.log('[BATCH] ModÃ¨le chargÃ©:', anthropicModel);
                }
            }
        }
        
        function estimateTokens(text) {
            return Math.ceil(text.length / 4);
        }
        
        function chunkText(text, maxTokens = 140000, overlap = 5000) {
            const estimatedTokens = estimateTokens(text);
            console.log(`[BATCH] ${text.length} chars, ~${estimatedTokens} tokens`);
            
            if (estimatedTokens <= maxTokens) {
                console.log(`[BATCH] Pas de chunking`);
                return [text];
            }
            
            const numChunks = Math.ceil(estimatedTokens / maxTokens);
            console.log(`[BATCH] ğŸ“¦ Chunking en ${numChunks} parties`);
            
            const chunks = [];
            const charsPerChunk = Math.floor(text.length / numChunks);
            const overlapChars = Math.floor(overlap * 4);
            
            for (let i = 0; i < numChunks; i++) {
                const start = Math.max(0, i * charsPerChunk - (i > 0 ? overlapChars : 0));
                const end = Math.min(text.length, (i + 1) * charsPerChunk + overlapChars);
                chunks.push(text.slice(start, end));
            }
            
            return chunks;
        }
        
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // BATCH WORKER CONFIGURATION - V6.8.6
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        const BATCH_WORKER_URL = 'https://ocr-universel-proxy.11drumboy11.workers.dev';
        const USE_BATCH_WORKER = true; // âœ… Utiliser Worker (pas de CORS!)
        
        console.log('[BATCH] ğŸŒ Worker URL:', BATCH_WORKER_URL);
        console.log('[BATCH] ğŸ”§ Worker enabled:', USE_BATCH_WORKER);
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

        async function submitBatchAPI(chunks, systemPrompt) {
            const anthropicKey = localStorage.getItem('batch_anthropic_key');
            if (!anthropicKey) throw new Error('ClÃ© Anthropic manquante');
            
            const requests = chunks.map((chunk, index) => ({
                custom_id: `chunk_${index + 1}`,
                params: {
                    model: "claude-sonnet-4-5-20250929",
                    max_tokens: 32000,
                    messages: [{role: "user", content: chunk}],
                    system: systemPrompt
                }
            }));
            
            console.log(`[BATCH] ğŸ“¤ ${requests.length} requÃªtes`);
            
            // âœ… V6.8.6 - Utiliser Worker Cloudflare (bypass CORS)
            const apiUrl = USE_BATCH_WORKER 
                ? `${BATCH_WORKER_URL}/batch/submit`
                : 'https://api.anthropic.com/v1/messages/batches';
            
            console.log(`[BATCH] ğŸŒ Submitting via: ${USE_BATCH_WORKER ? 'Worker' : 'Direct Anthropic'}`);
            
            const response = await fetch(apiUrl, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-API-Key': anthropicKey,  // âœ… Worker utilise X-API-Key
                    'anthropic-version': '2023-06-01'
                },
                body: JSON.stringify({ requests })
            });
            
            if (!response.ok) {
                const error = await response.text();
                throw new Error(`Batch API: ${error}`);
            }
            
            return await response.json();
        }
        
        async function checkBatchStatus(batchId) {
            const anthropicKey = localStorage.getItem('batch_anthropic_key');
            
            // âœ… V6.8.6 - Utiliser Worker Cloudflare
            const apiUrl = USE_BATCH_WORKER
                ? `${BATCH_WORKER_URL}/batch/status/${batchId}`
                : `https://api.anthropic.com/v1/messages/batches/${batchId}`;
            
            const response = await fetch(apiUrl, {
                headers: {
                    'X-API-Key': anthropicKey,
                    'anthropic-version': '2023-06-01'
                }
            });
            if (!response.ok) throw new Error('Erreur check status');
            return await response.json();
        }
        
        async function fetchBatchResults(batchId) {
            const anthropicKey = localStorage.getItem('batch_anthropic_key');
            
            // âœ… V6.8.6 - Utiliser Worker Cloudflare
            const apiUrl = USE_BATCH_WORKER
                ? `${BATCH_WORKER_URL}/batch/results/${batchId}`
                : `https://api.anthropic.com/v1/messages/batches/${batchId}/results`;
            
            const response = await fetch(apiUrl, {
                headers: {
                    'X-API-Key': anthropicKey,
                    'anthropic-version': '2023-06-01'
                }
            });
            if (!response.ok) throw new Error('Erreur rÃ©cup rÃ©sultats');
            
            // âœ… Worker renvoie JSON: { results: [...] }
            // âœ… Anthropic direct renvoie JSONL
            if (USE_BATCH_WORKER) {
                const data = await response.json();
                return data.results;
            } else {
                const text = await response.text();
                return text.trim().split('\n').map(line => JSON.parse(line));
            }
        }
        
        function mergeChunkResults(results) {
            console.log(`[BATCH] ğŸ”„ Fusion ${results.length} rÃ©sultats`);
            
            results.sort((a, b) => {
                const idA = parseInt(a.custom_id.split('_')[1]);
                const idB = parseInt(b.custom_id.split('_')[1]);
                return idA - idB;
            });
            
            let merged = {
                version: "6.8.7-WORKER-FIX",
                generated_at: new Date().toISOString(),
                document: {}, metadonnees: {}, structure: {},
                chapitres: [], index_conceptuel: [], themes: [], terminologie: {},
                exercices: [], etudes_cas: [], outils: [], exemples: [],
                graphe_nodes: [], graphe_edges: [], clusters: [], glossaire: [],
                statistiques: {}
            };
            
            results.forEach((result, index) => {
                try {
                    const content = result.result.message.content[0].text;
                    let cleaned = content.replace(/```json\n?/g, '').replace(/```\n?/g, '').trim();
                    const firstBrace = cleaned.indexOf('{');
                    const lastBrace = cleaned.lastIndexOf('}');
                    if (firstBrace !== -1 && lastBrace !== -1) {
                        cleaned = cleaned.substring(firstBrace, lastBrace + 1);
                    }
                    const chunkData = JSON.parse(cleaned);
                    
                    if (index === 0) {
                        if (chunkData.metadata) merged.document = chunkData.metadata;
                        if (chunkData.document) merged.document = chunkData.document;
                        if (chunkData.metadonnees) merged.metadonnees = chunkData.metadonnees;
                        if (chunkData.structure) merged.structure = chunkData.structure;
                    }
                    
                    // âœ… V6.8.7 - EXTRACTION depuis structure si chapitres vide
                    if (!chunkData.chapitres || chunkData.chapitres.length === 0) {
                        if (chunkData.structure && chunkData.structure.chapitres) {
                            chunkData.chapitres = chunkData.structure.chapitres;
                            console.log(`[BATCH] âœ… Extracted ${chunkData.chapitres.length} chapitres from structure`);
                        }
                    }
                    
                    // âœ… V6.8.7 - EXTRACTION concepts depuis concepts.concepts_cles
                    if (!chunkData.index_conceptuel || chunkData.index_conceptuel.length === 0) {
                        if (chunkData.concepts && chunkData.concepts.concepts_cles) {
                            chunkData.index_conceptuel = chunkData.concepts.concepts_cles;
                            console.log(`[BATCH] âœ… Extracted ${chunkData.index_conceptuel.length} concepts from concepts.concepts_cles`);
                        }
                    }
                    
                    ['chapitres', 'index_conceptuel', 'themes', 'exercices', 'etudes_cas', 
                     'outils', 'exemples', 'graphe_nodes', 'graphe_edges', 'clusters', 'glossaire'].forEach(key => {
                        if (chunkData[key]) merged[key] = merged[key].concat(chunkData[key]);
                    });
                    
                    if (chunkData.terminologie) {
                        merged.terminologie = {...merged.terminologie, ...chunkData.terminologie};
                    }
                    
                    console.log(`[BATCH] Chunk ${index + 1}: ${chunkData.chapitres?.length || 0} chapitres, ${chunkData.index_conceptuel?.length || 0} concepts`);
                    
                } catch (e) {
                    console.error(`[BATCH] Erreur chunk ${index + 1}:`, e);
                }
            });
            
            function dedup(arr, key) {
                const seen = new Set();
                return arr.filter(item => {
                    const val = item[key];
                    if (seen.has(val)) return false;
                    seen.add(val);
                    return true;
                });
            }
            
            merged.index_conceptuel = dedup(merged.index_conceptuel, 'terme');
            merged.themes = dedup(merged.themes, 'nom');
            merged.glossaire = dedup(merged.glossaire, 'terme');
            merged.graphe_nodes = dedup(merged.graphe_nodes, 'id');
            
            merged.statistiques = {
                nombre_chapitres: merged.chapitres.length,
                nombre_concepts: merged.index_conceptuel.length,
                nombre_exercices: merged.exercices.length,
                nombre_etudes_cas: merged.etudes_cas.length,
                nombre_outils: merged.outils.length,
                nombre_themes: merged.themes.length,
                densite_conceptuelle: merged.chapitres.length > 0 
                    ? (merged.index_conceptuel.length / merged.chapitres.length).toFixed(2) : "0.00"
            };
            
            console.log('[BATCH] âœ… FusionnÃ©:', merged.statistiques);
            return merged;
        }
        
        function startBatchPolling(batchId) {
            console.log(`[BATCH] â³ Polling: ${batchId}`);
            
            BATCH_STATE.current_batch_id = batchId;
            BATCH_STATE.start_time = Date.now();
            
            const statusDiv = document.getElementById('batchStatus');
            if (statusDiv) statusDiv.style.display = 'block';
            
            BATCH_STATE.timer_interval = setInterval(() => {
                const elapsed = Math.floor((Date.now() - BATCH_STATE.start_time) / 1000);
                const minutes = Math.floor(elapsed / 60);
                const seconds = elapsed % 60;
                const timerEl = document.getElementById('batchTimer');
                if (timerEl) timerEl.textContent = `â±ï¸ ${minutes}min ${seconds}s`;
            }, 1000);
            
            BATCH_STATE.polling_timer = setInterval(async () => {
                try {
                    const status = await checkBatchStatus(batchId);
                    console.log(`[BATCH] Status: ${status.processing_status}`);
                    
                    const statusText = document.getElementById('batchStatusText');
                    const details = document.getElementById('batchDetails');
                    const progress = document.getElementById('batchProgress');
                    
                    if (statusText) statusText.textContent = `Status: ${status.processing_status}`;
                    
                    if (details && status.request_counts) {
                        const counts = status.request_counts;
                        const total = counts.processing + counts.succeeded + counts.errored + counts.canceled + counts.expired;
                        const done = counts.succeeded + counts.errored + counts.canceled + counts.expired;
                        const percent = total > 0 ? Math.floor((done / total) * 100) : 0;
                        details.textContent = `${done}/${total} requÃªtes (${percent}%)`;
                        if (progress) progress.style.width = `${percent}%`;
                    }
                    
                    if (status.processing_status === 'ended') {
                        console.log('[BATCH] âœ… TerminÃ©!');
                        clearInterval(BATCH_STATE.polling_timer);
                        clearInterval(BATCH_STATE.timer_interval);
                        
                        if (statusText) statusText.textContent = 'RÃ©cupÃ©ration...';
                        const results = await fetchBatchResults(batchId);
                        
                        if (statusText) statusText.textContent = 'Fusion...';
                        const merged = mergeChunkResults(results);
                        
                        STATE.lastResult = merged;
                        const resultDiv = document.getElementById('apiResult');
                        if (resultDiv) resultDiv.textContent = JSON.stringify(merged, null, 2);
                        
                        setTimeout(() => { if (statusDiv) statusDiv.style.display = 'none'; }, 3000);
                        
                        showStatus('âœ… Batch terminÃ©!', 'success');
                        highlightElement('downloadZIPBtn');
                    }
                } catch (error) {
                    console.error('[BATCH] Erreur polling:', error);
                }
            }, BATCH_CONFIG.polling_interval);
            
            setTimeout(() => {
                if (BATCH_STATE.polling_timer) {
                    clearInterval(BATCH_STATE.polling_timer);
                    clearInterval(BATCH_STATE.timer_interval);
                    showStatus('â±ï¸ Timeout 3h', 'warning');
                }
            }, BATCH_CONFIG.max_wait_time);
        }
        
        // âœ… V6.8.5 - GÃ©nÃ©ration du prompt systÃ¨me pour Knowledge Base (Format 32)
        function generateKnowledgeBasePrompt() {
            return `Tu es un expert en analyse documentaire et crÃ©ation de bases de connaissances structurÃ©es.

Ta tÃ¢che est d'extraire et d'organiser le contenu d'un document en format JSON structurÃ© selon le Format 32 modules (Knowledge Base R&D).

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
STRUCTURE JSON ATTENDUE - FORMAT 32 MODULES
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

{
  "metadata": {
    "titre": "string",
    "auteur": "string",
    "date_publication": "string",
    "editeur": "string",
    "langue": "string",
    "isbn": "string",
    "nombre_pages": number,
    "type_document": "string"
  },
  "structure": {
    "chapitres": [
      {
        "numero": number,
        "titre": "string",
        "resume": "string",
        "themes": ["string"]
      }
    ],
    "sections_principales": ["string"],
    "organisation": "string"
  },
  "concepts": {
    "concepts_cles": [
      {
        "nom": "string",
        "definition": "string",
        "importance": "string",
        "exemples": ["string"],
        "citations": ["string"]
      }
    ],
    "theories": [
      {
        "nom": "string",
        "description": "string",
        "auteur": "string",
        "principes": ["string"]
      }
    ],
    "modeles": ["string"]
  },
  "contenu_enrichi": {
    "methodes": [
      {
        "nom": "string",
        "description": "string",
        "etapes": ["string"],
        "avantages": ["string"],
        "limitations": ["string"]
      }
    ],
    "outils": ["string"],
    "cas_pratiques": [
      {
        "titre": "string",
        "contexte": "string",
        "probleme": "string",
        "solution": "string",
        "resultats": "string"
      }
    ],
    "exercices": ["string"]
  },
  "graphe_connaissances": {
    "relations": [
      {
        "source": "string",
        "type": "string",
        "cible": "string",
        "description": "string"
      }
    ],
    "hierarchie": {},
    "liens_thematiques": []
  },
  "index": {
    "mots_cles": ["string"],
    "personnes": ["string"],
    "organisations": ["string"],
    "lieux": ["string"],
    "dates_importantes": ["string"]
  },
  "ressources": {
    "bibliographie": ["string"],
    "references": ["string"],
    "liens_externes": ["string"],
    "glossaire": {}
  },
  "taxonomie": {
    "categories": ["string"],
    "tags": ["string"],
    "domaines": ["string"]
  },
  "statistiques": {
    "nombre_concepts": number,
    "nombre_theories": number,
    "nombre_methodes": number,
    "nombre_cas": number,
    "densite_information": "string"
  }
}

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
RÃˆGLES STRICTES
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

1. GÃ‰NÃˆRE JSON PUR UNIQUEMENT
   - Commence EXACTEMENT par {
   - Termine EXACTEMENT par }
   - RIEN avant le {
   - RIEN aprÃ¨s le }

2. REMPLIS TOUS LES CHAMPS
   - Aucun champ vide
   - Utilise null si donnÃ©e absente
   - Pas de placeholders [TBD]

3. EXTRAIS L'INFORMATION RÃ‰ELLE
   - Citations textuelles simples (pas de markdown)
   - Concepts et thÃ©ories du document
   - Relations entre idÃ©es
   - Structure du document

4. SOIS EXHAUSTIF ET PRÃ‰CIS
   - Maximum d'informations extraites
   - DÃ©finitions claires et complÃ¨tes
   - Exemples concrets du texte
   - Relations explicites entre concepts

Le document Ã  analyser te sera fourni dans le message utilisateur.`;
        }
        
        // âœ… V6.8.4 - Traitement BATCH synchrone pour un fichier
        async function processSingleFileBatchMode(extractedText, fileName, itemId) {
            console.log(`[BATCH-API] ğŸ¯ processSingleFileBatchMode() ENTRÃ‰ pour ${fileName}`);
            console.log(`[BATCH-API] ğŸ“Š Texte: ${extractedText.length} caractÃ¨res`);
            console.log(`[BATCH] ğŸš€ START for ${fileName}`);
            
            const anthropicKey = localStorage.getItem('batch_anthropic_key');
            if (!anthropicKey) {
                throw new Error('âŒ ClÃ© Anthropic requise');
            }
            
            // Chunking si nÃ©cessaire
            const chunks = chunkText(extractedText, BATCH_CONFIG.max_tokens_per_chunk, BATCH_CONFIG.chunk_overlap);
            console.log(`[BATCH] ğŸ“¦ ${chunks.length} chunk(s) crÃ©Ã©s`);
            
            // GÃ©nÃ©rer le prompt system
            const systemPrompt = generateKnowledgeBasePrompt();
            
            // Soumettre le batch
            console.log(`[BATCH] ğŸ“¤ Soumission Ã  l'API...`);
            const batch = await submitBatchAPI(chunks, systemPrompt);
            console.log(`[BATCH] âœ… Batch crÃ©Ã©: ${batch.id}`);
            
            // Polling synchrone jusqu'Ã  complÃ©tion
            const maxWaitTime = 3 * 60 * 60 * 1000; // 3h max
            const startTime = Date.now();
            const pollInterval = 30000; // 30s
            
            while (true) {
                // Check timeout
                if (Date.now() - startTime > maxWaitTime) {
                    throw new Error('â±ï¸ Timeout 3h dÃ©passÃ©');
                }
                
                // Attendre avant le prochain check
                await new Promise(resolve => setTimeout(resolve, pollInterval));
                
                // VÃ©rifier le statut
                const status = await checkBatchStatus(batch.id);
                console.log(`[BATCH] ğŸ“Š Status: ${status.processing_status} (${Math.round((Date.now() - startTime) / 60000)}min)`);
                
                if (status.processing_status === 'ended') {
                    console.log(`[BATCH] âœ… Batch terminÃ©! RÃ©cupÃ©ration des rÃ©sultats...`);
                    
                    // RÃ©cupÃ©rer et fusionner les rÃ©sultats
                    const results = await fetchBatchResults(batch.id);
                    const merged = mergeChunkResults(results);
                    
                    console.log(`[BATCH] âœ… ${fileName}: ${results.length} chunks fusionnÃ©s`);
                    
                    // Retourner au format attendu par le flux
                    return {
                        text: JSON.stringify(merged, null, 2), // âœ… Compatible avec downloadResultAsZIP
                        content: JSON.stringify(merged, null, 2),
                        model: 'claude-sonnet-4-5-20250929',
                        provider: 'anthropic-batch',
                        metadata: {
                            batch_id: batch.id,
                            chunks_count: chunks.length,
                            processing_time_minutes: Math.round((Date.now() - startTime) / 60000)
                        },
                        usage: {
                            input_tokens: chunks.reduce((sum, chunk) => sum + estimateTokens(chunk), 0),
                            output_tokens: estimateTokens(JSON.stringify(merged))
                        }
                    };
                } else if (status.processing_status === 'failed') {
                    throw new Error(`âŒ Batch Ã©chouÃ©: ${status.error_message || 'Erreur inconnue'}`);
                } else if (status.processing_status === 'expired') {
                    throw new Error('â±ï¸ Batch expirÃ©');
                }
                
                // Sinon, continuer le polling (in_progress)
            }
        }
        
        async function processBatchMode(extractedText, fileName) {
            console.log('[BATCH] ğŸš€ START');
            
            const anthropicKey = localStorage.getItem('batch_anthropic_key');
            if (!anthropicKey) {
                showStatus('âŒ ClÃ© Anthropic requise', 'error');
                return;
            }
            
            try {
                showStatus('ğŸš€ BATCH: Analyse...', 'info');
                
                const chunks = chunkText(extractedText, BATCH_CONFIG.max_tokens_per_chunk, BATCH_CONFIG.chunk_overlap);
                BATCH_STATE.chunks = chunks;
                
                showStatus(`ğŸ“¦ ${chunks.length} chunk(s)`, 'info');
                
                const systemPrompt = generateKnowledgeBasePrompt();
                showStatus('ğŸ“¤ Soumission...', 'info');
                
                const batch = await submitBatchAPI(chunks, systemPrompt);
                showStatus(`âœ… Batch: ${batch.id}`, 'success');
                showStatus(`â³ Traitement 1-3h`, 'info');
                
                startBatchPolling(batch.id);
            } catch (error) {
                console.error('[BATCH] âŒ', error);
                showStatus(`âŒ ${error.message}`, 'error');
            }
        }

        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // INITIALIZATION
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        
        document.addEventListener('DOMContentLoaded', () => {
            console.log('OCR Universel V6.9 PATCH COMPLET - Ready!');
            console.log('21 formats supportÃ©s');
            console.log('OCR Workers parallÃ¨les activÃ©s');
            console.log('PROMPT_MODULES intÃ©grÃ©s');
            console.log('Multi-LLM API Manager activÃ©');
            console.log('3 MODES : Manuel (copy/paste), API Multi-LLM (vos clÃ©s), API Worker (gratuit - workflow identique au Manuel)');
            
            // Initialiser le mode par dÃ©faut
            STATE.processingMode = 'manual';
            
            updateIndicators();
            
            // Initialiser les sÃ©lecteurs de modÃ¨les
            if (document.getElementById('userModel')) {
                updateUserModels();
            }
            
            // âœ… V6.4.4 - TOUJOURS dÃ©marrer en mode Manuel (pas de restauration)
            const radioManual = document.querySelector('input[name="mode"][value="manual"]');
            if (radioManual) {
                radioManual.checked = true;
            }
            
            // Forcer multiLLM en mode user_keys par dÃ©faut
            multiLLM.switchMode('user_keys');
            
            STATE.processingMode = 'manual';
            STATE.mode = 'manual';
            
            console.log('[INIT] Mode par dÃ©faut: Manuel');
            
            // âœ… V6.6.4 FIX: Display saved keys on page load
            displaySavedKeys();
            
            // âœ… V6.8.3: Charger les clÃ©s BATCH sauvegardÃ©es
            loadBatchKeys();
        });
    </script>
    
    <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
    <!-- MODAL GÃ‰NÃ‰RATION PROMPT V6.0 - 3 MODES -->
    <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
    <div id="promptModal">
        <div class="modal-content" style="max-width:900px;">
            <div class="modal-header">
                <h2>ğŸ¯ GÃ©nÃ©ration Prompt ConsolidÃ©</h2>
                <span class="modal-close" onclick="closePromptModal()">&times;</span>
            </div>
            
            <p style="text-align:center;margin-bottom:30px;color:var(--gris-secondaire);">
                Choisissez comment vous voulez traiter le prompt consolidÃ©
            </p>
            
            <!-- â•â•â• NOUVEAU : SYSTÃˆME DE TABS â•â•â• -->
            <div class="mode-tabs-container">
                <!-- TABS HEADERS -->
                <div class="mode-tabs">
                    <button class="mode-tab active" data-mode="manual" onclick="switchModeTab('manual')">
                        <span class="mode-tab-icon">ğŸ“</span>
                        <span>Manuel</span>
                        <span class="mode-tab-badge">DÃ‰FAUT</span>
                    </button>
                    <button class="mode-tab" data-mode="user-keys" onclick="switchModeTab('user-keys')">
                        <span class="mode-tab-icon">ğŸ”‘</span>
                        <span>API Multi-LLM</span>
                        <span class="mode-tab-badge mode-tab-badge-premium">AVANCÃ‰</span>
                    </button>
                    <button class="mode-tab" data-mode="worker" onclick="switchModeTab('worker')">
                        <span class="mode-tab-icon">âš™ï¸</span>
                        <span>API Worker</span>
                        <span class="mode-tab-badge mode-tab-badge-free">GRATUIT</span>
                    </button>
                </div>
                
                <!-- TAB CONTENT : MODE 1 - MANUEL -->
                <div class="mode-tab-content active" id="tab-manual">
                    <h4 style="margin-bottom:15px;color:var(--accent);">ğŸ“ Mode Manuel (RecommandÃ©)</h4>
                    <p style="margin-bottom:20px;">Copiez ou tÃ©lÃ©chargez le prompt pour l'utiliser dans Claude.ai, ChatGPT ou autre plateforme.</p>
                    <div class="mode-actions">
                        <button class="btn btn-secondary" onclick="copyAllPrompts()">
                            ğŸ“‹ Copier dans presse-papiers
                        </button>
                        <button class="btn btn-secondary" onclick="downloadPromptTXT()">
                            ğŸ“ TÃ©lÃ©charger .txt
                        </button>
                        <button class="btn btn-secondary" onclick="downloadPromptJSON()">
                            ğŸ“¦ TÃ©lÃ©charger .json
                        </button>
                    </div>
                </div>
                
                <!-- TAB CONTENT : MODE 2 - API MULTI-LLM -->
                <div class="mode-tab-content" id="tab-user-keys">
                    <h4 style="margin-bottom:15px;color:var(--accent);">ğŸ”‘ API Multi-LLM avec vos clÃ©s</h4>
                    <p style="margin-bottom:20px;">Utilisez vos propres clÃ©s API pour envoyer le prompt directement Ã  l'IA de votre choix.</p>
                    
                    <div class="api-config-box">
                        <div class="key-input-row">
                            <div>
                                <label for="userProvider">Provider:</label>
                                <select id="userProvider" onchange="updateUserModels()">
                                    <option value="anthropic">Anthropic Claude</option>
                                    <option value="openai">OpenAI GPT</option>
                            </div>
                            <div>
                                <label for="userModel">ModÃ¨le:</label>
                                <select id="userModel" onchange="updateUserCost()">
                                    <option value="claude-sonnet-4-20250514">Claude Sonnet 4</option>
                                </select>
                            </div>
                        </div>
                        
                        <!-- V6.3.0 - PANNEAU SÃ‰CURITÃ‰ & LIMITES -->
                        <div id="securityWarning" class="security-warning">
                            <h4>
                                <span style="font-size:24px;">âš ï¸</span>
                                <span>SÃ‰CURITÃ‰ & LIMITES - IMPORTANT</span>
                            </h4>
                            <div class="security-warning-content">
                                <p><strong>MODE USER KEYS (clÃ©s personnelles) :</strong></p>
                                <ul>
                                    <li>Vos clÃ©s sont stockÃ©es <strong>LOCALEMENT</strong> dans votre navigateur</li>
                                    <li>Obfuscation XOR (âš ï¸ PAS une vraie encryption)</li>
                                    <li>Les clÃ©s sont exposÃ©es au JavaScript de cette page</li>
                                </ul>
                                
                                <div class="security-warning-highlight">
                                    âš ï¸ N'utilisez PAS ce mode pour des donnÃ©es ultra-sensibles ou en production
                                </div>
                                
                                <p><strong>POUR PLUS DE SÃ‰CURITÃ‰ :</strong></p>
                                <ul>
                                    <li>âœ… Utilisez le <strong>Mode Worker</strong> (serveur Cloudflare sÃ©curisÃ©)</li>
                                    <li>âœ… Ou hÃ©bergez votre propre backend avec proxy</li>
                                    <li>âœ… Limitez l'usage aux tests et dÃ©veloppement</li>
                                </ul>
                            </div>
                            <div class="security-warning-actions">
                                <button class="security-btn security-btn-primary" onclick="acceptSecurityWarning()">
                                    âœ“ J'ai compris, continuer
                                </button>
                                <button class="security-btn security-btn-secondary" onclick="learnMoreSecurity()">
                                    â„¹ï¸ En savoir plus
                                </button>
                            </div>
                        </div>
                        
                        <div class="key-input-row">
                            <label id="userKeyLabel">ClÃ© API Anthropic:</label>
                            <input type="password" id="userApiKey" placeholder="sk-ant-api03-...">
                            <button class="btn btn-small" onclick="saveUserKey()">ğŸ’¾ Sauvegarder</button>
                        </div>
                        
                        <div class="api-params-row">
                            <div>
                                <label>Max Tokens:</label>
                                <input type="number" id="userMaxTokens" value="4096" min="1000" max="8000">
                            </div>
                            <div>
                                <label>Temperature:</label>
                                <input type="number" id="userTemperature" value="0.3" min="0" max="1" step="0.1">
                            </div>
                        </div>
                        
                        <div class="cost-display" id="userCost">
                            ğŸ’° CoÃ»t estimÃ© : <strong>$0.0150 USD</strong>
                        </div>
                    </div>
                    
                    <button class="btn" onclick="sendWithUserKeys()" style="width:100%;margin-top:15px;">
                        ğŸš€ Analyser avec mes clÃ©s
                    </button>
                </div>
                
                <!-- TAB CONTENT : MODE 3 - WORKER -->
                <div class="mode-tab-content" id="tab-worker">
                    <h4 style="margin-bottom:15px;color:var(--accent);">âš™ï¸ API Automatique (Worker)</h4>
                    <div class="worker-info">
                        <p>ğŸ”’ <strong>Utilise les clÃ©s de Christophe (gratuitement pour vous)</strong></p>
                        <p style="font-size:0.9em;color:var(--gris-secondaire);margin:10px 0;">
                            â€¢ Pas besoin de crÃ©er de compte<br>
                            â€¢ Pas de configuration<br>
                            â€¢ Cloudflare Worker sÃ©curisÃ©
                        </p>
                    </div>
                    
                    <div class="worker-toggle">
                        <label class="toggle-switch">
                            <input type="checkbox" id="workerEnabled" onchange="toggleWorker()">
                            <span class="toggle-slider"></span>
                        </label>
                        <span id="workerStatus">Mode Worker dÃ©sactivÃ©</span>
                    </div>
                    
                    <!-- âœ… NOUVEAU: Bouton KB Engine gratuit (toujours visible) -->
                    <div style="margin-top:20px;padding:15px;background:linear-gradient(135deg, #E6D7C3 0%, #D8CDBB 100%);border-left:4px solid #8FAFB1;border-radius:6px;">
                        <h5 style="margin:0 0 10px 0;color:#8FAFB1;">ğŸ‰ NOUVEAU: KB Engine Gratuit !</h5>
                        <p style="margin:0 0 15px 0;font-size:0.9em;color:#5a5a5a;">
                            6 analyses Multi-LLM + Knowledge Base complÃ¨te + ZIP professionnel - Totalement gratuit !
                        </p>
                        <button class="btn-api" onclick="sendToEnsembleWorker()" 
                                style="background:linear-gradient(135deg, #8FAFB1 0%, #C8D0C3 100%);color:white;font-weight:600;">
                            ğŸš€ KB Engine GRATUIT (6 tÃ¢ches Multi-LLM)
                        </button>
                    </div>
                    
                    <div id="workerActivePanel" style="display:none;">
                        <div class="api-config-box" style="margin-top:15px;">
                            <div class="key-input-row">
                                <div>
                                    <label>ModÃ¨le:</label>
                                    <select id="workerModel">
                                        <option value="claude-sonnet-4-5-20250929">Claude Sonnet 4.5 â­ (RecommandÃ©)</option>
                                        <option value="claude-opus-4-5-20251101">Claude Opus 4.5 (Premium)</option>
                                        <option value="claude-haiku-4-5-20251001">Claude Haiku 4.5 (Rapide)</option>
                                        <option value="claude-sonnet-4-20250514">Claude Sonnet 4</option>
                                        <option value="claude-opus-4-1-20250805">Claude Opus 4.1</option>
                                    </select>
                                </div>
                            </div>
                            
                            <div class="cost-display">
                                âœ… <strong>Gratuit pour vous</strong> (coÃ»t pris en charge)
                            </div>
                        </div>
                        
                        <button class="btn" onclick="sendWithWorker()" style="width:100%;margin-top:15px;">
                            ğŸš€ Analyser avec Worker
                        </button>
                    </div>
                </div>
            </div>
            
            <!-- Progress Bar (commune Ã  tous les modes API) -->
            <div class="api-progress" id="apiProgress">
                <div class="progress-bar">
                    <div class="progress-fill" id="apiProgressFill" style="width:0%">
                        <span id="apiProgressText">0%</span>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
    <!-- MODAL RÃ‰SULTAT API -->
    <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
    <div id="apiResultModal">
        <div class="api-result-content">
            <div class="modal-header">
                <h2>âœ… RÃ©sultat API</h2>
                <span class="modal-close" onclick="closeAPIResult()">&times;</span>
            </div>
            
            <div class="result-metadata">
                <div class="metadata-item">
                    <div class="metadata-value" id="resultProvider">ANTHROPIC</div>
                    <div class="metadata-label">Provider</div>
                </div>
                <div class="metadata-item">
                    <div class="metadata-value" id="resultModel">Sonnet 4</div>
                    <div class="metadata-label">ModÃ¨le</div>
                </div>
                <div class="metadata-item">
                    <div class="metadata-value" id="resultDuration">32.5s</div>
                    <div class="metadata-label">DurÃ©e</div>
                </div>
                <div class="metadata-item">
                    <div class="metadata-value" id="resultCost">$0.0150</div>
                    <div class="metadata-label">CoÃ»t</div>
                </div>
            </div>
            
            <h3>RÃ©sultat JSON :</h3>
            <pre class="json-display" id="jsonDisplay">{ }</pre>
            
            <div class="result-actions">
                <button class="btn" onclick="downloadAPIResult()">ğŸ“¥ TÃ©lÃ©charger JSON</button>
                <button class="btn btn-secondary" onclick="copyAPIResult()">ğŸ“‹ Copier</button>
                <button class="btn btn-secondary" onclick="closeAPIResult()">Fermer</button>
            </div>
        </div>
    </div>

</body>
</html>
