<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PDF Batch PRO UNIVERSAL v2.0 - OCR Intelligent + Mode Livre L√©ger</title>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf-lib/1.17.1/pdf-lib.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <style>
        :root {
            --mer: #8FAFB1;
            --vert-sauge: #C8D0C3;
            --beige-sable: #D8CDBB;
            --sable: #E6D7C3;
            --blanc: #FFFFFF;
            --gris-texte: #333333;
            --accent-1: #6C63FF;
            --accent-2: #FF6B6B;
            --accent-3: #4ECDC4;
            --accent-light: #E8F4F8;
            --accent-warning: #FFF3CD;
            --accent-success: #D4EDDA;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Montserrat', 'Segoe UI', sans-serif;
            background: var(--blanc);
            min-height: 100vh;
            padding: 30px 20px;
            color: var(--gris-texte);
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: var(--blanc);
            border-radius: 20px;
            padding: 40px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.15);
        }

        h1 {
            color: var(--mer);
            text-align: center;
            margin-bottom: 10px;
            font-size: 3em;
            font-weight: 700;
            background: linear-gradient(135deg, var(--mer), var(--accent-1));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .subtitle {
            text-align: center;
            color: var(--gris-texte);
            margin-bottom: 15px;
            font-size: 1.2em;
            font-weight: 500;
        }

        .universal-badge {
            background: linear-gradient(135deg, var(--accent-1), var(--accent-3));
            color: var(--blanc);
            padding: 12px 30px;
            border-radius: 30px;
            font-weight: 700;
            display: inline-block;
            margin: 0 auto 30px;
            box-shadow: 0 6px 20px rgba(108, 99, 255, 0.4);
            font-size: 1.15em;
            text-align: center;
        }

        .version-tag {
            background: var(--accent-3);
            color: var(--blanc);
            padding: 4px 12px;
            border-radius: 10px;
            font-size: 0.7em;
            margin-left: 10px;
            vertical-align: middle;
        }

        .format-badges {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 10px;
            margin: 20px 0;
        }

        .format-badge {
            background: linear-gradient(135deg, var(--vert-sauge), var(--sable));
            color: var(--gris-texte);
            padding: 8px 20px;
            border-radius: 20px;
            font-size: 0.9em;
            font-weight: 600;
            border: 2px solid var(--mer);
        }

        .phase {
            background: var(--sable);
            padding: 35px;
            border-radius: 15px;
            margin: 30px 0;
            border-left: 6px solid var(--mer);
        }

        .phase-title {
            color: var(--mer);
            font-size: 2em;
            font-weight: 700;
            margin-bottom: 25px;
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .form-group {
            margin-bottom: 25px;
        }

        label {
            display: block;
            font-weight: 600;
            margin-bottom: 10px;
            color: var(--gris-texte);
            font-size: 1.05em;
        }

        input[type="text"], input[type="number"], select, textarea {
            width: 100%;
            padding: 14px;
            border: 2px solid var(--vert-sauge);
            border-radius: 10px;
            font-family: 'Montserrat', sans-serif;
            font-size: 16px;
            background: var(--blanc);
            transition: all 0.3s;
        }

        input[type="text"]:focus, input[type="number"]:focus, select:focus, textarea:focus {
            outline: none;
            border-color: var(--mer);
            box-shadow: 0 0 0 3px rgba(143, 175, 177, 0.1);
        }

        .file-drop-zone {
            border: 3px dashed var(--mer);
            border-radius: 15px;
            padding: 60px 40px;
            text-align: center;
            background: var(--blanc);
            cursor: pointer;
            transition: all 0.3s;
            margin: 20px 0;
        }

        .file-drop-zone:hover, .file-drop-zone.drag-over {
            background: linear-gradient(135deg, rgba(108, 99, 255, 0.05), rgba(78, 205, 196, 0.05));
            border-color: var(--accent-1);
            transform: scale(1.01);
        }

        .file-drop-icon {
            font-size: 5em;
            margin-bottom: 20px;
            background: linear-gradient(135deg, var(--accent-1), var(--accent-3));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .file-drop-text {
            font-size: 1.4em;
            font-weight: 700;
            color: var(--mer);
            margin-bottom: 10px;
        }

        .file-preview {
            background: var(--sable);
            border: 3px solid var(--vert-sauge);
            border-radius: 12px;
            padding: 20px;
            margin: 20px 0;
            display: none;
        }

        .file-preview-item {
            display: flex;
            align-items: center;
            gap: 15px;
            padding: 15px;
            background: var(--blanc);
            border-radius: 10px;
            margin: 10px 0;
        }

        .file-icon {
            font-size: 3em;
        }

        .file-info-text {
            flex: 1;
        }

        .file-name {
            font-weight: 700;
            color: var(--mer);
            font-size: 1.1em;
            margin-bottom: 5px;
        }

        .file-details {
            color: #666;
            font-size: 0.9em;
        }

        .btn {
            background: linear-gradient(135deg, var(--mer) 0%, var(--vert-sauge) 100%);
            color: var(--blanc);
            border: none;
            padding: 18px 45px;
            border-radius: 12px;
            font-size: 1.15em;
            font-weight: 700;
            cursor: pointer;
            width: 100%;
            transition: all 0.3s;
            box-shadow: 0 4px 20px rgba(143, 175, 177, 0.4);
            font-family: 'Montserrat', sans-serif;
        }

        .btn:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 6px 25px rgba(143, 175, 177, 0.5);
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .btn-secondary {
            background: var(--beige-sable);
            color: var(--gris-texte);
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .btn-small {
            padding: 12px 25px;
            font-size: 0.95em;
            width: auto;
        }

        .info-box {
            background: linear-gradient(135deg, var(--sable), var(--beige-sable));
            border: 3px solid var(--mer);
            border-radius: 12px;
            padding: 25px;
            margin: 25px 0;
        }

        .info-box-title {
            font-weight: 700;
            color: var(--mer);
            margin-bottom: 15px;
            font-size: 1.3em;
        }

        .info-box ul {
            margin-left: 25px;
            line-height: 2;
        }

        /* === MODE LIVRE L√âGER === */
        .mode-selector {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin: 25px 0;
        }

        .mode-card {
            background: var(--blanc);
            border: 3px solid var(--vert-sauge);
            border-radius: 15px;
            padding: 25px;
            cursor: pointer;
            transition: all 0.3s;
            position: relative;
        }

        .mode-card:hover {
            border-color: var(--mer);
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(143, 175, 177, 0.3);
        }

        .mode-card.selected {
            border-color: var(--accent-1);
            border-width: 4px;
            background: linear-gradient(135deg, var(--accent-light), var(--blanc));
        }

        .mode-card.selected::after {
            content: '‚úì';
            position: absolute;
            top: 10px;
            right: 10px;
            width: 30px;
            height: 30px;
            background: var(--accent-1);
            color: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2em;
            font-weight: 700;
        }

        .mode-card.recommended {
            border-color: #28a745;
        }

        .mode-card.recommended::before {
            content: 'RECOMMAND√â';
            position: absolute;
            top: -12px;
            left: 20px;
            background: #28a745;
            color: white;
            padding: 4px 12px;
            border-radius: 10px;
            font-size: 0.7em;
            font-weight: 700;
        }

        .mode-icon {
            font-size: 3em;
            margin-bottom: 15px;
        }

        .mode-title {
            font-weight: 700;
            color: var(--mer);
            font-size: 1.3em;
            margin-bottom: 10px;
        }

        .mode-desc {
            color: #666;
            font-size: 0.95em;
            line-height: 1.6;
            margin-bottom: 15px;
        }

        .mode-specs {
            background: var(--sable);
            padding: 12px;
            border-radius: 8px;
            font-size: 0.85em;
        }

        .mode-specs-item {
            display: flex;
            justify-content: space-between;
            padding: 5px 0;
            border-bottom: 1px dashed var(--vert-sauge);
        }

        .mode-specs-item:last-child {
            border-bottom: none;
        }

        .detection-box {
            background: var(--accent-warning);
            border: 2px solid #856404;
            border-radius: 12px;
            padding: 20px;
            margin: 20px 0;
        }

        .detection-box.light-book {
            background: var(--accent-success);
            border-color: #28a745;
        }

        .detection-title {
            font-weight: 700;
            font-size: 1.2em;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .detection-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }

        .detection-stat {
            text-align: center;
            padding: 10px;
            background: rgba(255,255,255,0.7);
            border-radius: 8px;
        }

        .detection-stat-value {
            font-size: 1.5em;
            font-weight: 700;
            color: var(--mer);
        }

        .detection-stat-label {
            font-size: 0.85em;
            color: #666;
        }

        /* === FIN MODE LIVRE L√âGER === */

        .template-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 20px;
            margin: 25px 0;
        }

        .template-card {
            background: var(--blanc);
            border: 3px solid var(--vert-sauge);
            border-radius: 12px;
            padding: 25px;
            cursor: pointer;
            transition: all 0.3s;
            position: relative;
        }

        .template-card:hover {
            border-color: var(--mer);
            transform: translateY(-5px);
            box-shadow: 0 8px 25px rgba(143, 175, 177, 0.3);
        }

        .template-card.selected {
            border-color: var(--accent-1);
            border-width: 4px;
            background: linear-gradient(135deg, rgba(108, 99, 255, 0.05), rgba(78, 205, 196, 0.05));
        }

        .template-card.selected::after {
            content: '‚úì';
            position: absolute;
            top: 10px;
            right: 10px;
            width: 35px;
            height: 35px;
            background: var(--accent-1);
            color: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5em;
            font-weight: 700;
        }

        .template-icon {
            font-size: 3em;
            margin-bottom: 15px;
        }

        .template-title {
            font-weight: 700;
            color: var(--mer);
            font-size: 1.2em;
            margin-bottom: 10px;
        }

        .template-desc {
            color: #666;
            font-size: 0.9em;
            line-height: 1.6;
        }

        .progress-indicator {
            display: flex;
            justify-content: center;
            gap: 30px;
            margin: 40px 0;
            flex-wrap: wrap;
        }

        .progress-step {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 10px;
        }

        .progress-circle {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: var(--beige-sable);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            font-size: 1.3em;
            color: #666;
            border: 3px solid var(--vert-sauge);
        }

        .progress-step.active .progress-circle {
            background: linear-gradient(135deg, var(--mer), var(--vert-sauge));
            color: var(--blanc);
            border-color: var(--mer);
            box-shadow: 0 4px 15px rgba(143, 175, 177, 0.4);
        }

        .progress-step.completed .progress-circle {
            background: var(--vert-sauge);
            color: var(--blanc);
            border-color: var(--mer);
        }

        .progress-label {
            font-size: 0.9em;
            font-weight: 600;
            color: #666;
        }

        .progress-step.active .progress-label {
            color: var(--mer);
            font-weight: 700;
        }

        .part-card {
            background: var(--blanc);
            border: 3px solid var(--vert-sauge);
            border-radius: 15px;
            padding: 30px;
            margin: 25px 0;
            transition: all 0.3s;
        }

        .part-card:hover {
            border-color: var(--mer);
            box-shadow: 0 8px 25px rgba(143, 175, 177, 0.3);
        }

        .part-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .part-title {
            color: var(--mer);
            font-size: 1.8em;
            font-weight: 700;
        }

        .prompt-box {
            background: #2d2d2d;
            color: #f8f8f2;
            padding: 25px;
            border-radius: 12px;
            font-family: 'Courier New', monospace;
            font-size: 0.9em;
            white-space: pre-wrap;
            margin: 20px 0;
            max-height: 400px;
            overflow-y: auto;
            line-height: 1.6;
        }

        .json-textarea {
            width: 100%;
            min-height: 200px;
            padding: 15px;
            border: 2px solid var(--vert-sauge);
            border-radius: 10px;
            font-family: 'Courier New', monospace;
            font-size: 0.9em;
            resize: vertical;
            background: #f8f9fa;
            transition: all 0.3s;
        }

        .json-textarea:focus {
            outline: none;
            border-color: var(--mer);
            box-shadow: 0 0 0 3px rgba(143, 175, 177, 0.1);
        }

        .action-buttons {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }

        .download-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 25px;
            margin-top: 30px;
        }

        .download-item {
            background: var(--blanc);
            border: 3px solid var(--vert-sauge);
            border-radius: 15px;
            padding: 30px;
            text-align: center;
            transition: all 0.3s;
        }

        .download-item:hover {
            border-color: var(--mer);
            transform: translateY(-5px);
            box-shadow: 0 10px 30px rgba(143, 175, 177, 0.3);
        }

        .download-icon {
            font-size: 4em;
            margin-bottom: 20px;
        }

        .hidden {
            display: none;
        }

        .footer {
            text-align: center;
            margin-top: 60px;
            padding-top: 30px;
            border-top: 3px solid var(--beige-sable);
            font-family: 'Montserrat', sans-serif;
            font-size: 11px;
            font-weight: 400;
            color: #000000;
        }

        @keyframes pulse {
            0%, 100% {
                transform: scale(1);
                box-shadow: 0 4px 20px rgba(143, 175, 177, 0.4);
            }
            50% {
                transform: scale(1.02);
                box-shadow: 0 8px 30px rgba(143, 175, 177, 0.6);
            }
        }

        #fusionBtn {
            animation: pulse 2s infinite;
        }

        @media (max-width: 768px) {
            .container {
                padding: 25px;
            }
            
            h1 {
                font-size: 2em;
            }
            
            .phase {
                padding: 25px;
            }

            .template-grid {
                grid-template-columns: 1fr;
            }

            .action-buttons {
                grid-template-columns: 1fr;
            }

            .download-grid {
                grid-template-columns: 1fr;
            }

            .mode-selector {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>PDF BATCH PRO UNIVERSAL <span class="version-tag">v2.0</span></h1>
        <div class="subtitle">OCR Intelligent Multi-Format + Mode Livre L√©ger</div>
        <div style="text-align: center;">
            <span class="universal-badge">√âdition Universelle - Tous Documents</span>
        </div>

        <div class="format-badges">
            <span class="format-badge">PDF</span>
            <span class="format-badge">Images (PNG/JPG/WEBP)</span>
            <span class="format-badge">Texte (TXT/MD)</span>
            <span class="format-badge">Livres</span>
            <span class="format-badge">Cours</span>
            <span class="format-badge">Articles</span>
            <span class="format-badge">Documents Pro</span>
        </div>

        <!-- Indicateur de progression -->
        <div class="progress-indicator">
            <div class="progress-step active" id="stepIndicator1">
                <div class="progress-circle">1</div>
                <div class="progress-label">Upload et Config</div>
            </div>
            <div class="progress-step" id="stepIndicator2">
                <div class="progress-circle">2</div>
                <div class="progress-label">Extraction</div>
            </div>
            <div class="progress-step" id="stepIndicator3">
                <div class="progress-circle">3</div>
                <div class="progress-label">Export</div>
            </div>
        </div>

        <!-- PHASE 1 : Upload et Configuration -->
        <div class="phase" id="phase1">
            <div class="phase-title">Phase 1 : Document et Configuration</div>
            
            <div class="info-box">
                <div class="info-box-title">OCR Universel Intelligent v2.0</div>
                <p style="line-height: 1.8; margin-bottom: 15px;">
                    Uploadez <strong>n'importe quel type de document</strong> : PDF, images, texte. 
                    Cette version inclut le <strong>Mode Livre L√©ger</strong> avec d√©tection automatique 
                    et extraction optimis√©e.
                </p>
                <ul>
                    <li><strong>Multi-formats :</strong> PDF, PNG, JPG, JPEG, WEBP, GIF, TXT, MD</li>
                    <li><strong>D√©tection intelligente :</strong> Analyse de densit√© automatique</li>
                    <li><strong>Mode adaptatif :</strong> Standard (27 p.) ou Livre L√©ger (45 p.)</li>
                    <li><strong>Qualit√© pr√©serv√©e :</strong> Extraction exhaustive sans perte</li>
                </ul>
            </div>

            <div class="file-drop-zone" id="dropZone">
                <div class="file-drop-icon">+</div>
                <div class="file-drop-text">Glissez-d√©posez vos fichiers ici</div>
                <div style="margin: 15px 0; color: #666; font-size: 1.1em;">ou</div>
                <button class="btn btn-secondary" onclick="document.getElementById('fileInput').click()">
                    Parcourir les fichiers
                </button>
                <input type="file" id="fileInput" accept=".pdf,.png,.jpg,.jpeg,.webp,.gif,.txt,.md" style="display: none;">
                <div style="margin-top: 20px; font-size: 0.9em; color: #666;">
                    Formats support√©s : PDF, PNG, JPG, JPEG, WEBP, GIF, TXT, MD
                </div>
            </div>

            <div class="file-preview" id="filePreview"></div>

            <!-- Zone de d√©tection automatique -->
            <div id="detectionZone" class="hidden"></div>

            <!-- S√©lecteur de mode -->
            <div id="modeSelector" class="hidden">
                <label>Mode d'extraction</label>
                <div class="mode-selector">
                    <div class="mode-card" id="modeStandard" onclick="selectMode('standard')">
                        <div class="mode-icon">üìö</div>
                        <div class="mode-title">Mode Standard</div>
                        <div class="mode-desc">
                            Pour les documents denses avec beaucoup de contenu par page. 
                            Extraction d√©taill√©e avec parties de 25-30 pages.
                        </div>
                        <div class="mode-specs">
                            <div class="mode-specs-item">
                                <span>Pages/partie</span>
                                <span><strong>~27</strong></span>
                            </div>
                            <div class="mode-specs-item">
                                <span>Contenus/page</span>
                                <span><strong>2-4</strong></span>
                            </div>
                            <div class="mode-specs-item">
                                <span>JSON estim√©</span>
                                <span><strong>~3 Ko/page</strong></span>
                            </div>
                        </div>
                    </div>

                    <div class="mode-card" id="modeLightBook" onclick="selectMode('lightbook')">
                        <div class="mode-icon">üìñ</div>
                        <div class="mode-title">Mode Livre L√©ger</div>
                        <div class="mode-desc">
                            Pour les livres avec beaucoup de pages mais peu de poids. 
                            Extraction condens√©e avec parties de 40-50 pages.
                        </div>
                        <div class="mode-specs">
                            <div class="mode-specs-item">
                                <span>Pages/partie</span>
                                <span><strong>~45</strong></span>
                            </div>
                            <div class="mode-specs-item">
                                <span>Contenus/page</span>
                                <span><strong>1-2</strong></span>
                            </div>
                            <div class="mode-specs-item">
                                <span>JSON estim√©</span>
                                <span><strong>~1.8 Ko/page</strong></span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="form-group">
                <label for="titleInput">Titre du document</label>
                <input type="text" id="titleInput" placeholder="Ex: Intelligence Artificielle - Guide Complet">
            </div>

            <div class="form-group">
                <label for="authorsInput">Auteur(s) (s√©par√©s par des virgules)</label>
                <input type="text" id="authorsInput" placeholder="Ex: Jean Dupont, Marie Martin">
            </div>

            <div class="form-group">
                <label for="yearInput">Ann√©e</label>
                <input type="number" id="yearInput" placeholder="2024" min="1900" max="2100">
            </div>

            <div class="form-group">
                <label for="categoryInput">Cat√©gorie / Domaine</label>
                <input type="text" id="categoryInput" placeholder="Ex: Informatique, Sciences, Litt√©rature, Business...">
            </div>

            <div class="form-group">
                <label for="tagsInput">Tags (s√©par√©s par des virgules)</label>
                <input type="text" id="tagsInput" placeholder="Ex: IA, Machine Learning, Python, Data Science">
            </div>

            <div class="form-group">
                <label>S√©lectionnez un Template d'Extraction</label>
                <div class="template-grid" id="templateGrid">
                    <div class="template-card" onclick="selectTemplate('academic')" data-template="academic">
                        <div class="template-icon">üìö</div>
                        <div class="template-title">Livre / Cours Acad√©mique</div>
                        <div class="template-desc">Structure compl√®te avec chapitres, concepts, exercices et r√©f√©rences</div>
                    </div>
                    
                    <div class="template-card" onclick="selectTemplate('technical')" data-template="technical">
                        <div class="template-icon">üîß</div>
                        <div class="template-title">Documentation Technique</div>
                        <div class="template-desc">APIs, proc√©dures, sp√©cifications et guides d'impl√©mentation</div>
                    </div>
                    
                    <div class="template-card" onclick="selectTemplate('article')" data-template="article">
                        <div class="template-icon">üì∞</div>
                        <div class="template-title">Article / Blog</div>
                        <div class="template-desc">Introduction, corps, conclusion, citations et sources</div>
                    </div>
                    
                    <div class="template-card" onclick="selectTemplate('business')" data-template="business">
                        <div class="template-icon">üíº</div>
                        <div class="template-title">Document Business</div>
                        <div class="template-desc">Rapports, pr√©sentations, analyses et plans strat√©giques</div>
                    </div>
                    
                    <div class="template-card" onclick="selectTemplate('research')" data-template="research">
                        <div class="template-icon">üî¨</div>
                        <div class="template-title">Recherche Scientifique</div>
                        <div class="template-desc">Abstract, m√©thodologie, r√©sultats, discussion, bibliographie</div>
                    </div>
                    
                    <div class="template-card selected" onclick="selectTemplate('universal')" data-template="universal">
                        <div class="template-icon">üåç</div>
                        <div class="template-title">Universel (D√©faut)</div>
                        <div class="template-desc">Extraction adaptative pour tout type de contenu</div>
                    </div>
                </div>
            </div>

            <button class="btn" onclick="validatePhase1()">Analyser et Pr√©parer l'Extraction</button>
        </div>

        <!-- PHASE 2 : Extraction -->
        <div class="phase hidden" id="phase2">
            <div class="phase-title">Phase 2 : Extraction avec Claude</div>
            
            <div id="extractionContent"></div>

            <div class="info-box" id="fusionReady" style="display: none; background: linear-gradient(135deg, var(--vert-sauge), var(--mer)); border-color: var(--mer); color: white;">
                <div style="font-size: 1.5em; font-weight: 700; margin-bottom: 15px; text-align: center;">
                    Toutes les parties sont valid√©es
                </div>
                <p style="text-align: center; font-size: 1.1em;">
                    Vous pouvez maintenant fusionner les r√©sultats en une base de connaissances unique.
                </p>
            </div>

            <button class="btn" id="fusionBtn" onclick="mergeAndGenerate()" style="margin-top: 30px; display: none; font-size: 1.3em; padding: 20px;">
                Fusionner et G√©n√©rer la Base de Connaissances
            </button>
        </div>

        <!-- PHASE 3 : Export -->
        <div class="phase hidden" id="phase3">
            <div class="phase-title">Phase 3 : Base de Connaissances G√©n√©r√©e</div>
            
            <div class="info-box">
                <div class="info-box-title">Extraction Termin√©e avec Succ√®s</div>
                <p style="line-height: 1.8;">
                    Votre document a √©t√© transform√© en une base de connaissances structur√©e et exploitable. 
                    T√©l√©chargez les fichiers dans le format de votre choix.
                </p>
            </div>

            <div style="text-align: center; margin: 30px 0;">
                <button class="btn" onclick="downloadAllAsZip()" style="max-width: 500px; font-size: 1.2em;">
                    T√©l√©charger Tout en ZIP
                </button>
            </div>

            <h3 style="color: var(--mer); margin: 40px 0 25px; text-align: center; font-size: 1.8em;">
                Fichiers Disponibles
            </h3>

            <div class="download-grid" id="finalDownloads"></div>

            <div style="text-align: center; margin-top: 40px;">
                <button class="btn btn-secondary" onclick="reset()">Traiter un Nouveau Document</button>
            </div>
        </div>

        <div class="footer">
            Bilan de Comp√©tences du couple - Marie-Christine Abatte Psychologue
        </div>
    </div>

    <script>
        // Configuration globale
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';

        const MAX_SIZE_BYTES = 20 * 1024 * 1024; // 20 MB

        // === CONFIGURATION DES MODES ===
        const EXTRACTION_MODES = {
            standard: {
                name: 'Standard',
                pagesPerPart: 27,
                contentsPerPage: 2.5,
                kbPerPage: 3.0,
                maxJsonKb: 80,
                description: 'Documents denses'
            },
            lightbook: {
                name: 'Livre L√©ger',
                pagesPerPart: 45,
                contentsPerPage: 1.5,
                kbPerPage: 1.8,
                maxJsonKb: 80,
                description: 'Livres a√©r√©s'
            }
        };

        const state = {
            files: [],
            selectedTemplate: 'universal',
            selectedMode: 'standard',
            metadata: {
                titre: '',
                auteurs: [],
                annee: null,
                categorie: '',
                tags: []
            },
            parts: [],
            uploadedJSONs: [],
            finalData: null,
            totalPages: 0,
            fileSize: 0,
            documentDensity: 0,
            isLightBook: false,
            isPDF: false
        };

        // PROMPT TEMPLATES
        const PROMPT_TEMPLATES = {
            universal: `# EXTRACTION UNIVERSELLE CLAUDE - HAUTE FID√âLIT√â

Tu es Claude Sonnet 4.5, expert en extraction de contenu. Ta mission est d'extraire INT√âGRALEMENT le contenu de ce document avec une FID√âLIT√â ABSOLUE au texte original.

‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ

PRINCIPES FONDAMENTAUX

1. FID√âLIT√â ABSOLUE
   - Respecte la terminologie exacte de l'auteur
   - Ne modifie JAMAIS le sens du contenu
   - Pr√©serve nuances et subtilit√©s
   - Cite textuellement quand pertinent

2. EXHAUSTIVIT√â
   - Identifie TOUS les concepts importants
   - Capture TOUTE l'information structur√©e
   - Note TOUS les exemples et illustrations
   - Extrait TOUTES les r√©f√©rences

3. STRUCTURE CLAIRE
   - Organisation hi√©rarchique logique
   - Progression coh√©rente
   - Liens entre sections

‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ

FORMAT JSON UNIVERSEL

{
  "document_metadata": {
    "titre": "Titre exact",
    "auteurs": ["Auteur 1", "Auteur 2"],
    "annee": 2024,
    "type_document": "livre|article|cours|rapport|guide|autre",
    "categorie": "Domaine principal",
    "tags": ["tag1", "tag2"],
    "langue": "Fran√ßais",
    "pages_total": 0
  },
  "structure_contenu": {
    "sections": [
      {
        "id": "sec_001",
        "titre": "Titre de la section",
        "niveau": 1,
        "pages": [1, 2, 3],
        "contenu": {
          "resume": "R√©sum√© de la section",
          "points_cles": ["Point 1", "Point 2"],
          "concepts": [
            {
              "nom": "Nom du concept",
              "definition": "D√©finition exacte",
              "explication": "Explication d√©taill√©e",
              "exemples": ["Exemple 1"],
              "mots_cles": ["mot1", "mot2"]
            }
          ]
        },
        "sous_sections": []
      }
    ]
  },
  "index_global": {
    "concepts_cles": {},
    "termes_importants": []
  },
  "statistiques": {
    "total_sections": 0,
    "total_concepts": 0
  }
}

‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ

VALIDATION QUALIT√â

- Compl√©tude : Tout le contenu est extrait
- Fid√©lit√© : Terminologie pr√©serv√©e
- Structure : Hi√©rarchie logique maintenue
- JSON : Syntaxe strictement valide

Lance l'extraction maintenant !`,

            academic: `# EXTRACTION ACAD√âMIQUE - LIVRES ET COURS

Structure pour documents acad√©miques avec chapitres, concepts, exercices et r√©f√©rences bibliographiques.`,

            technical: `# EXTRACTION DOCUMENTATION TECHNIQUE

Structure pour APIs, proc√©dures, sp√©cifications et guides techniques.`,

            article: `# EXTRACTION ARTICLE ET CONTENU WEB

Structure pour articles, blogs, avec introduction, corps et conclusion.`,

            business: `# EXTRACTION DOCUMENTS BUSINESS

Structure pour rapports, pr√©sentations et analyses strat√©giques.`,

            research: `# EXTRACTION RECHERCHE SCIENTIFIQUE

Structure avec abstract, m√©thodologie, r√©sultats et bibliographie.`
        };

        // Event Listeners pour le drag & drop
        const dropZone = document.getElementById('dropZone');
        const fileInput = document.getElementById('fileInput');

        dropZone.addEventListener('dragover', (e) => {
            e.preventDefault();
            dropZone.classList.add('drag-over');
        });

        dropZone.addEventListener('dragleave', () => {
            dropZone.classList.remove('drag-over');
        });

        dropZone.addEventListener('drop', (e) => {
            e.preventDefault();
            dropZone.classList.remove('drag-over');
            handleFiles(e.dataTransfer.files);
        });

        fileInput.addEventListener('change', (e) => {
            handleFiles(e.target.files);
        });

        async function handleFiles(files) {
            if (files.length === 0) return;
            
            state.files = Array.from(files);
            displayFilePreview();
            
            // Si c'est un PDF, analyser la densit√©
            const file = state.files[0];
            if (file.type === 'application/pdf') {
                state.isPDF = true;
                state.fileSize = file.size;
                
                const arrayBuffer = await file.arrayBuffer();
                const loadingTask = pdfjsLib.getDocument({ data: arrayBuffer });
                const pdfDoc = await loadingTask.promise;
                state.totalPages = pdfDoc.numPages;
                
                analyzeDocumentDensity();
            } else {
                state.isPDF = false;
                document.getElementById('detectionZone').classList.add('hidden');
                document.getElementById('modeSelector').classList.add('hidden');
            }
        }

        function analyzeDocumentDensity() {
            const sizeMB = state.fileSize / (1024 * 1024);
            state.documentDensity = sizeMB / state.totalPages;
            state.isLightBook = state.documentDensity < 0.05;
            
            const detectionZone = document.getElementById('detectionZone');
            detectionZone.classList.remove('hidden');
            
            const isLight = state.isLightBook;
            const densityText = state.documentDensity < 0.02 ? 'Tr√®s faible' : 
                               state.documentDensity < 0.05 ? 'Faible' : 
                               state.documentDensity < 0.1 ? 'Moyenne' : '√âlev√©e';
            
            detectionZone.innerHTML = `
                <div class="detection-box ${isLight ? 'light-book' : ''}">
                    <div class="detection-title">
                        ${isLight ? 'Document Livre L√©ger D√©tect√©' : 'Document Standard D√©tect√©'}
                    </div>
                    <p style="margin-bottom: 10px;">
                        ${isLight 
                            ? 'Ce document a une faible densit√©. Le Mode Livre L√©ger est recommand√©.' 
                            : 'Ce document a une densit√© normale. Le Mode Standard est recommand√©.'}
                    </p>
                    <div class="detection-stats">
                        <div class="detection-stat">
                            <div class="detection-stat-value">${state.totalPages}</div>
                            <div class="detection-stat-label">Pages</div>
                        </div>
                        <div class="detection-stat">
                            <div class="detection-stat-value">${sizeMB.toFixed(2)} Mo</div>
                            <div class="detection-stat-label">Taille</div>
                        </div>
                        <div class="detection-stat">
                            <div class="detection-stat-value">${(state.documentDensity * 1024).toFixed(1)} Ko</div>
                            <div class="detection-stat-label">Par page</div>
                        </div>
                        <div class="detection-stat">
                            <div class="detection-stat-value">${densityText}</div>
                            <div class="detection-stat-label">Densit√©</div>
                        </div>
                    </div>
                </div>
            `;
            
            document.getElementById('modeSelector').classList.remove('hidden');
            selectMode(isLight ? 'lightbook' : 'standard');
            
            if (isLight) {
                document.getElementById('modeLightBook').classList.add('recommended');
                document.getElementById('modeStandard').classList.remove('recommended');
            } else {
                document.getElementById('modeStandard').classList.add('recommended');
                document.getElementById('modeLightBook').classList.remove('recommended');
            }
        }

        function selectMode(mode) {
            state.selectedMode = mode;
            
            document.querySelectorAll('.mode-card').forEach(card => {
                card.classList.remove('selected');
            });
            
            if (mode === 'standard') {
                document.getElementById('modeStandard').classList.add('selected');
            } else {
                document.getElementById('modeLightBook').classList.add('selected');
            }
        }

        function displayFilePreview() {
            const preview = document.getElementById('filePreview');
            preview.style.display = 'block';
            preview.innerHTML = '<h3 style="color: var(--mer); margin-bottom: 15px;">Fichiers S√©lectionn√©s</h3>';
            
            state.files.forEach((file, index) => {
                const icon = getFileIcon(file.type, file.name);
                const sizeMB = (file.size / (1024 * 1024)).toFixed(2);
                const fileType = getFileType(file.type, file.name);
                
                const item = document.createElement('div');
                item.className = 'file-preview-item';
                item.innerHTML = `
                    <div class="file-icon">${icon}</div>
                    <div class="file-info-text">
                        <div class="file-name">${file.name}</div>
                        <div class="file-details">${fileType} - ${sizeMB} Mo</div>
                    </div>
                `;
                preview.appendChild(item);
            });
        }

        function getFileIcon(mimeType, filename) {
            if (mimeType.includes('pdf')) return 'PDF';
            if (mimeType.includes('image')) return 'IMG';
            if (mimeType.includes('text') || filename.endsWith('.md')) return 'TXT';
            return 'DOC';
        }

        function getFileType(mimeType, filename) {
            if (mimeType.includes('pdf')) return 'PDF Document';
            if (mimeType.includes('image/png')) return 'Image PNG';
            if (mimeType.includes('image/jpeg') || mimeType.includes('image/jpg')) return 'Image JPEG';
            if (mimeType.includes('image/webp')) return 'Image WEBP';
            if (mimeType.includes('image/gif')) return 'Image GIF';
            if (mimeType.includes('text/plain')) return 'Fichier Texte';
            if (filename.endsWith('.md')) return 'Markdown';
            return 'Document';
        }

        function selectTemplate(templateId) {
            state.selectedTemplate = templateId;
            document.querySelectorAll('.template-card').forEach(card => {
                card.classList.remove('selected');
            });
            document.querySelector(`[data-template="${templateId}"]`).classList.add('selected');
        }

        async function validatePhase1() {
            if (state.files.length === 0) {
                alert('Veuillez s√©lectionner au moins un fichier.');
                return;
            }

            const titre = document.getElementById('titleInput').value.trim();
            const auteurs = document.getElementById('authorsInput').value.trim();
            
            if (!titre) {
                alert('Veuillez renseigner au minimum le titre du document.');
                return;
            }

            state.metadata = {
                titre: titre,
                auteurs: auteurs ? auteurs.split(',').map(a => a.trim()) : [],
                annee: document.getElementById('yearInput').value ? parseInt(document.getElementById('yearInput').value) : null,
                categorie: document.getElementById('categoryInput').value.trim(),
                tags: document.getElementById('tagsInput').value.trim().split(',').map(t => t.trim()).filter(t => t)
            };

            // Calculer les parties si c'est un PDF
            if (state.isPDF) {
                await calculateOptimalSplit();
            } else {
                // Pour les autres formats, une seule partie
                state.parts = [{
                    partNum: 1,
                    totalParts: 1,
                    startPage: 1,
                    endPage: 1,
                    numPages: 1,
                    file: state.files[0],
                    mode: state.selectedMode
                }];
            }
            
            updateProgressIndicator(2);
            document.getElementById('phase1').classList.add('hidden');
            document.getElementById('phase2').classList.remove('hidden');
            document.getElementById('phase2').scrollIntoView({ behavior: 'smooth' });
            
            displayExtractionInterface();
        }

        async function calculateOptimalSplit() {
            const mode = EXTRACTION_MODES[state.selectedMode];
            const pagesPerPart = mode.pagesPerPart;
            const numParts = Math.ceil(state.totalPages / pagesPerPart);
            const basePagesPerPart = Math.floor(state.totalPages / numParts);
            const remainder = state.totalPages % numParts;

            state.parts = [];
            let currentPage = 1;

            for (let i = 0; i < numParts; i++) {
                const pagesThisPart = basePagesPerPart + (i < remainder ? 1 : 0);
                const startPage = currentPage;
                const endPage = currentPage + pagesThisPart - 1;

                state.parts.push({
                    partNum: i + 1,
                    totalParts: numParts,
                    startPage: startPage,
                    endPage: endPage,
                    numPages: pagesThisPart,
                    file: null,
                    mode: state.selectedMode
                });
                
                currentPage = endPage + 1;
            }

            // G√©n√©rer les PDFs des parties
            for (const part of state.parts) {
                await generatePartPDF(part);
            }
        }

        async function generatePartPDF(part) {
            try {
                const arrayBuffer = await state.files[0].arrayBuffer();
                const pdfDoc = await PDFLib.PDFDocument.load(arrayBuffer);
                
                const newPdf = await PDFLib.PDFDocument.create();
                const pages = await newPdf.copyPages(pdfDoc, Array.from({length: part.endPage - part.startPage + 1}, (_, i) => part.startPage - 1 + i));
                
                pages.forEach(page => newPdf.addPage(page));
                
                const pdfBytes = await newPdf.save();
                part.file = new Blob([pdfBytes], { type: 'application/pdf' });
            } catch (error) {
                console.error('Erreur g√©n√©ration PDF partie:', error);
            }
        }

        function displayExtractionInterface() {
            const container = document.getElementById('extractionContent');
            const mode = EXTRACTION_MODES[state.selectedMode];
            
            let partsHTML = '';
            
            state.parts.forEach(part => {
                const prompt = generatePrompt(part);
                partsHTML += `
                    <div class="part-card" id="partCard${part.partNum}">
                        <div class="part-header">
                            <div class="part-title">Partie ${part.partNum}/${part.totalParts}</div>
                            <div id="partValidated${part.partNum}" style="font-size: 2em; display: none;">‚úì</div>
                        </div>

                        ${state.isPDF ? `
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px; margin: 20px 0;">
                            <div style="background: var(--sable); padding: 15px; border-radius: 8px; text-align: center;">
                                <div style="font-size: 0.9em; color: #666;">Pages</div>
                                <div style="font-size: 1.4em; font-weight: 700; color: var(--mer);">${part.startPage}-${part.endPage}</div>
                            </div>
                            <div style="background: var(--sable); padding: 15px; border-radius: 8px; text-align: center;">
                                <div style="font-size: 0.9em; color: #666;">Quantit√©</div>
                                <div style="font-size: 1.4em; font-weight: 700; color: var(--mer);">${part.numPages} p.</div>
                            </div>
                            <div style="background: var(--sable); padding: 15px; border-radius: 8px; text-align: center;">
                                <div style="font-size: 0.9em; color: #666;">Mode</div>
                                <div style="font-size: 1.1em; font-weight: 700; color: var(--mer);">${mode.name}</div>
                            </div>
                        </div>
                        ` : ''}

                        <div style="background: var(--sable); padding: 20px; border-radius: 10px; margin: 20px 0;">
                            <h4 style="color: var(--mer); margin-bottom: 15px; font-size: 1.2em;">Fichier √† traiter</h4>
                            <button class="btn btn-secondary btn-small" onclick="downloadPartFile(${part.partNum})">
                                T√©l√©charger pour Claude
                            </button>
                        </div>

                        <div style="background: var(--sable); padding: 20px; border-radius: 10px; margin: 20px 0;">
                            <h4 style="color: var(--mer); margin-bottom: 15px; font-size: 1.2em;">Prompt pour Claude</h4>
                            <div class="prompt-box" id="promptBox${part.partNum}">${prompt}</div>
                            <div class="action-buttons" style="margin-top: 15px;">
                                <button class="btn btn-secondary" onclick="copyPrompt(${part.partNum})">Copier Prompt</button>
                                <button class="btn btn-secondary" onclick="downloadPromptTxt(${part.partNum})">T√©l√©charger Prompt.txt</button>
                            </div>
                        </div>

                        <div style="background: linear-gradient(135deg, rgba(143, 175, 177, 0.1), rgba(200, 208, 195, 0.1)); padding: 25px; border-radius: 12px; border: 3px solid var(--vert-sauge); margin-top: 25px;">
                            <h4 style="color: var(--mer); margin-bottom: 15px; font-size: 1.3em;">
                                Validation du JSON
                            </h4>
                            
                            <div id="jsonStatus${part.partNum}" style="margin-bottom: 15px; padding: 12px; background: var(--blanc); border-radius: 8px; font-weight: 600; color: #666;">
                                En attente du JSON Claude...
                            </div>
                            
                            <textarea id="jsonTextarea${part.partNum}" class="json-textarea" placeholder="Collez ici le JSON g√©n√©r√© par Claude..." oninput="enableButtons(${part.partNum})"></textarea>
                            
                            <div class="action-buttons" style="margin-top: 15px;">
                                <button class="btn btn-secondary" id="testBtn${part.partNum}" onclick="previewJSON(${part.partNum})" disabled style="opacity: 0.5;">
                                    Tester le JSON
                                </button>
                                <button class="btn btn-secondary" id="validateBtn${part.partNum}" onclick="validateJSON(${part.partNum})" disabled style="opacity: 0.5;">
                                    Valider et Enregistrer
                                </button>
                            </div>
                            
                            <div id="jsonPreview${part.partNum}" style="display: none; margin-top: 20px; padding: 20px; background: var(--blanc); border-radius: 10px; border: 2px solid var(--vert-sauge);"></div>
                        </div>
                    </div>
                `;
            });
            
            container.innerHTML = `
                <div class="info-box">
                    <div class="info-box-title">Instructions de Traitement</div>
                    <ol style="margin-left: 25px; line-height: 2;">
                        <li>T√©l√©chargez le fichier</li>
                        <li>Ouvrez Claude (claude.ai) et uploadez le fichier</li>
                        <li>Copiez et collez le prompt</li>
                        <li>Attendez la g√©n√©ration du JSON</li>
                        <li>Collez le r√©sultat ci-dessous et validez</li>
                    </ol>
                </div>
                ${state.isPDF && state.selectedMode === 'lightbook' ? `
                <div style="background: var(--accent-success); padding: 15px; border-radius: 10px; margin: 20px 0; border-left: 4px solid #28a745;">
                    <strong>Mode Livre L√©ger actif :</strong> Extraction condens√©e avec parties de ~${EXTRACTION_MODES.lightbook.pagesPerPart} pages. 
                    Qualit√© exceptionnelle pr√©serv√©e.
                </div>
                ` : ''}
                ${partsHTML}
            `;

            state.uploadedJSONs = new Array(state.parts.length).fill(null);
        }

        function generatePrompt(part) {
            const isMulti = part.totalParts > 1;
            const isLightBook = state.selectedMode === 'lightbook';
            const basePrompt = PROMPT_TEMPLATES[state.selectedTemplate];
            
            let modeInstructions = '';
            if (isLightBook && state.isPDF) {
                modeInstructions = `
MODE LIVRE L√âGER ACTIV√â
‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ
Extraction CONDENS√âE mais EXHAUSTIVE :
- Synth√©tise au niveau section (pas paragraphe par paragraphe)
- Regroupe les id√©es connexes
- Priorise les √©l√©ments actionnables
- Limite √† 1-2 contenus par page
- Pr√©serve 100% des informations cl√©s

`;
            }

            let contextInfo = `
DOCUMENT : ${state.metadata.titre}
AUTEURS : ${state.metadata.auteurs.join(', ')}
CAT√âGORIE : ${state.metadata.categorie}
`;

            if (isMulti) {
                contextInfo += `
PARTIE ${part.partNum}/${part.totalParts}
PAGES : ${part.startPage}-${part.endPage} (${part.numPages} pages)
`;
            }

            return `${modeInstructions}${contextInfo}

${basePrompt}

Ta r√©ponse doit √™tre UNIQUEMENT le JSON valide.`;
        }

        function downloadPartFile(partNum) {
            const part = state.parts[partNum - 1];
            if (!part.file) {
                alert('Le fichier n\'est pas encore pr√™t.');
                return;
            }
            const url = URL.createObjectURL(part.file);
            const a = document.createElement('a');
            a.href = url;
            const fileName = state.isPDF 
                ? `part${String(partNum).padStart(2, '0')}_${state.metadata.titre.substring(0, 30).replace(/[^a-z0-9]/gi, '_')}.pdf`
                : part.file.name;
            a.download = fileName;
            a.click();
            URL.revokeObjectURL(url);
        }

        function copyPrompt(partNum) {
            const part = state.parts[partNum - 1];
            const prompt = generatePrompt(part);
            navigator.clipboard.writeText(prompt).then(() => {
                alert('Prompt copi√©');
            });
        }

        function downloadPromptTxt(partNum) {
            const part = state.parts[partNum - 1];
            const prompt = generatePrompt(part);
            const blob = new Blob([prompt], { type: 'text/plain;charset=utf-8' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `prompt_${state.metadata.titre.substring(0, 30).replace(/[^a-z0-9]/gi, '_')}_part${partNum}.txt`;
            a.click();
            URL.revokeObjectURL(url);
        }

        function enableButtons(partNum) {
            const textarea = document.getElementById(`jsonTextarea${partNum}`);
            const hasContent = textarea && textarea.value.trim().length > 0;
            
            const testBtn = document.getElementById(`testBtn${partNum}`);
            const validateBtn = document.getElementById(`validateBtn${partNum}`);
            const statusDiv = document.getElementById(`jsonStatus${partNum}`);
            
            if (testBtn && validateBtn) {
                testBtn.disabled = !hasContent;
                validateBtn.disabled = !hasContent;
                testBtn.style.opacity = hasContent ? '1' : '0.5';
                validateBtn.style.opacity = hasContent ? '1' : '0.5';
            }
            
            if (statusDiv && hasContent) {
                statusDiv.innerHTML = 'JSON coll√© - Cliquez sur "Tester" puis "Valider"';
                statusDiv.style.color = '#0066cc';
                statusDiv.style.background = '#e3f2fd';
            }
        }

        function previewJSON(partNum) {
            const textarea = document.getElementById(`jsonTextarea${partNum}`);
            let jsonText = textarea.value.trim();
            const previewDiv = document.getElementById(`jsonPreview${partNum}`);
            
            if (!jsonText) {
                alert('Aucun JSON √† pr√©visualiser.');
                return;
            }

            jsonText = cleanJSON(jsonText);

            try {
                const json = JSON.parse(jsonText);
                
                let stats = { sections: 0, concepts: 0 };
                if (json.structure_contenu && json.structure_contenu.sections) {
                    stats.sections = json.structure_contenu.sections.length;
                }

                previewDiv.innerHTML = `
                    <div style="font-weight: 700; margin-bottom: 15px; color: var(--mer); font-size: 1.2em;">JSON VALIDE</div>
                    <div style="padding: 15px; background: linear-gradient(135deg, #d4edda, #c3e6cb); border-radius: 8px; border: 2px solid #28a745; color: #155724; font-weight: 600;">
                        Structure valid√©e : ${stats.sections} sections d√©tect√©es
                    </div>
                `;
                previewDiv.style.display = 'block';
                
            } catch (error) {
                previewDiv.innerHTML = `
                    <div style="font-weight: 700; margin-bottom: 10px; color: #dc3545; font-size: 1.2em;">JSON INVALIDE</div>
                    <div style="padding: 15px; background: #f8d7da; border-radius: 8px; color: #721c24;">
                        ${error.message}
                    </div>
                `;
                previewDiv.style.display = 'block';
            }
        }

        function validateJSON(partNum) {
            const textarea = document.getElementById(`jsonTextarea${partNum}`);
            let jsonText = textarea.value.trim();
            
            if (!jsonText) {
                alert('Veuillez coller le JSON.');
                return;
            }

            jsonText = cleanJSON(jsonText);

            try {
                const json = JSON.parse(jsonText);
                state.uploadedJSONs[partNum - 1] = json;
                
                const statusDiv = document.getElementById(`jsonStatus${partNum}`);
                statusDiv.innerHTML = `<strong>Partie ${partNum} VALID√âE</strong>`;
                statusDiv.style.color = '#155724';
                statusDiv.style.background = 'linear-gradient(135deg, #d4edda, #c3e6cb)';
                statusDiv.style.fontWeight = '700';
                statusDiv.style.border = '2px solid #28a745';
                statusDiv.style.padding = '15px';
                
                document.getElementById(`jsonTextarea${partNum}`).style.display = 'none';
                document.getElementById(`testBtn${partNum}`).style.display = 'none';
                document.getElementById(`validateBtn${partNum}`).style.display = 'none';
                document.getElementById(`partValidated${partNum}`).style.display = 'block';
                
                const validatedCount = state.uploadedJSONs.filter(j => j !== null).length;
                
                if (validatedCount === state.parts.length) {
                    document.getElementById('fusionReady').style.display = 'block';
                    document.getElementById('fusionBtn').style.display = 'block';
                    setTimeout(() => {
                        document.getElementById('fusionBtn').scrollIntoView({ behavior: 'smooth', block: 'center' });
                    }, 500);
                }
                
            } catch (error) {
                alert(`Erreur JSON : ${error.message}`);
            }
        }

        function cleanJSON(text) {
            text = text.replace(/```json\s*/g, '');
            text = text.replace(/```\s*/g, '');
            text = text.replace(/\/\*[\s\S]*?\*\//g, '');
            text = text.replace(/\/\/.*/g, '');
            text = text.trim();
            
            const jsonStart = text.indexOf('{');
            if (jsonStart !== -1) {
                text = text.substring(jsonStart);
            }
            
            return text;
        }

        function mergeAndGenerate() {
            const finalData = state.uploadedJSONs[0];
            state.finalData = finalData;
            state.finalData.extraction_mode = state.selectedMode;
            
            const readme = generateREADME(finalData);
            const html = generateHTML(finalData);
            const md = generateMarkdown(finalData);
            
            updateProgressIndicator(3);
            document.getElementById('phase2').classList.add('hidden');
            document.getElementById('phase3').classList.remove('hidden');
            document.getElementById('phase3').scrollIntoView({ behavior: 'smooth' });
            
            createFinalDownloads(finalData, readme, html, md);
        }

        function generateREADME(data) {
            const mode = EXTRACTION_MODES[state.selectedMode];
            return `# ${data.document_metadata.titre}

## M√©tadonn√©es

- **Auteurs** : ${data.document_metadata.auteurs.join(', ')}
- **Ann√©e** : ${data.document_metadata.annee || 'N/A'}
- **Type** : ${data.document_metadata.type_document || 'N/A'}
- **Cat√©gorie** : ${data.document_metadata.categorie || 'N/A'}
- **Tags** : ${data.document_metadata.tags ? data.document_metadata.tags.join(', ') : 'N/A'}
- **Mode d'extraction** : ${mode.name}

## Contenu Extrait

Document trait√© avec PDF Batch PRO UNIVERSAL v2.0 - Mode ${mode.name}.

---

Bilan de Comp√©tences du couple - Marie-Christine Abatte Psychologue
`;
        }

        function generateHTML(data) {
            const mode = EXTRACTION_MODES[state.selectedMode];
            return `<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>${data.document_metadata.titre}</title>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --mer: #8FAFB1;
            --vert-sauge: #C8D0C3;
            --sable: #E6D7C3;
            --blanc: #FFFFFF;
        }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Montserrat', sans-serif;
            background: var(--blanc);
            color: #333;
            padding: 40px 20px;
            line-height: 1.7;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: var(--blanc);
            padding: 50px;
            border-radius: 20px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.1);
        }
        h1 {
            color: var(--mer);
            font-size: 2.5em;
            margin-bottom: 20px;
            border-bottom: 4px solid var(--vert-sauge);
            padding-bottom: 20px;
        }
        .meta {
            background: linear-gradient(135deg, var(--sable), var(--vert-sauge));
            padding: 25px;
            border-radius: 12px;
            margin: 25px 0;
            border-left: 5px solid var(--mer);
        }
        .footer {
            text-align: center;
            margin-top: 50px;
            padding-top: 25px;
            border-top: 2px solid var(--vert-sauge);
            color: #666;
            font-size: 0.9em;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>${data.document_metadata.titre}</h1>
        
        <div class="meta">
            <p><strong>Auteurs :</strong> ${data.document_metadata.auteurs.join(', ')}</p>
            <p><strong>Type :</strong> ${data.document_metadata.type_document || 'N/A'}</p>
            <p><strong>Cat√©gorie :</strong> ${data.document_metadata.categorie || 'N/A'}</p>
            <p><strong>Mode :</strong> ${mode.name}</p>
        </div>

        <div class="footer">
            <p><strong>PDF Batch PRO UNIVERSAL v2.0</strong></p>
            <p>Bilan de Comp√©tences du couple - Marie-Christine Abatte Psychologue</p>
        </div>
    </div>
</body>
</html>`;
        }

        function generateMarkdown(data) {
            const mode = EXTRACTION_MODES[state.selectedMode];
            let md = `# ${data.document_metadata.titre}\n\n`;
            md += `**Auteurs :** ${data.document_metadata.auteurs.join(', ')}\n\n`;
            md += `**Mode :** ${mode.name}\n\n`;
            md += `---\n\n`;
            md += `*G√©n√©r√© avec PDF Batch PRO UNIVERSAL v2.0*\n`;
            return md;
        }

        function createFinalDownloads(json, readme, html, md) {
            const container = document.getElementById('finalDownloads');
            container.innerHTML = '';
            
            const files = [
                { 
                    name: 'knowledge_index.json', 
                    content: JSON.stringify(json, null, 2), 
                    type: 'application/json', 
                    icon: '{}',
                    desc: 'Structure JSON compl√®te' 
                },
                { 
                    name: 'README.md', 
                    content: readme, 
                    type: 'text/markdown', 
                    icon: '#',
                    desc: 'Documentation' 
                },
                { 
                    name: 'index.html', 
                    content: html, 
                    type: 'text/html', 
                    icon: '<>',
                    desc: 'Interface web' 
                },
                { 
                    name: 'knowledge.md', 
                    content: md, 
                    type: 'text/markdown', 
                    icon: 'MD',
                    desc: 'Format Markdown' 
                }
            ];

            state.files.forEach(file => {
                files.push({
                    name: file.name,
                    content: file,
                    type: file.type,
                    icon: getFileIcon(file.type, file.name),
                    desc: 'Fichier original',
                    isBlob: true
                });
            });

            files.forEach(file => {
                const blob = file.isBlob ? file.content : new Blob([file.content], { type: file.type });
                const url = URL.createObjectURL(blob);
                
                const item = document.createElement('div');
                item.className = 'download-item';
                item.innerHTML = `
                    <div class="download-icon" style="font-family: monospace; background: var(--sable); width: 80px; height: 80px; border-radius: 50%; display: flex; align-items: center; justify-content: center; margin: 0 auto 15px; font-size: 1.5em; font-weight: 700; color: var(--mer);">${file.icon}</div>
                    <div style="font-weight: 700; font-size: 1.1em; margin: 15px 0;">${file.name}</div>
                    <div style="font-size: 0.9em; color: #666; margin-bottom: 20px;">${file.desc}</div>
                    <a href="${url}" download="${file.name}" class="btn btn-secondary btn-small">T√©l√©charger</a>
                `;
                container.appendChild(item);
            });
        }

        async function downloadAllAsZip() {
            const zip = new JSZip();
            const baseName = state.metadata.titre.substring(0, 50).replace(/[^a-z0-9]/gi, '_');
            
            zip.file('knowledge_index.json', JSON.stringify(state.finalData, null, 2));
            zip.file('README.md', generateREADME(state.finalData));
            zip.file('index.html', generateHTML(state.finalData));
            zip.file('knowledge.md', generateMarkdown(state.finalData));
            
            for (const file of state.files) {
                zip.file(file.name, file);
            }
            
            const content = await zip.generateAsync({ type: 'blob' });
            const url = URL.createObjectURL(content);
            const a = document.createElement('a');
            a.href = url;
            a.download = `${baseName}_extraction.zip`;
            a.click();
            URL.revokeObjectURL(url);
        }

        function updateProgressIndicator(step) {
            for (let i = 1; i <= 3; i++) {
                const indicator = document.getElementById(`stepIndicator${i}`);
                indicator.classList.remove('active', 'completed');
                
                if (i < step) {
                    indicator.classList.add('completed');
                } else if (i === step) {
                    indicator.classList.add('active');
                }
            }
        }

        function reset() {
            location.reload();
        }
    </script>
</body>
</html>
